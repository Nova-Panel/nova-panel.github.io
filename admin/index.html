<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <title>پنل مدیریت</title>
    <script data-cfasync="false" src="https://cdn.jsdelivr.net/npm/@keeex/qrcodejs-kx@1.0.2/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&family=Orbitron:wght@700;800;900&display=swap"
        rel="stylesheet">
    <!-- Vazirmatn Persian Font -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <!-- Leaflet Map Resources -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* تنظیمات راست‌چین فارسی */
        html[dir="rtl"] {
            direction: rtl;
        }

        html[dir="rtl"] body {
            text-align: right;
        }

        html[dir="rtl"] .form-group {
            text-align: right;
        }

        html[dir="rtl"] .form-group label {
            text-align: right;
        }

        html[dir="rtl"] .input-icon {
            left: auto;
            right: 16px;
        }

        html[dir="rtl"] .form-group input.with-icon {
            padding-left: 16px;
            padding-right: 48px;
        }

        html[dir="rtl"] .social-text {
            margin-right: 0;
            margin-left: 10px;
        }

        html[dir="rtl"] .checkbox-group {
            flex-direction: row;
        }

        html[dir="rtl"] .checkbox-row {
            flex-direction: row;
        }

        html[dir="rtl"] .btn-group {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .module-footer {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .header {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .header-buttons {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .notification-row {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .notification-controls {
            margin-left: 0;
            margin-right: auto;
        }

        html[dir="rtl"] .save-tip {
            margin-right: 0;
            margin-left: auto;
        }

        html[dir="rtl"] .api-buttons {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .subapi-buttons {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .reset-modal-buttons {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .skipverify-buttons {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .optimize-buttons {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .path-template-buttons {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .ip-detection-box {
            text-align: right;
        }

        html[dir="rtl"] .latency-card-info {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .latency-card-header {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .cf-stats-grid {
            text-align: right;
        }

        html[dir="rtl"] .cf-progress-header {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .ip-detail-header {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .ip-detail-info-grid {
            text-align: right;
        }

        html[dir="rtl"] .modal {
            text-align: right;
        }

        html[dir="rtl"] .modal-close {
            right: auto;
            left: 15px;
        }

        html[dir="rtl"] .page-header {
            text-align: center;
        }

        html[dir="rtl"] .footer-hint {
            text-align: center;
        }

        html[dir="rtl"] .api-docs {
            text-align: right;
        }

        html[dir="rtl"] .latency-card-region {
            text-align: left;
        }

        html[dir="rtl"] .optimize-tabs {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .ech-tabs {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .form-group {
            text-align: right;
        }

        html[dir="rtl"] select,
        html[dir="rtl"] input,
        html[dir="rtl"] textarea {
            text-align: right;
        }

        html[dir="rtl"] .copy-btn {
            right: auto;
            left: 10px;
        }

        html[dir="rtl"] .input-wrapper {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .link-input-wrapper {
            flex-direction: row-reverse;
        }

        html[dir="rtl"] .readonly-wrapper input[readonly] {
            text-align: right;
        }

        html[dir="rtl"] .latency-status {
            right: auto;
            left: 0;
        }

        html[dir="rtl"] .cf-bar-green {
            justify-content: flex-start;
            padding-right: 12px;
            padding-left: 0;
        }

        html[dir="rtl"] .ip-detail-close {
            right: auto;
            left: 20px;
        }

        html[dir="rtl"] .proxy-map-container {
            direction: ltr;
        }

        html[dir="rtl"] .form-group input,
        html[dir="rtl"] .form-group select,
        html[dir="rtl"] .form-group textarea {
            text-align: right;
        }

        html[dir="rtl"] select option {
            text-align: right;
        }

        /* استایل آیکون‌های شبکه‌های اجتماعی در منو */
        .sidebar-footer a:hover {
            background: rgba(255, 255, 255, 0.25) !important;
            transform: translateY(-2px);
        }

        /* بازنشانی پایه */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Vazirmatn', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow-x: hidden;
            background: #ffffff !important;
            min-height: 100vh;
            text-align: right;
        }

        /* ==================== داشبورد و منو ==================== */
        .dashboard-layout {
            display: flex;
            min-height: 100vh;
            background: #ffffff;
        }

        /* منوی کناری */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #0ea5e9 0%, #8b5cf6 100%);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            font-size: 20px;
            font-weight: 700;
        }

        .sidebar-logo svg {
            width: 40px;
            height: 40px;
        }

        .sidebar-menu {
            flex: 1;
            overflow-y: auto;
            padding: 0 10px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            border-radius: 12px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateX(-4px);
        }

        .menu-item.active {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .menu-item svg {
            width: 22px;
            height: 22px;
            flex-shrink: 0;
        }

        .menu-item span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .menu-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
            margin: 15px 0;
        }

        .menu-section-title {
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 10px 16px 8px;
            margin-top: 10px;
        }

        /* دکمه‌های پایین منو */
        .sidebar-footer {
            padding: 15px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .theme-toggle-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .theme-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .sidebar-footer a:hover {
            background: rgba(255, 255, 255, 0.25) !important;
            transform: translateY(-2px);
        }

        .sidebar-buttons button:hover {
            background: rgba(255,255,255,0.2) !important;
            transform: translateY(-2px);
        }

        /* محتوای اصلی */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 30px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        /* صفحات داشبورد */
        .page {
            display: none;
            animation: fadeInPage 0.4s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeInPage {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* کارت‌های داشبورد */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            border: 1px solid #f0f0f0;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(14, 165, 233, 0.15);
            border-color: #0ea5e9;
        }

        .stat-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .stat-card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-card-icon svg {
            width: 26px;
            height: 26px;
            color: white;
        }

        .stat-card-title {
            color: #64748b;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card-value {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .stat-card-desc {
            font-size: 13px;
            color: #94a3b8;
        }

        /* عنوان صفحه */
        .page-title-section {
            margin-bottom: 30px;
        }

        .page-title-section h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .page-title-section p {
            color: #64748b;
            font-size: 14px;
        }

        /* موبایل - منوی کناری */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            right: auto;
            z-index: 1001;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #0ea5e9, #8b5cf6);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4);
        }

        html[dir="rtl"] .mobile-menu-toggle {
            right: 20px;
            left: auto;
        }

        .mobile-menu-toggle svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-right: 0;
            }

            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }

            .sidebar-overlay.show {
                display: block;
            }
        }

        /* راست‌چین منو */
        html[dir="rtl"] .sidebar {
            right: 0;
            left: auto;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
        }

        html[dir="rtl"] .main-content {
            margin-left: 0;
            margin-right: 280px;
        }

        html[dir="rtl"] .menu-item:hover {
            transform: translateX(-4px);
        }

        @media (max-width: 1024px) {
            html[dir="rtl"] .sidebar {
                transform: translateX(-100%);
            }

            html[dir="rtl"] .sidebar.open {
                transform: translateX(0);
            }

            html[dir="rtl"] .main-content {
                margin-right: 0;
            }
        }

        /* ==================== پایان داشبورد ==================== */

        html {
            background: #ffffff !important;
        }

        /* اسکرول بار راست‌چین */
        html[dir="rtl"] ::-webkit-scrollbar {
            width: 8px;
        }

        html[dir="rtl"] ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        html[dir="rtl"] ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        html[dir="rtl"] ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* انیمیشن‌های عمومی */

        @keyframes containerAppear {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.9)
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1)
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0)
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-5px)
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(5px)
            }
        }

        @keyframes gradientShift {
            0% {
                background-position: 0 50%
            }

            50% {
                background-position: 100% 50%
            }

            100% {
                background-position: 0 50%
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg)
            }

            to {
                transform: rotate(360deg)
            }
        }

        /* بسته‌بندی کانتینر عمومی */
        .page-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1 !important;
            padding: 20px;
            overflow-y: auto;
            background: #ffffff;
        }

        /* کانتینر کارت عمومی */
        .card-container {
            background: #ffffff;
            padding: 50px 40px;
            border-radius: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            animation: containerAppear 1s ease-out .8s backwards;
            position: relative;
            overflow: hidden
        }

        .card-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #0ea5e9 0, #8b5cf6 50%, #0ea5e9 100%);
            background-size: 200% 100%;
            animation: gradientShift 3s ease infinite
        }

        /* عنوان صفحه و آیکون */
        .page-header {
            margin-bottom: 35px;
            text-align: center
        }

        .page-icon {
            width: 70px;
            height: 70px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #0ea5e9 0, #8b5cf6 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(14, 165, 233, 0.15);
            animation: fadeIn .8s ease-out 1s backwards
        }

        .page-icon svg {
            width: 36px;
            height: 36px;
            fill: white
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #0ea5e9 0, #8b5cf6 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0 0 12px;
            line-height: 1.2;
            letter-spacing: -0.5px
        }

        .page-subtitle {
            font-size: 16px;
            color: #6b7280;
            margin: 0;
            line-height: 1.5;
            font-weight: 400
        }

        /* استایل فرم */
        .page-form {
            display: flex;
            flex-direction: column;
            margin-top: 35px
        }

        .form-group {
            margin-bottom: 24px;
            text-align: left;
            position: relative
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            letter-spacing: .3px
        }

        .input-wrapper {
            position: relative
        }

        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            opacity: .4;
            pointer-events: none;
            transition: opacity .3s ease
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid #e5e7eb !important;
            border-radius: 12px;
            font-size: 16px;
            color: #1e293b !important;
            background-color: #fff !important;
            box-sizing: border-box;
            transition: all .3s ease;
            -webkit-appearance: none;
            appearance: none;
            font-family: inherit
        }

        .form-group input.with-icon {
            padding-left: 48px
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: 0 !important;
            border-color: #0ea5e9 !important;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1) !important
        }

        .form-group input:focus+.input-icon {
            opacity: .7
        }

        .form-group input:disabled,
        .form-group select:disabled {
            background-color: #f3f4f6 !important;
            color: #9ca3af !important;
            cursor: not-allowed;
            opacity: 1
        }

        .form-group input[readonly] {
            background-color: #f9fafb !important;
            color: #6b7280 !important
        }

        .form-group textarea {
            resize: vertical;
            min-height: 382px;
            font-family: 'Vazirmatn', 'Courier New', monospace
        }

        /* استایل دکمه */
        .btn {
            padding: 10px 20px;
            border: 0;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Vazirmatn', sans-serif;
            cursor: pointer;
            transition: all .3s ease;
            box-sizing: border-box;
            -webkit-appearance: none;
            appearance: none;
            letter-spacing: .5px;
            position: relative;
            overflow: hidden
        }

        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0, #8b5cf6 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4)
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left .5s ease
        }

        .btn-primary:hover::before {
            left: 100%
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5)
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.4)
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151
        }

        .btn-secondary:hover {
            background: #d1d5db
        }

        .btn-search-proxy {
            background: linear-gradient(135deg, #8b5cf6 0, #6d28d9 100%);
            color: #fff !important;
            padding: 10px 16px;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
            transition: all 0.3s ease;
        }

        .btn-search-proxy:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.5);
        }

        .btn-search-proxy:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(139, 92, 246, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none
        }

        .btn-group {
            display: flex;
            gap: 10px
        }

        /* راهنمای فوتر */
        .footer-hint {
            margin-top: 30px;
            font-size: 13px;
            color: #9ca3af;
            animation: fadeIn 1s ease-out 1.5s backwards;
            text-align: center
        }

        .footer-hint a {
            color: #0ea5e9;
            text-decoration: none;
            font-weight: 500;
            transition: color .3s ease
        }

        .footer-hint a:hover {
            color: #0ea5e9
        }

        /* استایل لینک در پاراگراف */
        p a {
            color: #2196F3;
            text-decoration: none;
            border-bottom: 1px solid rgba(33, 150, 243, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            padding: 0 2px
        }

        p a:hover {
            color: #1976D2;
            border-bottom-color: #1976D2;
            background: rgba(33, 150, 243, 0.08);
            border-radius: 2px
        }

        p a:active {
            color: #0d47a1
        }

        /* استایل لینک در پاراگراف مودال */
        .modal p a {
            color: #1E88E5;
            border-bottom-color: rgba(30, 136, 229, 0.3)
        }

        .modal p a:hover {
            color: #1565C0;
            border-bottom-color: #1565C0;
            background: rgba(30, 136, 229, 0.08)
        }

        .modal p a:active {
            color: #0D47A1
        }

        /* استایل نشان HOSTS */
        .hosts-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: #fff;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
            transition: all 0.3s ease;
        }

        .hosts-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        html.dark-mode .hosts-badge {
            background: linear-gradient(135deg, #1E88E5 0%, #1565C0 100%);
            box-shadow: 0 2px 8px rgba(30, 136, 229, 0.4);
        }

        html.dark-mode .hosts-badge:hover {
            box-shadow: 0 4px 12px rgba(30, 136, 229, 0.5);
        }

        /* استایل دکمه هشدار HOSTS */
        .btn-hosts-warning {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%) !important;
            color: #fff !important;
            border: 2px solid #b71c1c !important;
            font-weight: 700 !important;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4) !important;
            transition: all 0.3s ease !important;
        }

        .btn-hosts-warning:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 16px rgba(244, 67, 54, 0.5) !important;
            background: linear-gradient(135deg, #e53935 0%, #c62828 100%) !important;
        }

        .btn-hosts-warning:active {
            transform: translateY(0) !important;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3) !important;
        }

        html.dark-mode .btn-hosts-warning {
            background: linear-gradient(135deg, #ef5350 0%, #e53935 100%) !important;
            border-color: #c62828 !important;
            box-shadow: 0 4px 12px rgba(239, 83, 80, 0.4) !important;
        }

        html.dark-mode .btn-hosts-warning:hover {
            box-shadow: 0 6px 16px rgba(239, 83, 80, 0.5) !important;
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%) !important;
        }

        /* اعلان Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            z-index: 9000000000;
            transform: translateX(100%);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            max-width: 300px;
            word-wrap: break-word
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1
        }

        .toast-success {
            background: linear-gradient(135deg, #10b981 0, #059669 100%);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3)
        }

        .toast-error {
            background: linear-gradient(135deg, #ef4444 0, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3)
        }

        .toast-info {
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3)
        }

        /* راهنمای پیام */
        .message {
            margin-top: 24px;
            font-size: 14px;
            line-height: 1.5;
            padding: 14px 18px;
            border-radius: 12px;
            font-weight: 500;
            animation: slideIn .3s ease-out
        }

        .message-success {
            background: linear-gradient(135deg, #10b981 0, #059669 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3)
        }

        .message-error {
            background: linear-gradient(135deg, #ef4444 0, #dc2626 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            animation: shake .5s ease-in-out, slideIn .3s ease-out
        }

        /* مودال */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000000000;
            justify-content: center;
            align-items: center
        }

        .modal-overlay.show {
            display: flex
        }

        .modal {
            background: #fff;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 95%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            z-index: 2000000001;
            position: relative;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        #qrcodeModal .modal {
            background: #808080;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #9ca3af
        }

        .modal-close:hover {
            color: #1e293b
        }

        /* استایل مودال SOCKS5 */
        #getMoreProxyIPModal .modal,
        #exploreSocks5Modal .modal,
        #exploreHTTPModal .modal {
            max-width: 900px;
            width: 95%;
            padding: 0;
            overflow: hidden;
            display: flex !important;
            flex-direction: row;
        }

        .modal-map-side {
            flex: 1.2;
            min-height: 500px;
            height: auto;
            background: #f0f0f0;
            position: relative;
            z-index: 1;
        }

        .modal-content-side {
            flex: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary, #fff);
            color: var(--text-primary, #1e293b);
            min-height: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        /* تغییر چیدمان در موبایل - وقتی عرض صفحه کمتر از 768px باشد */
        @media (max-width: 768px) {

            /* تنظیم استایل کانتینر اصلی پاپ‌آپ SOCKS5 و HTTP */
            #getMoreProxyIPModal .modal,
            #exploreSocks5Modal .modal,
            #exploreHTTPModal .modal {
                /* تغییر به چیدمان عمودی */
                flex-direction: column;
                /* حداکثر ارتفاع: ارتفاع قابل مشاهده مرورگر - 100px (برای فضای نوار ابزار و دکمه) */
                max-height: calc(100vh - 100px);
                /* تنظیم ارتفاع واقعی به حداکثر ارتفاع برای استفاده کامل از فضای صفحه */
                height: calc(100vh - 100px);
            }

            /* استایل ناحیه نقشه - در قسمت بالا */
            .modal-map-side {
                /* flex: 1 یعنی اشغال تمام فضای باقی مانده */
                flex: 1;
                /* ارتفاع خودکار */
                height: auto;
                /* حداقل ارتفاع 120px، کوچک کردن نقشه برای محافظت از فضای نمایش دکمه زیر */
                min-height: 120px;
                /* محدودیت حداکثر ارتفاع برای اطمینان از فشرده نشدن دکمه‌ها و select زیر */
                max-height: calc(100vh - 280px);
                /* عرض کامل */
                width: 100%;
            }

            /* استایل ناحیه محتوا - در قسمت پایین (انتخاب منطقه و پروکسی، دکمه) */
            .modal-content-side {
                /* flex: 0 0 auto یعنی کشش ندارد، فقط ارتفاع مورد نیاز محتوا را اشغال می‌کند */
                flex: 0 0 auto;
                /* تنظیم حداقل ارتفاع برای اطمینان از نمایش کامل دکمه و select */
                min-height: 180px;
                /* حذف محدودیت حداکثر ارتفاع برای سازگاری خودکار محتوا */
                max-height: none;
                /* فاصله داخلی */
                padding: 20px;
                /* حذف حاشیه چپ (چون دیگر کنار هم نیستند) */
                border-left: none;
                /* اسکرول عمودی در صورت تجاوز محتوا */
                overflow-y: auto;
            }
        }

/* چیدمان اصلی تغییرات:
1. دکمه/select نمایش داده نمی‌شود؟ min-height را افزایش دهید (مثلاً به 200px)
2. دکمه/select نمایش داده می‌شود اما می‌خواهید فضای بیشتری به نقشه دهید؟ min-height را کاهش دهید (مثلاً به 150px)
3. نقشه خیلی کوچک است؟ min-height را افزایش دهید (مثلاً به 150px) یا مقدار max-height 280 را کاهش دهید (مثلاً به 250)
4. نقشه بزرگ است و دکمه را فشرده می‌کند؟ min-height را کاهش دهید (مثلاً به 100px) یا مقدار max-height 280 را افزایش دهید (مثلاً به 300)
*/

        html.dark-mode .modal-content-side {
            background: var(--bg-secondary, #1a1a1a);
            border-left: 1px solid var(--border-color, #333);
        }

        html.dark-mode .modal-content-side .section-title {
            color: var(--text-primary, #fff);
        }

        html.dark-mode .modal-content-side p {
            color: var(--text-secondary, #a0a0a0);
        }

        html.dark-mode .modal-content-side label {
            color: var(--text-primary, #e5e5e5);
        }

        html.dark-mode .modal-content-side select {
            background-color: var(--input-bg, #2a2a2a) !important;
            border-color: var(--input-border, #333) !important;
            color: var(--text-primary, #e5e5e5) !important;
        }

        /* رفع کامل حالت تاریک نقشه */
        html.dark-mode .proxy-map-container {
            background-color: #1a1a1a !important;
        }

        /* معکوس کردن اجباری رنگ کاشی‌ها: نقشه روشن -> نقشه تاریک، متن مشکی -> متن سفید */
        html.dark-mode .leaflet-tile-pane {
            filter: invert(100%) hue-rotate(180deg) brightness(0.85) contrast(1.1) !important;
        }

        /* رفع استایل Leaflet Popup در حالت تاریک */
        html.dark-mode .leaflet-popup-content-wrapper,
        html.dark-mode .leaflet-popup-tip {
            background: #2a2a2a !important;
            color: #fff !important;
            box-shadow: 0 3px 14px rgba(0, 0, 0, 0.4) !important;
        }

        .proxy-map-container {
            width: 100%;
            height: 100%;
        }

        /* مخفی کردن نشان Leaflet */
        .leaflet-control-attribution {
            display: none !important;
        }

        @media (max-width: 768px) {

            #getMoreProxyIPModal .modal,
            #exploreSocks5Modal .modal,
            #exploreHTTPModal .modal {
                flex-direction: column;
                max-width: 550px;
            }

            .modal-map-side {
                height: 200px;
            }

            .modal-content-side {
                max-height: none;
            }
        }

        .proxy-list-container,
        .socks5-list-container,
        .http-list-container {
            width: 100%;
        }

        /* لینک‌های اجتماعی - بازسازی شده به سبک یکسان */
        .social-links {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            padding: 20px 0;
            border-top: 1px solid rgba(0, 0, 0, 0.08)
        }

        .social-text {
            font-size: 14px;
            color: #666;
            margin-right: 10px
        }

        .social-link {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(249, 250, 251, 0.9) 100%);
            border: 1px solid rgba(229, 231, 235, 0.8);
            border-radius: 12px;
            color: #6b7280;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04)
        }

        .social-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(250, 171, 65, 0) 0%, rgba(246, 130, 31, 0) 100%);
            opacity: 0;
            transition: opacity 0.35s ease;
            border-radius: 11px
        }

        .social-link:hover {
            transform: translateY(-4px) scale(1.05);
            border-color: rgba(250, 171, 65, 0.5);
            box-shadow: 0 8px 24px rgba(250, 171, 65, 0.25), 0 4px 12px rgba(246, 130, 31, 0.15);
            color: #0ea5e9
        }

        .social-link:hover::before {
            opacity: 0.08
        }

        .social-link:active {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 12px rgba(250, 171, 65, 0.2)
        }

        .social-link svg {
            width: 22px;
            height: 22px;
            position: relative;
            z-index: 1;
            transition: transform 0.35s ease
        }

        .social-link:hover svg {
            transform: scale(1.08)
        }

        /* استایل خاص آیکون تم */
        .social-link.theme-toggle .theme-icon {
            transition: all 0.35s ease
        }

        .social-link.theme-toggle:hover .sun-icon {
            color: #0ea5e9
        }

        .social-link.theme-toggle:hover .moon-icon {
            color: #7c3aed
        }

        /* استایل آیکون GitHub */
        .social-link[title="GitHub"]:hover {
            color: #1e293b;
            border-color: rgba(31, 41, 55, 0.4);
            box-shadow: 0 8px 24px rgba(31, 41, 55, 0.2), 0 4px 12px rgba(31, 41, 55, 0.1)
        }

        .social-link[title="GitHub"]:hover::before {
            background: linear-gradient(135deg, rgba(31, 41, 55, 0.05) 0%, rgba(31, 41, 55, 0.02) 100%);
            opacity: 1
        }

        /* استایل آیکون Telegram */
        .social-link[title="Telegram"]:hover {
            border-color: rgba(42, 171, 238, 0.4);
            box-shadow: 0 8px 24px rgba(42, 171, 238, 0.25), 0 4px 12px rgba(34, 158, 217, 0.15)
        }

        .social-link[title="Telegram"]:hover::before {
            background: linear-gradient(135deg, rgba(42, 171, 238, 0.08) 0%, rgba(34, 158, 217, 0.04) 100%);
            opacity: 1
        }

        /* استایل آیکون بازگشت به بالا */
        .social-link[title="بازگشت به بالا"]:hover {
            color: #10b981;
            border-color: rgba(16, 185, 129, 0.4);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.25), 0 4px 12px rgba(5, 150, 105, 0.15)
        }

        .social-link[title="بازگشت به بالا"]:hover::before {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(5, 150, 105, 0.04) 100%);
            opacity: 1
        }

        /* استایل چک‌باکس */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            padding: 0;
            border: 2px solid #e5e7eb;
            border-radius: 4px;
            -webkit-appearance: none;
            appearance: none;
            position: relative;
            transition: all 0.3s ease;
            background-color: #fff
        }

        .checkbox-group input[type="checkbox"]:hover {
            border-color: #0ea5e9
        }

        .checkbox-group input[type="checkbox"]:checked {
            background: linear-gradient(135deg, #0ea5e9 0, #8b5cf6 100%);
            border-color: #0ea5e9
        }

        .checkbox-group input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 2px;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg)
        }

        .checkbox-group input[type="checkbox"]:disabled {
            background-color: #f3f4f6;
            border-color: #d1d5db;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .checkbox-group input[type="checkbox"]:disabled:hover {
            border-color: #d1d5db;
        }

        .checkbox-label {
            font-size: 14px;
            color: #374151;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
        }

        .checkbox-row {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .checkbox-row .form-group {
            margin-bottom: 0;
            display: flex !important;
            grid-template-columns: unset !important;
            gap: unset !important;
        }

        .checkbox-row .form-group[style*="display: none"] {
            display: none !important;
        }

        /* طراحی واکنش‌گرا - تبلت */
        @media(max-width:768px) {
            .checkbox-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .page-wrapper {
                padding: 20px 16px;
                padding-top: 20px;
                padding-bottom: 20px;
                justify-content: flex-start;
                align-items: center
            }

            .card-container {
                padding: 40px 28px;
                border-radius: 20px;
                max-width: 100%;
                margin-top: auto;
                margin-bottom: auto
            }

            .page-icon {
                width: 60px;
                height: 60px;
                border-radius: 16px;
                margin-bottom: 16px
            }

            .page-icon svg {
                width: 30px;
                height: 30px
            }

            .page-title {
                font-size: 26px;
                margin-bottom: 10px
            }

            .page-subtitle {
                font-size: 15px
            }

            .page-form {
                margin-top: 28px
            }

            .form-group {
                margin-bottom: 20px
            }

            .form-group label {
                font-size: 13px;
                margin-bottom: 8px
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 14px;
                font-size: 16px;
                border-radius: 10px
            }

            .form-group input.with-icon {
                padding-left: 44px
            }

            .input-icon {
                left: 14px;
                width: 18px;
                height: 18px
            }

            .btn {
                padding: 15px 20px;
                font-size: 15px;
                border-radius: 10px
            }

            .message {
                margin-top: 20px;
                font-size: 13px;
                padding: 12px 16px;
                border-radius: 10px
            }

            .footer-hint {
                margin-top: 24px;
                font-size: 12px
            }
        }

        /* طراحی واکنش‌گرا - موبایل */
        @media(max-width:480px) {
            .page-wrapper {
                padding: 12px;
                justify-content: flex-start;
                align-items: center
            }

            .card-container {
                padding: 35px 24px;
                border-radius: 18px;
                margin-top: auto;
                margin-bottom: auto
            }

            .page-icon {
                width: 55px;
                height: 55px;
                border-radius: 14px
            }

            .page-icon svg {
                width: 28px;
                height: 28px
            }

            .page-title {
                font-size: 24px
            }

            .page-subtitle {
                font-size: 14px
            }
        }

        /* طراحی واکنش‌گرا - افقی */
        @media(max-height:600px) and (orientation:landscape) {
            .page-wrapper {
                padding: 20px;
                justify-content: flex-start;
                align-items: center
            }

            .card-container {
                padding: 30px 35px;
                margin-top: auto;
                margin-bottom: auto
            }

            .page-icon {
                width: 50px;
                height: 50px;
                margin-bottom: 12px
            }

            .page-icon svg {
                width: 26px;
                height: 26px
            }

            .page-title {
                font-size: 22px;
                margin-bottom: 8px
            }

            .page-subtitle {
                font-size: 13px
            }

            .page-form {
                margin-top: 20px
            }

            .form-group {
                margin-bottom: 16px
            }

            .footer-hint {
                margin-top: 16px
            }
        }

        /* حالت تاریک */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: rgba(255, 255, 255, 0.95);
            --text-primary: #1e293b;
            --text-secondary: #666;
            --border-color: #e5e7eb;
            --border-light: rgba(255, 255, 255, 0.1);
            --input-bg: #f3f4f6;
            --input-border: #e5e7eb;
            --overlay-bg: rgba(255, 255, 255, 0.7);
            --blur-overlay: rgba(0, 0, 0, 0.3);
            --latency-49: #4CAF50;
            --latency-149: #83DA00;
            --latency-299: #f58722;
            --latency-999: #ff404a;
            --latency-1000: #c40003;
        }

        html.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #0f0d0a;
            --text-primary: #e5e5e5;
            --text-secondary: #a0a0a0;
            --border-color: #333333;
            --border-light: rgba(255, 255, 255, 0.1);
            --input-bg: #2a2a2a;
            --input-border: #444444;
            --overlay-bg: rgba(32, 32, 32, 0.7);
            --blur-overlay: rgba(0, 0, 0, 0.8)
        }

        html.dark-mode body {
            background: #1a1a1a !important;
            color: var(--text-primary)
        }

        html.dark-mode #blur-overlay {
            background: var(--blur-overlay)
        }

        html.dark-mode .card-container {
            color: var(--text-primary)
        }

        html.dark-mode .page-wrapper {
            background: #1a1a1a;
        }

        html.dark-mode .header {
            background: #1a1a1a;
            border-image: linear-gradient(90deg, #0ea5e9 0, #8b5cf6 50%, #0ea5e9 100%) 1
        }

        html.dark-mode .module {
            background: #1a1a1a;
            color: var(--text-primary)
        }

        html.dark-mode .module-title {
            color: var(--text-primary)
        }

        html.dark-mode .form-group input:not([type="checkbox"]),
        html.dark-mode .form-group select,
        html.dark-mode .form-group textarea {
            background: var(--input-bg) !important;
            color: var(--text-primary) !important;
            border-color: var(--input-border) !important
        }

        html.dark-mode .form-group input:not([type="checkbox"])::placeholder,
        html.dark-mode .form-group textarea::placeholder {
            color: var(--text-secondary) !important
        }

        html.dark-mode .form-group input:not([type="checkbox"]):focus,
        html.dark-mode .form-group select:focus,
        html.dark-mode .form-group textarea:focus {
            border-color: #7c3aed !important;
            box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1) !important
        }

        html.dark-mode .form-group input:not([type="checkbox"]):disabled,
        html.dark-mode .form-group select:disabled {
            background-color: var(--input-bg) !important;
            color: var(--text-secondary) !important
        }

        html.dark-mode .form-group input:not([type="checkbox"])[readonly] {
            background-color: var(--input-bg) !important;
            color: var(--text-secondary) !important
        }

        html.dark-mode .module .form-group input,
        html.dark-mode .module .form-group select,
        html.dark-mode .module .form-group textarea {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--input-border)
        }

        html.dark-mode .module .form-group input::placeholder,
        html.dark-mode .module .form-group textarea::placeholder {
            color: var(--text-secondary)
        }

        html.dark-mode .modal-overlay {
            background: var(--blur-overlay)
        }

        html.dark-mode .modal {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-color)
        }

        html.dark-mode #qrcodeModal .modal {
            background: #808080;
        }

        html.dark-mode .modal input,
        html.dark-mode .modal select,
        html.dark-mode .modal textarea {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--input-border)
        }

        html.dark-mode .form-group label {
            color: var(--text-primary) !important
        }

        html.dark-mode .card-container {
            color: var(--text-primary);
        }

        html.dark-mode .modal-close {
            color: var(--text-primary)
        }

        html.dark-mode .page-header {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-image: linear-gradient(90deg, #0ea5e9 0, #8b5cf6 50%, #0ea5e9 100%) 1 !important
        }

        html.dark-mode .page-title {
            color: var(--text-primary) !important
        }

        html.dark-mode .page-subtitle {
            color: var(--text-secondary) !important
        }

        html.dark-mode table {
            color: var(--text-primary)
        }

        html.dark-mode thead {
            background: #2a2a2a !important
        }

        html.dark-mode thead th {
            background: #2a2a2a !important;
            color: var(--text-primary) !important;
            border-color: #333333 !important
        }

        html.dark-mode tbody tr {
            border-color: #333333
        }

        html.dark-mode tbody td {
            color: var(--text-primary)
        }

        html.dark-mode .social-links {
            border-top-color: rgba(255, 255, 255, 0.1)
        }

        html.dark-mode .social-link {
            background: linear-gradient(135deg, rgba(42, 42, 42, 0.95) 0%, rgba(34, 34, 34, 0.9) 100%);
            border-color: rgba(75, 75, 75, 0.6);
            color: #e5e7eb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), 0 1px 2px rgba(0, 0, 0, 0.15)
        }

        html.dark-mode .social-link:hover {
            color: #ffffff;
            border-color: rgba(124, 58, 237, 0.6);
            box-shadow: 0 8px 24px rgba(124, 58, 237, 0.3), 0 4px 12px rgba(91, 33, 182, 0.2)
        }

        html.dark-mode .social-link::before {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.08) 0%, rgba(91, 33, 182, 0.04) 100%)
        }

        html.dark-mode .social-link.theme-toggle:hover .moon-icon {
            color: #a78bfa
        }

        html.dark-mode .social-link[title="GitHub"]:hover {
            color: #ffffff;
            border-color: rgba(229, 231, 235, 0.4);
            box-shadow: 0 8px 24px rgba(229, 231, 235, 0.15), 0 4px 12px rgba(229, 231, 235, 0.1)
        }

        html.dark-mode .social-link[title="Telegram"]:hover {
            border-color: rgba(42, 171, 238, 0.5);
            box-shadow: 0 8px 24px rgba(42, 171, 238, 0.3), 0 4px 12px rgba(34, 158, 217, 0.2)
        }

        html.dark-mode .social-link[title="بازگشت به بالا"]:hover {
            color: #34d399;
            border-color: rgba(52, 211, 153, 0.5);
            box-shadow: 0 8px 24px rgba(52, 211, 153, 0.3), 0 4px 12px rgba(16, 185, 129, 0.2)
        }

        html.dark-mode .btn-secondary {
            background: var(--input-bg) !important;
            color: var(--text-primary) !important;
            border-color: var(--input-border) !important
        }

        html.dark-mode .btn-qrcode {
            background: linear-gradient(135deg, #0891b2 0, #065f73 100%) !important;
            color: #fff !important;
            box-shadow: 0 4px 15px rgba(8, 145, 178, 0.3) !important;
        }

        html.dark-mode .btn-mode-toggle {
            background: #f3f4f6;
            color: #1e293b;
            box-shadow: 0 4px 15px rgba(243, 244, 246, 0.3);
        }

        html.dark-mode .btn-mode-toggle:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(243, 244, 246, 0.4);
        }

        html.dark-mode .btn-mode-toggle:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(243, 244, 246, 0.3);
        }

        html.dark-mode .checkbox-group input[type="checkbox"] {
            border-color: var(--border-color);
            background: var(--input-bg)
        }

        html.dark-mode .checkbox-group input[type="checkbox"]:checked {
            background: linear-gradient(135deg, #7c3aed 0, #5b21b6 100%);
            border-color: #7c3aed
        }

        html.dark-mode .loading {
            border-color: rgba(14, 165, 233, 0.3);
            border-top-color: #0ea5e9
        }

        html.dark-mode .message {
            animation: slideIn .3s ease-out
        }

        html.dark-mode .success-message {
            background: linear-gradient(135deg, #059669 0, #047857 100%)
        }

        html.dark-mode .error-message {
            background: linear-gradient(135deg, #dc2626 0, #b91c1c 100%)
        }

        html.dark-mode .collapse-btn {
            color: #7c3aed
        }

        html.dark-mode .collapse-btn:hover {
            color: #9f7aea
        }

        html.dark-mode .collapse-section {
            border-left-color: #7c3aed;
            color: var(--text-primary)
        }

        html.dark-mode .module-footer {
            border-color: rgba(255, 255, 255, 0.1)
        }

        html.dark-mode .readonly-wrapper input[readonly] {
            background-color: var(--input-bg) !important;
            border-color: var(--input-border) !important;
            color: var(--text-primary) !important;
        }

        html.dark-mode .readonly-wrapper input[readonly]:hover {
            border-color: #7c3aed;
            background-color: var(--input-bg);
        }

        html.dark-mode .subapi-input {
            background-color: var(--input-bg) !important;
            color: var(--text-primary) !important;
        }

        html.dark-mode .form-group input[readonly].subapi-input {
            background-color: var(--input-bg) !important;
            color: var(--text-primary) !important;
        }

        html.dark-mode .input-icon {
            opacity: 0.6
        }

        html.dark-mode .module-title {
            color: var(--text-primary) !important
        }

        html.dark-mode .module-title .collapse-icon {
            fill: var(--text-secondary)
        }

        html.dark-mode .footer-hint {
            color: var(--text-secondary) !important
        }

        html.dark-mode .footer-hint a {
            color: #7c3aed !important
        }

        html.dark-mode .footer-hint a:hover {
            color: #9f7aea !important
        }

        /* استایل لینک در پاراگراف حالت تاریک */
        html.dark-mode p a {
            color: #64B5F6;
            border-bottom-color: rgba(100, 181, 246, 0.4)
        }

        html.dark-mode p a:hover {
            color: #90CAF9;
            border-bottom-color: #90CAF9;
            background: rgba(100, 181, 246, 0.12)
        }

        html.dark-mode p a:active {
            color: #42A5F5
        }

        /* استایل لینک در پاراگراف مودال حالت تاریک */
        html.dark-mode .modal p a {
            color: #64B5F6;
            border-bottom-color: rgba(100, 181, 246, 0.4)
        }

        html.dark-mode .modal p a:hover {
            color: #90CAF9;
            border-bottom-color: #90CAF9;
            background: rgba(100, 181, 246, 0.12)
        }

        html.dark-mode .modal p a:active {
            color: #42A5F5
        }

        .theme-icon {
            transition: transform 0.3s ease
        }

        .social-link.theme-toggle:hover .theme-icon {
            transform: rotate(20deg)
        }

        .social-link.theme-toggle {
            font-size: 0;
            line-height: 0
        }

        .theme-icon {
            width: 20px;
            height: 20px;
            display: block !important;
            transition: all 0.3s ease
        }

        .sun-icon {
            display: none !important;
            opacity: 0
        }

        .moon-icon {
            display: block !important;
            opacity: 1
        }

        html.dark-mode .sun-icon {
            display: block !important;
            opacity: 1
        }

        html.dark-mode .moon-icon {
            display: none !important;
            opacity: 0
        }

        .page-wrapper {
            justify-content: flex-start;
            align-items: flex-start
        }

        .card-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0;
            background: transparent !important;
            box-shadow: none !important
        }

        .card-container::before {
            display: none
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: #ffffff;
            padding: 25px 30px;
            border-radius: 16px;
            border-top: 4px solid;
            border-image: linear-gradient(90deg, #0ea5e9 0, #8b5cf6 50%, #0ea5e9 100%) 1
        }

        .header-title h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #0ea5e9 0, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0
        }

        .header-buttons {
            display: flex;
            gap: 12px
        }

        .header .btn {
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 8px
        }

        .module {
            background: #ffffff;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: box-shadow 280ms cubic-bezier(.2, .9, .2, 1), transform 220ms ease;
            will-change: transform
        }

        .module:hover,
        .module:focus-within {
            box-shadow: 0 8px 16px -2px rgba(0, 0, 0, 0.1), 0 0 12px rgba(14, 165, 233, 0.1);
            transform: translateY(-4px)
        }

        .module-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #1e293b;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            gap: 10px;
        }

        .module-title .collapse-icon {
            width: 24px;
            height: 24px;
            transition: transform 0.28s;
            fill: #666;
            flex-shrink: 0;
        }

        .module.collapsed .collapse-icon {
            transform: rotate(90deg)
        }

        /* آیکون فشرده ماژول اطلاعات شبکه */
        #network-module-content~.module-title .collapse-icon,
        .module-title .collapse-icon {
            transition: transform 0.3s ease;
        }

        .module-content {
            display: block;
            /* overflow: hidden; */
            max-height: 2000px;
            opacity: 1;
            transition: max-height 320ms cubic-bezier(.2, .8, .2, 1), opacity 220ms ease
        }

        .module.collapsed .module-content {
            max-height: 0;
            opacity: 0
        }

        .module .form-group,
        #portSection {
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 20px;
            align-items: center;
            text-align: left
        }

        .module .form-group label {
            display: block
        }

        .module .form-group input,
        .module .form-group select,
        .module .form-group textarea {
            padding: 8px 8px;
            border-radius: 8px
        }

        .module .input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .module .input-wrapper input {
            flex: 1
        }

        .readonly-wrapper {
            position: relative;
        }

        .proxy-input-wrapper {
            flex: 1;
        }

        .readonly-wrapper input[readonly] {
            cursor: pointer;
            background-color: #fff !important;
            border: 2px solid #e5e7eb !important;
            color: #1e293b !important;
            width: 100%;
        }

        .readonly-wrapper input[readonly]:hover {
            border-color: #0ea5e9;
            background-color: #fff;
        }

        .readonly-wrapper input[readonly]:focus {
            outline: 0 !important;
            border-color: #0ea5e9 !important;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1) !important;
        }

        .copy-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer
        }

        .module-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb
        }

        .module-footer .btn-group {
            margin-left: auto;
        }

        .collapse-section {
            margin-top: 15px;
            border-left: 3px solid #0ea5e9;
            padding-left: 20px
        }

        .collapse-btn {
            background: none;
            border: none;
            color: #0ea5e9;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease
        }

        .collapse-btn:hover {
            color: #0ea5e9
        }

        .success-message,
        .error-message {
            display: none;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 500;
            animation: slideIn 0.3s ease
        }

        .success-message {
            background: linear-gradient(135deg, #10b981 0, #059669 100%);
            color: #fff
        }

        .error-message {
            background: linear-gradient(135deg, #ef4444 0, #dc2626 100%);
            color: #fff
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #0ea5e9;
            border-top-color: transparent;
            border-radius: 50%;
            animation: rotate 0.6s linear infinite
        }

        @media(max-width:768px) {
            .optimize-params-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .card-container {
                padding: 20px;
                margin: 0
            }

            .header {
                flex-direction: column;
                gap: 15px;
                padding: 20px;
                margin-bottom: 20px
            }

            .module {
                padding: 20px;
                margin-bottom: 20px
            }

            .module .form-group,
            #portSection {
                grid-template-columns: 1fr;
                gap: 10px
            }

            .header-buttons {
                width: 100%;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px
            }

            .btn-mode-toggle {
                grid-column: 1 / -1;
            }

            .header-buttons .btn {
                width: 100%;
            }
        }

        @media(max-width:768px) {
            .module-footer {
                flex-wrap: wrap;
                align-items: flex-start;
                gap: 10px;
            }

            .module-footer .btn-online-optimize:not(.hidden-section),
            .module-footer .btn-api-optimize:not(.hidden-section) {
                flex: 1;
                min-width: calc(50% - 5px);
            }

            .module-footer .btn-group {
                width: 100%;
                display: flex;
                gap: 10px;
            }

            .module-footer .btn-group .btn {
                flex: 1;
            }

            .module-footer .btn-ech-help,
            .module-footer .btn-proxyip-help,
            .module-footer .btn-search-proxy {
                width: 100%;
                margin-bottom: 10px;
            }

            .ech-tabs::-webkit-scrollbar {
                height: 3px;
            }

            .ech-tab {
                padding: 7px 12px;
                font-size: 12px;
            }

            .ech-tab-content {
                min-height: 80px;
                max-height: calc(100vh - 220px);
            }

            /* 📋 بهینه‌سازی موبایل ماژول دریافت لینک گره */
            /* استفاده از کلاس جدید subscription-link-wrapper برای کنترل دقیق چیدمان موبایل لینک اشتراک */
            
            .subscription-link-wrapper {
                display: flex !important;
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 12px !important;
            }

            .subscription-link-wrapper input {
                width: 100% !important;
                flex: none !important;
                margin: 0 !important;
            }

            /* ایجاد div کانتینر دکمه */
            .subscription-link-wrapper .btn-container {
                display: flex !important;
                gap: 10px !important;
                width: 100% !important;
            }

            .subscription-link-wrapper .btn {
                flex: 1 !important;
                margin: 0 !important;
                display: block !important;
            }
        }

        @media(max-width:480px) {
            .card-container {
                padding: 15px
            }

            .ech-tabs::-webkit-scrollbar {
                height: 2px;
            }

            .ech-tab {
                padding: 6px 10px;
                font-size: 11px;
            }

            .ech-tab-content {
                min-height: 60px;
                max-height: calc(100vh - 240px);
            }
        }

        @media(max-height:600px) and (orientation:landscape) {
            .card-container {
                padding: 15px
            }
        }

        /* استایل دکمه سفارشی */
        .btn-mode-toggle {
            background: #1e293b;
            color: #fff;
            box-shadow: 0 4px 15px rgba(31, 41, 55, 0.4);
            transition: all 0.3s ease;
        }

        .btn-mode-toggle:hover {
            background: #111827;
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(31, 41, 55, 0.5);
        }

        .btn-mode-toggle:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(31, 41, 55, 0.4);
        }

        .btn-reset {
            background: linear-gradient(135deg, #ef4444 0, #dc2626 100%);
            color: #fff;
        }

        .btn-all-logs {
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            flex-shrink: 0;
        }

        .btn-online-optimize {
            background: linear-gradient(135deg, #10b981 0, #059669 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-online-optimize:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.5);
        }

        .btn-online-optimize:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(16, 185, 129, 0.4);
        }

        .btn-close-modal {
            width: 100%;
            margin-top: 20px;
        }

        .btn-confirm-reset {
            background: linear-gradient(135deg, #ef4444 0, #dc2626 100%);
            color: #fff;
        }

        .btn-test-api {
            flex: 2;
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            color: #fff;
        }

        .btn-confirm-api {
            flex: 1;
            opacity: 0.5;
        }

        .btn-confirm-api:not([disabled]) {
            opacity: 1;
        }

        .btn-cancel-api {
            flex: 1;
        }

        .btn-qrcode {
            background: linear-gradient(135deg, #06b6d4 0, #0891b2 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
        }

        .btn-qrcode:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(6, 182, 212, 0.5);
        }

        .btn-qrcode:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(6, 182, 212, 0.4);
        }

        .btn-api-optimize {
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-api-optimize:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
        }

        .btn-api-optimize:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.4);
        }

        /* استایل مودال بهینه‌سازی API */
        .api-optimize-modal {
            overflow-y: auto;
            width: 90vw;
            max-width: 600px;
            margin: 0 auto;
            max-height: 90vh;
        }

        .api-optimize-modal-title {
            margin-bottom: 20px;
        }

        .api-form-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .api-form-row {
            display: grid;
            grid-template-columns: 80px 1fr;
            gap: 10px;
            align-items: center;
        }

        .api-form-row label {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .api-form-row input {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            font-size: 14px;
        }

        .api-results-container {
            margin: 20px 0;
        }

        .api-results-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            text-align: left;
        }

        .api-results-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: 'Vazirmatn', 'Courier New', monospace;
            font-size: 12px;
            height: 200px;
            background-color: #f9fafb;
            color: #1e293b;
            resize: vertical;
            overflow-y: auto;
        }

        .api-buttons {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .api-buttons {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 10px;
                margin-top: 20px;
            }

            .btn-verify-api {
                grid-column: 1 / -1 !important;
                grid-row: 1 !important;
            }

            .btn-append-api {
                grid-column: 1 !important;
                grid-row: 2 !important;
            }

            .btn-close-api {
                grid-column: 2 !important;
                grid-row: 2 !important;
            }

            .btn-append-results {
                display: none !important;
            }
        }

        .btn-verify-api {
            background: linear-gradient(135deg, #10b981 0, #059669 100%);
            color: #fff;
            flex: 1;
        }

        .btn-verify-api:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.5);
        }

        .btn-append-api {
            background: linear-gradient(135deg, #f59e0b 0, #d97706 100%);
            color: #fff;
            opacity: 0.5;
            pointer-events: none;
        }

        .btn-append-api:not([disabled]) {
            opacity: 1;
            pointer-events: all;
        }

        .btn-append-api:hover:not([disabled]) {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(245, 158, 11, 0.5);
        }

        .btn-append-results {
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            color: #fff;
            opacity: 0.5;
            pointer-events: none;
        }

        .btn-append-results:not([disabled]) {
            opacity: 1;
            pointer-events: all;
        }

        .btn-append-results:hover:not([disabled]) {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
        }

        .btn-close-api {
            background: linear-gradient(135deg, #e5e7eb 0, #d1d5db 100%);
            color: #374151;
        }

        .btn-close-api:hover {
            background: linear-gradient(135deg, #d1d5db 0, #b3b8be 100%);
        }

        .btn-proxyip-help {
            background: linear-gradient(135deg, #10b981 0, #059669 100%);
            color: #fff !important;
            padding: 10px 16px;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
        }

        .btn-proxyip-help:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.5);
        }

        .btn-proxyip-help:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(16, 185, 129, 0.4);
        }

        .btn-path-template-config {
            background: linear-gradient(135deg, #8b5cf6 0, #6d28d9 100%);
            color: #fff !important;
            padding: 10px 16px;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
            transition: all 0.3s ease;
        }

        .btn-path-template-config:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.5);
        }

        .btn-path-template-config:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(139, 92, 246, 0.4);
        }

        .btn-fofa {
            background: linear-gradient(135deg, #439aff 0, #05f2f2 100%);
            color: #fff !important;
            box-shadow: 0 4px 15px rgb(67, 154, 255, 0.3);
            transition: all 0.3s ease;
        }

        .btn-fofa:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(5, 244, 244, 0.5);
        }

        .btn-fofa:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(5, 244, 244, 0.4);
        }

        .btn-360quake {
            background: linear-gradient(135deg, #00AB7A 0, #00AB7A 100%);
            color: #fff !important;
            box-shadow: 0 4px 15px rgba(0, 171, 122, 0.3);
            transition: all 0.3s ease;
        }

        .btn-360quake:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 171, 122, 0.5);
        }

        .btn-360quake:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 171, 122, 0.4);
        }

        .btn-ech-help {
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            color: #fff !important;
            padding: 10px 16px;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }

        .btn-ech-help:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
        }

        .btn-ech-help:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.4);
        }

        .proxyip-help-modal {
            max-width: 1200px;
            width: 90vw;
            max-height: 100vh;
            overflow-y: auto;
        }

        .ech-help-modal {
            max-width: 1200px;
            width: 90vw;
            max-height: 100vh;
            overflow-y: auto;
        }

        .path-template-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .path-template-hint {
            font-size: 12px;
            color: #666;
            margin-bottom: 16px;
            padding: 8px 12px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }

        .path-template-hint code {
            background-color: #d1d5db;
            padding: 2px 4px;
            border-radius: 2px;
            font-family: 'Fira Code', monospace;
            color: #1e293b;
            font-weight: 500;
        }

        .path-template-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        /* سازگاری موبایل مودال قالب مسیر */
        @media (max-width: 640px) {
            #pathTemplateConfigModal .modal {
                padding-bottom: calc(60px + env(safe-area-inset-bottom, 20px)) !important;
                max-height: calc(100dvh - 20px) !important;
                overflow-y: auto !important;
                display: flex !important;
                flex-direction: column;
            }

            .path-template-buttons {
                margin-top: auto;
                padding-top: 20px;
            }
        }

        .path-template-input-wrapper {
            display: flex;
            align-items: center;
            position: relative;
            border-radius: 6px;
        }

        .path-template-input-wrapper input {
            flex: 1;
        }

        .path-template-input-wrapper.invalid input {
            background-color: #fca5a5 !important;
            color: #7f1d1d;
        }

        html.dark-mode .path-template-input-wrapper.invalid input {
            background-color: #dc2626 !important;
            color: #fecaca;
        }

        html.dark-mode .path-template-hint {
            background-color: #1e293b;
            color: #e2e8f0;
        }

        html.dark-mode .path-template-hint code {
            background-color: #475569;
            color: #f1f5f9;
            font-weight: 500;
        }

        html.dark-mode .path-template-modal-title {
            color: var(--text-primary);
        }

        .api-docs {
            text-align: left;
        }

        .api-docs h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            margin-top: 0;
        }

        .api-docs h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 20px 0 12px;
        }

        .api-docs p {
            font-size: 14px;
            line-height: 1.8;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .api-docs a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .api-docs a:hover {
            text-decoration: underline;
        }

        .code-block {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
            padding: 12px;
            border-radius: 4px;
            margin: 12px 0;
            font-size: 13px;
            line-height: 1.6;
            font-family: 'Vazirmatn', 'Courier New', monospace;
            overflow-x: auto;
        }

        .simple-explanation {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
            padding: 16px;
            border-radius: 4px;
            margin: 16px 0;
            font-size: 14px;
            line-height: 1.8;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .toggle-switch input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .toggle-switch label {
            cursor: pointer;
            margin: 0;
            font-weight: 600;
            -webkit-user-select: none;
            user-select: none;
        }

        html.dark-mode .code-block {
            background: #2a2a2a;
            color: #ffd699;
            border-left-color: #ffc107;
        }

        html.dark-mode .simple-explanation {
            background: #1b4620;
            color: #81c784;
            border-left-color: #4caf50;
        }

        html.dark-mode .btn-proxyip-help {
            background: linear-gradient(135deg, #10b981 0, #059669 100%);
            color: #fff !important;
        }

        html.dark-mode .btn-proxyip-help:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.5);
        }

        html.dark-mode .btn-path-template-config {
            background: linear-gradient(135deg, #8b5cf6 0, #6d28d9 100%);
            color: #fff !important;
        }

        html.dark-mode .btn-path-template-config:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.5);
        }

        html.dark-mode .btn-ech-help {
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            color: #fff !important;
        }

        html.dark-mode .btn-ech-help:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
        }

        html.dark-mode .api-optimize-modal {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        html.dark-mode .ech-help-modal {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        html.dark-mode .api-form-row label {
            color: var(--text-primary);
        }

        html.dark-mode .api-form-row input {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--input-border);
        }

        html.dark-mode .api-results-label {
            color: var(--text-primary);
        }

        html.dark-mode .api-results-textarea {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--input-border);
        }

        html.dark-mode .btn-api-optimize {
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            color: #fff;
        }

        html.dark-mode .btn-verify-api {
            background: linear-gradient(135deg, #10b981 0, #059669 100%);
            color: #fff;
        }

        html.dark-mode .btn-append-api {
            background: linear-gradient(135deg, #f59e0b 0, #d97706 100%);
            color: #fff;
        }

        html.dark-mode .btn-append-results {
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            color: #fff;
        }

        html.dark-mode .btn-close-api {
            background: var(--input-bg);
            color: var(--text-primary);
        }

        html.dark-mode .btn-close-api:hover {
            background: var(--border-color);
        }

        /* مخفی کردن عناصر */
        .hidden-section {
            display: none;
        }

        /* حالت ساده - مخفی کردن ماژول پیشرفته */
        .advanced-module {
            transition: opacity 0.4s ease-in-out, max-height 0.5s ease-in-out, transform 0.4s ease-in-out, margin 0.5s ease-in-out, padding 0.5s ease-in-out, border-width 0.5s ease-in-out;
            transform-origin: top;
            overflow: hidden;
            transform: scaleY(1);
            opacity: 1;
        }

        /* حالت پیشرفته همیشه نمایش داده می‌شود */

        /* استایل بخش پیکربندی Cloudflare */
        #cloudflareEmailSection,
        #cloudflareAccountIDSection {
            display: none;
        }

        /* کانتینر QRCode */
        .qrcode-container {
            margin: 30px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 350px;
            background: #808080;
        }

        /* مودال تنظیم مجدد */
        .reset-modal-title {
            color: #ef4444;
            margin-bottom: 15px;
        }

        .reset-modal-description {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .reset-modal-confirm {
            color: #ef4444;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .reset-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: space-between;
        }

        /* مودال هشدار رد کردن تأیید گواهی */
        .skipverify-warning-modal {
            min-width: 400px;
        }

        .skipverify-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .skipverify-icon {
            font-size: 28px;
            line-height: 1;
        }

        .skipverify-title {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #ef4444;
        }

        .skipverify-content {
            margin-bottom: 24px;
        }

        .skipverify-text {
            margin: 0 0 12px 0;
            line-height: 1.6;
            font-size: 14px;
            color: var(--text-primary);
        }

        .skipverify-text:last-child {
            margin-bottom: 0;
        }

        .skipverify-link {
            color: #1976d2;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .skipverify-link:hover {
            color: #1565c0;
            text-decoration: underline;
        }

        .skipverify-buttons {
            display: flex;
            gap: 12px;
            justify-content: space-between;
        }

        .btn-confirm-skip-verify {
            flex: 1;
        }

        /* حالت تاریک - مودال هشدار رد کردن تأیید گواهی */
        html.dark-mode .skipverify-title {
            color: #ff6b6b;
        }

        html.dark-mode .skipverify-link {
            color: #64b5f6;
        }

        html.dark-mode .skipverify-link:hover {
            color: #42a5f5;
        }

        /* کانتینر لاگ‌ها */
        .logs-container {
            margin-bottom: 20px;
        }

        .logs-loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }

        .logs-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
        }

        .logs-footer-text {
            font-size: 12px;
            color: #9ca3af;
            margin: 0;
        }

        /* مودال لاگ‌ها */
        .logs-modal {
            overflow-y: auto;
            width: 90vw;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logs-modal-title {
            margin-bottom: 20px;
        }

        .logs-all-container {
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: auto;
        }

        /* مودال API اشتراک */
        .subapi-modal-title {
            margin-bottom: 20px;
        }

        .subapi-form-group {
            grid-template-columns: 1fr;
        }

        .subapi-status {
            margin: 15px 0;
            padding: 12px 16px;
            border-radius: 8px;
            display: none;
        }

        .subapi-buttons {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .subapi-buttons {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 10px;
                margin-top: 20px;
            }

            .btn-test-api {
                grid-column: 1 / -1 !important;
                grid-row: 1 !important;
            }

            .btn-confirm-api {
                grid-column: 1 !important;
                grid-row: 2 !important;
            }

            .btn-cancel-api {
                grid-column: 2 !important;
                grid-row: 2 !important;
            }
        }

        /* استایل خاص فیلد ورودی */
        .subapi-input {
            cursor: pointer !important;
            background-color: #fff !important;
            color: #1e293b !important;
        }

        #subAPISelect {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background-color: #fff;
            color: #1e293b;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #subAPISelect:hover {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        #subAPISelect:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        html.dark-mode #subAPISelect {
            background-color: #1e293b;
            color: #f3f4f6;
            border-color: #4b5563;
        }

        html.dark-mode #subAPISelect:hover {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }

        html.dark-mode #subAPISelect:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
        }

        /* بسته‌بندی ورودی لینک گره */
        .link-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .link-input-field {
            flex: 1;
        }

        /* استایل مودال بهینه‌سازی آنلاین */
        .optimize-modal {
            overflow-y: auto;
            width: 90vw;
            max-width: 960px;
            margin: 0 auto;
            max-height: 90vh;
        }

        .optimize-modal-title {
            margin-bottom: 20px;
        }

        .ip-detection-box {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(6, 182, 212, 0.05) 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 20px;
        }

        .optimize-params-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            align-items: flex-end;
        }

        .optimize-concurrency-input {
            width: 100%;
            max-width: none;
        }

        @media (max-width: 768px) {
            .optimize-params-row {
                display: block;
            }

            .optimize-params-row .form-group {
                margin-bottom: 15px;
            }
        }

        .ip-detection-info {
            font-size: 14px;
            color: #374151;
            line-height: 1.6;
        }

        .ip-detection-warning {
            color: #ef4444;
            font-size: 12px;
            margin-top: 8px;
            line-height: 1.5;
        }

        .optimize-progress-bar {
            width: 100%;
            height: 30px;
            background: #4b5563;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            margin: 20px 0;
        }

        .optimize-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: width 0.3s ease, background 0.3s ease;
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 15px;
        }

        .optimize-progress-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 13px;
            font-weight: 700;
            z-index: 1;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .optimize-results-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .optimize-tab {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .optimize-tab:hover {
            border-color: #10b981;
        }

        .optimize-tab.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #10b981;
        }

        .optimize-results-content {
            background: #f9fafb;
            border-radius: 8px;
            padding: 15px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Vazirmatn', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.1;
            text-align: left;
        }

        .ech-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 15px;
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 8px;
            scroll-behavior: smooth;
            cursor: grab;
            -webkit-user-select: none;
            user-select: none;
        }

        .ech-tabs.dragging {
            cursor: grabbing;
        }

        .ech-tabs::-webkit-scrollbar {
            height: 4px;
        }

        .ech-tabs::-webkit-scrollbar-track {
            background: transparent;
        }

        .ech-tabs::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 2px;
        }

        .ech-tabs::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .ech-tab {
            padding: 8px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
            pointer-events: auto;
        }

        .ech-tab:hover {
            border-color: #3b82f6;
        }

        .ech-tab.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border-color: #3b82f6;
        }

        .ech-tab-content {
            background: #f9fafb;
            border-radius: 8px;
            padding: 15px;
            min-height: 100px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .ech-tab-pane {
            display: none;
        }

        .ech-tab-pane.active {
            display: block;
        }

        .optimize-result-item {
            padding: 1px 0;
            color: #1e293b;
            text-align: left;
        }

        .optimize-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 8px;
        }

        @media (max-width: 768px) {
            .optimize-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .save-tip {
                order: -1;
                margin-right: 0;
                margin-bottom: 10px;
                width: 100%;
                min-height: 0;
            }

            .btn-start-optimize {
                order: 1;
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .btn-save-override {
                order: 2;
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .btn-save-append {
                order: 3;
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .optimize-buttons .btn-secondary {
                order: 4;
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .optimize-buttons {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto auto;
                gap: 10px;
                margin-top: 15px;
            }

            .save-tip {
                grid-column: 1 / -1;
                order: unset;
            }

            .btn-start-optimize {
                grid-column: 1;
                grid-row: 2;
                order: unset;
            }

            .btn-save-override {
                grid-column: 2;
                grid-row: 2;
                order: unset;
            }

            .btn-save-append {
                grid-column: 1;
                grid-row: 3;
                order: unset;
            }

            .optimize-buttons .btn-secondary {
                grid-column: 2;
                grid-row: 3;
                order: unset;
            }
        }

        .btn-start-optimize {
            background: linear-gradient(135deg, #10b981 0, #059669 100%);
            color: #fff;
        }

        .btn-save-override,
        .btn-save-append {
            opacity: 0.5;
            pointer-events: none;
        }

        .btn-save-override:not([disabled]),
        .btn-save-append:not([disabled]) {
            opacity: 1;
            pointer-events: all;
        }

        .save-tip {
            font-size: 12px;
            color: #7a7f88;
            font-weight: normal;
            display: flex;
            align-items: center;
            min-height: 32px;
            margin-right: auto;
            line-height: 1.2;
        }

        .btn-save-override {
            background: linear-gradient(135deg, #f59e0b 0, #d97706 100%);
            color: #fff;
        }

        .btn-save-append {
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            color: #fff;
        }

        html.dark-mode .ip-detection-box {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
            border-color: rgba(59, 130, 246, 0.3);
        }

        html.dark-mode .ip-detection-info {
            color: var(--text-primary);
        }

        html.dark-mode .optimize-progress-bar {
            background: #1e293b;
        }

        html.dark-mode .optimize-tab {
            background: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        html.dark-mode .optimize-tab.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        html.dark-mode .optimize-results-content {
            background: var(--input-bg);
        }

        html.dark-mode .optimize-result-item {
            color: var(--text-primary);
        }

        html.dark-mode .ech-tab {
            background: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        html.dark-mode .ech-tab.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }

        html.dark-mode .ech-tab-content {
            background: var(--input-bg);
        }

        html.dark-mode .ech-tabs::-webkit-scrollbar-thumb {
            background: #4b5563;
        }

        html.dark-mode .ech-tabs::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* استایل تنظیمات اعلان پیام */
        .notification-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px !important;
            padding: 2px 0;
        }

        .notification-row>label:first-child {
            display: flex;
            align-items: center;
            gap: 70px;
            margin: 0 !important;
            white-space: nowrap;
            flex: 1;
        }

        .notification-row>label:first-child .checkbox-group {
            display: flex;
            margin: 0;
            white-space: nowrap;
            gap: 6px;
        }

        .notification-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: auto;
            flex-shrink: 0;
        }

        .notification-controls .btn {
            flex-shrink: 0;
            font-size: 14px;
        }

        .btn-notification-config {
            background: linear-gradient(135deg, #8b5cf6 0, #7c3aed 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-notification-config::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left .5s ease
        }

        .btn-notification-config:hover::before {
            left: 100%
        }

        .btn-notification-config:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.5);
        }

        .btn-notification-config:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(139, 92, 246, 0.3);
        }

        .btn-clear-config {
            background: linear-gradient(135deg, #ef4444 0, #dc2626 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-clear-config::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left .5s ease
        }

        .btn-clear-config:hover::before {
            left: 100%
        }

        .btn-clear-config:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(239, 68, 68, 0.5);
        }

        .btn-clear-config:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(239, 68, 68, 0.3);
        }

        html.dark-mode .btn-clear-config {
            background: linear-gradient(135deg, #ef4444 0, #dc2626 100%);
            color: #fff;
        }

        /* استایل وضعیت دکمه Telegram */
        .btn-clear-config.btn-configured {
            background: linear-gradient(135deg, #ef4444 0, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            cursor: pointer;
            opacity: 1;
        }

        .btn-clear-config.btn-not-configured {
            background: linear-gradient(135deg, #d1d5db 0, #9ca3af 100%);
            box-shadow: 0 4px 15px rgba(209, 213, 219, 0.3);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .btn-clear-config.btn-not-configured:hover {
            transform: none;
            box-shadow: 0 4px 15px rgba(209, 213, 219, 0.3);
        }
		
        /*  استایل ماژول آمار استفاده CF  */

        .cf-usage-module {
            display: none;
        }

        .cf-usage-module[style*="display: block"] {
            display: block !important;
        }

        .cf-usage-wrapper {
            padding: 20px 0;
        }

        /* کارت آماری */
        .cf-stats-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            border-left: 4px solid #3b82f6;
        }

        .cf-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
        }

        .cf-stat-item {
            display: flex;
            flex-direction: column;
        }

        .cf-stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .cf-stat-value {
            font-size: 24px;
            font-weight: 700;
        }

        .cf-value-green {
            color: #10b981;
        }

        .cf-value-blue {
            color: #3b82f6;
        }

        .cf-value-orange {
            color: #f59e0b;
        }

        .cf-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .cf-progress-title {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
        }

        .cf-percentage-badge {
            font-size: 13px;
            font-weight: 600;
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
        }

        .cf-progress-bar {
            position: relative;
            height: 28px;
            background: linear-gradient(90deg, #9ca3af 0%, #6b7280 100%);
            border-radius: 14px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .cf-bar-segment {
            position: absolute;
            height: 100%;
            border-radius: 0;
            width: 0%;
            transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            font-size: 11px;
            font-weight: 700;
            color: white;
        }

        .cf-bar-green {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.5);
            justify-content: flex-end;
            padding-right: 12px;
            opacity: 0.9;
        }

        .cf-bar-blue {
            background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.5);
            justify-content: center;
            opacity: 0.85;
        }

        .cf-percentage-center {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* جعبه راهنمای اطلاعات */
        .cf-info-box {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.05) 0%, rgba(234, 179, 8, 0.05) 100%);
            border: 1px solid rgba(249, 115, 22, 0.2);
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 0;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .cf-info-icon {
            font-size: 16px;
            flex-shrink: 0;
        }

        .cf-info-text {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.6;
        }

        .cf-info-text strong {
            color: #1e293b;
        }

        .cf-highlight {
            color: #f59e0b !important;
        }

        /* استایل اعداد شمارش معکوس */
        .countdown-numbers {
            color: #f59e0b;
            font-weight: bold;
        }

        /* استایل متن شمارش معکوس */
        .countdown-text {
            color: #6b7280;
        }

        /* چیدمان واکنش‌گرا: دسکتاپ مخفی کردن شکستگی خط، موبایل نمایش */
        @media (min-width: 768px) {
            .cf-info-text br {
                display: none;
            }

            .cf-info-text {
                white-space: nowrap;
            }
        }

        @media (max-width: 767px) {
            .cf-info-text br {
                display: block;
            }

            .cf-info-text {
                white-space: normal;
            }
        }
		        /*  پشتیبانی از حالت تاریک  */

        html.dark-mode .cf-stats-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(6, 182, 212, 0.2) 100%);
            border-left-color: #3b82f6;
        }

        html.dark-mode .cf-stat-label {
            color: var(--text-secondary);
        }

        html.dark-mode .cf-progress-title {
            color: var(--text-primary);
        }

        html.dark-mode .cf-percentage-badge {
            color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }

        html.dark-mode .cf-progress-bar {
            background: linear-gradient(90deg, #111827 0%, #0f172a 100%);
        }

        html.dark-mode .cf-percentage-center {
            color: white;
        }

        html.dark-mode .cf-info-box {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.1) 0%, rgba(234, 179, 8, 0.1) 100%);
            border-color: rgba(249, 115, 22, 0.3);
        }

        html.dark-mode .cf-info-text {
            color: var(--text-secondary);
        }

        html.dark-mode .cf-info-text strong {
            color: var(--text-primary);
        }

        html.dark-mode .cf-highlight {
            color: #fbbf24 !important;
        }

        /* استایل اعداد شمارش معکوس در حالت تاریک */
        html.dark-mode .countdown-numbers {
            color: #fbbf24;
            font-weight: bold;
        }

        /* استایل متن شمارش معکوس در حالت تاریک */
        html.dark-mode .countdown-text {
            color: #9ca3af;
        }

        html.dark-mode .qrcode-container {
            background: #808080;
        }

        /* استایل کارت اطلاعات شبکه */
        .port-info {
            margin-top: 30px;
            padding: 0 20px;
        }

        .port-info>h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        html.dark-mode .port-info>h3 {
            color: #e0e0e0;
        }

        .network-cards-container {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 16px;
            margin-bottom: 10px;
            margin-top: 2px;
        }


        .network-card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }

        html.dark-mode .network-card-title {
            color: #e0e0e0;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: none;
        }

        .status-indicator.status-loading {
            background-color: #ffa500;
            box-shadow: 0 0 5px #ffa500;
            animation: pulse 1.5s infinite;
        }

        .status-indicator.status-success {
            background-color: #4caf50;
            box-shadow: 0 0 5px #4caf50;
        }

        .status-indicator.status-error {
            background-color: #f44336;
            box-shadow: 0 0 5px #f44336;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .network-info-content {
            padding-left: 20px;
        }

        .ip-text {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            word-break: break-all;
            margin-bottom: 8px;
            cursor: default;
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }

        html.dark-mode .ip-text {
            color: #ffffff;
        }

        .ip-text.clickable {
            cursor: pointer;
            color: #2196F3;
        }

        .ip-text.clickable:hover {
            color: #1976D2;
        }

        html.dark-mode .ip-text.clickable {
            color: #64B5F6;
        }

        html.dark-mode .ip-text.clickable:hover {
            color: #90CAF9;
        }

        .ip-text .error {
            color: #f44336;
            font-size: 14px;
        }

        .location-text {
            display: flex;
            gap: 15px;
            margin-bottom: 8px;
            font-size: 14px;
            color: #666;
            min-width: 0;
        }

        .country-text {
            color: var(--text-color-secondary);
            font-size: 0.875rem;
            white-space: nowrap;
            flex-shrink: 0;
        }

        html.dark-mode .location-text {
            color: #b0b0b0;
        }

        .country-text,
        .city-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }

        .network-tip {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }

        html.dark-mode .network-tip {
            color: #999;
        }

        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #e0e0e0;
            border-top: 2px solid #0ea5e9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .loading-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* استایل مودال جزئیات IP */
        /* Tech-savvy IP Detail Modal */
        .ip-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000000001;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .ip-detail-content {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 24px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 0;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
        }

        html.dark-mode .ip-detail-content {
            background: rgba(30, 30, 35, 0.85);
            border-color: rgba(255, 255, 255, 0.05);
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.5);
            color: #f0f0f0;
        }

        /* سربرگ مودال */
        .ip-detail-header {
            padding: 24px 30px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: inherit;
            z-index: 10;
        }

        html.dark-mode .ip-detail-header {
            border-bottom-color: rgba(255, 255, 255, 0.05);
        }

        .ip-detail-title {
            font-size: 20px;
            font-weight: 800;
            margin: 0;
            background: linear-gradient(135deg, #0ea5e9 0%, #0ea5e9 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Vazirmatn', sans-serif;
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .ip-detail-source-tag {
            font-size: 10px;
            font-weight: 500;
            color: #6b7280;
            -webkit-text-fill-color: #6b7280;
            opacity: 0.6;
            font-family: 'Vazirmatn', sans-serif;
            text-transform: none;
            letter-spacing: normal;
        }

        html.dark-mode .ip-detail-source-tag {
            color: #9ca3af;
            -webkit-text-fill-color: #9ca3af;
        }

        .ip-detail-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.05);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #666;
            transition: all 0.2s;
        }

        html.dark-mode .ip-detail-close {
            background: rgba(255, 255, 255, 0.05);
            color: #aaa;
        }

        .ip-detail-close:hover {
            background: #ef4444;
            color: white;
            transform: rotate(90deg);
        }

        /* چیدمان بدنه مودال */
        .ip-detail-body {
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        /* بخش نقشه */
        .ip-detail-map-container {
            height: 350px;
            width: 100%;
            position: relative;
            background: #f0f0f0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        html.dark-mode .ip-detail-map-container {
            background: #1a1a1a;
            border-bottom-color: rgba(255, 255, 255, 0.05);
        }

        #ip-detail-map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* بخش شبکه داده */
        .ip-detail-grid-container {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            align-items: start;
        }

        .ip-detail-left-col,
        .ip-detail-right-col {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .ip-detail-card {
            background: rgba(0, 0, 0, 0.02);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(0, 0, 0, 0.03);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        html.dark-mode .ip-detail-card {
            background: rgba(255, 255, 255, 0.02);
            border-color: rgba(255, 255, 255, 0.03);
        }

        .ip-detail-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
        }

        .ip-detail-section-title {
            font-size: 14px;
            font-weight: 700;
            color: #0ea5e9;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ip-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 13px;
        }

        .ip-detail-item:not(:last-child) {
            border-bottom: 1px dashed rgba(0, 0, 0, 0.05);
        }

        html.dark-mode .ip-detail-item:not(:last-child) {
            border-bottom-color: rgba(255, 255, 255, 0.05);
        }

        .ip-detail-label {
            color: #6b7280;
            font-weight: 500;
        }

        html.dark-mode .ip-detail-label {
            color: #9ca3af;
        }

        .ip-detail-value {
            font-family: 'Fira Code', monospace;
            font-weight: 600;
            color: #1e293b;
            text-align: right;
        }

        html.dark-mode .ip-detail-value {
            color: #e5e7eb;
        }

        /* Status & Badges - More vibrant for risk assessment */
        .ip-detail-badge {
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .badge-critical {
            background: #ef4444;
            color: white;
        }

        .badge-high {
            background: #f97316;
            color: white;
        }

        .badge-elevated {
            background: #eab308;
            color: white;
        }

        .badge-low {
            background: #ebfef2;
            color: #059669;
            border: 1px solid #10b981;
        }

        .badge-verylow {
            background: #10b981;
            color: white;
        }

        .badge-success {
            background: #10b981;
            color: white;
        }

        .badge-info {
            background: #3b82f6;
            color: white;
        }

        .badge-warning {
            background: #f59e0b;
            color: white;
        }

        .badge-danger {
            background: #ef4444;
            color: white;
        }

        .success-text {
            color: #10b981;
            font-weight: 700;
        }

        .warning-text {
            color: #f59e0b;
            font-weight: 700;
        }

        .danger-text {
            color: #ef4444;
            font-weight: 700;
        }

        /* Map Popup Styling */
        .leaflet-popup-content-wrapper {
            background: #ffffff !important;
            border-radius: 12px !important;
            border: 1px solid #e5e7eb;
            color: #374151 !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        html.dark-mode .leaflet-popup-content-wrapper {
            background: #1e293b !important;
            border-color: #374151;
            color: #e5e7eb !important;
        }

        .leaflet-popup-tip {
            background: #ffffff !important;
        }

        html.dark-mode .leaflet-popup-tip {
            background: #1e293b !important;
        }

        .ip-detail-popup-content {
            font-family: 'Vazirmatn', sans-serif;
            padding: 2px;
            max-width: 180px;
        }

        .ip-detail-popup-city {
            font-size: 14px;
            font-weight: 800;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
            color: #0ea5e9;
        }

        .ip-detail-popup-item {
            font-size: 11px;
            margin-bottom: 2px;
            display: flex;
            gap: 4px;
            line-height: 1.2;
        }

        .ip-detail-popup-label {
            opacity: 0.7;
            min-width: 45px;
        }

        .ip-detail-popup-value {
            font-weight: 600;
            word-break: break-all;
        }

        .ip-detail-security-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0 24px;
        }

        /* سازگاری موبایل */
        @media (max-width: 640px) {
            .ip-detail-modal {
                padding: 10px;
                /* اطمینان از استفاده کامل مودال از فضای صفحه */
                align-items: flex-end;
            }

            .ip-detail-content {
                /* استفاده از dvh (ارتفاع داینامیک ویوپورت) یا fallback به vh، برای سازگاری با تغییرات نوار آدرس مرورگر موبایل */
                max-height: calc(100dvh - 20px);
                max-height: calc(100vh - 20px);
                /* استایل پاپ‌آپ از پایین */
                border-radius: 20px 20px 0 0;
                margin-top: auto;
                /* اطمینان از قابلیت اسکرول محتوا */
                overflow-y: auto;
                /* افزودن فاصله داخلی امن برای دستگاه‌های دارای ناچ (notch) */
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }

            .ip-detail-grid-container {
                padding: 20px;
                /* افزایش قابل توجه فاصله داخلی پایین */
                padding-bottom: calc(60px + env(safe-area-inset-bottom, 20px));
                grid-template-columns: 1fr;
            }

            .ip-detail-security-grid {
                grid-template-columns: 1fr 1fr;
                gap: 0 16px;
            }

            .ip-detail-map-container {
                height: 200px;
                /* کاهش ارتفاع نقشه در موبایل برای دادن فضای بیشتر به محتوا */
            }

            .ip-detail-popup-content {
                max-width: 150px;
            }

            .ip-detail-popup-city {
                font-size: 13px;
            }

            .ip-detail-popup-item {
                font-size: 10px;
            }

            .ip-detail-header {
                padding: 16px 20px;
                /* هدر چسبنده برای جلوگیری از پوشاندن محتوا هنگام اسکرول */
                position: sticky;
                top: 0;
                z-index: 10;
                background: inherit;
            }

            /* افزودن فاصله داخلی اضافی به body در موبایل برای اطمینان از نمایش محتوای پایین */
            .ip-detail-body {
                padding-bottom: 60px;
            }
        }

        .badge-elevated {
            background-color: #fff9c4;
            color: #f57f17;
        }

        .badge-low {
            background-color: #c8e6c9;
            color: #1b5e20;
        }

        .badge-verylow {
            background-color: #a5d6a7;
            color: #00320c;
        }

        html.dark-mode .badge-success {
            background-color: #1b5e20;
            color: #81c784;
        }

        html.dark-mode .badge-info {
            background-color: #0d47a1;
            color: #64b5f6;
        }

        html.dark-mode .badge-warning {
            background-color: #e65100;
            color: #ffb74d;
        }

        html.dark-mode .badge-danger {
            background-color: #b71c1c;
            color: #ef5350;
        }

        /* استایل نوع IP */
        .ip-type-residential {
            color: #2e7d32;
            font-weight: bold;
        }

        .ip-type-business {
            color: #f59e0b;
            font-weight: bold;
        }

        .ip-type-hosting {
            font-weight: bold;
        }

        .ip-type-unknown {
            font-weight: bold;
        }

        html.dark-mode .ip-type-residential {
            color: #81c784;
            font-weight: bold;
        }

        html.dark-mode .ip-type-business {
            color: #fbbf24;
            font-weight: bold;
        }

        html.dark-mode .ip-type-hosting {
            font-weight: bold;
        }

        html.dark-mode .ip-type-unknown {
            font-weight: bold;
        }

        /* استایل متن سطح ریسک */
        .success-text {
            color: #2e7d32;
        }

        .warning-text {
            color: #e65100;
        }

        .danger-text {
            color: #c62828;
        }

        html.dark-mode .success-text {
            color: #81c784;
        }

        html.dark-mode .warning-text {
            color: #ffb74d;
        }

        html.dark-mode .danger-text {
            color: #ef5350;
        }

        /* توضیح ابزارک امتیاز الگوریتم */
        .score-help-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            line-height: 18px;
            text-align: center;
            background-color: #2196F3;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .score-help-icon:hover {
            background-color: #1976D2;
        }

        html.dark-mode .score-help-icon {
            background-color: #1976D2;
        }

        html.dark-mode .score-help-icon:hover {
            background-color: #64B5F6;
        }

        .score-tooltip {
            display: none;
            position: fixed;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            min-width: 300px;
            max-width: 350px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            font-size: 13px;
            line-height: 1.6;
        }

        /* کلاس تنظیم موقعیت ابزارک */
        .score-tooltip.tooltip-bottom {
            display: none;
        }

        .score-tooltip.tooltip-left {
            display: none;
        }

        .score-tooltip.tooltip-right {
            display: none;
        }

        html.dark-mode .score-tooltip {
            background: #3c3c3c;
            border-color: #444;
            color: #e0e0e0;
        }

        .score-tooltip.show {
            display: block;
        }

        .tooltip-header {
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
        }

        html.dark-mode .tooltip-header {
            border-bottom-color: #444;
        }

        .tooltip-section {
            margin-top: 10px;
        }

        .tooltip-section-title {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .formula-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding-left: 10px;
        }

        .formula-equation code {
            background-color: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        html.dark-mode .formula-equation code {
            background-color: #444;
        }

        .risk-list {
            list-style: none;
            padding-left: 0;
        }

        .risk-list li {
            padding: 4px 0;
            padding-left: 20px;
            position: relative;
        }

        .risk-list li::before {
            content: '•';
            position: absolute;
            left: 0;
        }

        /* طراحی واکنش‌گرا */
        @media (max-width: 1024px) {
            .network-cards-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .network-cards-container {
                grid-template-columns: 1fr;
            }

            .ip-detail-content {
                padding: 20px;
                max-width: 100%;
            }

            .ip-detail-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .ip-detail-label {
                min-width: unset;
            }

            .ip-detail-value {
                text-align: left;
                width: 100%;
            }

            .score-tooltip {
                position: fixed;
                bottom: auto;
                right: auto;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                min-width: 280px;
                max-width: 90%;
            }
        }

        /* استایل اطلاعات شبکه و تأخیر */
        .network-cards-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-top: 16px;
        }

        @media (max-width: 1200px) {
            .network-cards-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .network-cards-container {
                grid-template-columns: 1fr;
            }
        }

        .network-card,
        .latency-card {
            background: var(--bg-secondary);
            border: 1.5px solid var(--border-color);
            border-radius: 14px;
            padding: 16px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        html.dark-mode .network-card,
        html.dark-mode .latency-card {
            background: rgba(39, 39, 39, 0.7);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
        }

        .latency-card {
            padding: 12px 16px;
            min-height: 80px;
            flex-direction: row;
            /* کارت تأخیر معمولاً دارای چیدمان افقی header و graph است */
            align-items: center;
        }

        .network-card:hover,
        .latency-card:hover {
            transform: translateY(-4px) scale(1.02);
            border-color: #0ea5e9;
            box-shadow: 0 12px 20px rgba(246, 130, 31, 0.15);
        }

        .network-card-title {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }

        .title-text {
            display: flex;
            flex-direction: row;
            align-items: flex-end;
            gap: 4px;
            flex-wrap: wrap;
        }

        .title-main {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .title-subtitle {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary, #666);
            opacity: 0.7;
        }

        html.dark-mode .title-subtitle {
            color: #999;
        }

        .status-loading {
            background: #fbbf24;
            animation: pulse-loading 1.5s ease-in-out infinite;
        }

        .status-success {
            background: #10b981;
        }

        .status-error {
            background: #ef4444;
        }

        @keyframes pulse-loading {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .network-info-content {
            display: flex;
            flex-direction: column;
        }

        .ip-text {
            color: var(--text-primary);
            font-weight: 700;
            font-family: 'Fira Code', monospace;
            font-size: 15px;
            word-break: break-all;
        }

        .location-text {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .network-tip {
            margin-top: 4px;
            font-size: 11px;
            color: #9ca3af;
            line-height: 1.4;
        }

        .latency-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            row-gap: 8px;
            margin-top: 16px;
        }

        @media (max-width: 1200px) {
            .latency-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .latency-cards {
                grid-template-columns: 1fr;
            }
        }

        .latency-card-header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            position: relative;
            z-index: 2;
            width: 100%;
        }

        .latency-card-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .latency-card-icon-wrapper {
            width: 36px;
            height: 36px;
            background: var(--border-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1.5px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .latency-card:hover .latency-card-icon-wrapper {
            background: white;
            border-color: #0ea5e9;
            transform: rotate(5deg);
        }

        html.dark-mode .latency-card:hover .latency-card-icon-wrapper {
            background: #333;
        }

        .latency-card-icon-wrapper svg {
            width: 20px;
            height: 20px;
        }

        .latency-card-text {
            display: flex;
            flex-direction: row;
            align-items: flex-end;
            gap: 4px;
        }

        .latency-card-name {
            font-size: 14px;
            font-weight: 800;
            color: var(--text-primary);
            /*letter-spacing: 0.5px;*/
        }

        .latency-card-region {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            white-space: nowrap;
        }

        .latency-card-region[data-region="داخلی"] {
            color: #16a34a;
        }

        .latency-card-region[data-region="بین‌المللی"] {
            color: #3b82f6;
        }

        html.dark-mode .latency-card-region[data-region="داخلی"] {
            color: #4ade80;
        }

        html.dark-mode .latency-card-region[data-region="بین‌المللی"] {
            color: #60a5fa;
        }

        .latency-status {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            font-family: 'Vazirmatn', sans-serif;
            font-size: 1.6rem;
            font-weight: 800;
            font-style: italic;
            color: #0ea5e9;
            text-shadow: var(--bg-secondary);
            z-index: 3;
        }

        html.dark-mode .latency-status {
            text-shadow: rgba(39, 39, 39, 0.7),
        }

        .latency-status .unit {
            font-family: 'Vazirmatn', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            font-style: normal;
            margin-left: 1px;
            opacity: 0.7;
            vertical-align: baseline;
            text-transform: lowercase;
        }

        .latency-graph-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: transparent;
            pointer-events: none;
            opacity: 0.15;
        }

        .ecg-path {
            fill: none;
            stroke: #0ea5e9;
            stroke-width: 3.5;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: d 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ecg-path-bg {
            fill: none;
            stroke: var(--border-color);
            stroke-width: 1;
            opacity: 0.3;
        }

        .graph-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(var(--border-color) 0.5px, transparent 0.5px),
                linear-gradient(90deg, var(--border-color) 0.5px, transparent 0.5px);
            background-size: 15px 15px;
            pointer-events: none;
            opacity: 0.1;
        }

        .ecg-cursor {
            fill: #0ea5e9;
            filter: drop-shadow(0 0 5px #0ea5e9);
        }

        /* لوگوی GitHub در حالت روشن به رنگ مشکی نمایش داده می‌شود */
        .latency-card-icon-wrapper[data-site="github"] {
            color: #181717 !important;
        }

        .latency-card-icon-wrapper[data-site="github"] svg path {
            fill: #181717 !important;
        }

        html.dark-mode .latency-card-icon-wrapper[data-site="github"] {
            color: #ffffff !important;
        }

        html.dark-mode .latency-card-icon-wrapper[data-site="github"] svg path {
            fill: #ffffff !important;
        }

        /* انیمیشن بارگذاری */
        @keyframes latencyPulse {

            0%,
            100% {
                opacity: 0.4;
            }

            50% {
                opacity: 1;
            }
        }

        .latency-bar.loading {
            animation: latencyPulse 1.5s ease-in-out infinite;
        }

        /* استایل مودال ویرایش HOSTS */
        .hosts-edit-modal {
            overflow-y: auto;
            width: 90vw;
            max-width: 500px;
            margin: 0 auto;
            max-height: 90vh;
        }

        .hosts-edit-modal-title {
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
        }

        .hosts-edit-container {
            margin: 20px 0;
        }

        .hosts-edit-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            text-align: left;
        }

        .hosts-edit-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: 'Vazirmatn', 'Courier New', monospace;
            font-size: 14px;
            height: 200px;
            background-color: #f9fafb;
            color: #1e293b;
            resize: vertical;
            overflow-y: auto;
            box-sizing: border-box;
            line-height: 1.6;
        }

        .hosts-edit-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .hosts-edit-hint {
            font-size: 12px;
            color: #9ca3af;
            text-align: left;
        }

        .hosts-edit-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
        }

        .hosts-edit-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-hosts-confirm {
            background: linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-hosts-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
        }

        .btn-hosts-cancel {
            background: linear-gradient(135deg, #e5e7eb 0, #d1d5db 100%);
            color: #374151;
        }

        .btn-hosts-cancel:hover {
            background: linear-gradient(135deg, #d1d5db 0, #b3b8be 100%);
        }

        .form-group input[readonly].nodeHost-clickable {
            cursor: pointer;
            background-color: #ffffff !important;
            color: #1e293b !important;
        }

        html.dark-mode .hosts-edit-modal {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        html.dark-mode .hosts-edit-modal-title {
            color: var(--text-primary);
        }

        html.dark-mode .hosts-edit-label {
            color: var(--text-primary);
        }

        html.dark-mode .hosts-edit-textarea {
            background: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--input-border);
        }

        html.dark-mode .hosts-edit-hint {
            color: #6b7280;
        }

        html.dark-mode .btn-hosts-cancel {
            background: var(--input-bg);
            color: var(--text-primary);
        }

        html.dark-mode .btn-hosts-cancel:hover {
            background: var(--border-color);
        }

        html.dark-mode .form-group input[readonly].nodeHost-clickable {
            background-color: var(--input-bg) !important;
            color: var(--text-primary) !important;
        }

        /* استایل ویرایشگر متن پیشرفته */
        .line-editor {
            display: flex;
            gap: 0;
            align-items: stretch;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            background: #ffffff;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            margin-top: 8px;
            min-height: 300px;
        }

        .line-editor:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .line-editor .gutter {
            display: none;
            /* حذف gutter مستقل قدیمی */
        }

        .line-editor .editor-area {
            position: relative;
            flex-grow: 1;
            background: transparent;
            min-height: 300px;
            z-index: 1;
        }

        /* شبیه‌سازی پس‌زمینه gutter چپ - موقعیت ثابت */
        .line-editor .editor-area::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 48px;
            background: #f9fafb;
            border-right: 1px solid #e5e7eb;
            z-index: 0;
            pointer-events: none;
        }

        .line-editor .mirror {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 12px 12px 12px 60px !important;
            /* سمت چپ رزرو شده برای شماره خط */
            margin: 0 !important;
            white-space: pre-wrap !important;
            word-break: break-all !important;
            pointer-events: none;
            font-family: 'Vazirmatn', 'Courier New', monospace !important;
            font-size: 14px !important;
            line-height: 24px !important;
            color: transparent;
            overflow-y: scroll;
            overflow-x: hidden;
            box-sizing: border-box !important;
            border: none !important;
            scrollbar-width: none;
            z-index: 2;
            width: 100%;
            /* عرض اولیه، بعداً به صورت پویا توسط JS تنظیم می‌شود */
            /* اطمینان از قرارگیری در بالاترین لایه، از جمله روی پس‌زمینه textarea */
        }

        .line-editor .mirror::-webkit-scrollbar {
            display: none;
        }

        .line-editor .mirror .logical-line {
            display: block;
            margin: 0 !important;
            padding: 0 !important;
            position: relative;
            color: transparent;
            word-wrap: break-word;
            min-height: 24px;
            box-sizing: border-box;
        }

        .line-editor .mirror .logical-line:nth-child(even) {
            background: rgba(59, 130, 246, 0.06);
        }

        html.dark-mode .line-editor .mirror .logical-line:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        .line-editor .mirror .logical-line::before {
            content: attr(data-line-number);
            position: absolute;
            left: -60px;
            /* نسبت به padding-left آینه */
            top: 0;
            width: 48px;
            height: 24px;
            line-height: 24px;
            text-align: right;
            padding-right: 12px;
            color: #9ca3af;
            font-size: 13px;
            box-sizing: border-box;
            z-index: 1;
        }

        html.dark-mode .line-editor .mirror .logical-line::before {
            color: #6b7280;
        }

        /* نمایش یک نماد کوچک در محل شکستگی واقعی خط */
        .line-editor .mirror .logical-line::after {
            content: "↵";
            position: absolute;
            right: -4px;
            bottom: 0;
            color: rgba(59, 130, 246, 0.3);
            font-size: 12px;
            display: none;
        }

        .line-editor textarea {
            width: 100% !important;
            min-height: 300px;
            border: none !important;
            background: transparent !important;
            padding: 12px 12px 12px 60px !important;
            /* هم‌راستا با آینه */
            margin: 0 !important;
            font-family: 'Vazirmatn', 'Courier New', monospace !important;
            font-size: 14px !important;
            line-height: 24px !important;
            color: #1e293b;
            resize: vertical !important;
            outline: none !important;
            box-sizing: border-box !important;
            display: block;
            white-space: pre-wrap !important;
            word-break: break-all !important;
            scrollbar-width: thin;
            position: relative;
            z-index: 1;
            overflow-y: scroll;
        }

        html.dark-mode .line-editor {
            border-color: var(--input-border);
            background: var(--input-bg);
        }

        html.dark-mode .line-editor .gutter {
            background: rgba(255, 255, 255, 0.03);
            border-right-color: var(--border-color);
            color: #6b7280;
        }

        html.dark-mode .line-editor textarea {
            color: var(--text-primary);
        }

        html.dark-mode .line-editor .mirror .logical-line:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        html.dark-mode .line-editor .editor-area::before {
            background: rgba(255, 255, 255, 0.03);
            border-right-color: var(--border-color);
        }

        /* اسکلت لودر برای محتوای با تاخیر */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .skeleton-title {
            height: 24px;
            width: 60%;
            margin-bottom: 16px;
            border-radius: 6px;
        }

        .skeleton-box {
            height: 100px;
            border-radius: 12px;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        html.dark-mode .skeleton {
            background: linear-gradient(90deg, #2a2a2a 25%, #3a3a3a 50%, #2a2a2a 75%);
            background-size: 200% 100%;
        }

        /* افکت‌های هاور ملایم */
        .btn:hover {
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        .module:hover {
            transition: all 0.3s ease;
        }

        /* گرد کردن بیشتر گوشه‌ها */
        .card-container {
            border-radius: 20px;
        }

        .module {
            border-radius: 16px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            border-radius: 12px;
        }

        .btn {
            border-radius: 10px;
        }
    </style>
	</head>
<body>

    <!-- دکمه منوی موبایل -->
    <button class="mobile-menu-toggle" onclick="toggleSidebar()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12h18M3 6h18M3 18h18"/>
        </svg>
    </button>

    <!-- پس‌زمینه تاریک برای منوی موبایل -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- منوی کناری -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <svg viewBox="0 0 24 24" fill="white">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <span>پنل مدیریت</span>
            </div>
        </div>

        <div class="sidebar-menu">
            <div class="menu-section-title">اصلی</div>
            
            <div class="menu-item active" onclick="showPage('dashboard', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                </svg>
                <span>داشبورد</span>
            </div>

            <div class="menu-item" onclick="showPage('network', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/>
                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                </svg>
                <span>اطلاعات شبکه</span>
            </div>

            <div class="menu-item" onclick="showPage('subscribe', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                </svg>
                <span>دریافت لینک نودها</span>
            </div>

            <div class="menu-item" onclick="showPage('optimize', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                </svg>
                <span>تولید اشتراک بهینه</span>
            </div>

            <div class="menu-divider"></div>
            <div class="menu-section-title">تنظیمات</div>

            <div class="menu-item" onclick="showPage('config', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                <span>پیکربندی جزئی</span>
            </div>

            <div class="menu-item" onclick="showPage('cdn', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                </svg>
                <span>تنظیمات CDN</span>
            </div>

            <div class="menu-item" onclick="showPage('convert', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                </svg>
                <span>تبدیل اشتراک</span>
            </div>

            <div class="menu-item" onclick="showPage('notify', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
                <span>اعلانات</span>
            </div>

            <div class="menu-divider"></div>

            <div class="menu-item" onclick="showPage('logs', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                </svg>
                <span>مشاهده لاگ‌ها</span>
            </div>

            <div class="sidebar-buttons" style="padding: 0 10px; margin-bottom: 10px;">
                <button type="button" onclick="resetConfigWithConfirm()" 
                    style="width: 100%; padding: 12px; margin-bottom: 8px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 10px; color: white; cursor: pointer; font-family: inherit; font-size: 14px; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                        <path d="M3 3v5h5"/>
                    </svg>
                    بازنشانی تنظیمات
                </button>
                <button type="button" onclick="logout()" 
                    style="width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; cursor: pointer; font-family: inherit; font-size: 14px; font-weight: 500; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    خروج
                </button>
            </div>

        <div class="sidebar-footer">
            <div style="display: flex; gap: 10px; justify-content: center;">
                <a href="https://github.com/cmliu/edgetunnel" target="_blank" rel="noopener" 
                   style="width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.15); border-radius: 10px; color: white; text-decoration: none; transition: all 0.3s ease;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385c.6.105.825-.255.825-.57c0-.285-.015-1.23-.015-2.235c-3.015.555-3.795-.735-4.035-1.41c-.135-.345-.72-1.41-1.23-1.695c-.42-.225-1.02-.78-.015-.795c.945-.015 1.62.87 1.845 1.23c1.08 1.815 2.805 1.305 3.495.99c.105-.78.42-1.305.765-1.605c-2.67-.3-5.46-1.335-5.46-5.925c0-1.305.465-2.385 1.23-3.225c-.12-.3-.54-1.53.12-3.18c0 0 1.005-.315 3.3 1.23c.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23c.66 1.65.24 2.88.12 3.18c.765.84 1.23 1.905 1.23 3.225c0 4.605-2.805 5.625-5.475 5.925c.435.375.81 1.095.81 2.22c0 1.605-.015 2.895-.015 3.3c0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12Z" />
                    </svg>
                </a>
                <a href="https://t.me/CMLiussss" target="_blank" rel="noopener" 
                   style="width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.15); border-radius: 10px; color: white; text-decoration: none; transition: all 0.3s ease;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12a12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472c-.18 1.898-.962 6.502-1.36 8.627c-.168.9-.499 1.201-.82 1.23c-.696.065-1.225-.46-1.9-.902c-1.056-.693-1.653-1.124-2.678-1.8c-1.185-.78-.417-1.21.258-1.91c.177-.184 3.247-2.977 3.307-3.23c.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345c-.48.33-.913.49-1.302.48c-.428-.008-1.252-.241-1.865-.44c-.752-.245-1.349-.374-1.297-.789c.027-.216.325-.437.893-.663c3.498-1.524 5.83-2.529 6.998-3.014c3.332-1.386 4.025-1.627 4.476-1.635z" />
                    </svg>
                </a>
            </div>
        </div>
    </nav>

    <!-- محتوای اصلی -->
    <main class="main-content">
        
        <!-- صفحه داشبورد -->
        <div class="page active" id="page-dashboard">
            <div class="page-title-section">
                <h1>داشبورد</h1>
                <p>خوش آمدید! در اینجا می‌توانید وضعیت سیستم را مشاهده کنید.</p>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card" onclick="showPage('network', this)" style="cursor: pointer;">
                    <div class="stat-card-header">
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, #0ea5e9, #0284c7);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-card-title">اطلاعات شبکه</div>
                    <div class="stat-card-value">IP + Location</div>
                    <div class="stat-card-desc">مشاهده اطلاعات شبکه فعلی</div>
                </div>

                <div class="stat-card" onclick="showPage('subscribe', this)" style="cursor: pointer;">
                    <div class="stat-card-header">
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-card-title">لینک نودها</div>
                    <div class="stat-card-value">دریافت کنید</div>
                    <div class="stat-card-desc">دریافت لینک اشتراک نودها</div>
                </div>

                <div class="stat-card" onclick="showPage('optimize', this)" style="cursor: pointer;">
                    <div class="stat-card-header">
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-card-title">بهینه‌سازی</div>
                    <div class="stat-card-value">اشتراک بهینه</div>
                    <div class="stat-card-desc">تولید اشتراک بهینه شده</div>
                </div>

                <div class="stat-card" onclick="showPage('logs', this)" style="cursor: pointer;">
                    <div class="stat-card-header">
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-card-title">لاگ‌ها</div>
                    <div class="stat-card-value">فعالیت‌ها</div>
                    <div class="stat-card-desc">مشاهده تاریخچه عملیات</div>
                </div>
            </div>
        </div>

        <!-- صفحه دریافت لینک نودها -->
        <div class="page" id="page-subscribe">
            <div class="page-title-section">
                <h1>دریافت لینک نودها</h1>
                <p>دریافت لینک اشتراک نودهای خود را با فرمت‌های مختلف</p>
            </div>

            <!-- ماژول لینک‌های اشتراک -->
            <div class="module" style="margin-bottom: 20px;">
                <div class="module-title" onclick="toggleModule(this)">
                    📋 دریافت لینک نودها
                    <svg class="collapse-icon" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5z" />
                    </svg>
                </div>
                <div class="module-content">
                    <div class="form-group">
                        <label for="LinkURL">فرمت لینک نود</label>
                        <div class="input-wrapper subscription-link-wrapper">
                            <input type="text" id="LinkURL" title="فرمت لینک نود" readonly>
                            <div class="btn-container">
                                <button type="button" class="btn btn-qrcode" onclick="showQRCode('LinkURL')">📱 کد QR</button>
                                <button type="button" class="btn btn-primary" onclick="copySubscription('LinkURL')">کپی نود</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="subLink">اشتراک تطبیقی</label>
                        <div class="input-wrapper subscription-link-wrapper">
                            <input type="text" id="subLink" title="اشتراک تطبیقی" readonly>
                            <div class="btn-container">
                                <button type="button" class="btn btn-qrcode" onclick="showQRCode('subLink')">📱 کد QR</button>
                                <button type="button" class="btn btn-primary" onclick="copySubscription('subLink')">کپی اشتراک</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="base64Sub">Base64</label>
                        <div class="input-wrapper subscription-link-wrapper">
                            <input type="text" id="base64Sub" title="Base64" readonly>
                            <div class="btn-container">
                                <button type="button" class="btn btn-qrcode" onclick="showQRCode('base64Sub')">📱 کد QR</button>
                                <button type="button" class="btn btn-primary" onclick="copySubscription('base64Sub')">کپی Base64</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for=" Clash">🛡️ Clash</label>
                        <div class="input-wrapper subscription-link-wrapper">
                            <input type="text" id=" Clash" title="🛡️ Clash" readonly>
                            <div class="btn-container">
                                <button type="button" class="btn btn-qrcode" onclick="showQRCode(' Clash')">📱 کد QR</button>
                                <button type="button" class="btn btn-primary" onclick="copySubscription(' Clash')">کپی Clash</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="mlink">🟢 شکل کامل</label>
                        <div class="input-wrapper subscription-link-wrapper">
                            <input type="text" id="mlink" title="🟢 شکل کامل" readonly>
                            <div class="btn-container">
                                <button type="button" class="btn btn-qrcode" onclick="showQRCode('mlink')">📱 کد QR</button>
                                <button type="button" class="btn btn-primary" onclick="copySubscription('mlink')">کپی کامل</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="v2link">🟣 V2Ray</label>
                        <div class="input-wrapper subscription-link-wrapper">
                            <input type="text" id="v2link" title="🟣 V2Ray" readonly>
                            <div class="btn-container">
                                <button type="button" class="btn btn-qrcode" onclick="showQRCode('v2link')">📱 کد QR</button>
                                <button type="button" class="btn btn-primary" onclick="copySubscription('v2link')">کپی V2Ray</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="surge3sub">📝 Surge 3/4</label>
                        <div class="input-wrapper subscription-link-wrapper">
                            <input type="text" id="surge3sub" title="📝 Surge 3/4" readonly>
                            <div class="btn-container">
                                <button type="button" class="btn btn-qrcode" onclick="showQRCode('surge3sub')">📱 کد QR</button>
                                <button type="button" class="btn btn-primary" onclick="copySubscription('surge3sub')">کپی Surge</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="surge2sub">📄 Surge 2</label>
                        <div class="input-wrapper subscription-link-wrapper">
                            <input type="text" id="surge2sub" title="📄 Surge 2" readonly>
                            <div class="btn-container">
                                <button type="button" class="btn btn-qrcode" onclick="showQRCode('surge2sub')">📱 کد QR</button>
                                <button type="button" class="btn btn-primary" onclick="copySubscription('surge2sub')">کپی Surge2</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="quanxsub">📊 Quantumult</label>
                        <div class="input-wrapper subscription-link-wrapper">
                            <input type="text" id="quanxsub" title="📊 Quantumult" readonly>
                            <div class="btn-container">
                                <button type="button" class="btn btn-qrcode" onclick="showQRCode('quanxsub')">📱 کد QR</button>
                                <button type="button" class="btn btn-primary" onclick="copySubscription('quanxsub')">کپی Quantumult</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="loonlink">🎈 Loon</label>
                        <div class="input-wrapper subscription-link-wrapper">
                            <input type="text" id="loonlink" title="🎈 Loon" readonly>
                            <div class="btn-container">
                                <button type="button" class="btn btn-qrcode" onclick="showQRCode('loonlink')">📱 کد QR</button>
                                <button type="button" class="btn btn-primary" onclick="copySubscription('loonlink')">کپی Loon</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="sssublink">🔒 Shadowrocket</label>
                        <div class="input-wrapper subscription-link-wrapper">
                            <input type="text" id="sssublink" title="🔒 Shadowrocket" readonly>
                            <div class="btn-container">
                                <button type="button" class="btn btn-qrcode" onclick="showQRCode('sssublink')">📱 کد QR</button>
                                <button type="button" class="btn btn-primary" onclick="copySubscription('sssublink')">کپی Shadowrocket</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- صفحه تولید اشتراک بهینه -->
        <div class="page" id="page-optimize">
            <div class="page-title-section">
                <h1>تولید اشتراک بهینه</h1>
                <p>تولید لینک‌های اشتراک بهینه شده</p>
            </div>

            <!-- ماژول تولید اشتراک بهینه -->
            <div class="module" style="margin-bottom: 20px;">
                <div class="module-title" onclick="toggleModule(this)">
                    ⚡️ تولید اشتراک بهینه
                    <svg class="collapse-icon" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5z" />
                    </svg>
                </div>
                <div class="module-content">

                    <div class="form-group">
                        <label for="ipMode2">حالت اشتراک بهینه</label>
                        <select id="ipMode2" title="حالت اشتراک بهینه" onchange="updateIPMode2()">
                            <option value="generator">تولیدکننده اشتراک بهینه</option>
                            <option value="random">انتخاب تصادفی بهینه</option>
                            <option value="custom">اشتراک سفارشی (پشتیبانی از اشتراک تجمیعی)</option>
                        </select>
                    </div>

                    <div id="randomIPSection2" class="form-group">
                        <label for="randomCount2">تعداد انتخاب تصادفی بهینه</label>
                        <input type="number" id="randomCount2" title="تعداد انتخاب تصادفی بهینه 1~99" min="1" max="99" value="16"
                            onchange="markModified('sub')" oninput="if(this.value>99){this.value=99;}">
                    </div>

                    <div id="portSection2" class="form-group hidden-section">
                        <label for="specifiedPort2">پورت بهینه مشخص</label>
                        <select id="specifiedPort2" onchange="markModified('sub')">
                            <option value="-1">پورت تصادفی</option>
                            <option value="443">443</option>
                            <option value="2053">2053</option>
                            <option value="2083">2083</option>
                            <option value="2087">2087</option>
                            <option value="2096">2096</option>
                            <option value="8443">8443</option>
                        </select>
                    </div>

                    <div id="customIPSection2" class="form-group hidden-section">
                        <label for="customIPs2">آدرس بهینه سفارشی</label>
                        <div class="line-editor" id="subCustomEditor2">
                            <div class="gutter" aria-hidden="true"></div>
                            <div class="editor-area">
                                <pre class="mirror" aria-hidden="true"></pre>
                                <textarea id="customIPs2" title="آدرس بهینه سفارشی"
                                    placeholder="توجه:
هر خط یک آدرس، مانند: آدرس:پورت#یادداشت
آدرس IPv6 باید در براکت باشد، مانند: [2606:4700::]:2053
اگر پورت نوشته نشود، پیش‌فرض 443 است، مانند: www.visa.cn#دامنه بهینه

مثال:
www.visa.cn#دامنه بهینه
127.0.0.1:1234#CFnat
[2606:4700::]:2053#IPv6



مثال نودهای دیگر:
vless://7b102311-43fd-4e8f-977e-8090623c101d@edt-pages.github.io:443?security=tls&type=ws&host=edt-pages.github.io&path=%2F#edgetunnel"
                                    onchange="markModified('sub')"></textarea>
                            </div>
                        </div>
                    </div>

                    <div id="generatorSection2" class="form-group hidden-section">
                        <label for="generatorURL2">تولیدکننده اشتراک بهینه</label>
                        <input type="text" id="generatorURL2" title="تولیدکننده اشتراک بهینه" placeholder="sub.cmliussss.net"
                            onchange="processGeneratorURL2()" oninput="processGeneratorURL2()">
                    </div>

                    <div class="module-footer">
                        <button type="button" class="btn btn-online-optimize hidden-section" id="onlineOptimizeBtn2"
                            onclick="openOnlineOptimizeModal()">بهینه‌سازی آنلاین</button>
                        <button type="button" class="btn btn-api-optimize hidden-section" id="apiOptimizeBtn2"
                            onclick="openAPIOptimizeModal()">رابط اشتراک</button>
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit('sub')" disabled
                                id="cancelSubBtn2">انصراف</button>
                            <button type="button" class="btn btn-primary" onclick="saveSub()" disabled
                                id="saveSubBtn2">ذخیره</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- صفحه اطلاعات شبکه -->
        <div class="page" id="page-network">
            <div class="page-title-section">
                <h1>اطلاعات شبکه</h1>
                <p>مشاهده اطلاعات شبکه فعلی و وضعیت اتصال</p>
            </div>

            <!-- کانتینر پنل مدیریت -->
            <div class="page-wrapper" style="display: block;">
        <div class="card-container">
            <div class="success-message" id="successMsg"></div>
            <div class="error-message" id="errorMsg"></div>

            <div class="header">
                <div class="header-title">
                    <h1 id="pageTitle">در حال بارگذاری...</h1>
                </div>
            </div>

            <!-- ماژول آمار استفاده Cloudflare Workers/Pages -->
            <div class="module cf-usage-module collapsed" id="cfUsageModule">
                <div class="module-title" onclick="toggleModule(this)">
                    آمار درخواست‌های Workers/Pages
                    <svg class="collapse-icon" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5z" />
                    </svg>
                </div>
                <!-- نوار پیشرفت -->
                <div>
                    <div class="cf-progress-bar">
                        <!-- نوار Workers (سبز) -->
                        <div class="cf-bar-segment cf-bar-green" id="cfWorkerBar" title="درخواست‌های Workers"></div>
                        <!-- نوار Pages (آبی) -->
                        <div class="cf-bar-segment cf-bar-blue" id="cfPagesBar" title="درخواست‌های Pages"></div>
                        <!-- متن درصد کلی (مرکز) -->
                        <div class="cf-percentage-center" id="cfPercentageCenter">0%</div>
                    </div>
                </div>
                <div class="module-content">
                    <div class="cf-usage-wrapper">
                        <!-- کارت آمار استفاده -->
                        <div class="cf-stats-card">
                            <div class="cf-stats-grid">
                                <div class="cf-stat-item">
                                    <div class="cf-stat-label">درخواست‌های Workers</div>
                                    <div class="cf-stat-value cf-value-green" id="cfWorkerCount">-</div>
                                </div>
                                <div class="cf-stat-item">
                                    <div class="cf-stat-label">درخواست‌های Pages</div>
                                    <div class="cf-stat-value cf-value-blue" id="cfPagesCount">-</div>
                                </div>
                                <div class="cf-stat-item">
                                    <div class="cf-stat-label">سهمیه روزانه</div>
                                    <div class="cf-stat-value cf-value-orange" id="cfDailyQuota">100,000</div>
                                </div>
                            </div>
                        </div>

                        <!-- جعبه اطلاع‌رسانی -->
                        <div class="cf-info-box">
                            <div class="cf-info-icon">ℹ️</div>
                            <div class="cf-info-text">
                                <strong>بازنشانی شمارنده درخواست‌های روزانه:</strong><br><span id="countdown" class="cf-highlight">تا بازنشانی 15 ساعت و 24 دقیقه مانده</span>،<br>ساعت <strong
                                    class="cf-highlight">8:00</strong> به وقت تهران (UTC+3:30) بازنشانی می‌شود،<br>مجموع استفاده امروز：<strong class="cf-highlight"
                                    id="cfTotalDisplay">-</strong>。
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ماژول اطلاعات شبکه -->
            <div class="module advanced-module">
                <div class="module-title" onclick="toggleNetworkModule(this)">
                    🌍 اطلاعات شبکه فعلی
                    <svg class="collapse-icon" viewBox="0 0 24 24" style="transform: rotate(90deg);">
                        <path d="M7 10l5 5 5-5z" />
                    </svg>
                </div>
                <div class="module-content">
                    <div class="network-cards-container">
                        <div class="network-card">
                            <div class="network-card-title">
                                <span class="status-indicator" id="status-ipip"></span>
                                <div class="title-text">
                                    <div class="title-main">تست داخلی</div>
                                    <div class="title-subtitle">speedtest.cn</div>
                                </div>
                            </div>
                            <div class="network-info-content">
                                <span id="ipip-ip" class="ip-text">-</span>
                                <div class="location-text">
                                    <span id="ipip-country" class="country-text">-</span>
                                </div>
                                <div class="network-tip">· IP استفاده شده برای دسترسی به سایت‌های داخلی</div>
                            </div>
                        </div>

                        <div class="network-card">
                            <div class="network-card-title">
                                <span class="status-indicator" id="status-overseas"></span>
                                <div class="title-text">
                                    <div class="title-main">تست خارجی</div>
                                    <div class="title-subtitle">ip.sb</div>
                                </div>
                            </div>
                            <div class="network-info-content">
                                <span id="overseas-ip" class="ip-text">-</span>
                                <div class="location-text">
                                    <span id="overseas-country" class="country-text">-</span>
                                </div>
                                <div class="network-tip">· IP استفاده شده برای دسترسی به سایت‌های خارجی</div>
                            </div>
                        </div>

                        <div class="network-card">
                            <div class="network-card-title">
                                <span class="status-indicator" id="status-cf"></span>
                                <div class="title-text">
                                    <div class="title-main">CloudFlare</div>
                                    <div class="title-subtitle">ProxyIP</div>
                                </div>
                            </div>
                            <div class="network-info-content">
                                <span id="cf-ip" class="ip-text">-</span>
                                <div class="location-text">
                                    <span id="cf-country" class="country-text">-</span>
                                </div>
                                <div class="network-tip">· IP نهایی استفاده شده برای دسترسی به سایت‌های CFCDN</div>
                            </div>
                        </div>

                        <div class="network-card">
                            <div class="network-card-title">
                                <span class="status-indicator" id="status-twitter"></span>
                                <div class="title-text">
                                    <div class="title-main">تست فیلترشکن</div>
                                    <div class="title-subtitle">X.com</div>
                                </div>
                            </div>
                            <div class="network-info-content">
                                <span id="twitter-ip" class="ip-text">-</span>
                                <div class="location-text">
                                    <span id="twitter-country" class="country-text">-</span>
                                </div>
                                <div class="network-tip">· IP استفاده شده برای دسترسی به توییتر (x.com)</div>
                            </div>
                        </div>
                    </div>
                    <small style="font-size: 12px; color: #9ca3af; margin-top: 6px; display: block;">💡 <b>تست داخلی</b>
                        توسط <b>قوانین مسیریابی</b> فیلترشکن شما تعیین می‌شود،<b>تست خارجی</b> توسط <b>IP بهینه</b> شما تعیین می‌شود، و <b>CF، Twitter، ChatGPT</b> توسط
                        <b>PROXYIP</b> شما تعیین می‌شوند.</small>
                    <div class="module-content" style="display: none;" id="network-module-content">
                        <!-- کارت‌های تست تاخیر -->
                        <div class="latency-cards" id="latency-cards">
                            <!-- کارت‌ها از طریق JavaScript به صورت پویا تولید می‌شوند -->
                        </div>
                        <small
                            style="font-size: 12px; color: #9ca3af; margin-top: 6px; display: block;">💡<b>تست‌های بیشتر</b> را می‌توانید در
                            <a href="https://ip.skk.moe/" target="_blank" rel="noopener"
                                style="font-weight: bold; color: #6b7280;">ip.skk.moe</a> انجام دهید.
                        </small>
                    </div>

                </div>
            </div>

            <!-- ماژول 4: تنظیمات CDN Proxy -->
            <div class="module collapsed advanced-module">
                <div class="module-title" onclick="toggleModule(this)">
                    🌐 تنظیمات دسترسی Cloudflare CDN
                    <svg class="collapse-icon" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5z" />
                    </svg>
                </div>
                <div class="module-content">

                    <div class="form-group">
                        <label for="proxyMode">حالت Proxy</label>
                        <select id="proxyMode" title="حالت Proxy" onchange="updateProxyMode()">
                            <option value="auto">PROXYIP</option>
                            <option value="socks5">SOCKS5</option>
                            <option value="http">HTTP</option>
                        </select>
                    </div>

                    <div id="proxyIPSection" class="form-group">
                        <div class="form-group">
                            <label for="proxyIP">PROXYIP</label>
                            <div class="input-wrapper">
                                <input type="text" id="proxyIP" title="PROXYIP" placeholder="proxyip.cmliussss.net"
                                    onchange="processProxyIP()" oninput="processProxyIP()">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="autoProxy" title="فعال‌سازی دریافت خودکار: استفاده از PROXYIP داخلی پیش‌فرض"
                                        onchange="toggleAutoProxy(); markModified('proxy')">
                                    <label for="autoProxy" class="checkbox-label"
                                        title="فعال‌سازی دریافت خودکار: استفاده از PROXYIP داخلی پیش‌فرض">فعال‌سازی دریافت خودکار</label>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div id="socks5Section" class="hidden-section">
                        <div class="form-group">
                            <label for="socks5Addr">SOCKS5</label>
                            <div class="input-wrapper">
                                <div class="readonly-wrapper proxy-input-wrapper"
                                    onclick="openProxyVerificationModal('socks5')">
                                    <input type="text" id="socks5Addr" title="SOCKS5"
                                        placeholder="user:password@127.0.0.1:1080" readonly class="subapi-input">
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="globalSocks5" title="فعال‌سازی پروکسی سراسری: ترافیک سایت‌های غیر CFCDN نیز از SOCKS5 عبور کند"
                                        onchange="markModified('proxy')">
                                    <label for="globalSocks5" class="checkbox-label"
                                        title="فعال‌سازی پروکسی سراسری: ترافیک سایت‌های غیر CFCDN نیز از SOCKS5 عبور کند">فعال‌سازی پروکسی سراسری</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="httpSection" class="hidden-section">
                        <div class="form-group">
                            <label for="httpAddr">HTTP</label>
                            <div class="input-wrapper">
                                <div class="readonly-wrapper proxy-input-wrapper"
                                    onclick="openProxyVerificationModal('http')">
                                    <input type="text" id="httpAddr" title="HTTP"
                                        placeholder="user:password@127.0.0.1:8080" readonly class="subapi-input">
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="globalHTTP" title="فعال‌سازی پروکسی سراسری: ترافیک سایت‌های غیر CFCDN نیز از HTTP عبور کند"
                                        onchange="markModified('proxy')">
                                    <label for="globalHTTP" class="checkbox-label"
                                        title="فعال‌سازی پروکسی سراسری: ترافیک سایت‌های غیر CFCDN نیز از HTTP عبور کند">فعال‌سازی پروکسی سراسری</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="module-footer">
                        <button type="button" class="btn btn-proxyip-help" onclick="showProxyIPHelpModal()"
                            title="اطلاعات مربوط به ProxyIP">
                            💡 چرا به Proxy نیاز داریم؟ PROXYIP چیست؟
                        </button>
                        <button type="button" class="btn btn-ech-help btn-path-template-config"
                            id="pathTemplateConfigBtn" onclick="showPathTemplateConfigModal()"
                            style="display: none; padding: 10px 16px;" title="پیکربندی قالب مسیر">
                            ⚙️ پیکربندی قالب مسیر
                        </button>
                        <button type="button" class="btn btn-search-proxy" id="getMoreProxyIPBtn"
                            onclick="showGetMoreProxyIPModal()" style="display: none; padding: 10px 16px;"
                            title="انتخاب پروکسی از لیست ProxyIP">
                            🗺️ دریافت PROXYIP بیشتر
                        </button>
                        <button type="button" class="btn btn-search-proxy" id="exploreSocks5Btn"
                            onclick="showExploreSocks5Modal()" style="display: none; padding: 10px 16px;"
                            title="انتخاب پروکسی از لیست SOCKS5">
                            🔒 دریافت SOCKS5 بیشتر
                        </button>
                        <button type="button" class="btn btn-search-proxy" id="exploreHTTPBtn"
                            onclick="showExploreHTTPModal()" style="display: none; padding: 10px 16px;"
                            title="انتخاب پروکسی از لیست HTTP">
                            🌐 دریافت HTTP بیشتر
                        </button>
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit('proxy')" disabled
                                id="cancelProxyBtn">انصراف</button>
                            <button type="button" class="btn btn-primary" onclick="saveProxy()" disabled
                                id="saveProxyBtn">ذخیره</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ماژول 5: پیکربندی تبدیل اشتراک -->
            <div class="module collapsed advanced-module">
                <div class="module-title" onclick="toggleModule(this)">
                    🔄 پیکربندی تبدیل اشتراک
                    <svg class="collapse-icon" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5z" />
                    </svg>
                </div>
                <div class="module-content">

                    <div class="form-group">
                        <label for="subAPI">بک‌اند تبدیل اشتراک</label>
                        <div class="readonly-wrapper" onclick="openSubAPIModal()">
                            <input type="text" id="subAPI" title="بک‌اند تبدیل اشتراک" readonly
                                placeholder="https://SUBAPI.cmliussss.net" class="subapi-input">
                        </div>
                    </div>

                    <div class="form-group" style="align-items: start;">
                        <label for="subConfigSelect" style="padding-top: 10px;">فایل پیکربندی تبدیل اشتراک</label>
                        <div class="input-wrapper" style="flex-direction: column; align-items: stretch;">
                            <select id="subConfigSelect" title="فایل پیکربندی تبدیل اشتراک" style="display: none;">
                                <option value="">در حال بارگذاری...</option>
                            </select>
                            <input type="text" id="subConfigCustomInput" title="URL سفارشی فایل پیکربندی تبدیل اشتراک"
                                placeholder="https://raw.githubusercontent.com/..." onchange="onSubConfigCustomInput()"
                                style="display: none; margin-top: 8px;">
                            <input type="hidden" id="subConfig">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="emoji">Emoji</label>
                        <div class="input-wrapper">
                            <div class="checkbox-group">
                                <input type="checkbox" id="emoji" title="فعال‌سازی Emoji" onchange="markModified('convert')">
                                <label for="emoji" class="checkbox-label">فعال‌سازی</label>
                            </div>
                        </div>
                    </div>

                    <div class="module-footer">
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit('convert')" disabled
                                id="cancelConvertBtn">انصراف</button>
                            <button type="button" class="btn btn-primary" onclick="saveConvert()" disabled
                                id="saveConvertBtn">ذخیره</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ماژول 6: تنظیمات اعلانات -->
            <div class="module collapsed advanced-module">
                <div class="module-title" onclick="toggleModule(this)">
                    🔔 تنظیمات اعلانات
                    <svg class="collapse-icon" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5z" />
                    </svg>
                </div>
                <div class="module-content">

                    <!-- تنظیمات اعلان Telegram Bot -->
                    <div class="form-group notification-row">
                        <label>
                            تنظیمات اعلان Telegram Bot
                            <div class="checkbox-group">
                                <input type="checkbox" id="telegramEnabled" title="فعال‌سازی اعلان TelegramBot"
                                    onchange="markModified('notification')" disabled>
                                <label for="telegramEnabled" class="checkbox-label">فعال‌سازی</label>
                            </div>
                        </label>
                        <div class="notification-controls">
                            <button type="button" class="btn btn-notification-config"
                                onclick="openTelegramConfigModal()">⚙️ پیکربندی</button>
                            <button type="button" class="btn btn-clear-config"
                                onclick="clearTelegramConfig()">🗑️ پاک کردن</button>
                        </div>
                    </div>

                    <!-- آمار درخواست‌های قابل استفاده Cloudflare -->
                    <div class="form-group notification-row">
                        <label>
                            آمار درخواست‌های قابل استفاده Cloudflare Workers/Pages
                        </label>
                        <div class="notification-controls">
                            <button type="button" class="btn btn-notification-config"
                                onclick="openCloudflareConfigModal()">⚙️ پیکربندی</button>
                            <button type="button" class="btn btn-clear-config"
                                onclick="clearCloudflareConfig()">🗑️ پاک کردن</button>
                        </div>
                    </div>

                    <div class="module-footer">
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit('notification')"
                                disabled id="cancelNotificationBtn">انصراف</button>
                            <button type="button" class="btn btn-primary" onclick="saveNotification()" disabled
                                id="saveNotificationBtn">ذخیره</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ماژول 7: مشاهده تمام لاگ‌ها -->
            <div class="module collapsed advanced-module">
                <div class="module-title" onclick="toggleModule(this); loadLogsOnExpand(this)">
                    📋 مشاهده لاگ‌های عملیات
                    <svg class="collapse-icon" viewBox="0 0 24 24">
                        <path d="M7 10l5 5 5-5z" />
                    </svg>
                </div>
                <div class="module-content">
                    <div id="logsContainer" class="logs-container">
                        <div class="logs-loading">در حال بارگذاری...</div>
                    </div>
                    <div class="logs-footer">
                        <p class="logs-footer-text">به دلیل محدودیت فضای KV، فقط 4MB لاگ عملیات نگهداری می‌شود. وقتی حجم لاگ از این مقدار بیشتر شود، قدیمی‌ترین رکوردها به طور خودکار حذف می‌شوند.</p>
                        <button type="button" class="btn btn-primary btn-all-logs" onclick="showAllLogs()">تمام لاگ‌ها</button>
                    </div>
                </div>
            </div>

            <div class="social-links">
                <!-- دکمه تغییر تم -->
                <button type="button" class="social-link theme-toggle" id="themeToggle" title="تغییر به حالت روز"
                    onclick="toggleTheme()">
                    <!-- آیکن خورشید (در حالت روز نمایش داده می‌شود) -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="theme-icon sun-icon">
                        <circle cx="12" cy="12" r="5" fill="currentColor" />
                        <g stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none">
                            <line x1="12" y1="1" x2="12" y2="3" />
                            <line x1="12" y1="21" x2="12" y2="23" />
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                            <line x1="1" y1="12" x2="3" y2="12" />
                            <line x1="21" y1="12" x2="23" y2="12" />
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
                        </g>
                    </svg>
                    <!-- آیکن ماه (در حالت شب نمایش داده می‌شود) -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="theme-icon moon-icon">
                        <path fill="currentColor" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                    </svg>
                </button>
                <!-- لینک GitHub -->
                <a href="https://github.com/cmliu/edgetunnel" target="_blank" rel="noopener" class="social-link"
                    title="GitHub">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path fill="currentColor"
                            d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385c.6.105.825-.255.825-.57c0-.285-.015-1.23-.015-2.235c-3.015.555-3.795-.735-4.035-1.41c-.135-.345-.72-1.41-1.23-1.695c-.42-.225-1.02-.78-.015-.795c.945-.015 1.62.87 1.845 1.23c1.08 1.815 2.805 1.305 3.495.99c.105-.78.42-1.305.765-1.605c-2.67-.3-5.46-1.335-5.46-5.925c0-1.305.465-2.385 1.23-3.225c-.12-.3-.54-1.53.12-3.18c0 0 1.005-.315 3.3 1.23c.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23c.66 1.65.24 2.88.12 3.18c.765.84 1.23 1.905 1.23 3.225c0 4.605-2.805 5.625-5.475 5.925c.435.375.81 1.095.81 2.22c0 1.605-.015 2.895-.015 3.3c0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12Z" />
                    </svg>
                </a>
                <!-- لینک Telegram -->
                <a href="https://t.me/CMLiussss" target="_blank" rel="noopener" class="social-link" title="Telegram">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path fill="currentColor"
                            d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12a12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472c-.18 1.898-.962 6.502-1.36 8.627c-.168.9-.499 1.201-.82 1.23c-.696.065-1.225-.46-1.9-.902c-1.056-.693-1.653-1.124-2.678-1.8c-1.185-.78-.417-1.21.258-1.91c.177-.184 3.247-2.977 3.307-3.23c.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345c-.48.33-.913.49-1.302.48c-.428-.008-1.252-.241-1.865-.44c-.752-.245-1.349-.374-1.297-.789c.027-.216.325-.437.893-.663c3.498-1.524 5.83-2.529 6.998-3.014c3.332-1.386 4.025-1.627 4.476-1.635z" />
                    </svg>
                </a>
                <!-- دکمه بازگشت به بالا -->
                <button type="button" class="social-link" title="بازگشت به بالا" onclick="scrollToTop()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" d="M12 19V5M5 12l7-7l7 7" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- صفحه پیکربندی -->
    <div class="page" id="page-config">
        <div class="page-title-section">
            <h1>پیکربندی جزئی</h1>
            <p>یکربندپی و تنظیمات نود</p>
        </div>

        <!-- ماژول پیکربندی جزئی -->
        <div class="module" style="margin-bottom: 20px;">
            <div class="module-title" onclick="toggleModule(this)">
                ⚙️ اطلاعات پیکربندی جزئی
                <svg class="collapse-icon" viewBox="0 0 24 24">
                    <path d="M7 10l5 5 5-5z" />
                </svg>
            </div>
            <div class="module-content">

                <div class="form-group">
                    <label for="subName2">نام اشتراک</label>
                    <input type="text" id="subName2" title="نام اشتراک" onchange="markModified('config')">
                </div>

                <div class="form-group">
                    <label for="nodeHost2">HOST</label>
                    <input type="text" id="nodeHost2" title="دامنه نود" readonly>
                </div>

                <div class="form-group">
                    <label for="nodeUUID2">UUID</label>
                    <input type="text" id="nodeUUID2" title="UUID برای تأیید نود فقط از طریق متغیر محیطی 'UUID' قابل تغییر است" readonly>
                </div>

                <div class="form-group">
                    <label for="nodePATH2">PATH</label>
                    <input type="text" id="nodePATH2" title="مسار استتار نود فقط از طریق متغیر محیطی 'PATH' قابل تغییر است">
                </div>

                <div class="form-group">
                    <label for="protocol2">پروتکل نود</label>
                    <select id="protocol2" title="پروتکل نود" onchange="updateProtocol2(); markModified('config')">
                        <option value="vless">VLESS</option>
                        <option value="trojan">Trojan</option>
                    </select>
                </div>

                <div class="form-group" id="fingerprintGroup2">
                    <label for="fingerprint2">استتار اثر انگشت</label>
                    <select id="fingerprint2" title="اثر انگشت مرورگر"
                        onchange="handleFingerprintChange2(); markModified('config')">
                        <option value="chrome">chrome (پشتیبانی ECH)</option>
                        <option value="firefox">firefox (پشتیبانی ECH)</option>
                        <option value="safari">safari</option>
                        <option value="ios">ios</option>
                        <option value="android">android</option>
                        <option value="edge">edge</option>
                        <option value="360">360</option>
                        <option value="qq">qq</option>
                        <option value="random">random</option>
                        <option value="randomized">randomized</option>
                    </select>
                </div>

                <div class="checkbox-row">
                    <div class="form-group" id="skipVerifyGroup2" style="display: none;">
                        <div class="input-wrapper">
                            <div class="checkbox-group">
                                <input type="checkbox" id="skipVerify2" title="نسخه Xray v26.1.31+ از رد کردن تأیید گواهی TLS پشتیبانی نمی‌کند"
                                    onchange="handleSkipVerifyChange2(event)">
                                <label for="skipVerify2" class="checkbox-label"
                                    title="نسخه Xray v26.1.31+ از رد کردن تأیید گواهی TLS پشتیبانی نمی‌کند">رد کردن تأیید گواهی</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="randomPathGroup2" style="display: none;">
                        <div class="input-wrapper">
                            <div class="checkbox-group">
                                <input type="checkbox" id="randomPath2" title="مسیر استتار تصادفی"
                                    onchange="markModified('config')">
                                <label for="randomPath2" class="checkbox-label" title="مسیر استتار تصادفی">مسیر استتار تصادفی</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="enable0RTTGroup2" style="display: none;">
                        <div class="input-wrapper">
                            <div class="checkbox-group">
                                <input type="checkbox" id="enable0RTT2" title="فعال‌سازی 0-RTT (مبتدی‌ها استفاده نکنند)"
                                    onchange="markModified('config')">
                                <label for="enable0RTT2" class="checkbox-label"
                                    title="فعال‌سازی 0-RTT (مبتدی‌ها استفاده نکنند)">فعال‌سازی 0-RTT (ed=2560)</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="tlsFragmentGroup2" style="display: none;">
                        <div class="input-wrapper">
                            <div class="checkbox-group">
                                <input type="checkbox" id="tlsFragmentShadowrocket2"
                                    title="قابلیت تکه‌تکه کردن TLS مخصوص Shadowrocket"
                                    onchange="handleTLSFragmentChange2('Shadowrocket'); markModified('config')">
                                <label for="tlsFragmentShadowrocket2" class="checkbox-label"
                                    title="قابلیت تکه‌تکه کردن TLS مخصوص Shadowrocket">فعال‌سازی تکه‌تکه کردن (Shadowrocket)</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="tlsFragmentHappGroup2" style="display: none;">
                        <div class="input-wrapper">
                            <div class="checkbox-group">
                                <input type="checkbox" id="tlsFragmentHapp2" title="قابلیت تکه‌تکه کردن TLS مخصوص Happ"
                                    onchange="handleTLSFragmentChange2('Happ'); markModified('config')">
                                <label for="tlsFragmentHapp2" class="checkbox-label"
                                    title="قابلیت تکه‌تکه کردن TLS مخصوص Happ">فعال‌سازی تکه‌تکه کردن (Happ)</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="module-footer">
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit('config')" disabled
                            id="cancelConfigBtn2">انصراف</button>
                        <button type="button" class="btn btn-primary" onclick="saveConfig()" disabled
                            id="saveConfigBtn2">ذخیره</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ماژول ECH -->
        <div class="module collapsed" style="margin-bottom: 20px;">
            <div class="module-title" onclick="toggleModule(this)">
                🔐 تنظیمات ECH
                <svg class="collapse-icon" viewBox="0 0 24 24">
                    <path d="M7 10l5 5 5-5z" />
                </svg>
            </div>
            <div class="module-content">
                <div class="form-group">
                    <label>تنظیمات ECH</label>
                    <div class="input-wrapper">
                        <div class="checkbox-group">
                            <input type="checkbox" id="enableECH2"
                                title="فعال‌سازی ECH می‌تواند از مسدود شدن دامنه جلوگیری کند!&#10;&#10;نسخه‌های پشتیبان&#10;v2rayN v7.17.0+&#10;v2rayNG v2.0.0+&#10;Clash.Meta(Mihomo)&#10;Singbox"
                                onchange="handleECHEnableChange2()">
                            <label for="enableECH2" class="checkbox-label"
                                title="فعال‌سازی ECH می‌تواند از مسدود شدن دامنه جلوگیری کند!&#10;&#10;نسخه‌های پشتیبان&#10;v2rayN v7.17.0+&#10;v2rayNG v2.0.0+&#10;Clash.Meta(Mihomo)&#10;Singbox">فعال‌سازی</label>
                        </div>
                    </div>
                </div>

                <div class="form-group" id="echDNSGroup2" style="display: none; align-items: start;">
                    <label for="echDNSSelect2" style="padding-top: 10px;">سرویس DNS ECH</label>
                    <div class="input-wrapper" style="flex-direction: column; align-items: stretch;">
                        <select id="echDNSSelect2" title="سرویس DNS ECH" style="display: none;"
                            onchange="onEchDNSSelectChange2()">
                            <option value="udp://208.67.220.220:443" data-region="بین‌المللی">
                                udp://208.67.220.220:443 (OpenDNS) - پیشنهاد برای مبتدی‌ها!!!</option>
                            <option value="udp://149.112.112.112:9953" data-region="بین‌المللی">
                                udp://149.112.112.112:9953 (Quad9)</option>
                            <option value="udp://45.90.28.0:5353" data-region="بین‌المللی">
                                udp://45.90.28.0:5353 (NextDNS)</option>
                            <option value="udp://188.166.206.224:5003" data-region="بین‌المللی">
                                udp://188.166.206.224:5003 (Tiarap)</option>
                            <option value="https://doh.applied-privacy.net/query" data-region="بین‌المللی">
                                https://doh.applied-privacy.net/query (Applied Privacy DoH)</option>
                            <option value="https://odvr.nic.cz/doh" data-region="بین‌المللی">
                                https://odvr.nic.cz/doh (CZ.NIC DoH)</option>
                            <option value="https://doh.cmliussss.net/CMLiussss" data-region="بین‌المللی">
                                https://doh.cmliussss.net/CMLiussss (Cloudflare DoH: Mirror CM)</option>
                            <option value="https://doh.cmliussss.com/CMLiussss" data-region="بین‌المللی">
                                https://doh.cmliussss.com/CMLiussss (Google DoH: Mirror CM)</option>
                            <option value="https://dns.alidns.com/dns-query" data-region="داخلی">
                                https://dns.alidns.com/dns-query (Ali DoH: نیاز به تنظیم دامنه تجزیه ECH)</option>
                            <option value="https://sm2.doh.pub/dns-query" data-region="داخلی">
                                https://sm2.doh.pub/dns-query (Tencent SM DoH: نیاز به تنظیم دامنه تجزیه ECH)</option>
                            <option value="https://doh.360.cn/dns-query" data-region="داخلی">
                                https://doh.360.cn/dns-query (360 DoH: نیاز به تنظیم دامنه تجزیه ECH)</option>
                            <option value="https://doh.onedns.net/dns-query" data-region="داخلی">
                                https://doh.onedns.net/dns-query (OneDNS DoH: نیاز به تنظیم دامنه تجزیه ECH)</option>
                            <option value="custom">سفارشی</option>
                        </select>
                        <input type="text" id="echDNSCustomInput2" title="سرویس DNS ECH سفارشی"
                            placeholder="udp://... یا https://..." onchange="onEchDNSCustomInput2()"
                            style="display: none; margin-top: 8px;">
                        <input type="hidden" id="echDNSValue2">
                    </div>
                </div>

                <div class="form-group" id="echSNIGroup2" style="display: none; align-items: start;">
                    <label for="echSNISelect2" style="padding-top: 10px;">دامنه تجزیه ECH</label>
                    <div class="input-wrapper" style="flex-direction: column; align-items: stretch;">
                        <select id="echSNISelect2" title="دامنه تجزیه ECH" style="display: none;"
                            onchange="onEchSNISelectChange2()">
                            <option value="__AUTO__">دریافت خودکار (استفاده از دامنه استتار نود)</option>
                            <option value="cloudflare-ech.com">cloudflare-ech.com (دامنه تست ECH Cloudflare) - پیشنهاد برای مبتدی‌ها!!!
                            </option>
                            <option value="crypto.cloudflare.com">crypto.cloudflare.com (سرویس رمزنگاری Cloudflare)</option>
                            <option value="icook.hk">icook.hk (iCook HK)</option>
                            <option value="cm.edu.kg">cm.edu.kg (CM University)</option>
                            <option value="godotengine.org">godotengine.org (موتور بازی Godot)</option>
                            <option value="www.britannica.com">www.britannica.com (دایره المعارف بریتانیکا)</option>
                            <option value="www.prometheus.io">www.prometheus.io (سیستم مانیتورینگ Prometheus)</option>
                            <option value="www.kyocera.com">www.kyocera.com (وب‌سایت Kyocera)</option>
                            <option value="celestia.org">celestia.org (بلاک‌چین ماژولار Celestia)</option>
                            <option value="lido.fi">lido.fi (Lido Staking)</option>
                            <option value="custom">سفارشی</option>
                        </select>
                        <input type="text" id="echSNICustomInput2" title="دامنه تجزیه ECH سفارشی"
                            placeholder="cloudflare-ech.com" onchange="onEchSNICustomInput2()"
                            style="display: none; margin-top: 8px;">
                        <input type="hidden" id="echSNIValue2">
                    </div>
                </div>

                <div class="module-footer">
                    <button type="button" class="btn btn-ech-help" onclick="showECHHelpModal()"
                        title="اطلاعات مربوط به ECH">
                        💡 چرا به ECH نیاز داریم؟ ECH چیست؟
                    </button>
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit('ech')" disabled
                            id="cancelEchBtn2">انصراف</button>
                        <button type="button" class="btn btn-primary" onclick="saveEch()" disabled
                            id="saveEchBtn2">ذخیره</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال کد QR -->
    <div class="modal-overlay" id="qrcodeModal" onclick="closeQRCode(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeQRCode()">×</button>
            <div id="qrcodeContainer" class="qrcode-container"></div>
            <button type="button" class="btn btn-primary btn-close-modal" onclick="closeQRCode()">بستن</button>
        </div>
    </div>

    <!-- مودال هشدار رد کردن تأیید گواهی -->
    <div class="modal-overlay" id="skipVerifyWarningModal" onclick="closeSkipVerifyWarning(event)">
        <div class="modal skipverify-warning-modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeSkipVerifyWarning()">×</button>
            <div class="skipverify-header">
                <div class="skipverify-icon">⚠️</div>
                <h2 class="skipverify-title">درباره رد کردن تأیید گواهی</h2>
            </div>
            <div class="skipverify-content" style="text-align: left;">
                <p class="skipverify-text"><strong>به‌روزرسانی مهم:</strong><a
                        href="https://github.com/XTLS/Xray-core/releases/tag/v26.1.31" target="_blank" rel="noopener"
                        class="skipverify-link">Xray-core v26.1.31</a>
                    و نسخه‌های بعدی به تدریج از قابلیت "<strong>رد کردن تأیید گواهی</strong>" پشتیبانی نخواهند کرد، این یک <strong>تغییر سیاست امنیتی هسته</strong> است (<a
                        href="https://github.com/XTLS/Xray-core/commit/2c92339f95fe9aa493b6ae51d3b07017a44c4014"
                        target="_blank" rel="noopener" class="skipverify-link">جزئیات</a>).</p>
                <p class="skipverify-text"><strong>دامنه تأثیر:</strong> اگر کلاینت شما (مانند <strong>v2rayN، v2rayNG، Happ</strong> و غیره) از
                    <strong>هسته Xray</strong> استفاده می‌کند، فعال‌سازی این قابلیت باعث <strong class="skipverify-title">عدم اجرای هسته</strong> می‌شود.
                </p>
            </div>
            <div class="skipverify-buttons">
                <button type="button" class="btn btn-confirm-skip-verify btn-confirm-reset"
                    onclick="confirmSkipVerify()">تأیید فعال‌سازی</button>
                <button type="button" class="btn btn-secondary" onclick="closeSkipVerifyWarning()">بستن</button>
            </div>
        </div>
    </div>

    <!-- مودال تأیید بازنشانی پیکربندی -->
    <div class="modal-overlay" id="resetModal" onclick="closeResetModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <h2 class="reset-modal-title">⚠️ بازنشانی پیکربندی</h2>
            <p class="reset-modal-description">بازنشانی پیکربندی تمام تنظیمات را به حالت اولیه برمی‌گرداند، شامل تولید اشتراک، اطلاعات نود، تنظیمات Proxy و غیره. این عملیات غیرقابل بازگشت است، لطفاً با دقت عمل کنید.</p>
            <p class="reset-modal-confirm">آیا از بازنشانی کامل پیکربندی اطمینان دارید؟</p>
            <div class="reset-modal-buttons">
                <button type="button" class="btn btn-primary btn-confirm-reset" onclick="confirmReset()">تأیید بازنشانی</button>
                <button type="button" class="btn btn-secondary" onclick="closeResetModal()">انصراف</button>
            </div>
        </div>
    </div>

    <!-- مودال تأیید پاک کردن پیکربندی Telegram -->
    <div class="modal-overlay" id="clearTelegramModal" onclick="closeClearTelegramModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <h2 class="reset-modal-title">⚠️ پاک کردن پیکربندی Telegram</h2>
            <p class="reset-modal-description">پس از پاک کردن پیکربندی اعلان Telegram Bot، دیگر قادر به دریافت اعلان‌های Telegram نخواهید بود. این عملیات غیرقابل بازگشت است، لطفاً با دقت عمل کنید.</p>
            <p class="reset-modal-confirm">آیا از پاک کردن پیکربندی اعلان Telegram اطمینان دارید؟</p>
            <div class="reset-modal-buttons">
                <button type="button" class="btn btn-primary btn-confirm-reset"
                    onclick="confirmClearTelegramConfig()">تأیید پاک کردن</button>
                <button type="button" class="btn btn-secondary" onclick="closeClearTelegramModal()">انصراف</button>
            </div>
        </div>
    </div>

    <!-- مودال تأیید پاک کردن پیکربندی Cloudflare -->
    <div class="modal-overlay" id="clearCloudflareModal" onclick="closeClearCloudflareModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <h2 class="reset-modal-title">⚠️ پاک کردن پیکربندی Cloudflare</h2>
            <p class="reset-modal-description">پس از پاک کردن پیکربندی Cloudflare، دیگر قادر به آمارگیری درخواست‌های Workers/Pages نخواهید بود. این عملیات غیرقابل بازگشت است، لطفاً با دقت عمل کنید.</p>
            <p class="reset-modal-confirm">آیا از پاک کردن پیکربندی اعلان Cloudflare اطمینان دارید؟</p>
            <div class="reset-modal-buttons">
                <button type="button" class="btn btn-primary btn-confirm-reset"
                    onclick="confirmClearCloudflareConfig()">تأیید پاک کردن</button>
                <button type="button" class="btn btn-secondary" onclick="closeClearCloudflareModal()">انصراف</button>
            </div>
        </div>
    </div>

    <!-- مودال مشاهده لاگ‌ها -->
    <div class="modal-overlay" id="logsModal">
        <div class="modal logs-modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeLogsModal()">×</button>
            <h2 class="logs-modal-title">📋 تمام لاگ‌های عملیات</h2>
            <div id="allLogsContainer" class="logs-all-container"></div>
            <button type="button" class="btn btn-primary btn-close-modal" onclick="closeLogsModal()">بستن</button>
        </div>
    </div>

    <!-- مودال تنظیمات بک‌اند تبدیل اشتراک -->
    <div class="modal-overlay" id="subAPIModal">
        <div class="modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeSubAPIModal()">×</button>
            <h2 class="subapi-modal-title">⚙️ بک‌اند تبدیل اشتراک</h2>
            <div class="form-group subapi-form-group">
                <label>بک‌اند تبدیل اشتراک</label>
                <select id="subAPISelect" onchange="handleSubAPISelectChange()">
                    <option value="">-- در حال بارگذاری، لطفاً صبر کنید --</option>
                </select>
            </div>
            <div class="form-group subapi-form-group" id="customSubAPIInputGroup" style="display: none;">
                <label>آدرس بک‌اند سفارشی</label>
                <input type="text" id="testSubAPIInput" placeholder="آدرس بک‌اند تبدیل اشتراک را وارد کنید">
            </div>
            <div id="subAPIStatus" class="subapi-status"></div>
            <div class="subapi-buttons">
                <button type="button" class="btn btn-primary btn-test-api" onclick="testSubAPI()">بررسی دسترسی</button>
                <button type="button" class="btn btn-primary btn-confirm-api" id="subAPIConfirmBtn"
                    onclick="confirmSubAPI()" disabled>تأیید</button>
                <button type="button" class="btn btn-secondary btn-cancel-api" onclick="closeSubAPIModal()">انصراف</button>
            </div>
        </div>
    </div>

    <!-- مودال تنظیمات اعلان TelegramBot -->
    <div class="modal-overlay" id="telegramConfigModal">
        <div class="modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeTelegramConfigModal()">×</button>
            <h2 class="subapi-modal-title">🤖 پیکربندی پارامترهای اعلان TelegramBot</h2>
            <div class="form-group subapi-form-group">
                <label>Bot Token</label>
                <input type="text" id="telegramBotToken" placeholder="Telegram Bot Token را وارد کنید">
            </div>
            <div class="form-group subapi-form-group">
                <label>Chat ID</label>
                <input type="text" id="telegramChatID" placeholder="Chat ID را وارد کنید">
            </div>
            <div id="telegramStatus" class="subapi-status"></div>
            <div class="subapi-buttons">
                <button type="button" class="btn btn-primary btn-test-api" onclick="testTelegramConfig()">بررسی دسترسی</button>
                <button type="button" class="btn btn-primary btn-confirm-api" id="telegramConfirmBtn"
                    onclick="confirmTelegramConfig()" disabled>ذخیره</button>
                <button type="button" class="btn btn-secondary btn-cancel-api"
                    onclick="closeTelegramConfigModal()">انصراف</button>
            </div>
        </div>
    </div>

    <!-- مودال تنظیمات اعلان Cloudflare -->
    <div class="modal-overlay" id="cloudflareConfigModal">
        <div class="modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeCloudflareConfigModal()">×</button>
            <h2 class="subapi-modal-title">☁️ آمار درخواست‌های قابل استفاده Workers/Pages</h2>

            <!-- انتخاب روش درخواست -->
            <div class="form-group subapi-form-group">
                <label>روش درخواست</label>
                <select id="cloudflareAuthMethod" title="روش درخواست" onchange="updateCloudflareAuthMethod()">
                    <option id="usageapiOption" value="usageapi">UsageAPI</option>
                    <option value="accountid">Account ID + API Token</option>
                    <option value="email">Email + Global API Key</option>
                </select>
            </div>

            <!-- روش Email + Global API Key -->
            <div id="cloudflareEmailSection">
                <div class="form-group subapi-form-group">
                    <label>Email</label>
                    <input type="text" id="cloudflareEmail" placeholder="ایمیل حساب Cloudflare را وارد کنید">
                </div>
                <div class="form-group subapi-form-group">
                    <label>Global API Key</label>
                    <input type="password" id="cloudflareGlobalAPIKey" placeholder="Global API Key را وارد کنید">
                </div>
            </div>

            <!-- روش Account ID + API Token -->
            <div id="cloudflareAccountIDSection" class="hidden-section">
                <div class="form-group subapi-form-group">
                    <label>Account ID</label>
                    <input type="text" id="cloudflareAccountID" placeholder="Account ID را وارد کنید">
                </div>
                <div class="form-group subapi-form-group">
                    <label>API Token</label>
                    <input type="password" id="cloudflareAPIToken" placeholder="API Token را وارد کنید">
                    <small style="font-size: 12px; color: #9ca3af; margin-top: 6px; display: block;">💡 برای مجوز API Token از
                        قالب "خواندن داده‌های تحلیلی و لاگ‌ها" استفاده کنید</small>
                </div>
            </div>

            <!-- روش UsageAPI -->
            <div id="cloudflareUsageAPISection" class="hidden-section">
                <div class="form-group subapi-form-group">
                    <label>آدرس UsageAPI</label>
                    <input type="text" id="cloudflareUsageAPI"
                        placeholder="https://usagepanel.pages.dev/usage.json?token=4941477918857b30d8234ac19441ebb2">
                    <small style="font-size: 12px; color: #9ca3af; margin-top: 6px; display: block;">💡 پشتیبانی از تجمیع چند حساب، می‌توانید با استقرار پروژه <a
                            href="https://github.com/cmliu/CF-Workers-UsagePanel" target="_blank" rel="noopener"
                            style="color: #3b82f6; text-decoration: none;">UsagePanel</a> آدرس UsageAPI را دریافت کنید</small>
                </div>
            </div>

            <!-- پیام وضعیت تأیید -->
            <div id="cloudflareStatus" class="subapi-status"></div>

            <!-- گروه دکمه‌ها -->
            <div class="subapi-buttons">
                <button type="button" class="btn btn-primary btn-test-api"
                    onclick="testCloudflareConfig()">بررسی دسترسی</button>
                <button type="button" class="btn btn-primary btn-confirm-api" id="cloudflareConfirmBtn"
                    onclick="confirmCloudflareConfig()" disabled>ذخیره</button>
                <button type="button" class="btn btn-secondary btn-cancel-api"
                    onclick="closeCloudflareConfigModal()">انصراف</button>
            </div>
        </div>
    </div>

    <!-- مودال بهینه‌سازی آنلاین -->
    <div class="modal-overlay" id="onlineOptimizeModal">
        <div class="modal optimize-modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeOnlineOptimizeModal()">×</button>
            <h2 class="optimize-modal-title">🚀 بهینه‌سازی آنلاین</h2>

            <!-- اطلاعات تشخیص IP -->
            <div id="ipDetectionBox" class="ip-detection-box">
                <div class="ip-detection-info">
                    در حال بررسی محیط شبکه شما...
                </div>
            </div>

            <!-- انتخاب پارامترها -->
            <div class="optimize-params-row">
                <div class="form-group">
                    <label for="optimizeIPLibrary">کتابخانه IP:</label>
                    <select id="optimizeIPLibrary">
                        <option value="cf-official">لیست رسمی CF</option>
                        <option value="cm-list">لیست مرتب CM</option>
                        <option value="as13335">لیست AS13335</option>
                        <option value="as209242">لیست AS209242</option>
                        <option value="reverse-proxy">لیست Proxy معکوس CM</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="optimizePort">پورت:</label>
                    <select id="optimizePort">
                        <option value="443">443</option>
                        <option value="2053">2053</option>
                        <option value="2083">2083</option>
                        <option value="2087">2087</option>
                        <option value="2096">2096</option>
                        <option value="8443">8443</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="optimizeConcurrency">تعداد رشته‌های تست:</label>
                    <input type="number" id="optimizeConcurrency" min="1" max="32" value="8"
                        class="optimize-concurrency-input" placeholder="1-32" oninput="validateConcurrency(this)"
                        onchange="validateConcurrency(this)">
                </div>
            </div>

            <!-- نوار پیشرفت -->
            <div class="optimize-progress-bar hidden-section" id="optimizeProgressBar">
                <div class="optimize-progress-fill" id="optimizeProgressFill"></div>
                <div class="optimize-progress-text" id="optimizeProgressText">0/512 (0.00%) - موفق: 0, ناموفق: 0</div>
            </div>

            <!-- تب‌های نتیجه -->
            <div id="optimizeResultsTabs" class="optimize-results-tabs hidden-section"></div>

            <!-- محتوای نتیجه -->
            <div id="optimizeResultsContent" class="optimize-results-content hidden-section"></div>

            <!-- گروه دکمه‌ها -->
            <div class="optimize-buttons">
                <span class="save-tip">💡 راهنمای ذخیره: فقط 16 IP بهینه با کمترین تاخیر ذخیره می‌شوند</span>
                <button type="button" class="btn btn-start-optimize" id="btnStartOptimize"
                    onclick="startOptimize()">شروع بهینه‌سازی</button>
                <button type="button" class="btn btn-save-override" id="btnSaveOverride"
                    onclick="saveOptimizeResults('override')" disabled>ذخیره جایگزینی</button>
                <button type="button" class="btn btn-save-append" id="btnSaveAppend"
                    onclick="saveOptimizeResults('append')" disabled>ذخیره افزودن</button>
                <button type="button" class="btn btn-secondary" onclick="closeOnlineOptimizeModal()">بستن</button>
            </div>
        </div>
    </div>

    <!-- مودال بهینه‌سازی API -->
    <div class="modal-overlay" id="apiOptimizeModal">
        <div class="modal api-optimize-modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeAPIOptimizeModal()">×</button>
            <h2 class="api-optimize-modal-title">🔌 رابط اشتراک</h2>

            <!-- ورودی API URL -->
            <div class="api-form-group">
                <div class="api-form-row">
                    <label>API URL:</label>
                    <input type="text" id="apiOptimizeURL" placeholder="لطفاً آدرس API بهینه یا آدرس اشتراک تجمیعی را وارد کنید"
                        title="لطفاً آدرس API بهینه یا آدرس اشتراک تجمیعی را وارد کنید" oninput="autoConvertGitHubURL(); autoDetectPortFromURL()">
                </div>
            </div>

            <!-- ورودی پورت پیش‌فرض -->
            <div class="api-form-group">
                <div class="api-form-row">
                    <label>پورت پیش‌فرض:</label>
                    <input type="number" id="apiOptimizePort" value="443" min="1" max="65535" placeholder="1-65535"
                        title="پورت پیش‌فرض (1-65535)">
                </div>
            </div>

            <!-- ناحیه نمایش نتایج -->
            <div class="api-results-container">
                <label class="api-results-label">نتایج رابط:</label>
                <div class="line-editor" id="apiResultsEditor">
                    <div class="gutter" aria-hidden="true"></div>
                    <div class="editor-area">
                        <pre class="mirror" aria-hidden="true"></pre>
                        <textarea id="apiOptimizeResults" title="نتایج رابط API" placeholder="نتایج بازگشتی رابط اینجا نمایش داده می‌شود، هر خط یک آدرس"
                            readonly></textarea>
                    </div>
                </div>
            </div>

            <!-- گروه دکمه‌ها -->
            <div class="api-buttons">
                <button type="button" class="btn btn-verify-api" id="btnVerifyAPI"
                    onclick="verifyAPIOptimize()">بررسی دسترسی</button>
                <button type="button" class="btn btn-append-api" id="btnAppendAPI" onclick="appendAPIToCustom()"
                    disabled>افزودن API</button>
                <button type="button" class="btn btn-append-results" id="btnAppendResults"
                    onclick="appendResultsToCustom()" disabled>افزودن نتایج</button>
                <button type="button" class="btn btn-close-api" onclick="closeAPIOptimizeModal()">بستن</button>
            </div>
        </div>
    </div>

    <!-- مودال تأیید پروکسی -->
    <div class="modal-overlay" id="proxyVerificationModal">
        <div class="modal" id="proxyVerificationContent" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeProxyVerificationModal()">×</button>

            <h2 id="proxyVerificationTitle"
                style="margin-bottom: 20px; font-size: 18px; font-weight: 600; text-align: center;"></h2>

            <div class="form-group" style="margin-bottom: 20px;">
                <label id="proxyVerificationLabel" for="proxyVerificationInput"
                    style="display: block; margin-bottom: 10px; font-weight: 600;"></label>
                <input type="text" id="proxyVerificationInput" title="آدرس پروکسی"
                    style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>

            <div id="proxyVerificationStatus"
                style="margin-bottom: 20px; padding: 12px; border-radius: 8px; display: none; font-size: 14px;">
            </div>

            <div class="api-buttons" style="gap: 10px; justify-content: space-between;">
                <button type="button" class="btn btn-verify-api" onclick="verifyProxyAvailability()">
                    بررسی دسترسی
                </button>
                <button type="button" class="btn btn-append-api" id="proxyConfirmBtn" onclick="confirmProxyAddress()"
                    style="opacity: 0.5;" disabled>
                    تأیید
                </button>
                <button type="button" class="btn btn-close-api" onclick="closeProxyVerificationModal()">
                    انصراف
                </button>
            </div>
            <!-- placeholder برای چیدمان موبایل -->
            <div class="btn-append-results" style="display: none;"></div>
        </div>
    </div>
    </div>

    <!-- مودال راهنما و اطلاعات ProxyIP -->
    <div class="modal-overlay" id="proxyIPHelpModal" onclick="closeProxyIPHelpModal(event)">
        <div class="modal proxyip-help-modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeProxyIPHelpModal()">×</button>

            <!-- حالت ساده -->
            <div id="proxyIPHelpSimple" style="display: none;">
                <div class="api-docs">
                    <h2 class="section-title">🤔 چرا به حالت Proxy نیاز داریم؟ PROXYIP چیست؟</h2>

                    <div class="simple-explanation">
                        <strong>ساده‌ترین توضیح:</strong><br><br>

                        <strong>🚀 مشکل چیست:</strong><br>
                        سرویس edgetunnel ما روی Cloudflare Workers مستقر است. اما Cloudflare محدودیتی دارد - Workers آن‌ها نمی‌توانند مستقیماً به سرویس‌های خود Cloudflare دسترسی داشته باشند.<br><b>مثل اینکه Cloudflare نمی‌تواند خودش را در آینه ببیند.</b><br><br>

                        <strong>💡 راه‌حل:</strong><br>
                        برای حل این مشکل، نیاز به سرورهای خارجی (ProxyIP، SOCKS5 یا HTTP) به عنوان «پل» داریم، تا از طریق این سرورهای شخص ثالث به سرویس‌های Cloudflare دسترسی پیدا کنیم.<br><b>مثل اینکه یک آینه (ProxyIP/SOCKS5/HTTP) پیدا کرده‌ایم تا Cloudflare بتواند خودش را در آن ببیند.</b><br><br>

                        <strong>📍 نتیجه عملی:</strong>
                        <ul style="margin: 12px 0 0 20px; padding-left: 0;">
                            <li style="margin-bottom: 8px;">👤 هنگام دسترسی به <strong>سایت‌های غیر Cloudflare CDN
                                    </strong> (مانند <b>YouTube، Google</b> و غیره)، IP شما توسط «IP بهینه» تعیین می‌شود</li>
                            <li>🌐 هنگام دسترسی به <strong>سایت‌های میزبانی شده توسط Cloudflare CDN</strong> (مانند <b>Twitter، ChatGPT</b> و غیره)، IP شما توسط «حالت Proxy (PROXYIP/SOCKS5/HTTP)» تعیین می‌شود</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- حالت جزئی -->
            <div id="proxyIPHelpDetail" style="display: block;">
                <div class="api-docs">
                    <h2 class="section-title">🤔 چرا به حالت Proxy نیاز داریم؟ PROXYIP چیست؟</h2>
                    <h3 style="color: var(--text-primary); margin: 24px 0 16px;">❓ چرا به حالت Proxy نیاز داریم؟</h3>
                    <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                        طبق <a
                            href="https://developers.cloudflare.com/workers/runtime-apis/tcp-sockets/" target="_blank"
                            rel="noopener" style="color: var(--primary-color); text-decoration: none;">مستندات رسمی TCP Sockets
                            </a> Cloudflare Workers، محدودیت فنی زیر وجود دارد:
                    </p>
                    <div class="code-block">
                        ⚠️ Outbound TCP sockets to <a href="https://www.cloudflare.com/ips/" target="_blank"
                            rel="noopener" style="color: inherit; text-decoration: underline;">Cloudflare IP ranges
                            ↗</a> are temporarily blocked, but will be re-enabled shortly.
                    </div>

                    <p style="margin: 16px 0; line-height: 1.8; color: var(--text-secondary);">
                        این به این معناست که Cloudflare Workers نمی‌تواند مستقیماً به محدوده IPهای Cloudflare متصل شود. برای حل این محدودیت، نیاز به سرورهای شخص ثالث به عنوان «پل» داریم:
                    </p>

                    <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                        <b>edgetunnel</b> ما یک سرویس Proxy روی Cloudflare Workers است. طبق سیاست‌های محدودکننده Cloudflare Workers،
                        نودهای Workers نمی‌توانند مستقیماً به محدوده IPهای Cloudflare متصل شوند. این یعنی:
                    </p>
                    <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                        <li style="margin-bottom: 8px; color: var(--text-secondary);">✅ می‌توان به طور عادی به سایت‌های غیر Cloudflare CDN دسترسی داشت</li>
                        <li style="color: var(--text-secondary);">❌ نمی‌توان مستقیماً به سایت‌های میزبانی شده توسط Cloudflare CDN دسترسی داشت</li>
                    </ul>
                    <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                        بنابراین نیاز به حالت Proxy برای حل این مشکل داریم. حالت Proxy از طریق سرورهای شخص ثالث به عنوان «واسطه»، به Workers کمک می‌کند این محدودیت را دور بزند.
                    </p>

                    <div
                        style="background: var(--bg-secondary); padding: 20px; border-radius: var(--border-radius-sm); margin: 20px 0;">
                        <div
                            style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 16px;">
                            <div
                                style="background: #e3f2fd; padding: 12px; border-radius: 8px; text-align: center; flex: 1; min-width: 120px;">
                                <div style="font-weight: 600; color: #1976d2;">Cloudflare Workers</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">ارسال درخواست</div>
                            </div>
                            <div style="color: var(--primary-color); font-size: 1.5rem;">→</div>
                            <div
                                style="background: #f3e5f5; padding: 12px; border-radius: 8px; text-align: center; flex: 1; min-width: 120px;">
                                <div style="font-weight: 600; color: #7b1fa2;">سرور PROXYIP/SOCKS5/HTTP</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">پروکسی شخص ثالث</div>
                            </div>
                            <div style="color: var(--primary-color); font-size: 1.5rem;">→</div>
                            <div
                                style="background: #e8f5e8; padding: 12px; border-radius: 8px; text-align: center; flex: 1; min-width: 120px;">
                                <div style="font-weight: 600; color: #388e3c;">سرویس Cloudflare</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">سرویس مقصد</div>
                            </div>
                        </div>
                        <p style="text-align: center; color: var(--text-secondary); font-size: 0.95rem; margin: 0;">
                            از طریق Proxy معکوس سرورهای شخص ثالث به پورت 443 Cloudflare، دسترسی Workers به سرویس‌های Cloudflare فراهم می‌شود
                        </p>
                    </div>

                    <h3 style="color: var(--text-primary); margin: 24px 0 16px;">💡 نتیجه عملی</h3>
                    <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                        بنابراین، موقعیت IP شما هنگام دسترسی به شبکه به نوع سایت مقصد بستگی دارد:
                    </p>
                    <ul style="margin: 12px 0; padding-left: 20px; line-height: 1.8;">
                        <li style="margin-bottom: 12px; color: var(--text-secondary);">👤 هنگام دسترسی به <strong>سایت‌های غیر Cloudflare CDN
                                </strong> (مانند <b>YouTube، Google</b> و غیره)، موقعیت IP شما توسط «IP بهینه» تعیین می‌شود</li>
                        <li style="color: var(--text-secondary);">🌐 هنگام دسترسی به <strong>سایت‌های میزبانی شده توسط Cloudflare CDN
                                </strong> (مانند <b>Twitter، ChatGPT</b> و غیره)، موقعیت IP شما توسط «ProxyIP/SOCKS5/HTTP» تعیین می‌شود</li>
                    </ul>
                </div>
            </div>

            <!-- دکمه تغییر -->
            <div class="toggle-switch">
                <input type="checkbox" id="proxyIPSimpleMode" onchange="toggleProxyIPHelpMode()">
                <label for="proxyIPSimpleMode">حالت ساده (مبتدی)</label>
            </div>

            <button type="button" class="btn btn-primary btn-close-modal" onclick="closeProxyIPHelpModal()"
                style="margin-top: 20px;">بستن</button>
        </div>
    </div>

    <!-- مودال راهنمای ECH -->
    <div class="modal-overlay" id="echHelpModal" onclick="closeECHHelpModal(event)">
        <div class="modal ech-help-modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeECHHelpModal()">×</button>

            <!-- تب‌ها -->
            <div class="ech-tabs">
                <button class="ech-tab active" onclick="switchECHTab(0)">ECH چیست؟</button>
                <button class="ech-tab" onclick="switchECHTab(1)">چگونه استفاده کنیم؟</button>
                <button class="ech-tab" onclick="switchECHTab(2)">چگونه تأیید کنیم ECH فعال است؟</button>
            </div>

            <!-- محتوای تب‌ها -->
            <div class="ech-tab-content">
                <div class="ech-tab-pane active" id="echTab0">
                    <div class="api-docs">
                        <h2 class="section-title">🔐 ECH چیست؟</h2>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            <strong>ECH (Encrypted Client Hello، سلام مشتری رمزنگاری شده)</strong> یک ویژگی جدید در TLS است که 
                            <strong>اطلاعات دامنه‌ای که معمولاً به صورت plaintext نمایش داده می‌شود را نیز رمزنگاری می‌کند</strong>.
                        </p>

                        <h3 style="color: var(--text-primary); margin: 24px 0 16px;">📖 توضیحات پس‌زمینه</h3>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            وقتی از نودهای <strong>WS + TLS</strong> برای پروکسی استفاده می‌کنیم:
                        </p>

                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">✅ محتوای واقعی ارتباط قبلاً توسط TLS رمزنگاری شده، GFW
                                <strong>نمی‌تواند محتوای خاصی که بازدید می‌کنید را ببیند</strong>
                            </li>
                            <li style="color: var(--text-secondary);">❌ اما در مرحله TLS handshake، یک اطلاعات کلیدی همچنان فاش می‌شود: <strong>SNI</strong>
                            </li>
                        </ul>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            <strong>SNI همان دامنه استتار نود (HOST) است</strong>
                        </p>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            یعنی:
                        </p>

                        <div class="code-block"
                            style="background: #fff3cd; color: #856404; border-left-color: #ffc107;">
                            GFW هرچند نمی‌داند چه چیزی را بازدید می‌کنید، اما می‌داند در حال "عبور از فیلتر" هستید و به کدام دامنه متصل شده‌اید.
                        </div>

                        <h3 style="color: var(--text-primary); margin: 24px 0 16px;">⚠️ چه مشکلی ایجاد می‌کند؟</h3>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            به همین دلیل است که در سناریوهای زیر اغلب مشکلات غیرعادی رخ می‌دهد:
                        </p>

                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">❌ تست تأخیر لینک واقعی v2rayN به صورت گروهی</li>
                            <li style="color: var(--text-secondary);">❌ انتخاب خودکار نود در گروه سیاست Clash</li>
                        </ul>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            معمولاً نشانه‌های زیر را دارد:
                        </p>

                        <div class="code-block"
                            style="background: #f8d7da; color: #721c24; border-left-color: #dc3545;">
                            تمام نودها لحظه‌ای -1 می‌شوند و کاملاً غیرقابل استفاده می‌شوند
                        </div>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            دلیل آن این نیست که نودها واقعاً از کار افتاده‌اند، بلکه <strong>اپراتور / GFW با مسدود کردن دسترسی به دامنه نودها، ارتباط پروکسی را مختل می‌کند</strong>.<br>
                            از آنجا که این نوع مسدودسازی عمدتاً استراتژی خودکار است و به راحتی اشتباه می‌کند، بنابراین <strong>بعد از مدتی نودها ممکن است دوباره عادی شوند</strong>، و این چرخه تکرار می‌شود.
                        </p>

                        <h3 style="color: var(--text-primary); margin: 24px 0 16px;">💡 نقش ECH</h3>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            نقش اصلی ECH:
                        </p>

                        <div class="code-block"
                            style="background: #d1ecf1; color: #0c5460; border-left-color: #17a2b8;">
                            رمزنگاری SNI (یعنی دامنه نود)
                        </div>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            پس از فعال‌سازی ECH:
                        </p>

                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">✅ GFW
                                <strong>نمی‌تواند دامنه واقعی نود را دریافت کند</strong>
                            </li>
                            <li style="color: var(--text-secondary);">✅ دامنه مشاهده شده از بیرون به صورت یکپارچه نمایش داده می‌شود: <code
                                    style="background: #e9ecef; padding: 2px 4px; border-radius: 3px;">cloudflare-ech.com</code>
                            </li>
                        </ul>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            این از ریشه <strong>روش مسدودسازی دقیق نودها از طریق دامنه را قطع می‌کند</strong>.
                        </p>

                        <h3 style="color: var(--text-primary); margin: 24px 0 16px;">🤔 آیا ECH مسدود می‌شود؟</h3>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            از نظر تئوری، GFW فقط باید <strong>به طور مستقیم <code>cloudflare-ech.com</code> را مسدود کند</strong>.
                        </p>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            اما این کار:
                        </p>

                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">❌ آسیب به تعداد زیادی از وب‌سایت‌ها و سرویس‌هایی که به طور عادی از ECH استفاده می‌کنند</li>
                            <li style="color: var(--text-secondary);">❌ هزینه و عوارض جانبی بالایی برای مسدودسازی به همراه دارد</li>
                        </ul>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            بنابراین،<strong>مدت زمان دوام ECH به تصمیم و استراتژی GFW بستگی دارد</strong>، حداقل در مرحله فعلی هنوز بسیار مؤثر است.
                        </p>
                    </div>
                </div>

                        <h3 style="color: var(--text-primary); margin: 24px 0 16px;">⚠️ چه مشکلاتی ایجاد می‌کند؟</h3>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            به همین دلیل است که در سناریوهای زیر اغلب ناهنجاری رخ می‌دهد:
                        </p>

                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">❌ تست دسته‌ای تاخیر واقعی نود توسط v2rayN</li>
                            <li style="color: var(--text-secondary);">❌ انتخاب خودکار نود توسط گروه استراتژی Clash</li>
                        </ul>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            معمولاً به این صورت ظاهر می‌شود:
                        </p>

                        <div class="code-block"
                            style="background: #f8d7da; color: #721c24; border-left-color: #dc3545;">
                            تمام نودها فوراً -1، همه غیرقابل استفاده
                        </div>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            دلیلش این نیست که نودها واقعاً از کار افتاده‌اند، بلکه <strong>اپراتور / GFW با مسدود کردن دسترسی به دامنه نودها اتصال پروکسی را مختل می‌کند</strong>.<br>
                            از آنجایی که این مسدودسازی بیشتر استراتژی خودکار است و به راحتی اشتباه می‌کند، بنابراین <strong>پس از مدتی نودها ممکن است دوباره به حالت عادی برگردند</strong>، و این چرخه تکرار می‌شود.
                        </p>

                        <h3 style="color: var(--text-primary); margin: 24px 0 16px;">💡 نقش ECH</h3>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            نقش اصلی ECH این است:
                        </p>

                        <div class="code-block"
                            style="background: #d1ecf1; color: #0c5460; border-left-color: #17a2b8;">
                            رمزنگاری SNI (یعنی دامنه نود)
                        </div>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            پس از فعال‌سازی ECH:
                        </p>

                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">✅ GFW
                                <strong>نمی‌تواند دامنه واقعی نود را بدست آورد</strong>
                            </li>
                            <li style="color: var(--text-secondary);">✅ دامنه مشاهده شده از بیرون به طور یکسان نمایش داده می‌شود: <code
                                    style="background: #e9ecef; padding: 2px 4px; border-radius: 3px;">cloudflare-ech.com</code>
                            </li>
                        </ul>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            این از ریشه <strong>روش مسدودسازی دقیق نودها از طریق دامنه را مسدود می‌کند</strong>.
                        </p>

                        <h3 style="color: var(--text-primary); margin: 24px 0 16px;">🤔 آیا ECH مسدود می‌شود؟</h3>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            از نظر تئوری، GFW فقط <strong>مستقیماً <code>cloudflare-ech.com</code></strong> را مسدود کند.
                        </p>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            اما این کار باعث می‌شود:
                        </p>

                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">❌ آسیب رساندن به تعداد زیادی از وب‌سایت‌ها و سرویس‌هایی که از ECH استفاده می‌کنند</li>
                            <li style="color: var(--text-secondary);">❌ هزینه مسدودسازی بالا و عوارض جانبی زیاد</li>
                        </ul>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            بنابراین،<strong>مدت زمان دوام ECH به تصمیم و استراتژی GFW بستگی دارد</strong>، حداقل در مرحله فعلی هنوز بسیار مؤثر است.
                        </p>
                    </div>
                </div>

                <div class="ech-tab-pane" id="echTab1">
                    <div class="api-docs">
                        <h2 class="section-title">🚀 چگونه از ECH استفاده کنیم؟</h2>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            استفاده از ECH بسیار ساده است، فقط کافیست <strong>تنظیمات ECH</strong> را <strong>فعال</strong> کنید و سپس اشتراک را به‌روزرسانی کنید.
                        </p>

                        <h3 style="color: var(--text-primary); margin: 24px 0 16px;">📱 کلاینت‌های پشتیبان ECH</h3>

                        <h4 style="color: var(--text-primary); margin: 20px 0 12px;">Windows:</h4>
                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">
                                <strong>v2rayN ≥ v7.17.0</strong><br>
                                <a href="https://github.com/2dust/v2rayN/releases" target="_blank" rel="noopener"
                                    style="color: var(--primary-color); text-decoration: none;">https://github.com/2dust/v2rayN/releases</a>
                            </li>
                        </ul>

                        <h4 style="color: var(--text-primary); margin: 20px 0 12px;">Android:</h4>
                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">
                                <strong>v2rayNG ≥ v2.0.0</strong><br>
                                <a href="https://github.com/2dust/v2rayNG/releases" target="_blank" rel="noopener"
                                    style="color: var(--primary-color); text-decoration: none;">https://github.com/2dust/v2rayNG/releases</a>
                            </li>
                        </ul>

                        <h4 style="color: var(--text-primary); margin: 20px 0 12px;">Clash.Meta (هسته mihomo):</h4>
                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">
                                تمام کلاینت‌هایی که از <strong>هسته clash.meta / mihomo</strong> استفاده می‌کنند، از ECH پشتیبانی می‌کنند
                            </li>
                            <li style="color: var(--text-secondary);">
                                ⚠️ <strong>نیاز به استفاده از DNS دارد</strong>
                            </li>
                        </ul>

                        <h3 style="color: var(--text-primary); margin: 24px 0 16px;">⚠️ نکات مهم برای کاربران Clash</h3>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            در پیکربندی اشتراک فعلی، <strong>تنظیمات DNS مورد نیاز ECH قبلاً تعبیه شده است</strong>.
                        </p>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            اگر شرایط زیر رخ دهد:
                        </p>

                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">✅ ECH فعال است</li>
                            <li style="margin-bottom: 8px; color: var(--text-secondary);">✅ اشتراک به‌روزرسانی شده</li>
                            <li style="color: var(--text-secondary);">❌ نودهای ECH همچنان غیرقابل استفاده هستند</li>
                        </ul>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            لطفاً بررسی کنید:
                        </p>

                        <div class="code-block"
                            style="background: #fff3cd; color: #856404; border-left-color: #ffc107;">
                            آیا در هنگام به‌روزرسانی اشتراک، پیکربندی DNS اصلی را بازنویسی کرده‌اید
                        </div>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            پیشنهاد: <strong>تنظیمات DNS داخلی اشتراک را بازنویسی نکنید</strong>
                        </p>
                    </div>
                </div>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            پیشنهاد: <strong>تنظیمات DNS داخلی اشتراک را بازنویسی نکنید</strong>
                        </p>
                    </div>
                </div>

                <div class="ech-tab-pane" id="echTab2">
                    <div class="api-docs">
                        <h2 class="section-title">🔍 چگونه تأیید کنیم ECH فعال شده است؟</h2>

                        <p style="margin-bottom: 16px; line-height: 1.8; color: var(--text-secondary);">
                            می‌توان با یک <strong>روش ساده و شهودی</strong> بررسی کرد که آیا ECH به درستی کار می‌کند یا خیر.
                        </p>

                        <h3 style="color: var(--text-primary); margin: 24px 0 16px;">📋 مراحل تأیید</h3>

                        <ol style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 12px; color: var(--text-secondary);"><strong>「⚙️ اطلاعات پیکربندی جزئی»</strong> نود را باز کنید</li>
                            <li style="margin-bottom: 12px; color: var(--text-secondary);">در قسمت <strong>HOST</strong>
                                یک <strong>دامنه مسدود شده</strong> را به صورت دستی وارد کنید، مثلاً: <code
                                    style="background: #e9ecef; padding: 2px 4px; border-radius: 3px;">*.workers.dev</code>
                            </li>
                            <li style="margin-bottom: 12px; color: var(--text-secondary);">پس از ذخیره پیکربندی، <strong>اشتراک را دوباره به‌روزرسانی کنید</strong>
                            </li>
                            <li style="color: var(--text-secondary);">در لیست نودها جستجو کنید:
                                <ul style="margin: 8px 0 0 20px; padding-left: 0;">
                                    <li style="margin-bottom: 4px;">- نودی با HOST <code
                                            style="background: #e9ecef; padding: 2px 4px; border-radius: 3px;">*.workers.dev</code>
                                        </li>
                                    <li>- و سعی کنید به آن نود متصل شوید</li>
                                </ul>
                            </li>
                        </ol>

                        <h3 style="color: var(--text-primary); margin: 24px 0 16px;">✅ چگونه نتیجه را تشخیص دهیم؟</h3>

                        <ul style="margin: 12px 0 16px; padding-left: 20px; line-height: 1.8;">
                            <li style="margin-bottom: 12px; color: var(--text-secondary);">
                                <strong style="color: #28a745;">✅ اگر نود می‌تواند به طور عادی متصل شود و استفاده شود</strong><br>
                                یعنی <strong>ECH با موفقیت فعال شده است</strong>، دامنه واقعی مسدود شده پنهان شده و برای بیرون فقط <code
                                    style="background: #e9ecef; padding: 2px 4px; border-radius: 3px;">cloudflare-ech.com</code> نمایش داده می‌شود
                            </li>
                            <li style="color: var(--text-secondary);">
                                <strong style="color: #dc3545;">❌ اگر نود نمی‌تواند متصل شود</strong><br>
                                یعنی ECH فعال نشده، یا نسخه کلاینت/پیکربندی DNS مشکل دارد
                            </li>
                        </ul>
                    </div>
                </div>
                </div>
            </div>

            <button type="button" class="btn btn-primary btn-close-modal" onclick="closeECHHelpModal()"
                style="margin-top: 20px;">بستن</button>
        </div>
    </div>

    <!-- مودال ویرایش HOSTS -->
    <div class="modal-overlay" id="hostsEditModal">
        <div class="modal hosts-edit-modal" onclick="event.stopPropagation()">
            <button type="button" class="modal-close" onclick="closeHostsEditModal()">×</button>
            <h2 class="hosts-edit-modal-title">✏️ ویرایش لیست دامنه‌های سفارشی نود</h2>

            <div class="hosts-edit-container">
                <label class="hosts-edit-label">لیست دامنه‌های سفارشی:</label>
                <textarea id="hostsEditTextarea" class="hosts-edit-textarea" placeholder="هر خط یک دامنه وارد کنید"></textarea>
            </div>

            <div class="hosts-edit-footer">
                <div class="hosts-edit-hint">💡 هر خط یک دامنه نود، نیازی به اضافه کردن کاما نیست</div>
                <div class="hosts-edit-buttons">
                    <button type="button" class="btn btn-hosts-cancel" onclick="closeHostsEditModal()">انصراف</button>
                    <button type="button" class="btn btn-hosts-confirm" onclick="confirmHostsEdit()">تأیید</button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال پیکربندی قالب مسیر -->
    <div class="modal-overlay" id="pathTemplateConfigModal" onclick="closePathTemplateConfigModal(event)">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px;">
            <button type="button" class="modal-close" onclick="closePathTemplateConfigModal()">×</button>
            <h2 class="path-template-modal-title">⚙️ پیکربندی قالب مسیر</h2>

            <div class="path-template-hint"
                style="font-size: 12px; color: #374151; margin-bottom: 16px; padding: 8px 12px; background-color: #f3f4f6; border-radius: 4px;">
                💡 در قالب مسیر باید حتماً placeholder مسیر <code
                    style="background-color: #d1d5db; padding: 2px 4px; border-radius: 2px; color: #1e293b; font-weight: 500;">{{IP:PORT}}</code>
                وجود داشته باشد تا با proxy معکوس مسیر سازگار شود
            </div>

            <div class="form-group">
                <label for="presetTemplateSelect">قالب از پیش تعیین شده</label>
                <select id="presetTemplateSelect" onchange="onPresetTemplateChange()">
                    <option value="custom">سفارشی</option>
                </select>
            </div>

            <div class="form-group">
                <div style="display: flex; align-items: center; gap: 4px;">
                    <label for="proxyIPTemplateInput">مسیر PROXYIP</label>
                    <div id="proxyIPTemplateError" style="display: none; font-size: 12px; color: #ef4444;">placeholder
                        {{IP:PORT}} وجود ندارد</div>
                </div>
                <div class="path-template-input-wrapper">
                    <input type="text" id="proxyIPTemplateInput" placeholder="proxyip={{IP:PORT}}"
                        oninput="onPathTemplateInput(); preventInvalidChars(this); ensurePathPrefix(this)"
                        onkeypress="preventInvalidCharsOnKeypress(event); preventPathPrefixDeletion(event, this)"
                        onkeydown="preventPathPrefixDeletion(event, this)">
                </div>
            </div>

            <div class="form-group">
                <div style="display: flex; align-items: center; gap: 4px;">
                    <label for="socks5StandardTemplateInput">مسیر استاندارد SOCKS5</label>
                    <div id="socks5StandardTemplateError" style="display: none; font-size: 12px; color: #ef4444;">placeholder
                        {{IP:PORT}} وجود ندارد</div>
                </div>
                <div class="path-template-input-wrapper">
                    <input type="text" id="socks5StandardTemplateInput" placeholder="socks5={{IP:PORT}}"
                        oninput="onPathTemplateInput(); preventInvalidChars(this); ensurePathPrefix(this)"
                        onkeypress="preventInvalidCharsOnKeypress(event); preventPathPrefixDeletion(event, this)"
                        onkeydown="preventPathPrefixDeletion(event, this)">
                </div>
            </div>

            <div class="form-group">
                <div style="display: flex; align-items: center; gap: 4px;">
                    <label for="socks5GlobalTemplateInput">مسیر سراسری SOCKS5</label>
                    <div id="socks5GlobalTemplateError" style="display: none; font-size: 12px; color: #ef4444;">placeholder
                        {{IP:PORT}} وجود ندارد</div>
                </div>
                <div class="path-template-input-wrapper">
                    <input type="text" id="socks5GlobalTemplateInput" placeholder="socks5://{{IP:PORT}}"
                        oninput="onPathTemplateInput(); preventInvalidChars(this); ensurePathPrefix(this)"
                        onkeypress="preventInvalidCharsOnKeypress(event); preventPathPrefixDeletion(event, this)"
                        onkeydown="preventPathPrefixDeletion(event, this)">
                </div>
            </div>

            <div class="form-group">
                <div style="display: flex; align-items: center; gap: 4px;">
                    <label for="httpStandardTemplateInput">مسیر استاندارد HTTP</label>
                    <div id="httpStandardTemplateError" style="display: none; font-size: 12px; color: #ef4444;">placeholder
                        {{IP:PORT}} وجود ندارد</div>
                </div>
                <div class="path-template-input-wrapper">
                    <input type="text" id="httpStandardTemplateInput" placeholder="http={{IP:PORT}}"
                        oninput="onPathTemplateInput(); preventInvalidChars(this); ensurePathPrefix(this)"
                        onkeypress="preventInvalidCharsOnKeypress(event); preventPathPrefixDeletion(event, this)"
                        onkeydown="preventPathPrefixDeletion(event, this)">
                </div>
            </div>

            <div class="form-group">
                <div style="display: flex; align-items: center; gap: 4px;">
                    <label for="httpGlobalTemplateInput">مسیر سراسری HTTP</label>
                    <div id="httpGlobalTemplateError" style="display: none; font-size: 12px; color: #ef4444;">placeholder
                        {{IP:PORT}} وجود ندارد</div>
                </div>
                <div class="path-template-input-wrapper">
                    <input type="text" id="httpGlobalTemplateInput" placeholder="http://{{IP:PORT}}"
                        oninput="onPathTemplateInput(); preventInvalidChars(this); ensurePathPrefix(this)"
                        onkeypress="preventInvalidCharsOnKeypress(event); preventPathPrefixDeletion(event, this)"
                        onkeydown="preventPathPrefixDeletion(event, this)">
                </div>
            </div>

            <div class="path-template-buttons">
                <button type="button" class="btn btn-primary" id="pathTemplateSaveBtn"
                    onclick="savePathTemplateConfig()" disabled>
                    ذخیره و اعمال
                </button>
                <button type="button" class="btn btn-secondary" onclick="closePathTemplateConfigModal()">
                    بستن
                </button>
            </div>
        </div>
    </div>

    <!-- مودال دریافت PROXYIP بیشتر -->
    <div class="modal-overlay" id="getMoreProxyIPModal">
        <div class="modal">
            <div class="modal-map-side">
                <div id="proxy-map-proxyip" class="proxy-map-container"></div>
            </div>
            <div class="modal-content-side">
                <button type="button" class="modal-close" onclick="closeGetMoreProxyIPModal(event)"
                    style="cursor: pointer;">×</button>
                <h2 class="section-title" style="margin-bottom: 10px; text-align: center;">🗺️ دریافت PROXYIP بیشتر</h2>
                <p style="text-align: center; color: #666; font-size: 13px; margin-bottom: 20px;">
                    منابع proxy معکوس از Github، کانال <a href="https://t.me/zip_cm_edu_kg" target="_blank" rel="noopener noreferrer">CM University</a> و سایر جوامع متن‌باز.
                </p>
                <div class="proxy-list-container">
                    <div class="form-group">
                        <label for="proxyIPDataRegionSelect">🏳️‍🌈 انتخاب منطقه هدف</label>
                        <div class="input-wrapper">
                            <select id="proxyIPDataRegionSelect" onchange="onProxyIPDataRegionChange()"
                                style="padding-left: 16px;">
                                <option value="">در حال بارگذاری...</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" id="proxyIPProxySelectGroup">
                        <label for="proxyIPProxySelect">🌐 انتخاب پروکسی هدف (حداکثر 8)</label>
                        <div class="input-wrapper">
                            <select id="proxyIPProxySelect" onchange="addSelectedProxyIP(); updateProxyMap('proxyip');"
                                style="padding-left: 16px; font-family: 'Fira Code', monospace; font-size: 12px;">
                                <option value=""></option>
                            </select>
                        </div>
                    </div>

                    <div id="selectedProxyIPsContainer" class="selected-proxies-tags"
                        style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; min-height: 40px; padding: 10px; border: 1px dashed #e5e7eb; border-radius: 8px;">
                        <!-- برچسب‌های IP انتخاب شده اینجا نمایش داده می‌شوند -->
                    </div>
                </div>

                <div class="btn-group"
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: auto; padding-top: 20px;">
                    <button type="button" class="btn btn-primary" id="proxyIPConfirmBtn"
                        onclick="confirmSelectProxyIP()" disabled>
                        تأیید
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeGetMoreProxyIPModal(event)">
                        انصراف
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال اکتشاف SOCKS5 -->
    <div class="modal-overlay" id="exploreSocks5Modal">
        <div class="modal">
            <div class="modal-map-side">
                <div id="proxy-map-socks5" class="proxy-map-container"></div>
            </div>
            <div class="modal-content-side">
                <button type="button" class="modal-close" onclick="closeExploreSocks5Modal(event)"
                    style="cursor: pointer;">×</button>
                <h2 class="section-title" style="margin-bottom: 10px; text-align: center;">🔒 دریافت SOCKS5 بیشتر</h2>
                <p style="text-align: center; color: #666; font-size: 13px; margin-bottom: 20px;">
                    منابع پروکسی از Github، کانال <a href="https://t.me/Enkelte_notif" target="_blank" rel="noopener noreferrer">Notif
                        💬</a> و سایر جوامع متن‌باز.
                </p>
                <div class="socks5-list-container">
                    <div class="form-group">
                        <label for="socks5RegionSelect">🏳️‍🌈 انتخاب منطقه هدف</label>
                        <div class="input-wrapper">
                            <select id="socks5RegionSelect" onchange="onSocks5RegionChange()"
                                style="padding-left: 16px;">
                                <option value="">در حال بارگذاری...</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" id="socks5ProxySelectGroup">
                        <label for="socks5ProxySelect">🌐 انتخاب پروکسی هدف</label>
                        <div class="input-wrapper">
                            <select id="socks5ProxySelect"
                                onchange="updateSocks5ConfirmButton(); updateProxyMap('socks5');"
                                style="padding-left: 16px; font-family: 'Fira Code', monospace; font-size: 12px;">
                                <option value=""></option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="btn-group"
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: auto; padding-top: 20px;">
                    <button type="button" class="btn btn-primary" id="socks5ConfirmBtn" onclick="confirmSelectSocks5()">
                        تأیید
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeExploreSocks5Modal(event)">
                        انصراف
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال اکتشاف HTTP -->
    <div class="modal-overlay" id="exploreHTTPModal">
        <div class="modal">
            <div class="modal-map-side">
                <div id="proxy-map-http" class="proxy-map-container"></div>
            </div>
            <div class="modal-content-side">
                <button type="button" class="modal-close" onclick="closeExploreHTTPModal(event)"
                    style="cursor: pointer;">×</button>
                <h2 class="section-title" style="margin-bottom: 10px; text-align: center;">🌐 دریافت HTTP بیشتر</h2>
                <p style="text-align: center; color: #666; font-size: 13px; margin-bottom: 20px;">
                    منابع پروکسی از Github، کانال <a href="https://t.me/Enkelte_notif" target="_blank" rel="noopener noreferrer">Notif
                        💬</a> و سایر جوامع متن‌باز.
                </p>
                <div class="http-list-container">
                    <div class="form-group">
                        <label for="httpRegionSelect">🏳️‍🌈 انتخاب منطقه هدف</label>
                        <div class="input-wrapper">
                            <select id="httpRegionSelect" onchange="onHTTPRegionChange()" style="padding-left: 16px;">
                                <option value="">در حال بارگذاری...</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" id="httpProxySelectGroup">
                        <label for="httpProxySelect">🌐 انتخاب پروکسی هدف</label>
                        <div class="input-wrapper">
                            <select id="httpProxySelect" onchange="updateHTTPConfirmButton(); updateProxyMap('http');"
                                style="padding-left: 16px; font-family: 'Fira Code', monospace; font-size: 12px;">
                                <option value=""></option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="btn-group"
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: auto; padding-top: 20px;">
                    <button type="button" class="btn btn-primary" id="httpConfirmBtn" onclick="confirmSelectHTTP()"
                        disabled>
                        تأیید
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeExploreHTTPModal(event)">
                        انصراف
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال هشدار عدم تطابق HOSTS -->
    <div class="modal-overlay" id="hostsMismatchModal" onclick="closeHostsMismatchModal(event)">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px;">
            <button type="button" class="modal-close" onclick="closeHostsMismatchModal()">×</button>
            <div style="text-align: center; padding: 20px 0;">
                <h2 style="color: #f44336; margin: 0 0 16px 0; font-size: 22px; font-weight: 700;">⚠️ راهنمای پیکربندی دامنه</h2>
                <p style="margin: 0 0 12px 0; font-size: 14px; line-height: 1.6; text-align: left;">
                    دامنه‌ای که در حال حاضر برای دسترسی به پنل مدیریت استفاده می‌کنید: <strong id="currentHostname" style="color: #2196F3;"></strong>
                </p>
                <p style="margin: 0 0 12px 0; font-size: 14px; line-height: 1.6; text-align: left; color: #f44336;">
                    <strong>⚠️ توجه:</strong> این دامنه <strong>به عنوان دامنه استتار نود پیکربندی نشده است</strong>. این یعنی پیکربندی اشتراک تولید شده <strong>از این دامنه</strong> به عنوان
                    <strong>دامنه نود</strong> استفاده نخواهد کرد.
                </p>
                <p style="margin: 0 0 12px 0; font-size: 14px; line-height: 1.6; text-align: left;">
                    <strong>دامنه استتار نود فعلی:</strong>
                </p>
                <div id="currentHosts"
                    style="margin: 0 0 16px 0; padding: 12px; background-color: transparent; border-radius: 0; text-align: left; font-size: 13px; max-height: 120px; overflow-y: auto; word-break: break-all; display: flex; flex-wrap: wrap; gap: 8px; align-content: flex-start;">
                </div>
                <p style="margin: 0 0 16px 0; font-size: 13px; line-height: 1.6; text-align: left;">
                    <strong>چگونه تغییر دهیم؟</strong> لطفاً در حالت پیشرفته، "⚙️ اطلاعات پیکربندی جزئی" را باز کنید، دامنه خود "<strong id="hostToAdd"
                        style="color: #2196F3;"></strong>" را در "HOST" اضافه کنید، پس از ذخیره پیکربندی اعمال می‌شود.
                </p>
                </div>
            </div>
        </div>
        </div>
        </div>
    </main>
    <script data-cfasync="false">
    // ==================== توابع منو و صفحات ====================
    function showPage(pageId, menuElement) {
        // مخفی کردن تمام صفحات
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });

        // مخفی کردن تمام ماژول‌های اصلی
        document.querySelectorAll('.page-wrapper').forEach(wrapper => {
            wrapper.style.display = 'none';
        });

        // نمایش صفحه انتخاب شده
        const targetPage = document.getElementById('page-' + pageId);
        if (targetPage) {
            targetPage.classList.add('active');
        }

        // برای صفحات خاص، نمایش محتوای اختصاصی
        if (pageId === 'subscribe') {
            // صفحه دریافت لینک - محتوای خودش را نشان بده
            // page-wrapper را مخفی نکن چون ممکنه هنوز استفاده بشه
        } else if (pageId !== 'dashboard') {
            const pageWrapper = document.querySelector('.page-wrapper');
            if (pageWrapper) {
                pageWrapper.style.display = 'block';
            }
        }

        // بروزرسانی منوی فعال
        document.querySelectorAll('.menu-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // اگر menuElement ارسال شده، از آن استفاده کن
        // در غیر این صورت، بر اساس pageId پیدا کن
        if (menuElement && menuElement.classList && menuElement.classList.contains('menu-item')) {
            menuElement.classList.add('active');
        } else {
            // پیدا کردن آیتم منوی مناسب
            const menuMap = {
                'network': 1,
                'subscribe': 2,
                'optimize': 3,
                'config': 4,
                'cdn': 5,
                'convert': 6,
                'notify': 7,
                'logs': 9
            };
            const menuIndex = menuMap[pageId];
            if (menuIndex !== undefined) {
                const menuItems = document.querySelectorAll('.menu-item');
                if (menuItems[menuIndex]) {
                    menuItems[menuIndex].classList.add('active');
                }
            }
        }

        // بستن منوی موبایل
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
            sidebar.classList.remove('open');
        }
        const overlay = document.querySelector('.sidebar-overlay');
        if (overlay) {
            overlay.classList.remove('show');
        }
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.querySelector('.sidebar-overlay').classList.toggle('show');
    }

    // مخفی کردن page-wrapper اصلی
    document.addEventListener('DOMContentLoaded', function() {
        const pageWrapper = document.querySelector('.page-wrapper');
        if (pageWrapper) {
            pageWrapper.style.display = 'none';
        }
    });

    let currentConfig = {};
        let originalConfig = {};
        let modifiedSections = new Set();
        let subConfigData = null;
        let hasMultipleHosts = false; // علامت‌گذاری وجود چندین HOSTS

        // تنظیم تست تاخیر
        const latencyTestConfig = {
            count: 16  // تعداد نمونه‌برداری و نمایش
        };

        // ردیابی وضعیت انیمیشن نمایش تاخیر
        const latencyUIState = {};

        // علامت‌گذاری شروع تست تاخیر برای جلوگیری از اجرای تکراری
        let latencyTestStarted = false;

        // داده‌های تست تاخیر
        const latencySites = [
            {
                name: 'بایت دنس (Douyin)',
                region: 'داخلی',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#1677FF" d="m19.9 1.5 4.1 1v19l-4.1 1zM6.5 10.9l4.1 1v9l-4 1.1zM0 2.6l4.1 1v16.8l-4.1 1zm17.5 5.6v11.1l-4.2-1v-9z"></path></svg>',
                url: 'https://lf3-zlink-tos.ugurl.cn/obj/zebra-public/resource_lmmizj_1632398893.png'
            },
            {
                name: 'Bilibili',
                region: 'داخلی',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#FB7299" d="M17.813 4.653h.854q2.266.08 3.773 1.574Q23.946 7.72 24 9.987v7.36q-.054 2.266-1.56 3.773c-1.506 1.507-2.262 1.524-3.773 1.56H5.333q-2.266-.054-3.773-1.56C.053 19.614.036 18.858 0 17.347v-7.36q.054-2.267 1.56-3.76t3.773-1.574h.774l-1.174-1.12a1.23 1.23 0 0 1-.373-.906q0-.534.373-.907l.027-.027q.4-.373.92-.373t.92.373L9.653 4.44q.107.106.187.213h4.267a.8.8 0 0 1 .16-.213l2.853-2.747q.4-.373.92-.373c.347 0 .662.151.929.4s.391.551.391.907q0 .532-.373.906zM5.333 7.24q-1.12.027-1.88.773q-.76.748-.786 1.894v7.52q.026 1.146.786 1.893t1.88.773h13.334q1.12-.026 1.88-.773t.786-1.893v-7.52q-.026-1.147-.786-1.894t-1.88-.773zM8 11.107q.56 0 .933.373q.375.374.4.96v1.173q-.025.586-.4.96q-.373.375-.933.374c-.56-.001-.684-.125-.933-.374q-.375-.373-.4-.96V12.44q0-.56.386-.947q.387-.386.947-.386m8 0q.56 0 .933.373q.375.374.4.96v1.173q-.025.586-.4.96q-.373.375-.933.374c-.56-.001-.684-.125-.933-.374q-.375-.373-.4-.96V12.44q.025-.586.4-.96q.373-.373.933-.373"></path></svg>',
                url: 'https://i0.hdslb.com/bfs/face/member/noface.jpg@24w_24h_1c'
            },
            {
                name: 'تنسنت وی‌چت',
                region: 'داخلی',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#09B83E" d="M8.7 2.19C3.9 2.19 0 5.48 0 9.53c0 2.21 1.17 4.2 3 5.55a.6.6 0 0 1 .21.66l-.39 1.48q-.03.11-.04.22c0 .16.13.3.29.3a.3.3 0 0 0 .16-.06l1.9-1.11a.9.9 0 0 1 .72-.1 10 10 0 0 0 2.84.4q.41-.01.81-.05a5.85 5.85 0 0 1 1.93-6.45 8.3 8.3 0 0 1 5.86-1.83c-.58-3.59-4.2-6.35-8.6-6.35m-2.9 3.8c.64 0 1.16.53 1.16 1.18a1.17 1.17 0 0 1-1.16 1.18 1.17 1.17 0 0 1-1.17-1.18c0-.65.52-1.18 1.17-1.18m5.8 0c.65 0 1.17.53 1.17 1.18a1.17 1.17 0 0 1-1.16 1.18 1.17 1.17 0 0 1-1.16-1.18c0-.65.52-1.18 1.16-1.18m5.34 2.87a8 8 0 0 0-5.28 1.78 5.5 5.5 0 0 0-1.78 6.22c.94 2.46 3.66 4.23 6.88 4.23q1.25 0 2.36-.33a.7.7 0 0 1 .6.08l1.59.93.14.04c.13 0 .24-.1.24-.24q-.01-.09-.04-.18l-.33-1.23-.02-.16a.5.5 0 0 1 .2-.4 5.8 5.8 0 0 0 2.5-4.62c0-3.21-2.93-5.84-6.66-6.09zm-2.53 3.27c.53 0 .97.44.97.98a1 1 0 0 1-.97.99 1 1 0 0 1-.97-.99c0-.54.43-.98.97-.98zm4.84 0c.54 0 .97.44.97.98a1 1 0 0 1-.97.99 1 1 0 0 1-.97-.99c0-.54.44-.98.97-.98"></path></svg>',
                url: 'https://res.wx.qq.com/a/wx_fed/assets/res/NTI4MWU5.ico'
            },
            {
                name: 'علی‌بابا تائو‌بائو',
                region: 'داخلی',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#E16322" d="M21.31 9.9a3 3 0 1 1 0 1.92.96.96 0 0 1 0-1.92m2.39 3.05H13.3v-.96h4.14V9.76h-2.89v-.77h2.9v-.92h-2.52v.2H13.3v-2.9h1.64v.35l2.52-.3V4.6h1.85v.64c.93-.08 1.76-.13 2.21-.1 1.5.06 2.45.27 2.49 1.26.03 1-1.43 1.9-1.43 1.9l-.45-.43v.2h-2.8v.92h3.22v.77h-3.23v2.23h4.39zM21.53 7.3l-.02-.01s1.38-.76.35-1.27c-.87-.43-5.54.3-6.93.62v.66zM1.88 6.42a1 1 0 0 0 0-2 1 1 0 0 0-1 1 1 1 0 0 0 1 1m3.41-.86a7 7 0 0 0 .37-.72L4.2 4.42s-.6 1.93-1.65 2.83c0 0 1.02.6 1.01.58a10 10 0 0 0 .78-.88l.68-.3a9 9 0 0 1-1.14 1.69l.61.54s.42-.4.88-.9h.53v.9H3.86v.73H5.9v1.72h-.08c-.23-.01-.58-.05-.71-.27-.17-.26-.05-.75-.04-1.04h-1.4l-.06.02s-.52 2.32 1.5 2.27a5.3 5.3 0 0 0 3.46-.92l.2.76 1.17-.48-.79-1.92-.94.3.18.65a3 3 0 0 1-.82.42V9.6h2v-.72h-2v-.9h2v-.72H6.01c.26-.31.46-.6.51-.78l-.62-.17c2.67-.95 4.15-.79 4.13.77v4.12s.16 1.4-1.46 1.3l-.87-.18-.21.83s3.78 1.08 4.1-1.82-.09-4.76-.09-4.76-.34-2.68-6.2-1.02zm-5.23 6.6 1.58.98c1.1-2.38 1.03-2.06 1.3-2.92.29-.87.35-1.54-.13-2.02a10 10 0 0 0-1.6-1.36L.55 7.86l1.21.75s.82.42.43 1.2c-.36.73-2.13 2.34-2.13 2.34M20 19s-.02.53-.67.53c-.6 0-.64-.42-.64-.42q-.39.45-1.07.46c-.76 0-1.3-.51-1.3-1.3 0-.78.56-1.27 1.4-1.27.39 0 .73.15.93.4l.01-.2c0-.56-.3-.8-1-.8q-.51 0-1.02.13.16-.33.3-.45.18-.14.94-.14c1.27 0 1.74.42 1.74 1.42v1.2c0 .32.03.44.38.44m-1.33-.74c0-.48-.25-.75-.64-.75-.4 0-.66.28-.66.76 0 .47.27.76.65.76.39 0 .65-.27.65-.77m5.27-.5c0 1.15-.7 1.82-1.78 1.82-1.1 0-1.77-.67-1.77-1.82 0-1.16.68-1.83 1.77-1.83s1.78.67 1.78 1.83m-1.08 0q0-1.3-.7-1.3t-.69 1.3.7 1.3.69-1.3m-7.14-.05c0 1.17-.65 1.86-1.57 1.86q-.66-.01-1.05-.47s-.1.42-.66.42c-.69 0-.67-.52-.67-.52.4.02.38-.21.38-.43v-2.89c0-.36-.07-.48-.43-.49.02-.1.08-.53.68-.53.82 0 .76.91.76.91v.79q.34-.4 1-.4c.96 0 1.56.65 1.56 1.75m-1.09.08q-.01-1.35-.76-1.35c-.44 0-.74.4-.74 1.1v.36c0 .72.31 1.12.76 1.12q.73 0 .74-1.23m-3.24-.03c0 1.15-.7 1.82-1.78 1.82-1.1 0-1.78-.67-1.78-1.82 0-1.16.68-1.83 1.78-1.83s1.78.67 1.78 1.83m-1.09 0q0-1.3-.7-1.3-.69 0-.68 1.3t.69 1.3q.7 0 .7-1.3m-6-2.72q-.4.11-1.55.1-1.38-.02-1.85-.04c-.52 0-.73.13-.91.66q.45-.13 1.13-.11c.36 0 .42.04.42.3v2.9c0 .28.11.67.72.67.71 0 .84-.52.84-.52-.36 0-.43-.13-.43-.49v-2.56c0-.27.1-.28.47-.28h.26c.55 0 .7-.1.9-.63M7.46 19s-.02.52-.67.52c-.56 0-.64-.4-.64-.4q-.39.45-1.07.45c-.76 0-1.3-.52-1.3-1.3S4.33 17 5.17 17c.39 0 .73.14.93.4v-.2c0-.56-.3-.8-1-.8q-.5 0-1.01.13.15-.33.3-.46.17-.14.94-.14c1.26 0 1.74.43 1.74 1.43v1.2c0 .32.03.44.38.44m-1.33-.75c0-.48-.26-.74-.64-.74-.4 0-.67.28-.67.76 0 .46.28.76.66.76.39 0 .65-.28.65-.78"></path></svg>',
                url: 'https://img.alicdn.com/imgextra/i2/O1CN01qnQCrN1VkzAWiU4Hs_!!6000000002692-2-tps-33-33.png'
            },
            {
                name: 'GitHub',
                region: 'بین‌المللی',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#181717" d="M12 .3a12 12 0 0 0-3.8 23.38c.6.12.83-.26.83-.57L9 21.07c-3.34.72-4.04-1.61-4.04-1.61-.55-1.39-1.34-1.76-1.34-1.76-1.08-.74.09-.73.09-.73 1.2.09 1.84 1.24 1.84 1.24 1.07 1.83 2.8 1.3 3.49 1 .1-.78.42-1.31.76-1.61-2.66-.3-5.47-1.33-5.47-5.93 0-1.31.47-2.38 1.24-3.22-.14-.3-.54-1.52.1-3.18 0 0 1-.32 3.3 1.23a11.5 11.5 0 0 1 6 0c2.28-1.55 3.29-1.23 3.29-1.23.64 1.66.24 2.88.12 3.18a4.7 4.7 0 0 1 1.23 3.22c0 4.61-2.8 5.63-5.48 5.92.42.36.81 1.1.81 2.22l-.01 3.29c0 .31.2.69.82.57A12 12 0 0 0 12 .3"></path></svg>',
                url: 'https://github.github.io/janky/images/bg_hr.png'
            },
            {
                name: 'Telegram',
                region: 'بین‌المللی',
                icon: '<svg width="24px" height="24px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><linearGradient x1="50%" y1="0%" x2="50%" y2="100%" id="linearGradient-1"><stop stop-color="#38AEEB" offset="0%"></stop><stop stop-color="#279AD1" offset="100%"></stop></linearGradient></defs><g id="Artboard" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><circle id="Oval" fill="url(#linearGradient-1)" cx="8" cy="8" r="8"></circle><path d="M3.17026167,7.83635602 C5.78750201,6.74265999 7.53273882,6.02162863 8.40597211,5.67326193 C10.8992306,4.67860423 11.2454541,4.53439191 11.5831299,4.52864956 C11.6573986,4.52743168 11.8385417,4.55776042 11.9798438,4.67645833 C12.1211458,4.79515625 12.1635786,4.87206678 12.1755371,4.93908691 C12.1874957,5.00610705 12.1862759,5.21456762 12.1744385,5.3338623 C12.0393279,6.69547283 11.5259342,9.83829771 11.2285121,11.3633248 C11.1026617,12.008621 10.8548582,12.2249854 10.6149558,12.2461596 C10.0935924,12.2921758 9.69769267,11.9156852 9.19272668,11.5981993 C8.40255458,11.1013965 8.13911734,10.9180161 7.3721185,10.4332283 C6.48571864,9.87297217 6.85080034,9.6784879 7.35595703,9.17524981 C7.48815894,9.04355001 9.67825076,7.04590073 9.71077046,6.86250183 C9.7391276,6.70257812 9.7494847,6.68189389 9.67664063,6.60973958 C9.60379655,6.53758527 9.51674192,6.54658941 9.46083149,6.55876051 C9.38158015,6.57601267 8.17521836,7.33962686 5.84174612,8.84960308 C5.48344358,9.08558775 5.15890428,9.20056741 4.86812819,9.19454205 C4.54757089,9.18789957 3.93094724,9.02070014 3.47255094,8.87778221 C2.91030922,8.70248755 2.46345069,8.609808 2.50236203,8.31210343 C2.52262946,8.15704047 2.74526267,7.998458 3.17026167,7.83635602 Z" id="Path-3" fill="#FFFFFF"></path></g></svg>',
                url: 'https://web.telegram.org/k/'
            },
            {
                name: 'X.com',
                region: 'بین‌المللی',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#1DA1F2" d="M23.643 4.937c-.835.37-1.732.62-2.675.733.962-.576 1.7-1.49 2.048-2.578-.9.534-1.897.922-2.958 1.13-.85-.904-2.06-1.47-3.4-1.47-2.572 0-4.658 2.086-4.658 4.66 0 .364.042.718.12 1.06-3.873-.195-7.304-2.05-9.602-4.868-.4.69-.63 1.49-.63 2.342 0 1.616.823 3.043 2.072 3.878-.764-.025-1.482-.234-2.11-.583v.06c0 2.257 1.605 4.14 3.737 4.568-.392.106-.803.162-1.227.162-.3 0-.593-.028-.877-.082.594 1.85 2.323 3.196 4.368 3.233-1.595 1.25-3.604 1.995-5.786 1.995-.376 0-.747-.022-1.112-.065 2.072 1.328 4.532 2.104 7.172 2.104 8.607 0 13.3-7.132 13.3-13.3 0-.202-.005-.403-.014-.602.913-.66 1.706-1.477 2.332-2.41z"></path></svg>',
                url: 'https://abs.twimg.com/favicons/twitter.3.ico'
            },
            {
                name: 'YouTube',
                region: 'بین‌المللی',
                icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#FF0000" d="M23.5 6.19a3 3 0 0 0-2.12-2.14c-1.87-.5-9.38-.5-9.38-.5s-7.5 0-9.38.5A3 3 0 0 0 .5 6.19C0 8.07 0 12 0 12s0 3.93.5 5.81a3 3 0 0 0 2.12 2.14c1.87.5 9.38.5 9.38.5s7.5 0 9.38-.5a3 3 0 0 0 2.12-2.14C24 15.93 24 12 24 12s0-3.93-.5-5.81M9.55 15.57V8.43L15.82 12z"></path></svg>',
                url: 'https://www.youtube.com/favicon.ico'
            }
        ];

        // مقداردهی اولیه تم
        function initializeTheme() {
            const saved = localStorage.getItem('theme');
            let theme = saved;

            // اگر اولین بار است، بر اساس تم سیستم تصمیم بگیر
            if (!saved) {
                theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }

            applyTheme(theme);
        }

        // اعمال تم
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
                document.getElementById('themeToggle').title = 'تغییر به حالت روز';
            } else {
                document.documentElement.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
                document.getElementById('themeToggle').title = 'تغییر به حالت شب';
            }
        }

        // تولید کارت‌های تاخیر
        function generateLatencyCards() {
            const container = document.getElementById('latency-cards');
            if (!container) return;
            container.innerHTML = '';

            // مرتب‌سازی بر اساس منطقه: داخلی اول، سپس بین‌المللی
            const sortedSites = [...latencySites].sort((a, b) => {
                const aIsChina = a.region === 'داخلی' ? 0 : 1;
                const bIsChina = b.region === 'داخلی' ? 0 : 1;
                return aIsChina - bIsChina;
            });

            sortedSites.forEach(site => {
                const card = document.createElement('div');
                card.className = 'latency-card';
                const siteName = site.name.toLowerCase().replace(/\s+/g, '-');
                card.innerHTML = `
                    <div class="latency-card-header">
                        <div class="latency-card-info">
                            <div class="latency-card-icon-wrapper" data-site="${siteName}">
                                ${site.icon}
                            </div>
                            <div class="latency-card-text">
                                <span class="latency-card-name">${site.name}</span>
                                <span class="latency-card-region" data-region="${site.region}">${site.region}</span>
                            </div>
                        </div>
                        <div class="latency-status" id="latency-${siteName}">...<span class="unit">ms</span></div>
                    </div>
                    <div class="latency-graph-container">
                        <div class="graph-grid"></div>
                        <svg class="latency-ecg" viewBox="0 0 400 60" preserveAspectRatio="none">
                            <path class="ecg-path-bg" d="M0,30 L400,30"></path>
                            <path class="ecg-path" id="path-${siteName}" d="M0,30 L400,30"></path>
                            <circle class="ecg-cursor" id="cursor-${siteName}" r="3" cx="0" cy="30" style="display:none"></circle>
                        </svg>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // تست تاخیر
        async function testLatency(site) {
            const start = Date.now();
            try {
                const response = await fetch(site.url + '?t=' + Date.now(), {
                    method: 'HEAD',
                    cache: 'no-cache',
                    mode: 'no-cors',
                    referrerPolicy: 'no-referrer'
                });
                const latency = Date.now() - start;
                return latency;
            } catch (error) {
                return -1; // اتصال ناموفق
            }
        }

        // دریافت رنگ تاخیر
        function getLatencyColor(latency) {
            if (latency === -1) return 'var(--destructive)';
            if (latency <= 49) return 'var(--latency-49)';
            if (latency <= 149) return 'var(--latency-149)';
            if (latency <= 299) return 'var(--latency-299)';
            if (latency <= 999) return 'var(--latency-999)';
            return 'var(--latency-1000)';
        }

        // به‌روزرسانی نمایش تاخیر
        function updateLatencyDisplay(siteName, latencies) {
            const valueElement = document.getElementById(`latency-${siteName}`);
            const pathElement = document.getElementById(`path-${siteName}`);
            const cursorElement = document.getElementById(`cursor-${siteName}`);

            if (!valueElement || !pathElement) return;

            // محاسبه میانگین تاخیر
            const lastLatency = latencies[latencies.length - 1];
            const validLatencies = latencies.filter(l => l !== -1);
            let avgLatency = -1;

            if (validLatencies.length > 0) {
                // اگر داده کافی وجود دارد، بیشترین و کمترین تاخیر را حذف برای میانگین پایدارتر
                if (validLatencies.length > 5) {
                    const sorted = [...validLatencies].sort((a, b) => a - b);
                    const trimmed = sorted.slice(1, -1);
                    avgLatency = trimmed.reduce((a, b) => a + b, 0) / trimmed.length;
                } else {
                    avgLatency = validLatencies.reduce((a, b) => a + b, 0) / validLatencies.length;
                }
            }

            const targetValue = Math.round(avgLatency);

            // به‌روزرسانی نمایش متن
                if (validLatencies.length === 0) {
                    if (lastLatency === -1) {
                        valueElement.innerHTML = 'انقضای زمان';
                        valueElement.style.color = 'var(--latency-999)';
                } else {
                    valueElement.innerHTML = '...<span class="unit">ms</span>';
                    valueElement.style.color = '#0ea5e9';
                }
            } else {
                const siteState = latencyUIState[siteName] || { current: targetValue, timer: null };
                latencyUIState[siteName] = siteState;

                // تنظیم رنگ
                const avgColor = getLatencyColor(targetValue);
                valueElement.style.color = avgColor;

                // اگر تغییر عدد کم است، مستقیم نمایش بده
                if (Math.abs(siteState.current - targetValue) < 2) {
                    siteState.current = targetValue;
                    valueElement.innerHTML = `${targetValue}<span class="unit">ms</span>`;
                } else {
                    // پاک کردن تایمر قدیمی
                    if (siteState.timer) clearInterval(siteState.timer);

                    // هر 30ms یک بار رقم را به‌روز کن برای افکت اسکرول داینامیک
                    const step = () => {
                        if (siteState.current < targetValue) {
                            siteState.current += Math.ceil((targetValue - siteState.current) / 5);
                        } else if (siteState.current > targetValue) {
                            siteState.current -= Math.ceil((siteState.current - targetValue) / 5);
                        }

                        valueElement.innerHTML = `${siteState.current}<span class="unit">ms</span>`;

                        if (siteState.current === targetValue) {
                            clearInterval(siteState.timer);
                            siteState.timer = null;
                        }
                    };

                    siteState.timer = setInterval(step, 30);
                }
            }

            // به‌روزرسانی مسیر SVG
            const width = 400;
            const height = 60;
            const padding = 10;
            const step = width / (latencyTestConfig.count - 1);

            let points = [];
            latencies.forEach((l, i) => {
                const x = i * step;
                let y;
                if (l === -1) {
                    y = height - 5;
                } else {
                    // نگاشت 0-500ms به ارتفاع، تاخیر بالاتر = بالاتر؟ معمولاً ECG بالاتر یعنی مقدار بزرگ‌تر یا سریع‌تر
                    y = height - padding - (Math.min(l, 500) / 800 * (height - 2 * padding));
                }
                points.push({ x, y });
            });

            if (points.length > 0) {
                // تولید مسیر منحنی هموار (Bezier)
                let d = `M${points[0].x},${points[0].y}`;
                for (let i = 0; i < points.length - 1; i++) {
                    const x_mid = (points[i].x + points[i + 1].x) / 2;
                    const y_mid = (points[i].y + points[i + 1].y) / 2;
                    d += ` Q${points[i].x},${points[i].y} ${x_mid},${y_mid}`;
                }
                const lastPoint = points[points.length - 1];
                d += ` L${lastPoint.x},${lastPoint.y}`;

                pathElement.setAttribute('d', d);
                const avgColor = getLatencyColor(targetValue);
                pathElement.style.stroke = avgColor;

                // به‌روزرسانی موقعیت cursor
                if (cursorElement) {
                    cursorElement.style.display = 'block';
                    cursorElement.setAttribute('cx', lastPoint.x);
                    cursorElement.setAttribute('cy', lastPoint.y);
                    cursorElement.style.fill = avgColor;
                }
            }
        }

        // شروع تست تاخیر
        async function startLatencyTest() {
            if (latencyTestStarted) return;
            latencyTestStarted = true;

            generateLatencyCards();

            // برای هر وب‌سایت جدیدترین N داده تاخیر را نگه دار
            const siteLatencies = {};
            latencySites.forEach(site => {
                const siteName = site.name.toLowerCase().replace(/\s+/g, '-');
                siteLatencies[siteName] = [];
            });

            // نمونه‌برداری اولیه
            const initialPromises = latencySites.map(async (site) => {
                const siteName = site.name.toLowerCase().replace(/\s+/g, '-');
                for (let i = 0; i < latencyTestConfig.count; i++) {
                    const latency = await testLatency(site);
                    siteLatencies[siteName].push(latency);
                    updateLatencyDisplay(siteName, siteLatencies[siteName]);
                    if (i < latencyTestConfig.count - 1) {
                        await new Promise(resolve => setTimeout(resolve, 0));
                    }
                }
            });

            await Promise.all(initialPromises);

            // پس از آن هر 3.09 ثانیه یک بار تست کن، داده‌های جدید را به‌روز کن (منحنی ECG را جاری نگه دار)
            setInterval(async () => {
                const updatePromises = latencySites.map(async (site) => {
                    const siteName = site.name.toLowerCase().replace(/\s+/g, '-');
                    const latency = await testLatency(site);
                    // داده جدید را اضافه کن، فقط N تا نگه دار
                    siteLatencies[siteName].push(latency);
                    if (siteLatencies[siteName].length > latencyTestConfig.count) {
                        siteLatencies[siteName].shift(); // حذف قدیمی‌ترین
                    }
                    updateLatencyDisplay(siteName, siteLatencies[siteName]);
                });
                await Promise.all(updatePromises);
            }, 618 * 3);
        }

        // تغییر تم
        function toggleTheme() {
            const isDark = document.documentElement.classList.contains('dark-mode');
            applyTheme(isDark ? 'light' : 'dark');
        }

        // بازگشت به بالا
        function scrollToTop() {
            const pageWrapper = document.querySelector('.page-wrapper');
            if (pageWrapper) {
                pageWrapper.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // مقداردهی اولیه ویرایشگر متن پیشرفته
        function initLineEditor(textareaId) {
            const ta = document.getElementById(textareaId);
            if (!ta) return;
            const container = ta.closest('.line-editor');
            if (!container) return;
            const mirror = container.querySelector('.mirror');

            function escapeHtml(str) {
                return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            }

            function render() {
                const value = ta.value || '';
                const lines = value.split(/\r\n|\r|\n/);

                mirror.style.width = ta.clientWidth + 'px';

                mirror.innerHTML = lines.map((l, i) => `<div class="logical-line" data-line-number="${i + 1}">${escapeHtml(l) || ' '}</div>`).join('');

                syncScroll();
            }

            function syncScroll() {
                mirror.scrollTop = ta.scrollTop;
            }

            let throttleTimeout;
            const debouncedRender = () => {
                cancelAnimationFrame(throttleTimeout);
                throttleTimeout = requestAnimationFrame(render);
            };

            // گوش دادن به ورودی، اسکرول
            ta.addEventListener('input', debouncedRender);
            ta.addEventListener('scroll', syncScroll);

            // گوش دادن به تغییرات ارتفاع (ResizeObserver)، حل مشکل همگام‌سازی پس از کشیدن گوشه
            if (window.ResizeObserver) {
                const ro = new ResizeObserver(() => {
                    // وقتی ارتفاع یا عرض textarea تغییر کرد، دوباره رندر کن برای همگام‌سازی عرض
                    render();
                });
                ro.observe(ta);
            }

            // در تغییر اندازه پنجره هم رفرش کن
            window.addEventListener('resize', debouncedRender);

            // exposing تابع رندر
            ta._refreshLineEditor = render;

            // رندر اولیه
            render();
        }

        async function loadConfig() {
            try {
                // غیرفعال کردن تأثیر Rocket Loader بر این درخواست
                const response = await fetch('/admin/config.json?_t=' + Date.now(), {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                if (!response.ok) throw new Error('بارگذاری پیکربندی ناموفق');
                currentConfig = await response.json();
                originalConfig = JSON.parse(JSON.stringify(currentConfig));
                renderUI();
                // تنظیم عنوان صفحه
                document.title = `${currentConfig.优选订阅生成?.SUBNAME || 'edgetunnel'} صفحه تنظیمات - پنل مدیریت`;
            } catch (error) {
                showToast('بارگذاری پیکربندی ناموفق: ' + error.message, 'error');
            }
        }

        function renderUI() {
            // عنوان
            document.getElementById('pageTitle').textContent = (currentConfig.优选订阅生成?.SUBNAME || 'edgetunnel') + ' صفحه تنظیمات';

            // بررسی میزان استفاده CF و نمایش ماژول
            const cfUsageModule = document.getElementById('cfUsageModule');
            const cfUsage = currentConfig.CF?.Usage;
            if (cfUsage && cfUsage.success) {
                cfUsageModule.style.display = 'block';
                cfUsageModule.classList.remove('cf-usage-module');
                updateCFUsageDisplay(cfUsage);
                updateCloudflareButtonStates(true);
            } else {
                cfUsageModule.style.display = 'none';
                cfUsageModule.classList.add('cf-usage-module');
                updateCloudflareButtonStates(false);
            }

            // بررسی وجود فیلد CF.UsageAPI، سازگاری با نسخه‌های قدیمی
            const usageapiOption = document.getElementById('usageapiOption');
            if (usageapiOption) {
                // اگر فیلد CF.UsageAPI وجود ندارد (نسخه قدیمی)، گزینه UsageAPI را مخفی کن
                if (currentConfig.CF?.UsageAPI === undefined) {
                    usageapiOption.style.display = 'none';
                } else {
                    usageapiOption.style.display = '';
                }
            }

            // لینک‌های اشتراک
            const token = currentConfig.优选订阅生成?.TOKEN;
            const host = window.location.host;
            const link = currentConfig.LINK;
            document.getElementById('LinkURL').value = currentConfig.LINK;
            document.getElementById('subLink').value = `https://${host}/sub?token=${token}`;
            document.getElementById('base64Link').value = `https://${host}/sub?token=${token}&b64`;
            document.getElementById('clashLink').value = `https://${host}/sub?token=${token}&clash`;
            document.getElementById('singboxLink').value = `https://${host}/sub?token=${token}&sb`;

            // ویرایش تولید اشتراک
            const local = currentConfig.优选订阅生成?.local ?? true;
            const randomIP = currentConfig.优选订阅生成?.本地IP库?.随机IP ?? true;

            if (!local) {
                document.getElementById('ipMode').value = 'generator';
                document.getElementById('generatorURL').value = currentConfig.优选订阅生成?.SUB || '';
            } else if (randomIP) {
                document.getElementById('ipMode').value = 'random';
                document.getElementById('randomCount').value = currentConfig.优选订阅生成?.本地IP库?.随机数量 || 16;
                // تنظیم پورت مشخص
                if (currentConfig.优选订阅生成?.本地IP库?.指定端口 !== undefined) {
                    document.getElementById('specifiedPort').value = currentConfig.优选订阅生成.本地IP库.指定端口;
                }
            } else {
                document.getElementById('ipMode').value = 'custom';
                loadCustomIPs();
            }
            updateIPMode();

            // پیکربندی جزئی
            document.getElementById('subName').value = currentConfig.优选订阅生成?.SUBNAME || '';

            // بررسی وجود آرایه HOSTS
            hasMultipleHosts = Array.isArray(currentConfig.HOSTS) && currentConfig.HOSTS.length > 0;

            const nodeHostInput = document.getElementById('nodeHost');
            if (hasMultipleHosts) {
                // اگر آرایه HOSTS وجود دارد، با کاما همه hostها را نمایش بده
                nodeHostInput.value = currentConfig.HOSTS.join('、');
                // اضافه کردن استایل قابل کلیک و رویداد
                nodeHostInput.classList.add('nodeHost-clickable');
                nodeHostInput.title = 'کلیک برای ویرایش چند دامنه نود';
                nodeHostInput.onclick = openHostsEditModal;
            } else {
                // در غیر این صورت تک HOST را نمایش بده
                nodeHostInput.value = currentConfig.HOST || '';
                // حذف استایل قابل کلیک و رویداد
                nodeHostInput.classList.remove('nodeHost-clickable');
                nodeHostInput.title = 'دامنه نود';
                nodeHostInput.onclick = null;
            }

            document.getElementById('nodeUUID').value = currentConfig.UUID || '';
            document.getElementById('nodePATH').value = currentConfig.PATH || '';
            document.getElementById('protocol').value = currentConfig.协议类型 || 'vless';
            //document.getElementById('transport').value = currentConfig.传输协议 || 'ws';

            // بررسی وجود فیلد رد کردن تأیید گواهی
            const skipVerifyGroup = document.getElementById('skipVerifyGroup');
            if (currentConfig['跳过证书验证'] !== undefined) {
                skipVerifyGroup.style.setProperty('display', 'flex', 'important');
                document.getElementById('skipVerify').checked = currentConfig['跳过证书验证'] || false;
            } else {
                skipVerifyGroup.style.setProperty('display', 'none', 'important');
            }

            // بررسی فیلد "مسیر کامل نود" و تعیین قابلیت ویرایش PATH
            const nodePathInput = document.getElementById('nodePATH');
            if (currentConfig['完整节点路径'] !== undefined) {
                // وجود این فیلد به معنای پشتیبانی بک‌اند از ویرایش PATH، حذف ویژگی readonly
                nodePathInput.removeAttribute('readonly');
                nodePathInput.title = 'مسیر استتار نود';
                nodePathInput.onchange = handlePathChange;
            } else {
                // عدم وجود این فیلد، PATH فقط خواندنی بماند
                nodePathInput.setAttribute('readonly', '');
                nodePathInput.title = 'مسیر استتار نود فقط از طریق متغیر محیطی \'PATH\' قابل تغییر است';
                nodePathInput.onchange = null;
            }

            // بررسی وجود فیلد Fingerprint
            const fingerprintGroup = document.getElementById('fingerprintGroup');
            const fingerprintSelect = document.getElementById('fingerprint');
            if (currentConfig['Fingerprint'] == undefined) {
                fingerprintGroup.style.setProperty('display', 'none', 'important');
            } else {
                fingerprintSelect.value = currentConfig['Fingerprint'] || 'chrome';
            }

            // بررسی وجود فیلد مسیر تصادفی
            const randomPathGroup = document.getElementById('randomPathGroup');
            const randomPathCheckbox = document.getElementById('randomPath');
            if (currentConfig['随机路径'] !== undefined) {
                randomPathGroup.style.setProperty('display', 'flex', 'important');
                randomPathCheckbox.checked = currentConfig['随机路径'] || false;
            } else {
                randomPathGroup.style.setProperty('display', 'none', 'important');
            }

            // بررسی وجود فیلد فعال‌سازی 0RTT
            const enable0RTTGroup = document.getElementById('enable0RTTGroup');
            const enable0RTTCheckbox = document.getElementById('enable0RTT');
            if (currentConfig['启用0RTT'] !== undefined) {
                enable0RTTGroup.style.setProperty('display', 'flex', 'important');
                enable0RTTCheckbox.checked = currentConfig['启用0RTT'] || false;
            } else {
                enable0RTTGroup.style.setProperty('display', 'none', 'important');
            }

            // بررسی وجود فیلد TLS Fragment
            const tlsFragmentGroup = document.getElementById('tlsFragmentGroup');
            const tlsFragmentHappGroup = document.getElementById('tlsFragmentHappGroup');
            const tlsFragmentShadowrocket = document.getElementById('tlsFragmentShadowrocket');
            const tlsFragmentHapp = document.getElementById('tlsFragmentHapp');
            if (currentConfig['TLS分片'] !== undefined) {
                tlsFragmentGroup.style.setProperty('display', 'flex', 'important');
                tlsFragmentHappGroup.style.setProperty('display', 'flex', 'important');
                // بر اساس مقدار فعلی وضعیت تیک را تنظیم کن
                tlsFragmentShadowrocket.checked = currentConfig['TLS分片'] === 'Shadowrocket';
                tlsFragmentHapp.checked = currentConfig['TLS分片'] === 'Happ';
            } else {
                tlsFragmentGroup.style.setProperty('display', 'none', 'important');
                tlsFragmentHappGroup.style.setProperty('display', 'none', 'important');
            }

            // بررسی وجود فیلد ECH
            const echModule = document.getElementById('echModule');
            const enableECHCheckbox = document.getElementById('enableECH');
            if (currentConfig['ECH'] !== undefined) {
                echModule.style.display = 'block';
                enableECHCheckbox.checked = currentConfig['ECH'] || false;
                // بر اساس مقدار Fingerprint وضعیت غیرفعال گزینه‌های ECH را مقداردهی اولیه کن
                updateECHOptionState();

                // پر کردن لیست کشویی DNS ECH
                populateEchDNSSelect();

                // پر کردن لیست کشویی SNI ECH
                populateEchSNISelect();
            } else {
                echModule.style.display = 'none';
            }

            // تنظیم پروکسی معکوس
            const socksEnabled = currentConfig.反代?.SOCKS5?.启用;
            if (!socksEnabled) {
                document.getElementById('proxyMode').value = 'auto';
                document.getElementById('proxyIP').value = currentConfig.反代?.PROXYIP || '';
                document.getElementById('autoProxy').checked = (currentConfig.反代?.PROXYIP === 'auto');
                if (currentConfig.反代?.PROXYIP === 'auto') {
                    document.getElementById('proxyIP').disabled = true;
                }
            } else if (socksEnabled === 'socks5') {
                document.getElementById('proxyMode').value = 'socks5';
                document.getElementById('socks5Addr').value = currentConfig.反代?.SOCKS5?.账号 || '';
                document.getElementById('globalSocks5').checked = currentConfig.反代?.SOCKS5?.全局 || false;
            } else if (socksEnabled === 'http') {
                document.getElementById('proxyMode').value = 'http';
                document.getElementById('httpAddr').value = currentConfig.反代?.SOCKS5?.账号 || '';
                document.getElementById('globalHTTP').checked = currentConfig.反代?.SOCKS5?.全局 || false;
            }
            updateProxyMode();

            // بررسی وجود فیلد قالب مسیر
            const pathTemplateConfigBtn = document.getElementById('pathTemplateConfigBtn');
            if (currentConfig.反代?.路径模板 !== undefined) {
                pathTemplateConfigBtn.style.display = '';
            } else {
                pathTemplateConfigBtn.style.display = 'none';
            }

            // پیکربندی تبدیل اشتراک
            document.getElementById('subAPI').value = currentConfig.订阅转换配置?.SUBAPI || '';
            document.getElementById('subConfig').value = currentConfig.订阅转换配置?.SUBCONFIG || '';
            document.getElementById('emoji').checked = currentConfig.订阅转换配置?.SUBEMOJI || false;

            // تنظیمات اعلان پیام - سازگاری با دو ساختار کانفیگ
            // اول فیلد TG را بخوان، اگر نبود 通知.Telegram را بخوان
            const telegramBotToken = currentConfig.TG?.BotToken || currentConfig.通知?.Telegram?.BotToken;
            const telegramChatID = currentConfig.TG?.ChatID || currentConfig.通知?.Telegram?.ChatID;
            const telegramCheckbox = document.getElementById('telegramEnabled');

            // تشخیص اینکه آیا پیکربندی TG کامل است (هر دو BotToken و ChatID غیر-null و غیر رشته خالی)
            if (telegramBotToken && telegramChatID) {
                // هر دو وجود دارند، checkbox را فعال کن، و وضعیت TG.启用 را بارگذاری کن
                telegramCheckbox.disabled = false;
                telegramCheckbox.checked = currentConfig.TG?.启用 ?? false;
                // دکمه "پیکربندی پارامترها" به رنگ سبز، یعنی پیکربندی شده
                updateTelegramButtonStates(true);
                // دکمه "پاک کردن پیکربندی" قرمز، و قابل کلیک
            } else {
                // اگر هر کدام کم باشد، checkbox را غیرفعال کن
                telegramCheckbox.disabled = true;
                telegramCheckbox.checked = false;
                // دکمه "پیکربندی پارامترها" به رنگ پیش‌فرض، یعنی پیکربندی نشده
                updateTelegramButtonStates(false);
                // دکمه "پاک کردن پیکربندی" خاکستری، و غیرقابل کلیک
            }

            modifiedSections.clear();
            resetAllButtons();

            // از localStorage بارگذاری وضعیت باز/بسته ماژول‌ها
            loadModuleStates();

            // پر کردن لیست کشویی SubConfig (اگر داده بارگذاری شده باشد، مقدار انتخاب شده به صورت خودکار تنظیم می‌شود)
            populateSubConfigSelect();

            // بررسی اینکه آیا دامنه فعلی در آرایه HOSTS است
            checkHostsMismatch();
        }

        // تابع نمایش میزان استفاده CF
        function updateCFUsageDisplay(cfUsage) {
            const workers = cfUsage.workers || 0;
            const pages = cfUsage.pages || 0;
            const total = cfUsage.total || 0;
            const dailyQuota = cfUsage.max || 100000;

            // به‌روزرسانی اعداد نمایش
            document.getElementById('cfWorkerCount').textContent = workers.toLocaleString();
            document.getElementById('cfPagesCount').textContent = pages.toLocaleString();
            document.getElementById('cfDailyQuota').textContent = dailyQuota.toLocaleString();
            document.getElementById('cfTotalDisplay').textContent = total.toLocaleString();

            // محاسبه درصد
            const percentage = ((total / dailyQuota) * 100).toFixed(2);

            // محاسبه نسبت و تنظیم عرض نوار پیشرفت
            const workersRatio = (workers / dailyQuota) * 100;
            const pagesRatio = (pages / dailyQuota) * 100;

            // نوار Workers: از چپ شروع
            const workerBarEl = document.getElementById('cfWorkerBar');
            workerBarEl.style.width = Math.min(workersRatio, 100) + '%';
            workerBarEl.textContent = '';

            // نوار Pages: دنبال نوار Workers
            const pagesBarEl = document.getElementById('cfPagesBar');
            pagesBarEl.style.width = Math.min(pagesRatio, 100 - workersRatio) + '%';
            pagesBarEl.style.left = Math.min(workersRatio, 100) + '%';
            pagesBarEl.textContent = '';

            // متن درصد کلی (مرکز)
            const percentageCenterEl = document.getElementById('cfPercentageCenter');
            percentageCenterEl.textContent = `میزان استفاده درخواست: ${total.toLocaleString()} (${percentage}%)`;
        }

        async function loadCustomIPs() {
            const textarea = document.getElementById('customIPs');
            textarea.disabled = true;
            textarea.value = 'در حال بارگذاری...';
            if (textarea._refreshLineEditor) textarea._refreshLineEditor();

            try {
                const response = await fetch('/admin/ADD.txt?_t=' + Date.now(), {
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                if (response.ok) {
                    textarea.value = await response.text();
                } else {
                    textarea.value = '';
                }
            } catch (error) {
                showToast('بارگذاری IP سفارشی ناموفق', 'error');
                textarea.value = '';
            } finally {
                textarea.disabled = false;
                if (textarea._refreshLineEditor) textarea._refreshLineEditor();
            }
        }

        function updateIPMode() {
            const mode = document.getElementById('ipMode').value;

            const sections = {
                'random': document.getElementById('randomIPSection'),
                'custom': document.getElementById('customIPSection'),
                'generator': document.getElementById('generatorSection')
            };

            Object.keys(sections).forEach(key => {
                const el = sections[key];
                if (el) {
                    if (key === mode) {
                        el.classList.remove('hidden-section');
                        el.style.display = (key === 'custom') ? 'block' : 'grid';
                    } else {
                        el.classList.add('hidden-section');
                        el.style.display = 'none';
                    }
                }
            });

            // نمایش یا مخفی کردن پورت مشخص
            const portSection = document.getElementById('portSection');
            if (portSection) {
                if (mode === 'random' && currentConfig.优选订阅生成?.本地IP库?.指定端口 !== undefined) {
                    portSection.classList.remove('hidden-section');
                    portSection.style.display = 'grid';
                } else {
                    portSection.classList.add('hidden-section');
                    portSection.style.display = 'none';
                }
            }

            // نمایش یا مخفی کردن دکمه‌های بهینه‌سازی آنلاین و رابط اشتراک (فقط در حالت بهینه سفارشی نمایش داده می‌شود)
            const onlineOptimizeBtn = document.getElementById('onlineOptimizeBtn');
            const apiOptimizeBtn = document.getElementById('apiOptimizeBtn');
            if (onlineOptimizeBtn) {
                if (mode === 'custom') {
                    onlineOptimizeBtn.classList.remove('hidden-section');
                } else {
                    onlineOptimizeBtn.classList.add('hidden-section');
                }
            }
            if (apiOptimizeBtn) {
                if (mode === 'custom') {
                    apiOptimizeBtn.classList.remove('hidden-section');
                } else {
                    apiOptimizeBtn.classList.add('hidden-section');
                }
            }

            // هنگام تغییر به حالت بهینه سفارشی، محتوای ADD.txt موجود را به صورت خودکار بارگذاری کن
            if (mode === 'custom') {
                loadCustomIPs();
            }

            markModified('sub');
        }

        // پردازش URL تولیدکننده اشتراک بهینه
        function processGeneratorURL() {
            const input = document.getElementById('generatorURL').value.trim();
            let domain = '';

            if (input) {
                // اگر ورودی خالی نیست، استخراج دامنه
                domain = extractDomain(input);
                document.getElementById('generatorURL').value = domain;
            }

            markModified('sub');
        }

        // استخراج دامنه خالص از URL
        function extractDomain(url) {
            try {
                url = url.trim();

                // اگر پروتکل ندارد، بررسی کن آیا URL کامل یا دامنه خالص است
                if (!url.includes('://')) {
                    // بررسی شامل مسیر، پارامتر کوئری یا پورت
                    if (url.includes('/') || url.includes('?') || url.includes(':')) {
                        // این URL کامل است، پروتکل https را اضافه کن
                        url = 'https://' + url;
                    } else {
                        // این دامنه خالص است، مستقیم برگردان
                        return url;
                    }
                }

                // پارس URL
                const urlObj = new URL(url);

                // دریافت hostname (بدون پورت)
                let domain = urlObj.hostname;

                // حذف پیشوند www (اگر وجود دارد)
                if (domain.startsWith('www.')) {
                    domain = domain.substring(4);
                }

                return domain;
            } catch (error) {
                // اگر پارس URL ناموفق بود، ورودی اصلی بدون قسمت پروتکل را برگردان
                let temp = url.trim();
                if (temp.includes('://')) {
                    temp = temp.split('://')[1];
                }
                if (temp.includes('/')) {
                    temp = temp.split('/')[0];
                }
                if (temp.includes('?')) {
                    temp = temp.split('?')[0];
                }
                if (temp.includes(':')) {
                    temp = temp.split(':')[0];
                }
                if (temp.startsWith('www.')) {
                    temp = temp.substring(4);
                }
                return temp;
            }
        }

        function updateProtocol() {
            const protocol = document.getElementById('protocol').value;
            /*
            const transport = document.getElementById('transport');
            if (protocol === 'trojan') {
                transport.value = 'ws';
                transport.disabled = true;
            } else {
                transport.disabled = false;
            }
            */
        }

        // پردازش تغییرات fingerprint مرورگر، مرتبط با گزینه‌های ECH
        function handleFingerprintChange() {
            updateECHOptionState();
        }

        // پردازش تغییرات وضعیت فعال‌سازی ECH
        function handleECHEnableChange() {
            const enableECHCheckbox = document.getElementById('enableECH');
            const fingerprintSelect = document.getElementById('fingerprint');

            // انواع fingerprint پشتیبانی‌کننده ECH
            const supportECH = ['chrome', 'firefox'];

            // اگر کاربر ECH را روشن کند، اما fingerprint فعلی از ECH پشتیبانی نکند، به طور خودکار به chrome تغییر بده
            if (enableECHCheckbox && enableECHCheckbox.checked) {
                const currentFingerprint = fingerprintSelect?.value;
                if (currentFingerprint && !supportECH.includes(currentFingerprint)) {
                    fingerprintSelect.value = 'chrome';
                    // 同时标记详细配置模块为已修改
                    markModified('config');
                }
            }

            markModified('ech');
        }

        // به‌روزرسانی وضعیت گزینه‌های ECH (غیرفعال/فعال)
        function updateECHOptionState() {
            const fingerprint = document.getElementById('fingerprint').value;
            const enableECHCheckbox = document.getElementById('enableECH');

            // انواع fingerprint پشتیبانی‌کننده ECH
            const supportECH = ['chrome', 'firefox'];

            if (enableECHCheckbox) {
                // وقتی fingerprint از ECH پشتیبانی نمی‌کند، تیک را به طور خودکار بردار
                if (!supportECH.includes(fingerprint) && enableECHCheckbox.checked) {
                    enableECHCheckbox.checked = false;
                    markModified('ech');
                }
            }
        }

        // پر کردن لیست کشویی DNS ECH
        function populateEchDNSSelect() {
            const formGroup = document.getElementById('echDNSGroup');
            const select = document.getElementById('echDNSSelect');
            const customInput = document.getElementById('echDNSCustomInput');
            const hiddenValue = document.getElementById('echDNSValue');

            if (!select || !formGroup) return;

            // بررسی وجود فیلد ECHConfig.DNS
            if (currentConfig.ECHConfig?.DNS === undefined) {
                formGroup.style.display = 'none';
                return;
            }

            // نمایش form-group و لیست کشویی
            formGroup.style.display = 'grid';
            select.style.display = 'block';

            // اگر DNS ذخیره شده وجود دارد، وضعیت انتخاب را تنظیم کن
            const savedDNS = currentConfig.ECHConfig?.DNS || '';
            if (savedDNS) {
                // تلاش برای پیدا کردن گزینه منطبق در لیست کشویی
                select.value = savedDNS;

                // اگر مطابقت ندارد (مقدار در لیست نیست)، "سفارشی" را انتخاب و فیلد ورودی را نمایش بده
                if (select.value !== savedDNS) {
                    select.value = 'custom';
                    customInput.value = savedDNS;
                    customInput.style.display = 'block';
                    hiddenValue.value = savedDNS;
                } else {
                    // موفقیت‌آمیز، مخفی کردن فیلد ورودی سفارشی
                    customInput.style.display = 'none';
                    customInput.value = '';
                    hiddenValue.value = savedDNS;
                }
            } else {
                // مقدار ذخیره شده نیست، پیش‌فرض "سفارشی" را انتخاب
                select.value = 'custom';
                customInput.style.display = 'block';
            }
        }

        // پر کردن لیست کشویی SNI ECH
        function populateEchSNISelect() {
            const formGroup = document.getElementById('echSNIGroup');
            const select = document.getElementById('echSNISelect');
            const customInput = document.getElementById('echSNICustomInput');
            const hiddenValue = document.getElementById('echSNIValue');

            if (!select || !formGroup) return;

            // بررسی وجود فیلد ECHConfig.SNI
            if (currentConfig.ECHConfig?.SNI === undefined) {
                formGroup.style.display = 'none';
                return;
            }

            // نمایش form-group و لیست کشویی
            formGroup.style.display = 'grid';
            select.style.display = 'block';

            // اگر مقدار SNI ذخیره شده وجود دارد، وضعیت انتخاب را تنظیم کن
            const savedSNI = currentConfig.ECHConfig?.SNI;
            if (savedSNI !== undefined) {
                if (savedSNI === null) {
                    // دریافت خودکار
                    select.value = '__AUTO__';
                    customInput.style.display = 'none';
                    customInput.value = '';
                    hiddenValue.value = null;
                } else {
                    // تلاش برای پیدا کردن گزینه منطبق در لیست کشویی
                    select.value = savedSNI;

                    // اگر مطابقت ندارد (مقدار در لیست نیست)، "سفارشی" را انتخاب و فیلد ورودی را نمایش بده
                    if (select.value !== savedSNI) {
                        select.value = 'custom';
                        customInput.value = savedSNI;
                        customInput.style.display = 'block';
                        hiddenValue.value = savedSNI;
                    } else {
                        // موفقیت‌آمیز، مخفی کردن فیلد ورودی سفارشی
                        customInput.style.display = 'none';
                        customInput.value = '';
                        hiddenValue.value = savedSNI;
                    }
                }
            } else {
                // مقدار ذخیره شده نیست، پیش‌فرض "سفارشی" را انتخاب
                select.value = 'custom';
                customInput.style.display = 'block';
            }
        }

        // پردازش تغییرات select DNS ECH
        function onEchDNSSelectChange() {
            const select = document.getElementById('echDNSSelect');
            const customInput = document.getElementById('echDNSCustomInput');
            const hiddenValue = document.getElementById('echDNSValue');

            if (select.value === 'custom') {
                customInput.style.display = 'block';
                hiddenValue.value = customInput.value;
            } else {
                customInput.style.display = 'none';
                customInput.value = '';
                hiddenValue.value = select.value;
            }

            // بررسی آیا DNS داخلی انتخاب شده، اگر بله دامنه تجزیه ECH را به طور خودکار تنظیم کن
            const selectedOption = select.options[select.selectedIndex];
            const region = selectedOption.dataset.region;

            if (region === 'domestic') {
                const echSNISelect = document.getElementById('echSNISelect');
                // اگر انتخاب فعلی __AUTO__ است، به طور خودکار به cloudflare-ech.com تغییر بده
                if (echSNISelect.value === '__AUTO__') {
                    echSNISelect.value = 'cloudflare-ech.com';
                    onEchSNISelectChange();
                }
            }

            markModified('ech');
        }

        // پردازش تغییرات فیلد ورودی سفارشی DNS ECH
        function onEchDNSCustomInput() {
            const customInput = document.getElementById('echDNSCustomInput');
            const hiddenValue = document.getElementById('echDNSValue');
            hiddenValue.value = customInput.value;
            markModified('ech');
        }

        // پردازش تغییرات select SNI ECH
        function onEchSNISelectChange() {
            const select = document.getElementById('echSNISelect');
            const customInput = document.getElementById('echSNICustomInput');
            const hiddenValue = document.getElementById('echSNIValue');

            if (select.value === '__AUTO__') {
                customInput.style.display = 'none';
                customInput.value = '';
                hiddenValue.value = null;

                // بررسی آیا سرویس DNS فعلی داخلی است
                const echDNSSelect = document.getElementById('echDNSSelect');
                const selectedDNSOption = echDNSSelect.options[echDNSSelect.selectedIndex];
                const dnsRegion = selectedDNSOption.dataset.region;

                if (dnsRegion === 'domestic') {
                    alert('⚠️ راهنمای پیکربندی ECH\n\nاستفاده پیش‌فرض از دامنه استتار HOST نود همراه با DNS داخلی ممکن است باعث شکست تجزیه ECH شود.\n\nراه‌حل‌ها (یکی را انتخاب کنید):\n① دامنه تجزیه ECH را به cloudflare-ech.com تغییر دهید (پیشنهاد شده)\n② DNS ECH را به سرویس بین‌المللی تغییر دهید (مانند NextDNS)');
                    select.value = 'cloudflare-ech.com';
                }
            } else if (select.value === 'custom') {
                customInput.style.display = 'block';
                hiddenValue.value = customInput.value;
            } else {
                customInput.style.display = 'none';
                customInput.value = '';
                hiddenValue.value = select.value;
            }
            markModified('ech');
        }

        // پردازش تغییرات فیلد ورودی سفارشی SNI ECH
        function onEchSNICustomInput() {
            const customInput = document.getElementById('echSNICustomInput');
            const hiddenValue = document.getElementById('echSNIValue');
            hiddenValue.value = customInput.value;
            markModified('ech');
        }

        // پردازش آدرس IP PROXY
        function processProxyIP() {
            const input = document.getElementById('proxyIP').value.trim();

            if (input && input !== 'auto') {
                const cleanAddress = extractProxyIPAddress(input);
                document.getElementById('proxyIP').value = cleanAddress;
            }

            markModified('proxy');
        }

        // استخراج فرمت خالص آدرس IP PROXY (نگه داشتن پورت)
        function extractProxyIPAddress(input) {
            input = input.trim();

            // ابتدا بررسی شامل "ip=" (شامل proxyip= و pyip=)
            const ipPatterns = ['proxyip=', 'pyip=', 'ip='];
            for (const pattern of ipPatterns) {
                const index = input.toLowerCase().indexOf(pattern);
                if (index !== -1) {
                    input = input.substring(index + pattern.length).trim();
                    break;
                }
            }

            // حذف پیشوند پروتکل (http:// یا https://)
            if (input.toLowerCase().startsWith('http://')) {
                input = input.substring(7).trim();
            } else if (input.toLowerCase().startsWith('https://')) {
                input = input.substring(8).trim();
            }

            // حذف اسلش انتها
            if (input.endsWith('/')) {
                input = input.substring(0, input.length - 1).trim();
            }

            // حذف توضیحات انتها (محتوای بعد از #)
            if (input.includes('#')) {
                input = input.split('#')[0].trim();
            }

            return input;
        }

        // پردازش آدرس پروکسی SOCKS5 و HTTP
        function processProxyAddress(type) {
            const fieldId = type === 'socks5' ? 'socks5Addr' : 'httpAddr';
            const input = document.getElementById(fieldId).value.trim();
            let cleanAddress = '';

            if (input) {
                cleanAddress = extractProxyAddress(input, type);
                document.getElementById(fieldId).value = cleanAddress;

                // اگر ورودی شامل شناسه پروتکل است، به طور خودکار حالت پروکسی را تغییر و محتوا را منتقل کن
                switchProxyModeByProtocol(input, cleanAddress);
            }

            markModified('proxy');
        }

        // استخراج فرمت خالص آدرس پروکسی
        function extractProxyAddress(input, type) {
            input = input.trim();

            // حذف "/" یا "/" ابتدا
            if (input.startsWith('/')) {
                input = input.substring(1).trim();
            }

            // تشخیص و حذف پیشوند پروتکل
            const socks5Prefixes = ['socks5://', 'socks5=', 'socks5://'];
            const httpPrefixes = ['http://', 'http=', 'https://'];

            for (const prefix of socks5Prefixes) {
                if (input.toLowerCase().startsWith(prefix)) {
                    input = input.substring(prefix.length).trim();
                    break;
                }
            }

            for (const prefix of httpPrefixes) {
                if (input.toLowerCase().startsWith(prefix)) {
                    input = input.substring(prefix.length).trim();
                    break;
                }
            }

            // حذف توضیحات انتها (محتوای بعد از #)
            if (input.includes('#')) {
                input = input.split('#')[0].trim();
            }

            return input;
        }

        // تغییر خودکار حالت پروکسی بر اساس پروتکل
        function switchProxyModeByProtocol(input, cleanAddress) {
            const lowerInput = input.toLowerCase();

            // بررسی شامل پروتکل socks5
            if (lowerInput.includes('socks5://') || lowerInput.includes('socks5=') || lowerInput.startsWith('/socks')) {
                // تغییر به حالت SOCKS5
                document.getElementById('proxyMode').value = 'socks5';

                // پاک کردن محتوای حالت‌های دیگر و پر کردن SOCKS5
                document.getElementById('proxyIP').value = '';
                document.getElementById('socks5Addr').value = cleanAddress;
                document.getElementById('httpAddr').value = '';

                updateProxyMode();
                return;
            }

            // بررسی شامل پروتکل http
            if (lowerInput.includes('http://') || lowerInput.includes('http=') || lowerInput.includes('https://') || lowerInput.startsWith('/http')) {
                // تغییر به حالت HTTP
                document.getElementById('proxyMode').value = 'http';

                // پاک کردن محتوای حالت‌های دیگر و پر کردن HTTP
                document.getElementById('proxyIP').value = '';
                document.getElementById('socks5Addr').value = '';
                document.getElementById('httpAddr').value = cleanAddress;

                updateProxyMode();
                return;
            }
        }
		        function updateProxyMode() {
            const mode = document.getElementById('proxyMode').value;
            document.getElementById('proxyIPSection').style.display = mode === 'auto' ? 'block' : 'none';
            document.getElementById('socks5Section').style.display = mode === 'socks5' ? 'block' : 'none';
            document.getElementById('httpSection').style.display = mode === 'http' ? 'block' : 'none';

            // بر اساس حالت انتخاب شده داده‌های مربوطه را پر کن
            if (mode === 'auto') {
                document.getElementById('proxyIP').value = currentConfig.反代?.PROXYIP || '';
                document.getElementById('autoProxy').checked = (currentConfig.反代?.PROXYIP === 'auto');
                if (currentConfig.反代?.PROXYIP === 'auto') {
                    document.getElementById('proxyIP').disabled = true;
                } else {
                    document.getElementById('proxyIP').disabled = false;
                }
            } else if (mode === 'socks5') {
                document.getElementById('socks5Addr').value = currentConfig.反代?.SOCKS5?.账号 || '';
                document.getElementById('globalSocks5').checked = currentConfig.反代?.SOCKS5?.全局 || false;
            } else if (mode === 'http') {
                document.getElementById('httpAddr').value = currentConfig.反代?.SOCKS5?.账号 || '';
                document.getElementById('globalHTTP').checked = currentConfig.反代?.SOCKS5?.全局 || false;
            }

            // بروزرسانی وضعیت نمایش دکمه "دریافت PROXYIP بیشتر"
            const getMoreBtn = document.getElementById('getMoreProxyIPBtn');
            if (getMoreBtn) {
                getMoreBtn.style.display = mode === 'auto' ? 'inline-block' : 'none';
            }

            // بروزرسانی وضعیت نمایش دکمه "کشف SOCKS5 بیشتر"
            const exploreSocks5Btn = document.getElementById('exploreSocks5Btn');
            if (exploreSocks5Btn) {
                exploreSocks5Btn.style.display = mode === 'socks5' ? 'inline-block' : 'none';
            }

            // بروزرسانی وضعیت نمایش دکمه "کشف HTTP بیشتر"
            const exploreHTTPBtn = document.getElementById('exploreHTTPBtn');
            if (exploreHTTPBtn) {
                exploreHTTPBtn.style.display = mode === 'http' ? 'inline-block' : 'none';
            }

            markModified('proxy');
        }

        function toggleAutoProxy() {
            const autoProxy = document.getElementById('autoProxy').checked;
            document.getElementById('proxyIP').disabled = autoProxy;
            markModified('proxy');
        }

        function toggleModule(titleEl) {
            const module = titleEl.parentElement;
            const content = module.querySelector('.module-content');

            // If there's no collapsible content, just toggle the class
            if (!content) {
                module.classList.toggle('collapsed');
                saveModuleStates();
                return;
            }

            // If a transition is currently attached, remove it to avoid duplicate handlers
            if (content._transitionHandler) {
                content.removeEventListener('transitionend', content._transitionHandler);
                content._transitionHandler = null;
            }

            const isCollapsed = module.classList.contains('collapsed');

            if (isCollapsed) {
                // Expand
                content.style.display = 'block';

                // بررسی می‌کند که آیا ماژول شبکه است، اگر بله داده‌ها را بارگذاری می‌کند
                if (module.querySelector('.network-cards-container') && !networkInfoLoaded) {
                    loadNetworkInfo();
                }

                // Measure height
                const height = content.scrollHeight;
                // Start from 0
                content.style.maxHeight = '0px';
                content.style.opacity = '0';
                // Force reflow
                content.getBoundingClientRect();
                // Animate to measured height
                content.style.maxHeight = height + 'px';
                content.style.opacity = '1';

                const onEnd = function (e) {
                    if (e.propertyName === 'max-height') {
                        // Clear fixed max-height so content can grow/shrink naturally
                        content.style.maxHeight = '';
                        content.removeEventListener('transitionend', onEnd);
                        content._transitionHandler = null;
                    }
                };
                content._transitionHandler = onEnd;
                content.addEventListener('transitionend', onEnd);

                module.classList.remove('collapsed');
            } else {
                // Collapse
                const height = content.scrollHeight;
                // Ensure starting height is set
                content.style.maxHeight = height + 'px';
                content.style.opacity = '1';
                // Force reflow
                content.getBoundingClientRect();
                // Animate to 0
                content.style.maxHeight = '0px';
                content.style.opacity = '0';

                const onEnd = function (e) {
                    if (e.propertyName === 'max-height') {
                        // Hide after collapsing to remove from tab order
                        content.style.display = 'none';
                        content.removeEventListener('transitionend', onEnd);
                        content._transitionHandler = null;
                    }
                };
                content._transitionHandler = onEnd;
                content.addEventListener('transitionend', onEnd);

                module.classList.add('collapsed');
            }

            // ذخیره وضعیت ماژول در localStorage
            saveModuleStates();
        }

        // تابع باز/بسته شدن ماژول اطلاعات شبکه
        function toggleNetworkModule(titleEl) {
            const module = titleEl.closest('.module');
            const content = document.getElementById('network-module-content');
            const icon = titleEl.querySelector('.collapse-icon');

            // If a transition is currently attached, remove it to avoid duplicate handlers
            if (content._transitionHandler) {
                content.removeEventListener('transitionend', content._transitionHandler);
                content._transitionHandler = null;
            }

            const isHidden = content.style.display === 'none' || getComputedStyle(content).display === 'none';

            if (isHidden) {
                // Expand - show latency tests and start testing
                content.style.display = 'block';
                content.style.maxHeight = '0px';
                content.style.opacity = '0';

                requestAnimationFrame(() => {
                    const height = content.scrollHeight;
                    content.style.maxHeight = height + 'px';
                    content.style.opacity = '1';
                });

                if (icon) {
                    icon.style.transform = 'rotate(0deg)';
                }

                const onEnd = function (e) {
                    if (e.propertyName === 'max-height') {
                        // Clear fixed max-height so content can grow/shrink naturally
                        content.style.maxHeight = '';
                        content.removeEventListener('transitionend', onEnd);
                        content._transitionHandler = null;
                    }
                };
                content._transitionHandler = onEnd;
                content.addEventListener('transitionend', onEnd);

                // تولید کارت‌ها و شروع تست
                startLatencyTest();
            } else {
                // Collapse - hide latency tests
                const height = content.scrollHeight;
                // Ensure starting height is set
                content.style.maxHeight = height + 'px';
                content.style.opacity = '1';
                // Force reflow
                content.getBoundingClientRect();
                // Animate to 0
                content.style.maxHeight = '0px';
                content.style.opacity = '0';

                if (icon) {
                    icon.style.transform = 'rotate(90deg)';
                }

                const onEnd = function (e) {
                    if (e.propertyName === 'max-height') {
                        content.style.display = 'none';
                        content.removeEventListener('transitionend', onEnd);
                        content._transitionHandler = null;
                    }
                };
                content._transitionHandler = onEnd;
                content.addEventListener('transitionend', onEnd);
            }
        }

        // هنجارسازی فیلد PATH
        function normalizePath(path) {
            // اگر خالی است، مقدار اصلی را برگردان
            if (!path) return path;

            // حذف '#' و تمام محتوای بعد از آن (نظرات)
            let normalizedPath = path.split('#')[0];

            // حذف فاصله‌های ابتدایی و انتهایی
            normalizedPath = normalizedPath.trim();

            // اگر اولین کاراکتر '/' نیست، اضافه کن
            if (normalizedPath && !normalizedPath.startsWith('/')) {
                normalizedPath = '/' + normalizedPath;
            }

            return normalizedPath;
        }

        // هنجارسازی پس از تکمیل ورودی PATH
        function handlePathChange() {
            const nodePathInput = document.getElementById('nodePATH');
            const originalValue = nodePathInput.value;
            const normalizedValue = normalizePath(originalValue);

            // اگر مقدار هنجارسازی شده با مقدار اصلی متفاوت است، ورودی را بروزرسانی کن
            if (normalizedValue !== originalValue) {
                nodePathInput.value = normalizedValue;
            }

            // علامت‌گذاری به عنوان ویرایش شده
            markModified('config');
        }

        function markModified(section) {
            modifiedSections.add(section);

            // پردازش ویژه بخش اعلان‌ها: بروزرسانی وضعیت TG.فعال
            if (section === 'notification') {
                const telegramCheckbox = document.getElementById('telegramEnabled');
                if (!currentConfig.TG) currentConfig.TG = {};
                currentConfig.TG.启用 = telegramCheckbox.checked;
            }

            updateButtonStates();
        }

        function updateButtonStates() {
            // ماژول تولید اشتراک
            const subModified = modifiedSections.has('sub');
            document.getElementById('saveSubBtn').disabled = !subModified;
            document.getElementById('cancelSubBtn').disabled = !subModified;

            // ماژول اطلاعات پیکربندی
            const configModified = modifiedSections.has('config');
            document.getElementById('saveConfigBtn').disabled = !configModified;
            document.getElementById('cancelConfigBtn').disabled = !configModified;

            // ماژول تنظیمات ECH
            const echModified = modifiedSections.has('ech');
            document.getElementById('saveEchBtn').disabled = !echModified;
            document.getElementById('cancelEchBtn').disabled = !echModified;

            // ماژول تنظیمات پروکسی معکوس
            const proxyModified = modifiedSections.has('proxy');
            document.getElementById('saveProxyBtn').disabled = !proxyModified;
            document.getElementById('cancelProxyBtn').disabled = !proxyModified;

            // ماژول تبدیل اشتراک
            const convertModified = modifiedSections.has('convert');
            document.getElementById('saveConvertBtn').disabled = !convertModified;
            document.getElementById('cancelConvertBtn').disabled = !convertModified;

            // ماژول تنظیمات اعلان
            const notificationModified = modifiedSections.has('notification');
            document.getElementById('saveNotificationBtn').disabled = !notificationModified;
            document.getElementById('cancelNotificationBtn').disabled = !notificationModified;
        }

        function resetAllButtons() {
            document.querySelectorAll('[id^="save"]').forEach(btn => btn.disabled = true);
            document.querySelectorAll('[id^="cancel"]').forEach(btn => btn.disabled = true);
        }

        function copySubscription(elementId) {
            const element = document.getElementById(elementId);
            navigator.clipboard.writeText(element.value).then(() => {
                showToast('در کلیپ‌بورد کپی شد', 'success');
            }).catch(() => {
                showToast('کپی ناموفق بود', 'error');
            });
        }

        function handleTLSFragmentChange(type) {
            const shadowrocket = document.getElementById('tlsFragmentShadowrocket');
            const happ = document.getElementById('tlsFragmentHapp');

            if (type === 'Shadowrocket') {
                if (shadowrocket.checked) {
                    happ.checked = false;
                }
            } else if (type === 'Happ') {
                if (happ.checked) {
                    shadowrocket.checked = false;
                }
            }
        }

        function showQRCode(elementId) {
            const text = document.getElementById(elementId).value;
            const container = document.getElementById('qrcodeContainer');
            container.innerHTML = '';

            // اگر متن بیش از حد طولانی است، از سطح تصحیح خطای پایین‌تر برای پشتیبانی از محتوای طولانی‌تر استفاده کن
            let correctLevel = QRCode.CorrectLevel.H;
            if (text.length > 1500) {
                correctLevel = QRCode.CorrectLevel.M;
            }
            if (text.length > 2500) {
                correctLevel = QRCode.CorrectLevel.L;
            }

            try {
                new QRCode(container, {
                    text: text,
                    width: 300,
                    height: 300,
                    colorDark: '#000',
                    colorLight: '#fff',
                    correctLevel: correctLevel
                });
                document.getElementById('qrcodeModal').classList.add('show');
            } catch (error) {
            // اگر متن بیش از حد طولانی است، پیام خطا نمایش بده
                console.error('خطا در تولید QR code:', error);
                showToast('لینک بیش از حد طولانی است، امکان تولید QR code وجود ندارد. با نویسنده پروژه تماس بگیرید.', 'error');
                container.innerHTML = '<div style="padding:20px;text-align:center;color:#f44336;">خطا در تولید QR code: محتوا بیش از حد طولانی است</div>';
            }
        }

        function closeQRCode(event) {
            if (!event || event.target.id === 'qrcodeModal') {
                document.getElementById('qrcodeModal').classList.remove('show');
            }
        }

        function handleSkipVerifyChange(event) {
            if (event.target.checked) {
                // نمایش هشدار
                event.target.checked = false; // ابتدا تیک را بردارید
                document.getElementById('skipVerifyWarningModal').classList.add('show');
            } else {
                markModified('config');
            }
        }

        function closeSkipVerifyWarning(event) {
            if (!event || event.target.id === 'skipVerifyWarningModal') {
                document.getElementById('skipVerifyWarningModal').classList.remove('show');
            }
        }

        function confirmSkipVerify() {
            document.getElementById('skipVerify').checked = true;
            markModified('config');
            closeSkipVerifyWarning();
        }

        // توابع مربوط به کادر ویرایش HOSTS
        function openHostsEditModal(event) {
            if (event) event.stopPropagation();
            const modal = document.getElementById('hostsEditModal');
            const textarea = document.getElementById('hostsEditTextarea');

            // پر کردن محتوای آرایه HOSTS در کادر متنی، هر کدام در یک خط
            if (currentConfig.HOSTS && Array.isArray(currentConfig.HOSTS)) {
                textarea.value = currentConfig.HOSTS.join('\n');
            } else {
                textarea.value = '';
            }

            modal.classList.add('show');
            textarea.focus();
        }

        function closeHostsEditModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('hostsEditModal');
            modal.classList.remove('show');
        }

        function confirmHostsEdit() {
            const textarea = document.getElementById('hostsEditTextarea');
            const nodeHostInput = document.getElementById('nodeHost');

            // تقسیم محتوای کادر متنی بر اساس کاما، کامای فارسی و خط جدید به آرایه
            const text = textarea.value;
            // استفاده از عبارات منظم، , 、، و \n همه به عنوان جداکننده
            const items = text.split(/[ ,，。\n]+/)
                .map(item => cleanHostDomain(item.trim()))
                .filter(item => item.length > 0);

            if (items.length === 0) {
                showToast('لطفاً حداقل یک دامنه وارد کنید', 'error');
                return;
            }

            // بروزرسانی آرایه currentConfig.HOSTS
            currentConfig.HOSTS = items;

            // بروزرسانی نمایش کادر ورودی (با کاما اتصال)
            nodeHostInput.value = items.join('、');

            // بستن کادر
            closeHostsEditModal();

            // علامت‌گذاری که پیکربندی ویرایش شده است
            markModified('config');

            showToast('لیست دامنه‌ها بروزرسانی شد، لطفاً پیکربندی را ذخیره کنید', 'success');
        }

        // پاکسازی فرمت دامنه: حذف پروتکل، مسیر، پورت، فقط دامنه خالص نگه دار
        function cleanHostDomain(input) {
            if (!input) return '';

            let domain = input;

            // حذف پیشوند پروتکل (http:// یا https://)
            domain = domain.replace(/^https?:\/\//i, '');

            // حذف بخش مسیر (اولین / و بعد از آن)
            const slashIndex = domain.indexOf('/');
            if (slashIndex !== -1) {
                domain = domain.substring(0, slashIndex);
            }

            // حذف پورت (عدد بعد از :)
            domain = domain.replace(/:\d+$/, '');

            return domain.trim();
        }

        async function saveSub() {
            const mode = document.getElementById('ipMode').value;

            // بررسی خالی بودن محتوای کادر متنی
            if (mode === 'random') {
                const randomCount = document.getElementById('randomCount').value.trim();
                if (!randomCount) {
                    showToast('تعداد IP تصادفی نمی‌تواند خالی باشد', 'error');
                    return;
                }
            } else if (mode === 'custom') {
                const customIPs = document.getElementById('customIPs').value.trim();
                if (!customIPs) {
                    showToast('آدرس IP سفارشی نمی‌تواند خالی باشد', 'error');
                    return;
                }
            } else if (mode === 'generator') {
                const generatorURL = document.getElementById('generatorURL').value.trim();
                if (!generatorURL) {
                    showToast('آدرس تولیدکننده اشتراک نمی‌تواند خالی باشد', 'error');
                    return;
                }
            }

            const updates = {
                local: mode !== 'generator',
                本地IP库: { 随机IP: mode === 'random', 随机数量: parseInt(document.getElementById('randomCount').value) || 16 },
                SUB: mode === 'generator' ? document.getElementById('generatorURL').value : null,
                SUBNAME: currentConfig.优选订阅生成.SUBNAME,
                SUBUpdateTime: currentConfig.优选订阅生成.SUBUpdateTime,
                TOKEN: currentConfig.优选订阅生成.TOKEN
            };

            // اگر پورت مشخص شده وجود دارد، به IP محلی اضافه کن
            if (currentConfig.优选订阅生成?.本地IP库?.指定端口 !== undefined) {
                updates.本地IP库.指定端口 = parseInt(document.getElementById('specifiedPort').value);
            }

            currentConfig.优选订阅生成 = { ...currentConfig.优选订阅生成, ...updates };

            if (mode === 'custom') {
                const customIPs = document.getElementById('customIPs').value;
                try {
                    await fetch('/admin/ADD.txt', { method: 'POST', body: customIPs });
                } catch (error) {
                    showToast('ذخیره IP سفارشی ناموفق بود', 'error');
                    return;
                }
            }

            await saveConfigToServer('sub');
        }

        async function saveConfig() {
            currentConfig.优选订阅生成.SUBNAME = document.getElementById('subName').value;
            currentConfig.协议类型 = document.getElementById('protocol').value;
            //currentConfig.传输协议 = currentConfig.协议类型 === 'trojan' ? 'ws' : document.getElementById('transport').value;
            currentConfig.跳过证书验证 = document.getElementById('skipVerify').checked;

            // ذخیره PATH (اگر فیلد "مسیر کامل نود" وجود دارد، به معنای پشتیبانیbackend از ویرایش PATH)
            if (currentConfig['完整节点路径'] !== undefined) {
                currentConfig.PATH = document.getElementById('nodePATH').value;
            }

            // ذخیره Fingerprint (اگر فیلد وجود دارد)
            if (currentConfig['Fingerprint'] !== undefined) {
                currentConfig['Fingerprint'] = document.getElementById('fingerprint').value;
            }

            // ذخیره مسیر تصادفی (اگر فیلد وجود دارد)
            if (currentConfig['随机路径'] !== undefined) {
                currentConfig['随机路径'] = document.getElementById('randomPath').checked;
            }

            // ذخیره فعال‌سازی 0RTT (اگر فیلد وجود دارد)
            if (currentConfig['启用0RTT'] !== undefined) {
                currentConfig['启用0RTT'] = document.getElementById('enable0RTT').checked;
            }

            // ذخیره TLS Fragmentation (اگر فیلد وجود دارد)
            if (currentConfig['TLS分片'] !== undefined) {
                const shadowrocket = document.getElementById('tlsFragmentShadowrocket').checked;
                const happ = document.getElementById('tlsFragmentHapp').checked;

                if (shadowrocket) {
                    currentConfig['TLS分片'] = 'Shadowrocket';
                } else if (happ) {
                    currentConfig['TLS分片'] = 'Happ';
                } else {
                    currentConfig['TLS分片'] = null;
                }
            }

            await saveConfigToServer('config');
            // بروزرسانی عنوان صفحه وب
            document.title = `${currentConfig.优选订阅生成?.SUBNAME || 'edgetunnel'} - صفحه تنظیمات پنل مدیریت`;
        }

        async function saveEch() {
            // ذخیره ECH (اگر فیلد وجود دارد)
            if (currentConfig['ECH'] !== undefined) {
                currentConfig['ECH'] = document.getElementById('enableECH').checked;

                // ذخیره ECHConfig.DNS (اگر وجود دارد)
                if (currentConfig.ECHConfig?.DNS !== undefined) {
                    const dnsValue = document.getElementById('echDNSValue').value;
                    if (dnsValue) {
                        currentConfig.ECHConfig.DNS = dnsValue;
                    }
                }

                // ذخیره ECHConfig.SNI (اگر وجود دارد)
                if (currentConfig.ECHConfig?.SNI !== undefined) {
                    const sniValue = document.getElementById('echSNIValue').value;
                    currentConfig.ECHConfig.SNI = sniValue === '' ? null : sniValue;
                }
            }

            await saveConfigToServer('ech');
        }

        async function saveProxy() {
            const mode = document.getElementById('proxyMode').value;
            let socksEnabled = null;
            let socksAccount = '';
            let globalProxy = false;
            let proxyIP = currentConfig.反代.PROXYIP;

            // بررسی خالی بودن محتوای کادر متنی
            if (mode === 'auto') {
                socksEnabled = null;
                const autoProxy = document.getElementById('autoProxy').checked;
                proxyIP = autoProxy ? 'auto' : document.getElementById('proxyIP').value.trim();

                if (!autoProxy && !proxyIP) {
                    showToast('آدرس IP PROXY نمی‌تواند خالی باشد', 'error');
                    return;
                }
            } else if (mode === 'socks5') {
                socksEnabled = 'socks5';
                socksAccount = document.getElementById('socks5Addr').value.trim();
                globalProxy = document.getElementById('globalSocks5').checked;

                if (!socksAccount) {
                    showToast('آدرس SOCKS5 نمی‌تواند خالی باشد', 'error');
                    return;
                }
            } else if (mode === 'http') {
                socksEnabled = 'http';
                socksAccount = document.getElementById('httpAddr').value.trim();
                globalProxy = document.getElementById('globalHTTP').checked;

                if (!socksAccount) {
                    showToast('آدرس HTTP نمی‌تواند خالی باشد', 'error');
                    return;
                }
            }

            currentConfig.反代 = {
                PROXYIP: proxyIP,
                SOCKS5: {
                    启用: socksEnabled,
                    全局: globalProxy,
                    账号: socksAccount,
                    白名单: currentConfig.反代.SOCKS5.白名单
                }
            };

            await saveConfigToServer('proxy');
        }

        // بارگذاری داده‌های SubConfig JSON
        async function loadSubConfigData() {
            try {
                const url = 'https://raw.githubusercontent.com/cmliu/cmliu/main/SUBCONFIG.json';
                const text = await fetchWithAutoMirror(url, 'SubConfig');
                subConfigData = JSON.parse(text);
                populateSubConfigSelect();
                console.log('[لیست پیکربندی تبدیل اشتراک] داده‌های SUBCONFIG با موفقیت بارگذاری شدند');
            } catch (error) {
                console.error('Error loading SubConfig:', error);
                // در صورت شکست بارگذاری، همچنان کادر کشویی نمایش داده می‌شود (فقط گزینه سفارشی)
                subConfigData = null;
                populateSubConfigSelect();
            }
        }

        // پر کردن کادر کشویی SubConfig
        function populateSubConfigSelect() {
            const select = document.getElementById('subConfigSelect');
            const customInput = document.getElementById('subConfigCustomInput');
            if (!select) return; // عنصر وجود ندارد، منتظر فراخوانی بعدی بمان

            // همیشه گزینه "سفارشی" را به عنوان اولین مورد اضافه کن
            select.innerHTML = '<option value="custom">&nbsp;&nbsp;&nbsp;&nbsp;سفارشی</option>';

            // اگر داده‌ها وجود دارند، گزینه‌های گروه‌بندی شده اضافه کن
            if (subConfigData && Array.isArray(subConfigData)) {
                subConfigData.forEach(group => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = group.label;

                    if (group.options && Array.isArray(group.options)) {
                        group.options.forEach(option => {
                            const opt = document.createElement('option');
                            opt.value = option.value;
                            opt.textContent = option.label;
                            optgroup.appendChild(opt);
                        });
                    }

                    select.appendChild(optgroup);
                });
            }

            // نمایش کادر کشویی
            select.style.display = 'block';

            // اگر مقدار پیکربندی ذخیره شده وجود دارد، وضعیت انتخاب را تنظیم کن
            const savedSubConfig = currentConfig.订阅转换配置?.SUBCONFIG || '';
            if (savedSubConfig) {
                // تلاش برای یافتن گزینه منطبق در کادر کشویی
                select.value = savedSubConfig;

                // اگر مطابقت ندارد (مقدار در لیست نیست)، "سفارشی" را انتخاب کن و کادر ورودی را نمایش بده
                if (select.value !== savedSubConfig) {
                    select.value = 'custom';
                    customInput.value = savedSubConfig;
                    customInput.style.display = 'block';
                    document.getElementById('subConfig').value = savedSubConfig;
                } else {
                    // مطابقت موفقیت‌آمیز، پنهان کردن کادر ورودی سفارشی
                    customInput.style.display = 'none';
                    customInput.value = '';
                    document.getElementById('subConfig').value = savedSubConfig;
                }
            } else {
                // مقدار ذخیره شده نیست، پیش‌فرض "سفارشی" را انتخاب کن
                select.value = 'custom';
                customInput.style.display = 'block';
            }

            // تنظیم رویداد تغییر listener
            select.onchange = function () {
                if (this.value === 'custom') {
                    // سفارشی را انتخاب کن، کادر ورودی را نمایش بده
                    customInput.style.display = 'block';
                    document.getElementById('subConfig').value = customInput.value;
                } else {
                    // پیش‌تنظیم را انتخاب کن، پنهان کردن کادر ورودی و بروزرسانی مقدار
                    customInput.style.display = 'none';
                    customInput.value = '';
                    document.getElementById('subConfig').value = this.value;
                }
                markModified('convert');
            };
        }

        // پردازش تغییر کادر ورودی سفارشی
        function onSubConfigCustomInput() {
            const customInput = document.getElementById('subConfigCustomInput');
            document.getElementById('subConfig').value = customInput.value;
            markModified('convert');
        }

        async function saveConvert() {
            currentConfig.订阅转换配置 = {
                SUBAPI: document.getElementById('subAPI').value,
                SUBCONFIG: document.getElementById('subConfig').value,
                SUBEMOJI: document.getElementById('emoji').checked
            };

            await saveConfigToServer('convert');
        }

        async function saveConfigToServer(section) {
            try {
                const response = await fetch('/admin/config.json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    },
                    body: JSON.stringify(currentConfig)
                });

                if (!response.ok) throw new Error('ذخیره ناموفق بود');
                showToast('✅ پیکربندی ذخیره شد، لطفاً اشتراک را بروزرسانی کنید تا آخرین محتوای نود را دریافت کنید!', 'success');
                modifiedSections.delete(section);
                updateButtonStates();
            } catch (error) {
                showToast('😢 ' + error.message + '، لطفاً محیط شبکه را بررسی کنید یا پروکسی را خاموش و دوباره امتحان کنید!', 'error');
            }
        }

        function cancelEdit(section) {
            currentConfig = JSON.parse(JSON.stringify(originalConfig));

            // فقط مقادیر آن ماژول را بازنشانی کن، renderUI را فراخوانی نکن تا حالت باز بماند
            if (section === 'sub') {
                const local = currentConfig.优选订阅生成?.local ?? true;
                const randomIP = currentConfig.优选订阅生成?.本地IP库?.随机IP ?? true;

                if (!local) {
                    document.getElementById('ipMode').value = 'generator';
                    document.getElementById('generatorURL').value = currentConfig.优选订阅生成?.SUB || '';
                } else if (randomIP) {
                    document.getElementById('ipMode').value = 'random';
                    document.getElementById('randomCount').value = currentConfig.优选订阅生成?.本地IP库?.随机数量 || 16;
                    // تنظیم پورت مشخص شده
                    if (currentConfig.优选订阅生成?.本地IP库?.指定端口 !== undefined) {
                        document.getElementById('specifiedPort').value = currentConfig.优选订阅生成.本地IP库.指定端口;
                    }
                } else {
                    document.getElementById('ipMode').value = 'custom';
                    loadCustomIPs();
                }
                updateIPMode();
            } else if (section === 'config') {
                document.getElementById('subName').value = currentConfig.优选订阅生成?.SUBNAME || '';
                document.getElementById('nodeHost').value = currentConfig.HOST || '';
                document.getElementById('nodeUUID').value = currentConfig.UUID || '';
                document.getElementById('nodePATH').value = currentConfig.PATH || '';
                document.getElementById('protocol').value = currentConfig.协议类型 || 'vless';
                document.getElementById('skipVerify').checked = currentConfig.跳过证书验证 || false;

                // مدیریت وضعیت فقط خواندنی فیلد PATH
                const nodePathInput = document.getElementById('nodePATH');
                if (currentConfig['完整节点路径'] !== undefined) {
                    nodePathInput.removeAttribute('readonly');
                    nodePathInput.title = 'مسیر نود';
                    nodePathInput.onchange = handlePathChange;
                } else {
                    nodePathInput.setAttribute('readonly', '');
                    nodePathInput.title = 'مسیر نود فقط از طریق متغیر محیطی PATH قابل تغییر است';
                    nodePathInput.onchange = null;
                }

                // بازنشانی مسیر تصادفی (اگر فیلد وجود دارد)
                if (currentConfig['随机路径'] !== undefined) {
                    document.getElementById('randomPath').checked = currentConfig['随机路径'] || false;
                }

                // بازنشانی فعال‌سازی 0RTT (اگر فیلد وجود دارد)
                if (currentConfig['启用0RTT'] !== undefined) {
                    document.getElementById('enable0RTT').checked = currentConfig['启用0RTT'] || false;
                }

                // بازنشانی TLS Fragmentation (اگر فیلد وجود دارد)
                if (currentConfig['TLS分片'] !== undefined) {
                    document.getElementById('tlsFragmentShadowrocket').checked = currentConfig['TLS分片'] === 'Shadowrocket';
                    document.getElementById('tlsFragmentHapp').checked = currentConfig['TLS分片'] === 'Happ';
                }

                // بازنشانی ECH (اگر فیلد وجود دارد)
                if (currentConfig['ECH'] !== undefined) {
                    document.getElementById('enableECH').checked = currentConfig['ECH'] || false;

                    // بازنشانی کادر کشویی ECHConfig
                    populateEchDNSSelect();
                    populateEchSNISelect();
                }

                updateProtocol();
            } else if (section === 'ech') {
                // بازنشانی تنظیمات ECH
                if (currentConfig['ECH'] !== undefined) {
                    document.getElementById('enableECH').checked = currentConfig['ECH'] || false;

                    // بازنشانی کادر کشویی ECHConfig
                    populateEchDNSSelect();
                    populateEchSNISelect();
                }
            } else if (section === 'proxy') {
                const socksEnabled = currentConfig.反代?.SOCKS5?.启用;
                if (!socksEnabled) {
                    document.getElementById('proxyMode').value = 'auto';
                    document.getElementById('proxyIP').value = currentConfig.反代?.PROXYIP || '';
                    document.getElementById('autoProxy').checked = (currentConfig.反代?.PROXYIP === 'auto');
                    if (currentConfig.反代?.PROXYIP === 'auto') {
                        document.getElementById('proxyIP').disabled = true;
                    }
                } else if (socksEnabled === 'socks5') {
                    document.getElementById('proxyMode').value = 'socks5';
                    document.getElementById('socks5Addr').value = currentConfig.反代?.SOCKS5?.账号 || '';
                    document.getElementById('globalSocks5').checked = currentConfig.反代?.SOCKS5?.全局 || false;
                } else if (socksEnabled === 'http') {
                    document.getElementById('proxyMode').value = 'http';
                    document.getElementById('httpAddr').value = currentConfig.反代?.SOCKS5?.账号 || '';
                    document.getElementById('globalHTTP').checked = currentConfig.反代?.SOCKS5?.全局 || false;
                }
                updateProxyMode();
            } else if (section === 'convert') {
                document.getElementById('subAPI').value = currentConfig.订阅转换配置?.SUBAPI || '';
                document.getElementById('subConfig').value = currentConfig.订阅转换配置?.SUBCONFIG || '';
                document.getElementById('emoji').checked = currentConfig.订阅转换配置?.SUBEMOJI || false;
                // دوباره پر کردن کادر کشویی برای بازیابی وضعیت انتخاب صحیح
                populateSubConfigSelect();
            }

            modifiedSections.delete(section);
            updateButtonStates();
        }

        // ذخیره وضعیت باز/بسته شدن ماژول در localStorage
        function saveModuleStates() {
            const states = {};
            document.querySelectorAll('.module').forEach((module, index) => {
                const title = module.querySelector('.module-title')?.textContent?.trim() || ('module-' + index);
                // وضعیت ماژول‌های "مشاهده لاگ‌ها" و "اطلاعات شبکه فعلی" ذخیره نشود
                if (title !== '📋 مشاهده لاگ‌ها' && title !== '🌍 اطلاعات شبکه فعلی') {
                    states[title] = !module.classList.contains('collapsed');
                }
            });
            localStorage.setItem('adminModuleStates', JSON.stringify(states));
        }

        // بارگذاری وضعیت باز/بسته شدن ماژول از localStorage
        function loadModuleStates() {
            const savedStates = localStorage.getItem('adminModuleStates');
            const states = savedStates ? JSON.parse(savedStates) : {};

            // اگر اولین بازدید است (localStorage وضعیتی ذخیره نشده)، همه ماژول‌ها به طور پیش‌فرض بسته هستند
            const isFirstVisit = !savedStates;

            document.querySelectorAll('.module').forEach((module, index) => {
                const title = module.querySelector('.module-title')?.textContent?.trim() || ('module-' + index);
                let shouldBeExpanded;

                // ماژول "مشاهده لاگ‌ها" همیشه بسته می‌ماند، ماژول "اطلاعات شبکه" همیشه باز است
                if (title === '📋 مشاهده لاگ‌ها') {
                    shouldBeExpanded = false;
                } else if (title === '🌍 اطلاعات شبکه فعلی') {
                    shouldBeExpanded = true;
                } else {
                    shouldBeExpanded = isFirstVisit ? false : (states[title] !== false); // اول پیش‌فرض بسته است، سپس بر اساس وضعیت ذخیره شده
                }

                const isCurrentlyCollapsed = module.classList.contains('collapsed');
                const content = module.querySelector('.module-content');

                if (shouldBeExpanded && isCurrentlyCollapsed) {
                    // نیاز به باز کردن
                    module.classList.remove('collapsed');
                    if (content) {
                        content.style.display = 'block';
                        content.style.maxHeight = '';
                        content.style.opacity = '1';
                    }
                } else if (!shouldBeExpanded && !isCurrentlyCollapsed) {
                    // نیاز به بستن
                    module.classList.add('collapsed');
                    if (content) {
                        content.style.display = 'none';
                        content.style.maxHeight = '0px';
                        content.style.opacity = '0';
                    }
                }
            });
        }

        async function refreshConfig() {
            await loadConfig();
            const loadTime = currentConfig.加载时间 || 'ناشناخته';
            showToast(`پیکربندی بروزرسانی شد (زمان بارگذاری: ${loadTime})`, 'success');
        }

        function resetConfigWithConfirm() {
            document.getElementById('resetModal').classList.add('show');
        }

        function closeResetModal(event) {
            if (event && event.target.id !== 'resetModal') return;
            document.getElementById('resetModal').classList.remove('show');
        }

        async function confirmReset() {
            try {
                const response = await fetch('/admin/init');
                if (!response.ok) throw new Error('بازنشانی ناموفق بود');

                closeResetModal();
                showToast('پیکربندی به مقادیر پیش‌فرض بازنشانی شد', 'success');

                // تاخیر 1 ثانیه‌ای برای بارگذاری مجدد صفحه، تا کاربر پیام موفقیت را ببیند
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } catch (error) {
                showToast('بازنشانی ناموفق بود: ' + error.message, 'error');
            }
        }

        function logout() {
            window.location.href = '/logout';
        }

        // تغییر حالت کاربر - غیرفعال شده، همیشه پیشرفته
        function toggleUserMode() {
            // حالت پیشرفته همیشه فعال است
            showToast('🚀 سیستم همیشه در حالت پیشرفته قرار دارد', 'info');
        }

        // مقداردهی اولیه حالت کاربر - همیشه پیشرفته
        function initUserMode() {
            // همیشه حالت پیشرفته فعال است
            const cardContainer = document.querySelector('.card-container');
            if (cardContainer) {
                cardContainer.classList.remove('simple-mode');
            }
            
            // مخفی کردن المان‌های حالت ساده
            document.querySelectorAll('.simple-mode-only').forEach(el => {
                el.style.display = 'none';
            });
            
            // نمایش المان‌های حالت پیشرفته
            document.querySelectorAll('.expert-mode-only').forEach(el => {
                el.style.display = '';
            });
        }

        function showToast(message, type = 'info') {
            // حذف toast موجود
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            // ایجاد toast جدید
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            // انیمیشن نمایش
            setTimeout(() => toast.classList.add('show'), 10);

            // مخفی شدن خودکار
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ترجمه نوع لاگ
        function translateLogType(type, ua = '') {
            // اگر نوع Get_SUB است، بررسی کن آیا UA شامل subconverter است
            if (type === 'Get_SUB') {
                const uaLowercase = (ua || '').toLowerCase();
                if (uaLowercase.includes('subconverter')) {
                    return { text: 'تبدیل اشتراک', color: '#3b82f6' };
                }
                return { text: 'دریافت اشتراک', color: '#10b981' };
            }

            const typeMap = {
                'Admin_Login': { text: 'ورود به پنل', color: '#f59e0b' },
                'Save_Config': { text: 'ذخیره پیکربندی', color: '#8b5cf6' },
                'Init_Config': { text: 'بازنشانی پیکربندی', color: '#ef4444' },
                'Save_Custom_IPs': { text: 'IP سفارشی', color: '#06b6d4' }
            };
            return typeMap[type] || { text: type, color: '#6b7280' };
        }

        // قالب‌بندی timestamp به UTC+8
        function formatTime(timestamp) {
            const date = new Date(timestamp + 8 * 3600 * 1000);
            const year = date.getUTCFullYear();
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const day = String(date.getUTCDate()).padStart(2, '0');
            const hours = String(date.getUTCHours()).padStart(2, '0');
            const minutes = String(date.getUTCMinutes()).padStart(2, '0');
            const seconds = String(date.getUTCSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // در هنگام باز شدن ماژول لاگ، بارگذاری لاگ‌ها
        let logsLoaded = false;
        function loadLogsOnExpand(titleEl) {
            const module = titleEl.parentElement;
            const isCollapsed = module.classList.contains('collapsed');

            // اگر حالت باز است و لاگ‌ها قبلاً بارگذاری نشده‌اند، بارگذاری کن
            if (!isCollapsed && !logsLoaded) {
                loadLogs();
            }
        }

        // بارگذاری آخرین 8 لاگ
        async function loadLogs() {
            try {
                const response = await fetch('/admin/log.json?_t=' + Date.now(), {
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                if (!response.ok) throw new Error('بارگذاری لاگ‌ها ناموفق بود');
                const logs = await response.json();
                logsLoaded = true;

                // مرتب‌سازی بر اساس زمان از جدید به قدیم، گرفتن 6 مورد اول
                const recentLogs = logs.sort((a, b) => b.TIME - a.TIME).slice(0, 6);

                const container = document.getElementById('logsContainer');
                if (recentLogs.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;">هیچ لاگی ثبت نشده است</div>';
                    return;
                }

                // بررسی آیا دستگاه موبایل است
                const isMobile = window.innerWidth <= 768;

                let html = '<table style="width: 100%; border-collapse: collapse;">';
                if (isMobile) {
                    // موبایل: نمایش زمان، IP، عملیات
                    html += '<thead><tr style="border-bottom: 2px solid #e5e7eb;"><th style="text-align: left; padding: 10px; font-weight: 600;">زمان (UTC+8)</th><th style="text-align: left; padding: 10px; font-weight: 600;">IP</th><th style="text-align: left; padding: 10px; font-weight: 600;">عملیات</th></tr></thead>';
                } else {
                    // دسکتاپ: نمایش زمان، IP، منطقه، عملیات
                    html += '<thead><tr style="border-bottom: 2px solid #e5e7eb;"><th style="text-align: left; padding: 10px; font-weight: 600;">زمان (UTC+8)</th><th style="text-align: left; padding: 10px; font-weight: 600;">IP</th><th style="text-align: left; padding: 10px; font-weight: 600;">منطقه</th><th style="text-align: left; padding: 10px; font-weight: 600;">عملیات</th></tr></thead>';
                }
                html += '<tbody>';

                recentLogs.forEach(log => {
                    const logType = translateLogType(log.TYPE, log.UA);
                    const cc = log.CC || 'ناشناخته';
                    const timeStr = formatTime(log.TIME);
                    const ip = log.IP || 'ناشناخته';

                    if (isMobile) {
                        // موبایل: نمایش ندادن منطقه
                        html += `<tr style="border-bottom: 1px solid #f3f4f6;"><td style="padding: 10px; font-size: 12px;">${timeStr}</td><td style="padding: 10px; font-family: monospace; font-size: 12px;">${ip}</td><td style="padding: 10px;"><span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 12px; color: #fff; background-color: ${logType.color};">${logType.text}</span></td></tr>`;
                    } else {
                        // دسکتاپ: نمایش منطقه
                        html += `<tr style="border-bottom: 1px solid #f3f4f6;"><td style="padding: 10px;">${timeStr}</td><td style="padding: 10px; font-family: monospace; font-size: 12px;">${ip}</td><td style="padding: 10px;">${cc}</td><td style="padding: 10px;"><span style="display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 12px; color: #fff; background-color: ${logType.color};">${logType.text}</span></td></tr>`;
                    }
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                const container = document.getElementById('logsContainer');
                container.innerHTML = `<div style="text-align: center; padding: 20px; color: #ef4444;">بارگذاری لاگ‌ها ناموفق بود: ${error.message}</div>`;
            }
        }

        // نمایش تمام لاگ‌ها
        async function showAllLogs() {
            try {
                const response = await fetch('/admin/log.json?_t=' + Date.now(), {
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                if (!response.ok) throw new Error('بارگذاری لاگ‌ها ناموفق بود');
                const logs = await response.json();

                // مرتب‌سازی بر اساس زمان از جدید به قدیم
                const sortedLogs = logs.sort((a, b) => b.TIME - a.TIME);

                const container = document.getElementById('allLogsContainer');
                let html = '<table style="width: 100%; border-collapse: collapse; font-size: 12px; table-layout: auto;">';
                html += '<thead><tr style="border-bottom: 2px solid #e5e7eb; background: #f9fafb; white-space: nowrap;"><th style="text-align: left; padding: 10px; font-weight: 600; width: 160px;">زمان (UTC+8)</th><th style="text-align: left; padding: 10px; font-weight: 600; width: 120px;">IP</th><th style="text-align: left; padding: 10px; font-weight: 600; width: 80px;">منطقه</th><th style="text-align: left; padding: 10px; font-weight: 600; width: 80px;">ASN</th><th style="text-align: left; padding: 10px; font-weight: 600; width: 150px;">عملیات</th><th style="text-align: left; padding: 10px; font-weight: 600; flex: 1; min-width: 300px;">URL</th><th style="text-align: left; padding: 10px; font-weight: 600; flex: 1; min-width: 200px;">UA</th></tr></thead>';
                html += '<tbody>';

                sortedLogs.forEach(log => {
                    const logType = translateLogType(log.TYPE, log.UA);
                    const cc = log.CC || 'ناشناخته';
                    const asn = log.ASN || 'ناشناخته';
                    const timeStr = formatTime(log.TIME);
                    const ip = log.IP || 'ناشناخته';
                    const url = log.URL || 'ندارد';
                    const ua = log.UA ? log.UA.substring(0, 60) : 'ندارد';

                    html += `<tr style="border-bottom: 1px solid #f3f4f6;"><td style="text-align: left; padding: 8px; white-space: nowrap; width: 160px; font-size: 11px;">${timeStr}</td><td style="text-align: left; padding: 8px; font-family: monospace; font-size: 10px; white-space: nowrap; width: 120px; word-break: break-word;">${ip}</td><td style="text-align: left; padding: 8px; white-space: nowrap; width: 80px; font-size: 11px;">${cc}</td><td style="text-align: left; padding: 8px; white-space: nowrap; width: 80px; font-size: 11px; font-family: monospace;">${asn}</td><td style="text-align: left; padding: 8px; width: 150px;"><span style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; color: #fff; background-color: ${logType.color}; white-space: nowrap;">${logType.text}</span></td><td style="text-align: left; padding: 8px; font-size: 11px; word-break: break-word; min-width: 300px;">${url}</td><td style="text-align: left; padding: 8px; font-size: 10px; color: #6b7280; min-width: 200px; word-break: break-word;">${ua}</td></tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
                document.getElementById('logsModal').classList.add('show');
            } catch (error) {
                showToast('بارگذاری لاگ‌ها ناموفق بود: ' + error.message, 'error');
            }
        }

        // بستن کادر لاگ
        function closeLogsModal(event) {
            if (event && event.target.id !== 'logsModal') return;
            document.getElementById('logsModal').classList.remove('show');
        }
		// ==================== توابع کادر تایید پروکسی ====================

        // متغیرهای سراسری برای ذخیره نوع پروکسی در حال تایید
        let currentProxyType = null;
        let currentProxyFieldId = null;

        function openProxyVerificationModal(proxyType) {
            currentProxyType = proxyType;
            currentProxyFieldId = proxyType === 'socks5' ? 'socks5Addr' : 'httpAddr';

            // تنظیم عنوان و برچسب کادر
            const title = proxyType === 'socks5' ? '🔒 تایید پروکسی SOCKS5' : '🌐 تایید پروکسی HTTP';
            const label = proxyType === 'socks5' ? 'پروکسی SOCKS5:' : 'پروکسی HTTP:';

            document.getElementById('proxyVerificationTitle').textContent = title;
            document.getElementById('proxyVerificationLabel').textContent = label;
            document.getElementById('proxyVerificationInput').placeholder = proxyType === 'socks5'
                ? 'user:password@127.0.0.1:1080'
                : 'user:password@127.0.0.1:8080';

            // تنظیم مقدار فعلی کادر ورودی
            const currentValue = document.getElementById(currentProxyFieldId).value;
            document.getElementById('proxyVerificationInput').value = currentValue;

            // بازنشانی وضعیت
            document.getElementById('proxyVerificationStatus').style.display = 'none';
            document.getElementById('proxyVerificationStatus').textContent = '';
            document.getElementById('proxyConfirmBtn').disabled = true;
            document.getElementById('proxyConfirmBtn').style.opacity = '0.5';

            // نمایش کادر
            document.getElementById('proxyVerificationModal').classList.add('show');
        }

        function closeProxyVerificationModal(event) {
            document.getElementById('proxyVerificationModal').classList.remove('show');
            currentProxyType = null;
            currentProxyFieldId = null;
            document.getElementById('proxyVerificationInput').value = '';
            document.getElementById('proxyVerificationStatus').style.display = 'none';
        }

        async function verifyProxyAvailability() {
            const input = document.getElementById('proxyVerificationInput').value.trim();
            if (!input) {
                showProxyVerificationStatus('لطفاً آدرس پروکسی را وارد کنید', 'error');
                return;
            }

            // پیش‌پردازش آدرس پروکسی
            const processedAddress = processProxyAddressForValidation(input, currentProxyType);
            if (!processedAddress) {
                showProxyVerificationStatus('فرمت آدرس پروکسی نامعتبر است', 'error');
                return;
            }

            const statusEl = document.getElementById('proxyVerificationStatus');
            const verifyBtn = document.querySelector('#proxyVerificationModal .btn-verify-api');

            try {
                verifyBtn.disabled = true;
                statusEl.textContent = '⏳ در حال تایید...';
                statusEl.style.display = 'block';
                statusEl.style.background = 'linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%)';
                statusEl.style.color = '#fff';
                statusEl.style.padding = '16px';
                statusEl.style.borderRadius = '8px';

                // ساخت پارامترهای درخواست
                const params = new URLSearchParams();
                if (currentProxyType === 'socks5') {
                    params.append('socks5', processedAddress);
                } else {
                    params.append('http', processedAddress);
                }

                // ایجاد AbortController برای تایم‌اوت 5 ثانیه‌ای
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 12000);

                const response = await fetch(`/admin/check?${params}&_t=${Date.now()}`, {
                    method: 'GET',
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                const data = await response.json();

                // بررسی وجود فیلد success
                if (!data.hasOwnProperty('success')) {
                    statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                    statusEl.style.padding = '16px';
                    statusEl.style.borderRadius = '8px';
                    statusEl.innerHTML = '❌ <strong>نسخه backend قدیمی است</strong><br/><small style="opacity: 0.9;">لطفاً کد edgetunnel را ارتقا دهید</small>';
                    document.getElementById('proxyConfirmBtn').disabled = true;
                    document.getElementById('proxyConfirmBtn').style.opacity = '0.5';
                } else if (data.success === false) {
                    statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                    statusEl.style.padding = '16px';
                    statusEl.style.borderRadius = '8px';
                    statusEl.innerHTML = `❌ <strong>پروکسی نامعتبر است</strong><br/><small style="opacity: 0.9;">${data.error || 'خطای ناشناخته'}</small>`;
                    document.getElementById('proxyConfirmBtn').disabled = true;
                    document.getElementById('proxyConfirmBtn').style.opacity = '0.5';
                } else if (data.success === true) {
                    const ip = data.ip || 'ناشناخته';
                    const loc = data.loc || 'ناشناخته';
                    const responseTime = data.responseTime || 0;
                    const responseTimeDisplay = responseTime > 0 ? `${responseTime}ms` : 'ناشناخته';

                    statusEl.style.background = 'linear-gradient(135deg, #10b981 0, #059669 100%)';
                    statusEl.style.padding = '16px';
                    statusEl.style.borderRadius = '8px';
                    statusEl.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 10px; font-family: 'Vazirmatn', system-ui, sans-serif;">
                            <!-- نوار عنوان بالا -->
                            <div style="display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.15); padding-bottom: 8px; margin-bottom: 2px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 8px; height: 8px; background: #fff; border-radius: 50%; box-shadow: 0 0 8px #fff; animation: pulse 2s infinite;"></div>
                                    <span style="font-weight: 700; font-size: 12px; letter-spacing: 0.05em; text-transform: uppercase; color: #fff;">Connection Secured</span>
                                </div>
                                <span style="font-size: 10px; opacity: 0.7; font-family: 'Fira Code', monospace; color: #fff;">STATUS: 200 OK</span>
                            </div>
                            
                            <!-- شبکه اطلاعات -->
                            <div style="display: grid; grid-template-columns: 0.4fr 1.2fr; gap: 8px;">
                                <div style="background: rgba(0,0,0,0.15); padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); min-width: 0; max-width: 100px;">
                                    <div style="font-size: 10px; opacity: 0.7; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; color: #fff;">منطقه (Region)</div>
                                    <div style="font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #fff;" title="${loc}">${loc}</div>
                                </div>
                                <div style="background: rgba(0,0,0,0.15); padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); min-width: 0;">
                                    <div style="font-size: 10px; opacity: 0.7; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; color: #fff; text-align: center;">آدرس IP</div>
                                    <div style="font-family: 'Fira Code', monospace; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; color: #fff; text-decoration: underline; min-width: 0;" onclick="showIpDetailForProxy('${ip}', this)">
                                        <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${ip}">${ip}</span>
                                        <span style="font-size: 12px; opacity: 0.8; flex-shrink: 0;">🔍</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- نوار تاخیر پایین -->
                            <div style="background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #fff;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="font-size: 14px;">⏱️</span>
                                    <span style="font-size: 11px; font-weight: 500; opacity: 0.9; color: #fff;">تاخیر پاسخ</span>
                                </div>
                                <div style="font-family: 'Vazirmatn', sans-serif; font-size: 16px; font-weight: 800; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.3);">
                                    ${responseTimeDisplay}
                                </div>
                            </div>
                        </div>
                    `;
					
					                    // فعال‌سازی دکمه تایید
                    document.getElementById('proxyConfirmBtn').disabled = false;
                    document.getElementById('proxyConfirmBtn').style.opacity = '1';

                    // ذخیره آدرس تایید شده برای استفاده بعدی
                    document.getElementById('proxyConfirmBtn').dataset.validAddress = processedAddress;
                }
            } catch (error) {
                statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                statusEl.style.padding = '16px';
                statusEl.style.borderRadius = '8px';

                // تشخیص اینکه آیا خطای تایم‌اوت است
                if (error.name === 'AbortError') {
                    statusEl.innerHTML = `❌ <strong>تایم‌اوت تایید</strong><br/><small style="opacity: 0.9;">درخواست بیش از 10 ثانیه بدون پاسخ ماند، لطفاً اتصال پروکسی را بررسی کنید</small>`;
                } else {
                    statusEl.innerHTML = `❌ <strong>تایید ناموفق بود</strong><br/><small style="opacity: 0.9;">${error.message}</small>`;
                }

                document.getElementById('proxyConfirmBtn').disabled = true;
                document.getElementById('proxyConfirmBtn').style.opacity = '0.5';
            } finally {
                verifyBtn.disabled = false;
            }
        }

        function processProxyAddressForValidation(input, type) {
            input = input.trim();

            // حذف "/" اول
            if (input.startsWith('/')) {
                input = input.substring(1).trim();
            }

            // تشخیص و حذف پیشوند پروتکل
            const socks5Prefixes = ['socks5://', 'socks5=', 'socks5://'];
            const httpPrefixes = ['http://', 'http=', 'https://'];

            for (const prefix of socks5Prefixes) {
                if (input.toLowerCase().startsWith(prefix)) {
                    input = input.substring(prefix.length).trim();
                    break;
                }
            }

            for (const prefix of httpPrefixes) {
                if (input.toLowerCase().startsWith(prefix)) {
                    input = input.substring(prefix.length).trim();
                    break;
                }
            }

            // حذف یادداشت‌های انتهایی (محتوای بعد از #)
            if (input.includes('#')) {
                input = input.split('#')[0].trim();
            }

            return input;
        }

        function showProxyVerificationStatus(message, type) {
            const statusEl = document.getElementById('proxyVerificationStatus');
            const prefix = type === 'error' ? '❌' : 'ℹ️';
            statusEl.textContent = prefix + ' ' + message;
            statusEl.style.display = 'block';
            if (type === 'error') {
                statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
            } else {
                statusEl.style.background = 'linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%)';
            }
            statusEl.style.color = '#fff';
        }

        async function fetchAndShowIpDetail(ip, targetElement = null) {
            // جایگزینی * با 0 (سازگار با IP ماسک شده)
            const cleanIp = ip.toString().replace(/\*/g, '0');

            if (targetElement) {
                // حذف انیمیشن بارگذاری موجود
                const existingSpinner = targetElement.querySelector('.loading-spinner');
                if (existingSpinner) {
                    return; // در حال بارگذاری، درخواست تکراری نفرست
                }

                // اضافه کردن انیمیشن بارگذاری
                const spinner = document.createElement('span');
                spinner.className = 'loading-spinner';
                targetElement.appendChild(spinner);
            }

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                let response;
                try {
                    response = await fetch(`https://api.ipapi.is/?q=${cleanIp}`, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (!response.ok) throw new Error('Primary API failed');
                } catch (e) {
                    console.warn('Primary IP API failed, trying fallback...', e);
                    response = await fetch(`https://api.cmliussss.net/api/ipapi?ip=${cleanIp}`);
                    if (!response.ok) throw new Error('Fallback API failed');
                }

                const data = await response.json();

                // نمایش کادر جزئیات
                showIpDetailModal(data);
            } catch (error) {
                showToast('❌ شکست در دریافت جزئیات IP');
                console.error('خطای جستجوی IP:', error);
            } finally {
                if (targetElement) {
                    const spinner = targetElement.querySelector('.loading-spinner');
                    if (spinner) spinner.remove();
                }
            }
        }

        function showIpDetailForProxy(ip, element = null) {
            fetchAndShowIpDetail(ip, element);
        }

        function confirmProxyAddress() {
            const validAddress = document.getElementById('proxyConfirmBtn').dataset.validAddress;
            if (!validAddress) return;

            document.getElementById(currentProxyFieldId).value = validAddress;
            markModified('proxy');
            closeProxyVerificationModal();
        }

        function openSubAPIModal() {
            const currentValue = document.getElementById('subAPI').value;
            document.getElementById('subAPIStatus').style.display = 'none';
            document.getElementById('subAPIStatus').textContent = '';
            document.getElementById('subAPIConfirmBtn').disabled = true;
            document.getElementById('subAPIConfirmBtn').style.opacity = '0.5';
            document.getElementById('subAPIModal').classList.add('show');

            // بارگذاری لیست SUBAPI
            loadSubAPIList(currentValue);
        }

        function closeSubAPIModal(event) {
            if (event && event.target.id !== 'subAPIModal') return;
            document.getElementById('subAPIModal').classList.remove('show');
            document.getElementById('testSubAPIInput').value = '';
            document.getElementById('subAPIStatus').style.display = 'none';
        }

        async function loadSubAPIList(currentValue) {
            const selectEl = document.getElementById('subAPISelect');
            selectEl.innerHTML = '<option value="">-- در حال بارگذاری، لطفاً صبر کنید --</option>';

            try {
                const jsonText = await fetchWithAutoMirror(
                    'https://raw.githubusercontent.com/cmliu/cmliu/main/SUBAPI.json',
                    'SUBAPI لیست'
                );

                const apiList = JSON.parse(jsonText);

                // خالی کردن گزینه‌ها
                selectEl.innerHTML = '';

                // اضافه کردن گزینه‌های لیست API
                apiList.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.value;
                    option.textContent = `${item.label}[${item.value}]`;
                    selectEl.appendChild(option);
                });

                // اضافه کردن گزینه سفارشی
                const customOption = document.createElement('option');
                customOption.value = 'custom';
                customOption.textContent = '🔧 سفارشی';
                selectEl.appendChild(customOption);

                // تلاش برای تطبیق مقدار فعلی (مقایسه بدون حساسیت به حروف)
                if (currentValue && currentValue.trim()) {
                    const currentValueLower = currentValue.trim().toLowerCase();
                    const matchedOption = Array.from(selectEl.options).find(
                        opt => opt.value.toLowerCase() === currentValueLower
                    );
                    if (matchedOption) {
                        // گزینه منطبق پیدا شد
                        selectEl.value = matchedOption.value;
                        document.getElementById('customSubAPIInputGroup').style.display = 'none';
                        document.getElementById('testSubAPIInput').value = '';
                    } else {
                        // گزینه منطبق پیدا نشد، یعنی سفارشی است
                        selectEl.value = 'custom';
                        document.getElementById('testSubAPIInput').value = currentValue.trim();
                        document.getElementById('customSubAPIInputGroup').style.display = 'block';
                    }
                } else {
                    // مقدار فعلی وجود ندارد، نمایش اولین گزینه
                    selectEl.value = '';
                    document.getElementById('customSubAPIInputGroup').style.display = 'none';
                    document.getElementById('testSubAPIInput').value = '';
                }
            } catch (error) {
                console.error('شکست در بارگذاری لیست SUBAPI:', error);
                selectEl.innerHTML = '<option value="custom">🔧 سفارشی</option>';
                selectEl.value = 'custom';
                document.getElementById('customSubAPIInputGroup').style.display = 'block';
                if (currentValue && currentValue.trim()) {
                    document.getElementById('testSubAPIInput').value = currentValue.trim();
                } else {
                    document.getElementById('testSubAPIInput').value = '';
                }
            }
        }

        function handleSubAPISelectChange() {
            const selectEl = document.getElementById('subAPISelect');
            const customInputGroup = document.getElementById('customSubAPIInputGroup');
            const testInput = document.getElementById('testSubAPIInput');

            if (selectEl.value === 'custom') {
                customInputGroup.style.display = 'block';
                testInput.focus();
            } else {
                customInputGroup.style.display = 'none';
                testInput.value = selectEl.value;
            }
        }

        // توابع کادر راهنمای ProxyIP
        function showProxyIPHelpModal() {
            document.getElementById('proxyIPHelpModal').classList.add('show');
        }

        function closeProxyIPHelpModal(event) {
            if (event && event.target.id !== 'proxyIPHelpModal') return;
            document.getElementById('proxyIPHelpModal').classList.remove('show');
        }

        // توابع پیکربندی قالب مسیر
        let pathTemplatePresets = [];
        let pathTemplateOriginal = {};

        async function showPathTemplateConfigModal() {
            const modal = document.getElementById('pathTemplateConfigModal');
            modal.classList.add('show');

            // مقداردهی اولیه مقادیر اصلی
            pathTemplateOriginal = JSON.parse(JSON.stringify(currentConfig.反代?.路径模板 || {}));

            // بارگذاری قالب‌های از پیش تعیین شده
            await loadPathTemplatePresets();

            // پر کردن پیکربندی فعلی در کادر متنی (اضافه کردن پیشوند "/" برای نمایش)
            document.getElementById('proxyIPTemplateInput').value = '/' + (currentConfig.反代?.路径模板?.PROXYIP || '');
            document.getElementById('socks5StandardTemplateInput').value = '/' + (currentConfig.反代?.路径模板?.SOCKS5?.标准 || '');
            document.getElementById('socks5GlobalTemplateInput').value = '/' + (currentConfig.反代?.路径模板?.SOCKS5?.全局 || '');
            document.getElementById('httpStandardTemplateInput').value = '/' + (currentConfig.反代?.路径模板?.HTTP?.标准 || '');
            document.getElementById('httpGlobalTemplateInput').value = '/' + (currentConfig.反代?.路径模板?.HTTP?.全局 || '');

            // مقداردهی اولیه وضعیت اعتبارسنجی
            validatePathTemplate('proxyIPTemplateInput', currentConfig.反代?.路径模板?.PROXYIP || '');
            validatePathTemplate('socks5StandardTemplateInput', currentConfig.反代?.路径模板?.SOCKS5?.标准 || '');
            validatePathTemplate('socks5GlobalTemplateInput', currentConfig.反代?.路径模板?.SOCKS5?.全局 || '');
            validatePathTemplate('httpStandardTemplateInput', currentConfig.反代?.路径模板?.HTTP?.标准 || '');
            validatePathTemplate('httpGlobalTemplateInput', currentConfig.反代?.路径模板?.HTTP?.全局 || '');

            // غیرفعال کردن دکمه ذخیره
            document.getElementById('pathTemplateSaveBtn').disabled = true;

            // بازنشانی انتخاب قالب از پیش تعیین شده
            document.getElementById('presetTemplateSelect').value = 'custom';
        }

        function closePathTemplateConfigModal(event) {
            if (event && event.target.id !== 'pathTemplateConfigModal') return;
            document.getElementById('pathTemplateConfigModal').classList.remove('show');
        }

        async function loadPathTemplatePresets() {
            try {
                const url = 'https://raw.githubusercontent.com/cmliu/cmliu/main/json/edt-path-config.json';
                const text = await fetchWithAutoMirror(url, 'پیکربندی قالب مسیر');
                pathTemplatePresets = JSON.parse(text);

                const select = document.getElementById('presetTemplateSelect');
                // حذف همه گزینه‌ها به جز "سفارشی"
                while (select.options.length > 1) {
                    select.remove(1);
                }

                // اضافه کردن گزینه‌های قالب از پیش تعیین شده
                pathTemplatePresets.forEach(preset => {
                    const option = document.createElement('option');
                    option.value = preset.项目名;
                    option.textContent = preset.项目名;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('شکست در بارگذاری قالب مسیر از پیش تعیین شده:', error);
                showToast('شکست در بارگذاری قالب از پیش تعیین شده: ' + error.message, 'error');
            }
        }

        function onPresetTemplateChange() {
            const select = document.getElementById('presetTemplateSelect');
            const selectedValue = select.value;

            if (selectedValue === 'custom') {
                return;
            }

            // پیدا کردن قالب مربوطه
            const preset = pathTemplatePresets.find(p => p.项目名 === selectedValue);
            if (!preset) return;

            // نمایش پیام راهنما
            showToast(preset.提示消息, 'info');

            // پر کردن قالب (اضافه کردن پیشوند "/" برای نمایش)
            document.getElementById('proxyIPTemplateInput').value = '/' + (preset.路径模板.PROXYIP || '');
            document.getElementById('socks5StandardTemplateInput').value = '/' + (preset.路径模板.SOCKS5.标准 || '');
            document.getElementById('socks5GlobalTemplateInput').value = '/' + (preset.路径模板.SOCKS5.全局 || '');
            document.getElementById('httpStandardTemplateInput').value = '/' + (preset.路径模板.HTTP.标准 || '');
            document.getElementById('httpGlobalTemplateInput').value = '/' + (preset.路径模板.HTTP.全局 || '');

            // اعتبارسنجی محتوای پر شده
            validatePathTemplate('proxyIPTemplateInput', preset.路径模板.PROXYIP || '');
            validatePathTemplate('socks5StandardTemplateInput', preset.路径模板.SOCKS5.标准 || '');
            validatePathTemplate('socks5GlobalTemplateInput', preset.路径模板.SOCKS5.全局 || '');
            validatePathTemplate('httpStandardTemplateInput', preset.路径模板.HTTP.标准 || '');
            validatePathTemplate('httpGlobalTemplateInput', preset.路径模板.HTTP.全局 || '');

            // روشن کردن دکمه ذخیره
            document.getElementById('pathTemplateSaveBtn').disabled = false;
        }

        function onPathTemplateInput() {
            // دریافت مقادیر همه کادرهای قالب (حذف "/" اول برای مقایسه)
            const proxyIP = document.getElementById('proxyIPTemplateInput').value.replace(/^\//, '');
            const socks5Standard = document.getElementById('socks5StandardTemplateInput').value.replace(/^\//, '');
            const socks5Global = document.getElementById('socks5GlobalTemplateInput').value.replace(/^\//, '');
            const httpStandard = document.getElementById('httpStandardTemplateInput').value.replace(/^\//, '');
            const httpGlobal = document.getElementById('httpGlobalTemplateInput').value.replace(/^\//, '');

            // اعتبارسنجی هر کادر ورودی که آیا شامل placeholder است، اگر نه به عنوان invalid علامت‌گذاری کن
            validatePathTemplate('proxyIPTemplateInput', proxyIP);
            validatePathTemplate('socks5StandardTemplateInput', socks5Standard);
            validatePathTemplate('socks5GlobalTemplateInput', socks5Global);
            validatePathTemplate('httpStandardTemplateInput', httpStandard);
            validatePathTemplate('httpGlobalTemplateInput', httpGlobal);

            // بررسی تغییر هر محتوا
            const hasChanged =
                proxyIP !== (pathTemplateOriginal.PROXYIP || '') ||
                socks5Standard !== (pathTemplateOriginal.SOCKS5?.标准 || '') ||
                socks5Global !== (pathTemplateOriginal.SOCKS5?.全局 || '') ||
                httpStandard !== (pathTemplateOriginal.HTTP?.标准 || '') ||
                httpGlobal !== (pathTemplateOriginal.HTTP?.全局 || '');

            // کنترل فعال/غیرفعال دکمه ذخیره
            document.getElementById('pathTemplateSaveBtn').disabled = !hasChanged;
        }

        function validatePathTemplate(inputId, value) {
            const inputElement = document.getElementById(inputId);
            const wrapper = inputElement.closest('.path-template-input-wrapper');

            // تولید ID پیام خطای مربوطه
            const errorId = inputId.replace('Input', 'Error');
            const errorElement = document.getElementById(errorId);

            // اگر محتوا خالی نیست و شامل placeholder نیست، اضافه کردن استایل invalid و نمایش پیام خطا
            if (value.trim() && !value.includes('{{IP:PORT}}')) {
                wrapper.classList.add('invalid');
                if (errorElement) {
                    errorElement.style.display = 'block';
                }
            } else {
                wrapper.classList.remove('invalid');
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
            }
        }

        async function savePathTemplateConfig() {
            // دریافت مقادیر کادرهای ورودی و حذف "/" اول
            const proxyIP = document.getElementById('proxyIPTemplateInput').value.replace(/^\//, '');
            const socks5Standard = document.getElementById('socks5StandardTemplateInput').value.replace(/^\//, '');
            const socks5Global = document.getElementById('socks5GlobalTemplateInput').value.replace(/^\//, '');
            const httpStandard = document.getElementById('httpStandardTemplateInput').value.replace(/^\//, '');
            const httpGlobal = document.getElementById('httpGlobalTemplateInput').value.replace(/^\//, '');

            try {
                // اعتبارسنجی وجود placeholder {{IP:PORT}}
                const templates = [proxyIP, socks5Standard, socks5Global, httpStandard, httpGlobal].filter(t => t);
                if (templates.length > 0) {
                    const hasPlaceholder = templates.every(t => t.includes('{{IP:PORT}}'));
                    if (!hasPlaceholder) {
                        showToast('قالب مسیر فعلی فاقد placeholder {{IP:PORT}} است', 'error');
                        //return;
                    }
                }

                // بروزرسانی داده‌های قالب مسیر در currentConfig (بدون "/" اول)
                if (!currentConfig.反代) {
                    currentConfig.反代 = {};
                }
                if (!currentConfig.反代.路径模板) {
                    currentConfig.反代.路径模板 = {};
                }

                currentConfig.反代.路径模板.PROXYIP = proxyIP;
                currentConfig.反代.路径模板.SOCKS5 = {
                    标准: socks5Standard,
                    全局: socks5Global
                };
                currentConfig.反代.路径模板.HTTP = {
                    标准: httpStandard,
                    全局: httpGlobal
                };

                // ذخیره در سرور از طریق saveConfigToServer
                await saveConfigToServer('pathTemplate');

                // بستن کادر
                closePathTemplateConfigModal();
            } catch (error) {
                console.error('شکست در ذخیره قالب مسیر:', error);
                showToast('شکست در ذخیره قالب مسیر: ' + error.message, 'error');
            }
        }

        function toggleProxyIPHelpMode() {
            const checkbox = document.getElementById('proxyIPSimpleMode');
            const simpleDiv = document.getElementById('proxyIPHelpSimple');
            const detailDiv = document.getElementById('proxyIPHelpDetail');

            if (checkbox.checked) {
                // نمایش حالت ساده
                simpleDiv.style.display = 'block';
                detailDiv.style.display = 'none';
            } else {
                // نمایش حالت جزئی
                simpleDiv.style.display = 'none';
                detailDiv.style.display = 'block';
            }
        }

        // جلوگیری از خروجی کاراکتر "#"، اجازه ورود "؟"
        function preventInvalidChars(input) {
            input.value = input.value.replace(/#/g, '');
        }

        function preventInvalidCharsOnKeypress(event) {
            if (event.key === '#') {
                event.preventDefault();
            }
        }

        // اطمینان از شروع مسیر با "/" (اگرچه در نمایش پیشوند وجود دارد، اما از حذف تصادفی جلوگیری می‌کند)
        function ensurePathPrefix(input) {
            // اینجا اجبار نیست، در تابع جلوگیری از حذف مدیریت می‌شود
        }

        // جلوگیری از حذف پیشوند مسیر "/"
        function preventPathPrefixDeletion(event, input) {
            // فقط هنگام فشردن کلید Delete مدیریت کن
            if (event.key === 'Backspace' || event.key === 'Delete') {
                // اگر متن انتخاب شده شامل موقعیت 0 (اول) است، از حذف جلوگیری کن
                if (input.selectionStart === 0 && event.key === 'Backspace') {
                    event.preventDefault();
                    return false;
                }
                // اگر cursor در ابتدا و Delete فشرده شد، از حذف جلوگیری کن
                if (input.selectionStart === 0 && event.key === 'Delete') {
                    event.preventDefault();
                    return false;
                }
            }
            // جلوگیری از ورود هر کاراکتری در ابتدا
            if (input.selectionStart === 0 && event.key && event.key.length === 1 && event.key !== '/') {
                // cursor را به موقعیت 1 منتقل کن
                setTimeout(() => {
                    input.setSelectionRange(1, 1);
                }, 0);
            }
        }

        // توابع کادر راهنمای ECH
        function showECHHelpModal() {
            document.getElementById('echHelpModal').classList.add('show');

            // محاسبه و تنظیم ارتفاع محتوا برای تطبیق با ارتفاع مرورگر
            setTimeout(() => {
                calculateECHContentHeight();
                // محاسبه مجدد هنگام تغییر اندازه پنجره
                window.addEventListener('resize', calculateECHContentHeight);
            }, 0);
        }

        function calculateECHContentHeight() {
            const modal = document.querySelector('.ech-help-modal');
            const tabContent = document.querySelector('.ech-tab-content');
            const tabs = document.querySelector('.ech-tabs');
            const closeBtn = document.querySelector('#echHelpModal .modal-close');
            const bottomBtn = document.querySelector('#echHelpModal .btn-close-modal');

            if (!modal || !tabContent) return;

            // دریافت ارتفاع viewport مرورگر
            const viewportHeight = window.innerHeight;

            // محاسبه ارتفاع هر عنصر (با حاشیه)
            const modalPadding = 20; // padding داخلی کادر
            const tabsHeight = tabs ? tabs.offsetHeight + 15 : 50; // ارتفاع تب‌ها + margin
            const closeBtnHeight = 40; // ارتفاع دکمه بستن
            const bottomBtnHeight = bottomBtn ? bottomBtn.offsetHeight + 20 : 60; // ارتفاع دکمه پایین + margin
            const headerHeight = 20; // سایر حاشیه‌های بالا

            // محاسبه ارتفاع محتوای موجود
            // viewportHeight - (padding بالا + تب‌ها + دکمه پایین + padding پایین)
            const availableHeight = viewportHeight - (modalPadding * 2 + tabsHeight + bottomBtnHeight + headerHeight);

            // تنظیم حداکثر ارتفاع، اطمینان از عدم تجاوز از viewport
            tabContent.style.maxHeight = Math.max(200, availableHeight) + 'px';
        }

        function closeECHHelpModal(event) {
            if (event && event.target.id !== 'echHelpModal') return;
            document.getElementById('echHelpModal').classList.remove('show');
        }

        function switchECHTab(tabIndex) {
            // تغییر وضعیت دکمه‌های تب
            const tabs = document.querySelectorAll('.ech-tab');
            tabs.forEach((tab, index) => {
                if (index === tabIndex) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // تغییر محتوای تب
            const panes = document.querySelectorAll('.ech-tab-pane');
            panes.forEach((pane, index) => {
                if (index === tabIndex) {
                    pane.classList.add('active');
                } else {
                    pane.classList.remove('active');
                }
            });

            // اسکرول خودکار به تب فعال
            const activeTab = tabs[tabIndex];
            if (activeTab) {
                const tabsContainer = document.querySelector('.ech-tabs');
                if (tabsContainer) {
                    activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            }
        }

        // قابلیت کشیدن تب‌های ECH
        function initECHTabsDrag() {
            const tabsContainer = document.querySelector('.ech-tabs');
            if (!tabsContainer) return;

            let isDown = false;
            let startX;
            let scrollLeft;
            let isDragged = false;

            tabsContainer.addEventListener('mousedown', (e) => {
                // اگر دکمه کلیک شده، کشیدن را شروع نکن
                if (e.target.closest('.ech-tab')) {
                    isDown = true;
                    isDragged = false;
                    startX = e.pageX - tabsContainer.offsetLeft;
                    scrollLeft = tabsContainer.scrollLeft;
                    tabsContainer.classList.add('dragging');
                }
            });

            tabsContainer.addEventListener('mouseleave', () => {
                isDown = false;
                tabsContainer.classList.remove('dragging');
            });

            tabsContainer.addEventListener('mouseup', () => {
                isDown = false;
                tabsContainer.classList.remove('dragging');
            });

            tabsContainer.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();

                const x = e.pageX - tabsContainer.offsetLeft;
                const walk = (x - startX) * 1; // سرعت کشیدن

                if (Math.abs(walk) > 5) {
                    isDragged = true;
                }

                tabsContainer.scrollLeft = scrollLeft - walk;
            });

            // پشتیبانی از دستگاه‌های لمسی
            tabsContainer.addEventListener('touchstart', (e) => {
                isDown = true;
                isDragged = false;
                startX = e.touches[0].pageX - tabsContainer.offsetLeft;
                scrollLeft = tabsContainer.scrollLeft;
            });

            tabsContainer.addEventListener('touchend', () => {
                isDown = false;
            });

            tabsContainer.addEventListener('touchmove', (e) => {
                if (!isDown) return;

                const x = e.touches[0].pageX - tabsContainer.offsetLeft;
                const walk = (x - startX) * 1;

                if (Math.abs(walk) > 5) {
                    isDragged = true;
                }

                tabsContainer.scrollLeft = scrollLeft - walk;
            });

            // اضافه کردن interceptor کلیک به دکمه‌های تب، جلوگیری از trigger شدن تصادفی هنگام کشیدن
            const tabs = document.querySelectorAll('.ech-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    if (isDragged) {
                        e.preventDefault();
                        e.stopPropagation();
                        isDragged = false;
                    }
                });
            });
        }

        // مقداردهی اولیه کشیدن هنگام نمایش کادر
        const echHelpModalOriginal = showECHHelpModal;
        showECHHelpModal = function () {
            echHelpModalOriginal.call(this);
            setTimeout(() => {
                initECHTabsDrag();
            }, 0);
        }

        function normalizeSubAPIURL(url) {
            url = url.trim();
            if (!url) return null;

            let parsedURL;

            if (!url.includes('://')) {
                url = 'https://' + url;
            }

            try {
                parsedURL = new URL(url);
            } catch (e) {
                return null;
            }

            const baseURL = parsedURL.origin;
            return baseURL;
        }

        async function testSubAPI() {
            let input;
            const selectEl = document.getElementById('subAPISelect');

            if (selectEl.value === 'custom' || !selectEl.value) {
                // اگر سفارشی یا انتخاب نشده، از کادر ورودی دریافت کن
                input = document.getElementById('testSubAPIInput').value.trim();
            } else {
                // در غیر این صورت از کادر کشویی دریافت کن
                input = selectEl.value.trim();
                document.getElementById('testSubAPIInput').value = input;
            }

            if (!input) {
                showStatus('لطفاً آدرس را وارد کنید', 'error');
                return;
            }

            const baseURL = normalizeSubAPIURL(input);
            if (!baseURL) {
                showStatus('فرمت آدرس نامعتبر است', 'error');
                return;
            }

            const testURL = baseURL + '/version';
            const statusEl = document.getElementById('subAPIStatus');
            const buttons = document.querySelectorAll('#subAPIModal button.btn');
            const testBtn = buttons[0];

            try {
                testBtn.disabled = true;
                statusEl.textContent = '⏳ در حال تشخیص...';
                statusEl.style.display = 'block';
                statusEl.style.background = 'linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%)';
                statusEl.style.color = '#fff';

                const response = await fetch(testURL, {
                    method: 'GET'
                });

                if (response.status === 200) {
                    const content = await response.text();
                    const lowerContent = content.toLowerCase();

                    if (lowerContent.includes('subconverter')) {
                        statusEl.style.background = 'linear-gradient(135deg, #10b981 0, #059669 100%)';
                        statusEl.textContent = '✅ ' + content;
                        document.getElementById('subAPIConfirmBtn').disabled = false;
                        document.getElementById('subAPIConfirmBtn').style.opacity = '1';
                        document.getElementById('subAPIConfirmBtn').dataset.validURL = baseURL;
                    } else {
                        statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                        statusEl.textContent = '❌ محتوای پاسخ نامعتبر است';
                        document.getElementById('subAPIConfirmBtn').disabled = true;
                        document.getElementById('subAPIConfirmBtn').style.opacity = '0.5';
                    }
                } else {
                    statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                    statusEl.textContent = '❌ درخواست ناموفق (HTTP ' + response.status + ')';
                    document.getElementById('subAPIConfirmBtn').disabled = true;
                    document.getElementById('subAPIConfirmBtn').style.opacity = '0.5';
                }
            } catch (error) {
                statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                statusEl.textContent = '❌ تشخیص ناموفق: ' + error.message;
                document.getElementById('subAPIConfirmBtn').disabled = true;
                document.getElementById('subAPIConfirmBtn').style.opacity = '0.5';
            } finally {
                testBtn.disabled = false;
            }
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('subAPIStatus');
            const prefix = type === 'error' ? '❌' : 'ℹ️';
            statusEl.textContent = prefix + ' ' + message;
            statusEl.style.display = 'block';
            if (type === 'error') {
                statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
            } else {
                statusEl.style.background = 'linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%)';
            }
            statusEl.style.color = '#fff';
        }

        function confirmSubAPI() {
            const validURL = document.getElementById('subAPIConfirmBtn').dataset.validURL;
            if (!validURL) return;

            document.getElementById('subAPI').value = validURL;
            markModified('convert');
            closeSubAPIModal();
        }
		// ==================== توابع مربوط به تنظیمات اعلان‌ها ====================

        // بروزرسانی وضعیت و رنگ دکمه‌های Telegram
        function updateTelegramButtonStates(isConfigured) {
            // دریافت عناصر دکمه Telegram (اولین گروه دکمه‌های اعلان Telegram است)
            const buttons = document.querySelectorAll('.notification-controls');

            if (buttons.length > 0) {
                const telegramControls = buttons[0];
                const configBtn = telegramControls.querySelector('.btn-notification-config');
                const clearBtn = telegramControls.querySelector('.btn-clear-config');

                if (isConfigured) {
                    // پیکربندی شده: دکمه پیکربندی پارامترها سبز، دکمه پاک کردن قرمز و قابل کلیک
                    clearBtn.classList.remove('btn-not-configured');
                    clearBtn.classList.add('btn-configured');
                    clearBtn.disabled = false;
                } else {
                    // پیکربندی نشده: دکمه پیکربندی پارامترها سبز باقی می‌ماند، دکمه پاک کردن خاکستری و غیرفعال
                    clearBtn.classList.remove('btn-configured');
                    clearBtn.classList.add('btn-not-configured');
                    clearBtn.disabled = true;
                }
            }
        }

        // پاک کردن پیکربندی Telegram
        async function clearTelegramConfig() {
            if (confirm('آیا مطمئن هستید که می‌خواهید پیکربندی Telegram را پاک کنید؟')) {
                currentConfig.TG = {
                    BotToken: null,
                    ChatID: null,
                    启用: false
                };

                try {
                    await saveConfigToServer('notification');
                    showToast('پیکربندی Telegram پاک شد', 'success');
                    updateTelegramButtonStates(false);
                    const telegramCheckbox = document.getElementById('telegramEnabled');
                    telegramCheckbox.disabled = true;
                    telegramCheckbox.checked = false;
                } catch (error) {
                    showToast('پاک کردن پیکربندی ناموفق بود: ' + error.message, 'error');
                }
            }
        }

        // بروزرسانی وضعیت و رنگ دکمه‌های Cloudflare
        function updateCloudflareButtonStates(isConfigured) {
            // دریافت عناصر دکمه Cloudflare (دومین گروه دکمه‌های اعلان Cloudflare است)
            const buttons = document.querySelectorAll('.notification-controls');

            if (buttons.length > 1) {
                const cloudflareControls = buttons[1];
                const clearBtn = cloudflareControls.querySelector('.btn-clear-config');

                if (isConfigured) {
                    // پیکربندی شده: دکمه پاک کردن قرمز و قابل کلیک
                    clearBtn.classList.remove('btn-not-configured');
                    clearBtn.classList.add('btn-configured');
                    clearBtn.disabled = false;
                } else {
                    // پیکربندی نشده: دکمه پاک کردن خاکستری و غیرفعال
                    clearBtn.classList.remove('btn-configured');
                    clearBtn.classList.add('btn-not-configured');
                    clearBtn.disabled = true;
                }
            }
        }

        // پاک کردن پیکربندی Cloudflare
        async function clearCloudflareConfig() {
            if (confirm('آیا مطمئن هستید که می‌خواهید پیکربندی Cloudflare را پاک کنید؟')) {
                currentConfig.CF = {
                    Usage: null,
                    启用: false
                };

                try {
                    await saveConfigToServer('notification');
                    showToast('پیکربندی Cloudflare پاک شد', 'success');
                    updateCloudflareButtonStates(false);
                } catch (error) {
                    showToast('پاک کردن پیکربندی ناموفق بود: ' + error.message, 'error');
                }
            }
        }

        // باز کردن کادر پیکربندی TelegramBot
        function openTelegramConfigModal() {
            document.getElementById('telegramConfigModal').classList.add('show');
            // فقط بارگذاری Chat ID، بارگذاری Bot Token نه (چون Bot Token اطلاعات حساس است)
            const chatID = currentConfig.TG?.ChatID || currentConfig.通知?.Telegram?.ChatID || '';
            document.getElementById('telegramBotToken').value = '';
            document.getElementById('telegramChatID').value = chatID;

            // بازنشانی وضعیت و دکمه ذخیره
            document.getElementById('telegramStatus').style.display = 'none';
            document.getElementById('telegramStatus').textContent = '';
            document.getElementById('telegramConfirmBtn').disabled = true;
            document.getElementById('telegramConfirmBtn').style.opacity = '0.5';
        }

        // بستن کادر پیکربندی TelegramBot
        function closeTelegramConfigModal(event) {
            if (event && event.target.id !== 'telegramConfigModal') return;
            document.getElementById('telegramConfigModal').classList.remove('show');
        }

        // تست اتصال TelegramBot
        async function testTelegramConfig() {
            const token = document.getElementById('telegramBotToken').value.trim();
            const chatID = document.getElementById('telegramChatID').value.trim();
            const statusEl = document.getElementById('telegramStatus');
            const confirmBtn = document.getElementById('telegramConfirmBtn');
            const testBtn = event.target;

            if (!token || !chatID) {
                statusEl.textContent = '❌ لطفاً Bot Token و Chat ID را پر کنید';
                statusEl.style.display = 'block';
                statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                statusEl.style.color = '#fff';
                confirmBtn.disabled = true;
                confirmBtn.style.opacity = '0.5';
                return;
            }

            try {
                testBtn.disabled = true;
                statusEl.textContent = '⏳ در حال تأیید...';
                statusEl.style.display = 'block';
                statusEl.style.background = 'linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%)';
                statusEl.style.color = '#fff';

                // مرحله اول: اعتبارسنجی اعتبار Bot Token
                const getUrlParams = new URLSearchParams({
                    access_token: token
                });
                const getMeUrl = `https://api.telegram.org/bot${token}/getMe`;

                const getMeResponse = await fetch(getMeUrl);
                if (!getMeResponse.ok) {
                    throw new Error('Bot Token نامعتبر است، امکان دریافت اطلاعات ربات وجود ندارد');
                }

                const getMeData = await getMeResponse.json();
                if (!getMeData.ok) {
                    throw new Error('Bot Token نامعتبر: ' + (getMeData.description || 'خطای ناشناخته'));
                }

                // مرحله دوم: ارسال پیام تست به Chat ID از طریق Bot Token
                const sendUrlParams = new URLSearchParams({
                    chat_id: chatID,
                    text: '✅ پیکربندی اعلان Telegram با موفقیت تأیید شد!'
                });
                const sendUrl = `https://api.telegram.org/bot${token}/sendMessage?${sendUrlParams}`;

                const sendResponse = await fetch(sendUrl);
                if (!sendResponse.ok) {
                    throw new Error('ارسال پیام ناموفق بود، لطفاً صحت Chat ID را بررسی کنید');
                }

                const sendData = await sendResponse.json();
                if (!sendData.ok) {
                    throw new Error('Chat ID نامعتبر: ' + (sendData.description || 'خطای ناشناخته'));
                }

                // اعتبارسنجی موفق
                statusEl.style.background = 'linear-gradient(135deg, #10b981 0, #059669 100%)';
                statusEl.textContent = '✅ Bot Token و Chat ID هر دو معتبر هستند';
                confirmBtn.disabled = false;
                confirmBtn.style.opacity = '1';

            } catch (error) {
                statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                statusEl.textContent = '❌ تایید ناموفق بود: ' + error.message;
                confirmBtn.disabled = true;
                confirmBtn.style.opacity = '0.5';
            } finally {
                testBtn.disabled = false;
            }
        }

        // ذخیره پیکربندی TelegramBot
        async function confirmTelegramConfig() {
            const token = document.getElementById('telegramBotToken').value.trim();
            const chatID = document.getElementById('telegramChatID').value.trim();
            const confirmBtn = document.getElementById('telegramConfirmBtn');

            // بررسی دکمه آیا غیرفعال است (باید ابتدا از اعتبارسنجی عبور کند)
            if (confirmBtn.disabled) {
                showToast('لطفاً ابتدا دکمه "اعتبارسنجی دسترس‌پذیری" را کلیک کنید', 'error');
                return;
            }

            if (!token || !chatID) {
                showToast('لطفاً Bot Token و Chat ID کامل را پر کنید', 'error');
                return;
            }

            try {
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'در حال ذخیره...';

                // ارسال به backend
                const response = await fetch('/admin/tg.json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        BotToken: token,
                        ChatID: chatID
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showToast('✅ پیکربندی TelegramBot ذخیره شد', 'success');
                    closeTelegramConfigModal();

                    // بروزرسانی وضعیت دکمه‌ها
                    currentConfig.TG = {
                        BotToken: token,
                        ChatID: chatID,
                        启用: true
                    };
                    updateTelegramButtonStates(true);

                    // 1 ثانیه بعد بارگذاری مجدد صفحه
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    const errorData = await response.json();
                    showToast('❌ ذخیره ناموفق بود: ' + (errorData.error || 'خطای ناشناخته'), 'error');
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'ذخیره';
                }
            } catch (error) {
                showToast('❌ ذخیره ناموفق بود: ' + error.message, 'error');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'ذخیره';
            }
        }

        // باز کردن کادر پیکربندی Cloudflare
        function openCloudflareConfigModal() {
            document.getElementById('cloudflareConfigModal').classList.add('show');

            // پیش‌فرض انتخاب اولین روش
            document.getElementById('cloudflareAuthMethod').value = 'accountid';
            updateCloudflareAuthMethod();

            // خالی کردن کادرهای ورودی
            document.getElementById('cloudflareEmail').value = '';
            document.getElementById('cloudflareGlobalAPIKey').value = '';
            document.getElementById('cloudflareAccountID').value = '';
            document.getElementById('cloudflareAPIToken').value = '';
            document.getElementById('cloudflareUsageAPI').value = '';

            // بازنشانی وضعیت و دکمه ذخیره
            document.getElementById('cloudflareStatus').style.display = 'none';
            document.getElementById('cloudflareStatus').textContent = '';
            document.getElementById('cloudflareConfirmBtn').disabled = true;
            document.getElementById('cloudflareConfirmBtn').style.opacity = '0.5';
            document.getElementById('cloudflareConfirmBtn').dataset.testPassed = 'false';
        }

        // بروزرسانی نمایش هنگام انتخاب روش تأیید Cloudflare
        function updateCloudflareAuthMethod() {
            const method = document.getElementById('cloudflareAuthMethod').value;

            // مخفی کردن کادرهای ورودی همه روش‌ها
            document.getElementById('cloudflareEmailSection').style.display = 'none';
            document.getElementById('cloudflareAccountIDSection').style.display = 'none';
            document.getElementById('cloudflareUsageAPISection').style.display = 'none';

            // نمایش کادر ورودی روش انتخاب شده
            if (method === 'email') {
                document.getElementById('cloudflareEmailSection').style.display = 'block';
            } else if (method === 'accountid') {
                document.getElementById('cloudflareAccountIDSection').style.display = 'block';
            } else if (method === 'usageapi') {
                document.getElementById('cloudflareUsageAPISection').style.display = 'block';
            }

            // بازنشانی وضعیت اعتبارسنجی و دکمه ذخیره هنگام تغییر روش
            document.getElementById('cloudflareStatus').style.display = 'none';
            document.getElementById('cloudflareStatus').textContent = '';
            document.getElementById('cloudflareConfirmBtn').disabled = true;
            document.getElementById('cloudflareConfirmBtn').style.opacity = '0.5';
            document.getElementById('cloudflareConfirmBtn').dataset.testPassed = 'false';
        }

        // بستن کادر پیکربندی Cloudflare
        function closeCloudflareConfigModal(event) {
            if (event && event.target.id !== 'cloudflareConfigModal') return;
            document.getElementById('cloudflareConfigModal').classList.remove('show');

            // خالی کردن کادرهای ورودی و وضعیت
            document.getElementById('cloudflareEmail').value = '';
            document.getElementById('cloudflareGlobalAPIKey').value = '';
            document.getElementById('cloudflareAccountID').value = '';
            document.getElementById('cloudflareAPIToken').value = '';
            document.getElementById('cloudflareUsageAPI').value = '';
            document.getElementById('cloudflareStatus').style.display = 'none';
            document.getElementById('cloudflareStatus').textContent = '';
        }

        // تست اتصال Cloudflare
        async function testCloudflareConfig() {
            const method = document.getElementById('cloudflareAuthMethod').value;
            let email = '', globalAPIKey = '', accountID = '', apiToken = '', usageAPI = '';

            const statusEl = document.getElementById('cloudflareStatus');
            const confirmBtn = document.getElementById('cloudflareConfirmBtn');
            const testBtn = event.target;

            // بر اساس روش انتخاب شده دریافت مقدار ورودی
            if (method === 'email') {
                email = document.getElementById('cloudflareEmail').value.trim();
                globalAPIKey = document.getElementById('cloudflareGlobalAPIKey').value.trim();

                if (!email || !globalAPIKey) {
                    statusEl.textContent = '❌ لطفاً Email و Global API Key را پر کنید';
                    statusEl.style.display = 'block';
                    statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                    statusEl.style.color = '#fff';
                    confirmBtn.disabled = true;
                    confirmBtn.style.opacity = '0.5';
                    confirmBtn.dataset.testPassed = 'false';
                    return;
                }
            } else if (method === 'accountid') {
                accountID = document.getElementById('cloudflareAccountID').value.trim();
                apiToken = document.getElementById('cloudflareAPIToken').value.trim();

                if (!accountID || !apiToken) {
                    statusEl.textContent = '❌ لطفاً Account ID و API Token را پر کنید';
                    statusEl.style.display = 'block';
                    statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                    statusEl.style.color = '#fff';
                    confirmBtn.disabled = true;
                    confirmBtn.style.opacity = '0.5';
                    confirmBtn.dataset.testPassed = 'false';
                    return;
                }
            } else if (method === 'usageapi') {
                usageAPI = document.getElementById('cloudflareUsageAPI').value.trim();

                if (!usageAPI) {
                    statusEl.textContent = '❌ لطفاً آدرس UsageAPI را پر کنید';
                    statusEl.style.display = 'block';
                    statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                    statusEl.style.color = '#fff';
                    confirmBtn.disabled = true;
                    confirmBtn.style.opacity = '0.5';
                    confirmBtn.dataset.testPassed = 'false';
                    return;
                }
            }

            try {
                testBtn.disabled = true;
                statusEl.textContent = '⏳ در حال بررسی...';
                statusEl.style.display = 'block';
                statusEl.style.background = 'linear-gradient(135deg, #3b82f6 0, #1d4ed8 100%)';
                statusEl.style.color = '#fff';

                let response;

                if (method === 'usageapi') {
                    // روش UsageAPI: درخواست مستقیم به API خارجی
                    response = await fetch(usageAPI);
                } else {
                    // ساخت URL درخواست
                    let queryParams = new URLSearchParams();
                    if (method === 'email') {
                        queryParams.append('Email', email);
                        queryParams.append('GlobalAPIKey', globalAPIKey);
                    } else if (method === 'accountid') {
                        queryParams.append('AccountID', accountID);
                        queryParams.append('APIToken', apiToken);
                    }

                    response = await fetch('/admin/getCloudflareUsage?' + queryParams.toString());
                }

                if (!response.ok) {
                    throw new Error('درخواست ناموفق بود (HTTP ' + response.status + ')');
                }

                const data = await response.json();

                if (data.success) {
                    // اعتبارسنجی موفق
                    statusEl.style.background = 'linear-gradient(135deg, #10b981 0, #059669 100%)';
                    const maxQuota = data.max || 100000;
                    const percentage = (data.total / maxQuota * 100).toFixed(2);
                    statusEl.textContent = `✅ اعتبارسنجی موفق! سهمیه درخواست امروز: ${data.total}/${maxQuota} (${percentage}%)`;
                    confirmBtn.disabled = false;
                    confirmBtn.style.opacity = '1';
                    confirmBtn.dataset.testPassed = 'true';

                    // ذخیره داده‌های اعتبارسنجی شده برای استفاده در ذخیره بعدی
                    confirmBtn.dataset.method = method;
                    confirmBtn.dataset.email = email;
                    confirmBtn.dataset.globalAPIKey = globalAPIKey;
                    confirmBtn.dataset.accountID = accountID;
                    confirmBtn.dataset.apiToken = apiToken;
                    confirmBtn.dataset.usageAPI = usageAPI;
                } else {
                    // اعتبارسنجی ناموفق
                    statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                    statusEl.textContent = '❌ اعتبارسنجی ناموفق: ' + (data.msg || 'اعتبار نامعتبر یا بدون دسترسی');
                    confirmBtn.disabled = true;
                    confirmBtn.style.opacity = '0.5';
                    confirmBtn.dataset.testPassed = 'false';
                }
            } catch (error) {
                statusEl.style.background = 'linear-gradient(135deg, #ef4444 0, #dc2626 100%)';
                statusEl.textContent = '❌ تشخیص ناموفق: ' + error.message;
                confirmBtn.disabled = true;
                confirmBtn.style.opacity = '0.5';
                confirmBtn.dataset.testPassed = 'false';
            } finally {
                testBtn.disabled = false;
            }
        }

        // ذخیره پیکربندی Cloudflare
        async function confirmCloudflareConfig() {
            const confirmBtn = document.getElementById('cloudflareConfirmBtn');

            // بررسی اینکه آیا از اعتبارسنجی عبور کرده
            if (confirmBtn.dataset.testPassed !== 'true') {
                showToast('لطفاً ابتدا دکمه "اعتبارسنجی دسترس‌پذیری" را کلیک کنید تا تأیید شود', 'error');
                return;
            }

            const method = confirmBtn.dataset.method;
            const email = confirmBtn.dataset.email || '';
            const globalAPIKey = confirmBtn.dataset.globalAPIKey || '';
            const accountID = confirmBtn.dataset.accountID || '';
            const apiToken = confirmBtn.dataset.apiToken || '';
            const usageAPI = confirmBtn.dataset.usageAPI || '';

            try {
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'در حال ذخیره...';

                // ساخت بدنه درخواست
                let payload;
                if (method === 'usageapi') {
                    payload = {
                        Email: null,
                        GlobalAPIKey: null,
                        AccountID: null,
                        APIToken: null,
                        UsageAPI: usageAPI
                    };
                } else {
                    payload = {
                        Email: method === 'email' ? email : null,
                        GlobalAPIKey: method === 'email' ? globalAPIKey : null,
                        AccountID: method === 'accountid' ? accountID : null,
                        APIToken: method === 'accountid' ? apiToken : null,
                        UsageAPI: null
                    };
                }

                // ارسال به backend
                const response = await fetch('/admin/cf.json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    showToast('✅ پیکربندی Cloudflare ذخیره شد', 'success');
                    closeCloudflareConfigModal();

                    // 1 ثانیه بعد بارگذاری مجدد صفحه
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    const errorData = await response.json();
                    showToast('❌ ذخیره ناموفق بود: ' + (errorData.error || 'خطای ناشناخته'), 'error');
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'ذخیره';
                }
            } catch (error) {
                showToast('❌ ذخیره ناموفق بود: ' + error.message, 'error');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'ذخیره';
            }
        }

        // ذخیره تنظیمات اعلان
        async function saveNotification() {
            try {
                // فقط بروزرسانی فیلد TG.فعال
                if (!currentConfig.TG) currentConfig.TG = {};
                currentConfig.TG.启用 = document.getElementById('telegramEnabled').checked;

                // ارسال به سرور، اما کل currentConfig
                const response = await fetch('/admin/config.json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentConfig)
                });

                if (!response.ok) throw new Error('ذخیره ناموفق بود');

                showToast('✅ وضعیت فعال‌سازی ذخیره شد', 'success');
                modifiedSections.delete('notification');
                updateButtonStates();
            } catch (error) {
                showToast('❌ ذخیره ناموفق بود: ' + error.message, 'error');
            }
        }

        // پاک کردن پیکربندی Telegram
        // پاک کردن پیکربندی Telegram
        function clearTelegramConfig() {
            document.getElementById('clearTelegramModal').classList.add('show');
        }

        function closeClearTelegramModal(event) {
            if (!event || event.target.id === 'clearTelegramModal') {
                document.getElementById('clearTelegramModal').classList.remove('show');
            }
        }

        async function confirmClearTelegramConfig() {
            try {
                const response = await fetch('/admin/tg.json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ init: true })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    closeClearTelegramModal();
                    showToast('✅ پیکربندی Telegram پاک شد، صفحه به زودی بارگذاری می‌شود...', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showToast('❌ پاک کردن ناموفق: ' + (data.message || 'خطای ناشناخته'), 'error');
                }
            } catch (error) {
                showToast('❌ خطا در پاک کردن: ' + error.message, 'error');
            }
        }

        // پاک کردن پیکربندی Cloudflare
        function clearCloudflareConfig() {
            document.getElementById('clearCloudflareModal').classList.add('show');
        }

        function closeClearCloudflareModal(event) {
            if (!event || event.target.id === 'clearCloudflareModal') {
                document.getElementById('clearCloudflareModal').classList.remove('show');
            }
        }

        async function confirmClearCloudflareConfig() {
            try {
                const response = await fetch('/admin/cf.json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ init: true })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    closeClearCloudflareModal();
                    showToast('✅ پیکربندی Cloudflare پاک شد، صفحه به زودی بارگذاری می‌شود...', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showToast('❌ پاک کردن ناموفق: ' + (data.message || 'خطای ناشناخته'), 'error');
                }
            } catch (error) {
                showToast('❌ خطا در پاک کردن: ' + error.message, 'error');
            }
        }

        // لغو ویرایش تنظیمات اعلان
        function cancelEdit(section) {
            if (section === 'notification') {
                // بازنشانی وضعیت فعال‌سازی اعلان به مقدار اصلی
                const telegramCheckbox = document.getElementById('telegramEnabled');
                const originalEnabled = originalConfig.TG?.启用 ?? false;
                telegramCheckbox.checked = originalEnabled;
                currentConfig.TG.启用 = originalEnabled;
            } else {
                // منطق cancelEdit اصلی
                currentConfig = JSON.parse(JSON.stringify(originalConfig));

                if (section === 'sub') {
                    const local = currentConfig.优选订阅生成?.local ?? true;
                    const randomIP = currentConfig.优选订阅生成?.本地IP库?.随机IP ?? true;

                    if (!local) {
                        document.getElementById('ipMode').value = 'generator';
                        document.getElementById('generatorURL').value = currentConfig.优选订阅生成?.SUB || '';
                    } else if (randomIP) {
                        document.getElementById('ipMode').value = 'random';
                        document.getElementById('randomCount').value = currentConfig.优选订阅生成?.本地IP库?.随机数量 || 16;
                    } else {
                        document.getElementById('ipMode').value = 'custom';
                        loadCustomIPs();
                    }
                    updateIPMode();
                } else if (section === 'config') {
                    document.getElementById('subName').value = currentConfig.优选订阅生成?.SUBNAME || '';
                    document.getElementById('nodeHost').value = currentConfig.HOST || '';
                    document.getElementById('nodeUUID').value = currentConfig.UUID || '';
                    document.getElementById('nodePATH').value = currentConfig.PATH || '';
                    document.getElementById('protocol').value = currentConfig.协议类型 || 'vless';
                    document.getElementById('skipVerify').checked = currentConfig.跳过证书验证 || false;
                    updateProtocol();
                } else if (section === 'proxy') {
                    const socksEnabled = currentConfig.反代?.SOCKS5?.启用;
                    if (!socksEnabled) {
                        document.getElementById('proxyMode').value = 'auto';
                        document.getElementById('proxyIP').value = currentConfig.反代?.PROXYIP || '';
                        document.getElementById('autoProxy').checked = (currentConfig.反代?.PROXYIP === 'auto');
                        if (currentConfig.反代?.PROXYIP === 'auto') {
                            document.getElementById('proxyIP').disabled = true;
                        }
                    } else if (socksEnabled === 'socks5') {
                        document.getElementById('proxyMode').value = 'socks5';
                        document.getElementById('socks5Addr').value = currentConfig.反代?.SOCKS5?.账号 || '';
                        document.getElementById('globalSocks5').checked = currentConfig.反代?.SOCKS5?.全局 || false;
                    } else if (socksEnabled === 'http') {
                        document.getElementById('proxyMode').value = 'http';
                        document.getElementById('httpAddr').value = currentConfig.反代?.SOCKS5?.账号 || '';
                        document.getElementById('globalHTTP').checked = currentConfig.反代?.SOCKS5?.全局 || false;
                    }
                    updateProxyMode();
                } else if (section === 'convert') {
                    document.getElementById('subAPI').value = currentConfig.订阅转换配置?.SUBAPI || '';
                    document.getElementById('subConfig').value = currentConfig.订阅转换配置?.SUBCONFIG || '';
                    document.getElementById('emoji').checked = currentConfig.订阅转换配置?.SUBEMOJI || false;
                }
            }

            modifiedSections.delete(section);
            updateButtonStates();
        }

        // بروزرسانی شمارش معکوس
        function updateCountdown() {
            const now = new Date();
            const nextMidnightUTC = new Date(now);
            nextMidnightUTC.setUTCHours(0, 0, 0, 0);
            nextMidnightUTC.setUTCDate(nextMidnightUTC.getUTCDate() + 1); // همیشه تنظیم به فردا ساعت 0

            const diff = nextMidnightUTC - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            document.getElementById('countdown').innerHTML = `<span class="countdown-text">تا ریست</span> <span class="countdown-numbers">${hours.toString().padStart(2, '0')}</span><span class="countdown-text">ساعت</span><span class="countdown-numbers">${minutes.toString().padStart(2, '0')}</span><span class="countdown-text">دقیقه</span><span class="countdown-numbers">${seconds.toString().padStart(2, '0')}</span><span class="countdown-text">ثانیه</span>`;
        }
// ==================== توابع مربوط به انتخاب آنلاین ====================

        // تابع ماسک کردن IP - ماسک کردن بخش وسط IP
        function expandIPv6(ip) {
            // حذف [] احتمالی
            ip = ip.replace(/^\[|\]$/g, '');
            // اگر :: نیست، مستقیم split
            if (!ip.includes('::')) {
                return ip.split(':').map(part => part.padStart(4, '0')).join(':');
            }
            // پردازش ::
            const parts = ip.split('::');
            const left = parts[0] ? parts[0].split(':') : [];
            const right = parts[1] ? parts[1].split(':') : [];
            const missing = 8 - left.length - right.length;
            const middle = new Array(missing).fill('0000');
            const full = left.concat(middle).concat(right);
            return full.map(part => part.padStart(4, '0')).join(':');
        }

        function maskIP(ip) {
            if (!ip) return ip;
            // بررسی IPv4
            if (ip.includes('.') && !ip.includes(':')) {
                // IPv4: مثلاً 192.168.1.1 -> 192.*.*.1
                const parts = ip.split('.');
                if (parts.length === 4) {
                    return `${parts[0]}.*.*.${parts[3]}`;
                }
            } else if (ip.includes(':')) {
                // IPv6: گسترش و ماسک کردن بخش وسط
                const expanded = expandIPv6(ip);
                const parts = expanded.split(':');
                if (parts.length === 8) {
                    return `${parts[0]}:****:****:****:****:****:${parts[6]}:${parts[7]}`;
                }
            }
            return ip;
        }

        // تغییر حالت نمایش IP
        function toggleIPDisplay() {
            ipDisplayMode = ipDisplayMode === 'masked' ? 'full' : 'masked';
            updateIPDisplay();
        }

        // بروزرسانی نمایش IP
        function updateIPDisplay() {
            const displayIP = ipDisplayMode === 'masked' ? maskIP(currentDetectedIP) : currentDetectedIP;
            const ipElement = document.getElementById('ipDisplayElement');
            if (ipElement) {
                ipElement.textContent = displayIP;
            }
        }

        let optimizeResults = {}; // ذخیره نتایج انتخاب
        let currentSelectedCountry = ''; // کشور فعلی انتخاب شده
        let locationsData = []; // ذخیره داده‌های مکان
        let currentIPLibrary = ''; // نوع کتابخانه IP فعلی
        let currentDetectedIP = ''; // IP تشخیص داده شده فعلی
        let ipDisplayMode = 'masked'; // حالت نمایش IP: 'masked' یا 'full'

        // باز کردن کادر انتخاب آنلاین
        async function openOnlineOptimizeModal() {
            document.getElementById('onlineOptimizeModal').classList.add('show');

            // بازنشانی وضعیت
            optimizeResults = {};
            currentSelectedCountry = '';
            document.getElementById('optimizeProgressBar').classList.add('hidden-section');
            document.getElementById('optimizeResultsTabs').classList.add('hidden-section');
            document.getElementById('optimizeResultsContent').classList.add('hidden-section');
            document.getElementById('btnSaveOverride').disabled = true;
            document.getElementById('btnSaveAppend').disabled = true;
            document.getElementById('btnStartOptimize').disabled = true;
            document.getElementById('btnStartOptimize').textContent = 'در حال تشخیص...';

            // تشخیص IP و محیط
            await detectIPAndEnvironment();
        }

        // بستن کادر انتخاب آنلاین
        function closeOnlineOptimizeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('onlineOptimizeModal').classList.remove('show');
        }
		// ==================== توابع مربوط به انتخاب API ====================

        // باز کردن کادر انتخاب API
        function openAPIOptimizeModal() {
            document.getElementById('apiOptimizeModal').classList.add('show');
            // بازنشانی فرم
            document.getElementById('apiOptimizeURL').value = '';
            document.getElementById('apiOptimizePort').value = '443';
            document.getElementById('apiOptimizeResults').value = '';
            document.getElementById('btnAppendAPI').disabled = true;
            document.getElementById('btnAppendResults').disabled = true;
            // مقداردهی اولیه line-editor
            initLineEditor('apiOptimizeResults');
        }

        // بستن کادر انتخاب API
        function closeAPIOptimizeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('apiOptimizeModal').classList.remove('show');
        }

        // اعتبارسنجی و هنجارسازی شماره پورت
        function validateAndNormalizePort(port) {
            let num = parseInt(port, 10);
            if (isNaN(num)) return '443';
            if (num < 1) return '1';
            if (num > 65535) return '65535';
            return num.toString();
        }

        // اعتبارسنجی فرمت URL API
        function isValidURL(url) {
            try {
                new URL(url);
                return true;
            } catch (e) {
                return false;
            }
        }

        // تبدیل لینک GitHub به فرمت raw
        function convertGitHubURLToRaw(url) {
            if (!url.includes('github.com')) {
                return url;
            }

            // تبدیل https://github.com/user/repo/blob/branch/path به https://raw.githubusercontent.com/user/repo/refs/heads/branch/path
            if (url.includes('/blob/')) {
                // استخراج شاخه و مسیر فایل
                const match = url.match(/github\.com\/([^/]+)\/([^/]+)\/blob\/([^/]+)\/(.*)/);
                if (match) {
                    const [, user, repo, branch, filePath] = match;
                    return `https://raw.githubusercontent.com/${user}/${repo}/refs/heads/${branch}/${filePath}`;
                }
            }

            // تبدیل https://github.com/user/repo/tree/branch/path به https://raw.githubusercontent.com/user/repo/refs/heads/branch/path
            if (url.includes('/tree/')) {
                const match = url.match(/github\.com\/([^/]+)\/([^/]+)\/tree\/([^/]+)\/(.*)/);
                if (match) {
                    const [, user, repo, branch, filePath] = match;
                    return `https://raw.githubusercontent.com/${user}/${repo}/refs/heads/${branch}/${filePath}`;
                }
            }

            return url;
        }

        // تبدیل خودکار زنده لینک GitHub
        function autoConvertGitHubURL() {
            const urlInput = document.getElementById('apiOptimizeURL');
            const url = urlInput.value.trim();

            if (url.includes('github.com/')) {
                const convertedURL = convertGitHubURLToRaw(url);
                if (convertedURL !== url) {
                    urlInput.value = convertedURL;
                }
            }
        }

        // تشخیص خودکار پورت از URL و پر کردن فیلد پورت پیش‌فرض
        function autoDetectPortFromURL() {
            const urlInput = document.getElementById('apiOptimizeURL').value.trim();
            const portInput = document.getElementById('apiOptimizePort');

            if (!urlInput) return;

            try {
                const urlObj = new URL(urlInput);
                const portParam = urlObj.searchParams.get('port');

                if (portParam) {
                    // تشخیص پارامتر port، اعتبارسنجی و هنجارسازی
                    const normalizedPort = validateAndNormalizePort(portParam);
                    portInput.value = normalizedPort;
                }
            } catch (error) {
                // فرمت URL اشتباه، نادیده گرفته شود
                console.log('بررسی فرمت URL ناموفق:', error);
            }
        }

        // اعتبارسنجی دسترس‌پذیری
        async function verifyAPIOptimize() {
            let urlInput = document.getElementById('apiOptimizeURL').value.trim();
            const portInput = document.getElementById('apiOptimizePort').value.trim();

            if (!urlInput) {
                alert('لطفاً URL API را وارد کنید');
                return;
            }

            // تبدیل خودکار لینک GitHub به فرمت raw
            const convertedURL = convertGitHubURLToRaw(urlInput);
            if (convertedURL !== urlInput) {
                document.getElementById('apiOptimizeURL').value = convertedURL;
                urlInput = convertedURL;
                showToast('✅ لینک GitHub به طور خودکار به فرمت raw تبدیل شد', 'info');
            }

            if (!isValidURL(urlInput)) {
                alert('لطفاً فرمت معتبر URL را وارد کنید');
                return;
            }

            // تشخیص و استخراج پارامتر port از URL
            let detectedPort = null;
            let cleanURL = urlInput;

            try {
                const urlObj = new URL(urlInput);
                const portParam = urlObj.searchParams.get('port');

                if (portParam) {
                    // تشخیص پارامتر port
                    detectedPort = validateAndNormalizePort(portParam);

                    // حذف پارامتر port
                    urlObj.searchParams.delete('port');
                    cleanURL = urlObj.toString();

                    // بروزرسانی کادر ورودی URL (حذف پارامتر port)
                    document.getElementById('apiOptimizeURL').value = cleanURL;

                    // بروزرسانی کادر پورت
                    document.getElementById('apiOptimizePort').value = detectedPort;

                    showToast(`✅ پورت از URL تشخیص داده شد: ${detectedPort}، و پارامتر port حذف شد`, 'success');
                }
            } catch (error) {
                console.log('استخراج پارامتر port از URL ناموفق:', error);
            }

            // هنجارسازی پورت (اگر از URL تشخیص داده نشد، از مقدار کادر ورودی استفاده شود)
            const normalizedPort = detectedPort || validateAndNormalizePort(portInput);
            document.getElementById('apiOptimizePort').value = normalizedPort;

            // ساخت URL کامل با استفاده از URL پاک شده
            const separator = cleanURL.includes('?') ? '&' : '?';
            const completeURL = `${cleanURL}${separator}port=${normalizedPort}`;

            // URL encoding
            const encodedURL = encodeURIComponent(completeURL);

            // ساخت URL درخواست
            const requestURL = `/admin/getADDAPI?url=${encodedURL}`;

            try {
                const btn = document.getElementById('btnVerifyAPI');
                btn.disabled = true;
                btn.textContent = 'در حال اعتبارسنجی...';

                const response = await fetch(requestURL);
                const data = await response.json();

                if (data.success && data.data && Array.isArray(data.data)) {
                    // رابط قابل استفاده
                    const results = data.data.join('\n');
                    document.getElementById('apiOptimizeResults').value = results;
                    // تازه‌سازی شماره خط‌های line-editor
                    const resultsTA = document.getElementById('apiOptimizeResults');
                    if (resultsTA._refreshLineEditor) {
                        resultsTA._refreshLineEditor();
                    }
                    document.getElementById('btnAppendAPI').disabled = false;
                    document.getElementById('btnAppendResults').disabled = false;
                    showToast('✅ اعتبارسنجی رابط API موفق!', 'success');
                } else {
                    // رابط قابل استفاده نیست
                    document.getElementById('apiOptimizeResults').value = '❌ رابط قابل استفاده نیست، لطفاً URL و پورت را بررسی کنید';
                    // تازه‌سازی شماره خط‌های line-editor
                    const resultsTA = document.getElementById('apiOptimizeResults');
                    if (resultsTA._refreshLineEditor) {
                        resultsTA._refreshLineEditor();
                    }
                    document.getElementById('btnAppendAPI').disabled = true;
                    document.getElementById('btnAppendResults').disabled = true;
                    showToast('❌ اعتبارسنجی رابط API ناموفق، لطفاً رابط را بررسی کنید', 'error');
                }
            } catch (error) {
                console.error('خطای اعتبارسنجی API:', error);
                document.getElementById('apiOptimizeResults').value = `❌ خطای اعتبارسنجی: ${error.message}`;
                // تازه‌سازی شماره خط‌های line-editor
                const resultsTA = document.getElementById('apiOptimizeResults');
                if (resultsTA._refreshLineEditor) {
                    resultsTA._refreshLineEditor();
                }
                document.getElementById('btnAppendAPI').disabled = true;
                document.getElementById('btnAppendResults').disabled = true;
                showToast('❌ خطای اعتبارسنجی، لطفاً بعداً دوباره امتحان کنید', 'error');
            } finally {
                const btn = document.getElementById('btnVerifyAPI');
                btn.disabled = false;
                btn.textContent = 'اعتبارسنجی دسترس‌پذیری';
            }
        }

        // اضافه کردن API به آدرس سفارشی
        function appendAPIToCustom() {
            let urlInput = document.getElementById('apiOptimizeURL').value.trim();
            const portInput = document.getElementById('apiOptimizePort').value.trim();

            if (!urlInput) {
                alert('لطفاً URL API را وارد کنید');
                return;
            }

            // حذف پارامتر port احتمالی از URL
            try {
                const urlObj = new URL(urlInput);
                urlObj.searchParams.delete('port');
                urlInput = urlObj.toString();
            } catch (error) {
                console.log('پردازش URL ناموفق:', error);
            }

            // ساخت URL کامل
            const separator = urlInput.includes('?') ? '&' : '?';
            const completeURL = `${urlInput}${separator}port=${portInput}`;

            const customIPsTextarea = document.getElementById('customIPs');
            const currentValue = customIPsTextarea.value.trim();

            // اضافه به کادر متنی
            if (currentValue) {
                customIPsTextarea.value = currentValue + '\n' + completeURL;
            } else {
                customIPsTextarea.value = completeURL;
            }

            // تازه‌سازی شماره خط‌های line-editor
            if (customIPsTextarea._refreshLineEditor) {
                customIPsTextarea._refreshLineEditor();
            }

            // علامت‌گذاری به عنوان ویرایش شده
            markModified('sub');

            showToast('✅ URL API به آدرس سفارشی اضافه شد', 'success');
            closeAPIOptimizeModal();
        }

        // اضافه کردن نتایج به آدرس سفارشی
        function appendResultsToCustom() {
            const resultsTextarea = document.getElementById('apiOptimizeResults');
            const results = resultsTextarea.value.trim();

            if (!results || results.startsWith('❌')) {
                alert('لطفاً ابتدا اعتبارسنجی را انجام دهید و اعتبارسنجی موفق باشد');
                return;
            }

            const customIPsTextarea = document.getElementById('customIPs');
            const currentValue = customIPsTextarea.value.trim();

            // اضافه به کادر متنی
            if (currentValue) {
                customIPsTextarea.value = currentValue + '\n' + results;
            } else {
                customIPsTextarea.value = results;
            }

            // تازه‌سازی شماره خط‌های line-editor
            if (customIPsTextarea._refreshLineEditor) {
                customIPsTextarea._refreshLineEditor();
            }

            // علامت‌گذاری به عنوان ویرایش شده
            markModified('sub');

            showToast('✅ نتایج API به آدرس سفارشی اضافه شد', 'success');
            closeAPIOptimizeModal();
        }

        // تشخیص IP و محیط شبکه
        async function detectIPAndEnvironment() {
            console.log('[انتخاب آنلاین] شروع: تشخیص محیط شبکه');
            const detectionBox = document.getElementById('ipDetectionBox');
            const btnStart = document.getElementById('btnStartOptimize');
            detectionBox.innerHTML = '<div class="ip-detection-info">در حال تشخیص محیط شبکه شما...</div>';

            try {
                // ابتدا مسیر محلی را امتحان کن
                let response, text;
                try {
                    console.log('[انتخاب آنلاین] پیشرفت: امتحان تشخیص با مسیر دامنه فعلی');
                    response = await fetch(`/cdn-cgi/trace?_t=${Date.now()}`, {
                        signal: AbortSignal.timeout(5000),
                        cache: 'no-store'
                    });
                    text = await response.text();
                    console.log('[انتخاب آنلاین] موفق: تشخیص مسیر محلی موفق (استفاده از دامنه محلی)');
                    window.detectDomain = window.location.origin;
                } catch (primaryError) {
                    console.warn('[انتخاب آنلاین] تشخیص مسیر محلی ناموفق، امتحان speed.cloudflare.com...', primaryError);
                    response = await fetch(`https://speed.cloudflare.com/cdn-cgi/trace?_t=${Date.now()}`, {
                        signal: AbortSignal.timeout(5000),
                        cache: 'no-store'
                    });
                    text = await response.text();
                    console.log('[انتخاب آنلاین] موفق: تشخیص لینک اصلی موفق');
                    window.detectDomain = 'https://speed.cloudflare.com';
                }

                // پاسخ را تجزیه کن
                const lines = text.trim().split('\n');
                const data = {};
                lines.forEach(line => {
                    const [key, value] = line.split('=');
                    if (key && value) data[key.trim()] = value.trim();
                });

                const ip = data.ip || 'ناشناخته';
                const loc = data.loc || 'ناشناخته';
                currentDetectedIP = ip;
                ipDisplayMode = 'masked';
                console.log(`[انتخاب آنلاین] نتیجه: IP=${ip}, کشور=${loc}`);

                // نمایش IP ماسک شده، با رویداد کلیک
                const displayIP = maskIP(ip);
                let html = `<div class="ip-detection-info">IP فعلی: <strong id="ipDisplayElement" style="cursor: pointer; transition: all 0.2s ease;" title="کلیک برای تغییر حالت نمایش">${displayIP}</strong> | کشور دسترسی: <strong>${loc}</strong></div>`;

                if (loc !== 'CN') {
                    console.warn('[انتخاب آنلاین] هشدار: تشخیص دسترسی غیر CN، ممکن است در محیط پروکسی/VPN باشید');
                    html += `<div class="ip-detection-warning" style="font-size: 16px; font-weight: 700; color: #dc2626; margin-top: 12px; line-height: 1.6;">⚠️ تشخیص داده شد که احتمالاً در محیط پروکسی/VPN هستید! لطفاً مطمئن شوید که در محیط شبکه مستقیم هستید قبل از انتخاب آنلاین، در غیر این صورت نتایج تست انتخاب نaccurate نخواهند بود!</div>`;
                    // منطقه غیر CN، دکمه شروع را غیرفعال کن
                    btnStart.disabled = true;
                    btnStart.textContent = 'فقط مناطق CN';
                } else {
                    // منطقه CN، دکمه شروع را فعال کن
                    btnStart.disabled = false;
                    btnStart.textContent = 'شروع انتخاب';
                    console.log('[انتخاب آنلاین] موفق: تشخیص منطقه CN، دکمه انتخاب فعال شد');
                }

                detectionBox.innerHTML = html;

                // اضافه کردن رویداد کلیک به عنصر IP
                const ipElement = document.getElementById('ipDisplayElement');
                if (ipElement) {
                    ipElement.addEventListener('click', toggleIPDisplay);
                }
            } catch (error) {
                console.error('[انتخاب آنلاین] تشخیص ناموفق:', error);
                detectionBox.innerHTML = '<div class="ip-detection-info">⚠️ دسترسی به https://speed.cloudflare.com/cdn-cgi/trace برای تشخیص محیط شبکه ممکن نیست، لطفاً اتصال شبکه را بررسی کنید یا پروکسی را خاموش کنید</div>';
                // تشخیص ناموفق، دکمه را غیرفعال کن
                btnStart.disabled = true;
                btnStart.textContent = 'تشخیص ناموفق';
            }
        }

        // اعتبارسنجی ورودی تعداد رشته‌های تست
        function validateConcurrency(input) {
            let value = parseInt(input.value);
            if (isNaN(value) || value < 1) {
                input.value = 1;
            } else if (value > 32) {
                input.value = 32;
            }
        }

        // شروع انتخاب
        async function startOptimize() {
            console.log('[انتخاب آنلاین] شروع: فرآیند انتخاب');
            const btnStart = document.getElementById('btnStartOptimize');
            btnStart.disabled = true;
            btnStart.textContent = 'در حال انتخاب...';

            const progressBar = document.getElementById('optimizeProgressBar');
            const progressFill = document.getElementById('optimizeProgressFill');
            const progressText = document.getElementById('optimizeProgressText');
            progressBar.classList.remove('hidden-section');
            progressFill.style.width = '0%';
            progressText.textContent = '0/512 (0.00%)';

            document.getElementById('optimizeResultsTabs').classList.add('hidden-section');
            document.getElementById('optimizeResultsContent').classList.add('hidden-section');

            try {
                // بارگذاری داده‌های locations
                console.log('[انتخاب آنلاین] مرحله 1: بارگذاری داده‌های مکان');
                await loadLocationsData();

                // دریافت انتخاب کاربر
                const ipLibrary = document.getElementById('optimizeIPLibrary').value;
                const port = document.getElementById('optimizePort').value;
                let concurrency = parseInt(document.getElementById('optimizeConcurrency').value) || 8;

                // اعتبارسنجی تعداد رشته‌های همزمان
                if (isNaN(concurrency) || concurrency < 1 || concurrency > 32) {
                    concurrency = 8;
                    document.getElementById('optimizeConcurrency').value = '8';
                }

                console.log(`[انتخاب آنلاین] مرحله 2: انتخاب کاربر - کتابخانه IP=${ipLibrary}, پورت=${port}, رشته همزمان=${concurrency}`);
                currentIPLibrary = ipLibrary;

                // دریافت لیست IP
                console.log('[انتخاب آنلاین] مرحله 3: دریافت لیست IP');
                const ips = await getIPList(ipLibrary, port);

                if (ips.length === 0) {
                    console.error('[انتخاب آنلاین] خطا: لیست IP دریافت نشد');
                    showToast('لیست IP دریافت نشد', 'error');
                    return;
                }

                console.log(`[انتخاب آنلاین] موفق: ${ips.length} IP دریافت شد`);

                // تست سرعت (همزمان چند رشته‌ای)
                console.log('[انتخاب آنلاین] مرحله 4: شروع تست IP (همزمان چند رشته‌ای)');
                const results = await testIPsConcurrent(ips, progressFill, progressText, concurrency);
                console.log(`[انتخاب آنلاین] تکمیل: تست تکمیل شد، تعداد IP معتبر=${results.length}`);

                // دسته‌بندی نتایج
                console.log('[انتخاب آنلاین] مرحله 5: شروع دسته‌بندی نتایج');
                classifyResults(results);

                // نمایش نتایج
                console.log('[انتخاب آنلاین] مرحله 6: نمایش نتایج');
                displayResults();

                console.log('[انتخاب آنلاین] تکمیل: فرآیند انتخاب تکمیل شد');
                showToast('انتخاب تکمیل شد!', 'success');

            } catch (error) {
                console.error('[انتخاب آنلاین] خطا در فرآیند انتخاب:', error);
                showToast('خطا در فرآیند انتخاب: ' + error.message, 'error');
            } finally {
                btnStart.disabled = false;
                btnStart.textContent = 'شروع انتخاب';
            }
        }

        // بارگذاری داده‌های locations
        async function loadLocationsData() {
            const backupUrl = 'https://zip.cm.edu.kg/locations.json';

            try {
                // استفاده از دامنه فعلی برای بارگذاری داده‌های مکان، جلوگیری از مشکل跨域
                const url = `${window.detectDomain}/locations`;
                console.log(`[انتخاب آنلاین] پیشرفت: بارگذاری داده‌های مکان URL=${url}`);

                const response = await fetch(url, { headers: { 'Referer': window.detectDomain + '/' } });
                const data = await response.json();

                // بررسی خالی بودن داده‌های برگشتی
                if (!data || (Array.isArray(data) && data.length === 0) || (typeof data === 'object' && !Array.isArray(data) && Object.keys(data).length === 0)) {
                    console.warn('[انتخاب آنلاین] رابط اصلی داده خالی برگرداند، امتحان رابط پشتیبان...');
                    throw new Error('رابط اصلی داده خالی برگرداند');
                }

                locationsData = data;
                console.log(`[انتخاب آنلاین] موفق: ${locationsData.length} داده مکان بارگذاری شد`);
            } catch (error) {
                console.error('[انتخاب آنلاین] بارگذاری داده‌های locations ناموفق:', error);

                // تلاش برای دریافت از رابط پشتیبان
                try {
                    console.log(`[انتخاب آنلاین] پیشرفت: تلاش برای بارگذاری از رابط پشتیبان URL=${backupUrl}`);
                    const backupResponse = await fetch(backupUrl, { headers: { 'Referer': 'https://zip.cm.edu.kg/' } });
                    const backupData = await backupResponse.json();

                    if (backupData && Array.isArray(backupData) && backupData.length > 0) {
                        locationsData = backupData;
                        console.log(`[انتخاب آنلاین] موفق: از رابط پشتیبان ${locationsData.length} داده مکان بارگذاری شد`);
                    } else {
                        console.error('[انتخاب آنلاین] رابط پشتیبان هم داده خالی برگرداند');
                        locationsData = [];
                    }
                } catch (backupError) {
                    console.error('[انتخاب آنلاین] بارگذاری رابط پشتیبان ناموفق:', backupError);
                    locationsData = [];
                }
            }
        }

        // تابع هوشمند دریافت با mirror - جایگزینی خودکار دامنه برای retry
        async function fetchWithAutoMirror(originalUrl, description = 'منبع') {
            // لیست دامنه‌های جایگزین (به ترتیب اولویت)
            const mirrorDomains = [
                'https://github.cmliussss.net/raw.githubusercontent.com',
                'https://github.cmliussss.com/raw.githubusercontent.com'
            ];

            // اولین تلاش: استفاده از URL اصلی
            try {
                console.log(`[درخواست RAW] پیشرفت: تلاش با لینک اصلی URL=${originalUrl}`);
                const response = await fetch(originalUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const text = await response.text();
                console.log(`[درخواست RAW] موفق: دریافت ${description} از لینک اصلی، طول=${text.length} کاراکتر`);
                return text;
            } catch (error) {
                console.warn(`[درخواست RAW] ❌ دریافت از لینک اصلی ناموفق: ${error.message}`);
            }

            // تلاش‌های بعدی: استفاده از دامنه‌های mirror جایگزین
            for (let i = 0; i < mirrorDomains.length; i++) {
                try {
                    // جایگزینی https://raw.githubusercontent.com در URL اصلی با دامنه mirror
                    const mirrorUrl = originalUrl.replace(
                        'https://raw.githubusercontent.com',
                        mirrorDomains[i]
                    );

                    console.log(`[درخواست RAW] پیشرفت: تلاش با mirror جایگزین (${i + 1}/${mirrorDomains.length}) URL=${mirrorUrl}`);
                    const response = await fetch(mirrorUrl);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    const text = await response.text();
                    console.log(`[درخواست RAW] موفق: دریافت ${description} از mirror جایگزین، طول=${text.length} کاراکتر`);
                    return text;
                } catch (error) {
                    console.warn(`[درخواست RAW] ❌ دریافت از mirror ${i + 1} ناموفق: ${error.message}`);

                    // اگر آخرین mirror است، خطا را پرتاب کن
                    if (i === mirrorDomains.length - 1) {
                        throw new Error(`دریافت ${description} ناموفق، لینک اصلی و همه ${mirrorDomains.length} mirror جایگزین امتحان شدند`);
                    }
                }
            }
        }

        // دریافت لیست IP
        async function getIPList(ipLibrary, port) {
            // تعریف URLهای اصلی کتابخانه‌های IP (فقط استفاده از آدرس‌های رسمی)
            const urlMap = {
                'cf-official': 'https://cf.090227.xyz/ips-v4',
                'cm-list': 'https://raw.githubusercontent.com/cmliu/cmliu/main/CF-CIDR.txt',
                'as13335': 'https://raw.githubusercontent.com/ipverse/asn-ip/master/as/13335/ipv4-aggregated.txt',
                'as209242': 'https://raw.githubusercontent.com/ipverse/asn-ip/master/as/209242/ipv4-aggregated.txt',
                'reverse-proxy': 'https://zip.cm.edu.kg/all.txt'
            };

            try {
                const url = urlMap[ipLibrary];
                if (!url) throw new Error(`نوع کتابخانه IP ناشناخته: ${ipLibrary}`);

                console.log(`[انتخاب آنلاین] پیشرفت: دریافت لیست IP از ${ipLibrary}`);
                const text = await fetchWithAutoMirror(url, `داده ${ipLibrary}`);

                if (ipLibrary === 'reverse-proxy') {
                    // پردازش لیست پروکسی معکوس
                    console.log('[انتخاب آنلاین] پیشرفت: پردازش لیست پروکسی معکوس');
                    return processReverseProxyList(text, port);
                } else {
                    // پردازش لیست CIDR
                    console.log('[انتخاب آنلاین] پیشرفت: پردازش لیست CIDR');
                    return processCIDRList(text, port);
                }
            } catch (error) {
                console.error('[انتخاب آنلاین] دریافت لیست IP ناموفق:', error);
                throw new Error('دریافت لیست IP ناموفق: ' + error.message);
            }
        }

        // پردازش لیست پروکسی معکوس
        function processReverseProxyList(text, targetPort) {
            const lines = text.trim().split('\n');
            const filteredIPs = [];

            console.log(`[انتخاب آنلاین] دیباگ: تعداد خط‌های اصلی لیست پروکسی معکوس=${lines.length}`);

            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed || trimmed.startsWith('#')) continue;

                // فرمت: IP:PORT#یادداشت
                const match = trimmed.match(/^([^:]+):(\d+)#(.+)$/);
                if (match) {
                    const [, ip, linePort, remark] = match;
                    if (linePort === targetPort) {
                        filteredIPs.push(`${ip}:${linePort}#${remark}`);
                    }
                }
            }

            console.log(`[انتخاب آنلاین] نتیجه: تعداد IP با پورت=${targetPort} برابر ${filteredIPs.length}`);

            // اگر بیش از 512، انتخاب تصادفی 512
            if (filteredIPs.length > 512) {
                console.log('[انتخاب آنلاین] نکته: تعداد IP بیش از 512، انتخاب تصادفی 512');
                return shuffleArray(filteredIPs).slice(0, 512);
            }

            return filteredIPs;
        }

        // پردازش لیست CIDR
        function processCIDRList(text, port) {
            const lines = text.trim().split('\n');
            const cidrs = lines.filter(line => line.trim() && !line.startsWith('#'));

            console.log(`[انتخاب آنلاین] دیباگ: تعداد CIDRها=${cidrs.length}`);

            const ips = [];
            const targetCount = 512;

            while (ips.length < targetCount && cidrs.length > 0) {
                for (const cidr of cidrs) {
                    if (ips.length >= targetCount) break;

                    const ip = generateRandomIPFromCIDR(cidr);
                    const ipWithPort = `${ip}:${port}`;

                    // بررسی تکراری نبودن
                    if (!ips.includes(ipWithPort)) {
                        ips.push(ipWithPort);
                    }
                }
            }

            console.log(`[انتخاب آنلاین] موفق: ${ips.length} IP تصادفی تولید شد`);
            return ips;
        }

        // تولید IP تصادفی از CIDR
        function generateRandomIPFromCIDR(cidr) {
            const [network, bits] = cidr.split('/');
            const maskBits = parseInt(bits);
            const networkParts = network.split('.').map(Number);

            // محاسبه آدرس شبکه
            const networkInt = (networkParts[0] << 24) | (networkParts[1] << 16) |
                (networkParts[2] << 8) | networkParts[3];

            // محاسبه تعداد هاست
            const hostBits = 32 - maskBits;
            const hostCount = Math.pow(2, hostBits);

            // انتخاب تصادفی یک آدرس هاست
            const randomHost = Math.floor(Math.random() * hostCount);
            const ipInt = networkInt + randomHost;

            // تبدیل به IP
            const ip1 = (ipInt >>> 24) & 255;
            const ip2 = (ip16 >>> 16) & 255;
            const ip3 = (ipInt >>> 8) & 255;
            const ip4 = ipInt & 255;

            return `${ip1}.${ip2}.${ip3}.${ip4}`;
        }

        // تست لیست IP (نسخه 4 رشته همزمان)
        async function testIPsConcurrent(ips, progressFill, progressText, concurrency = 8) {
            const results = [];
            const total = ips.length;
            let completedCount = 0;
            let successCount = 0;
            let failCount = 0;

            console.log(`[انتخاب آنلاین] شروع: تست همزمان مجموع=${total} IP (رشته=${concurrency})`);

            // تابع بروزرسانی پیشرفت
            const updateProgress = () => {
                const progress = (completedCount / total * 100).toFixed(2);
                // محاسبه نسبت قرمز و سبز (نسبت به IPهای تکمیل شده)
                let failPercent = 0;
                if (completedCount > 0) {
                    failPercent = (failCount / completedCount * 100).toFixed(2);
                }

                // تنظیم پس‌زمینه گرادیان پیشرفت، قرمز برای ناموفق، سبز برای موفق
                progressFill.style.background = `linear-gradient(90deg, #ef4444 0%, #ef4444 ${failPercent}%, #10b981 ${failPercent}%, #10b981 100%)`;
                progressFill.style.width = progress + '%';
                progressText.textContent = `${completedCount}/${total} (${progress}%) - موفق: ${successCount}, ناموفق: ${failCount}`;

                // هر 64 IP یکبار آماره چاپ شود
                if (completedCount % 64 === 0 || completedCount === total) {
                    console.log(`[انتخاب آنلاین] پیشرفت: تکمیل ${completedCount}/${total}، موفق=${successCount}، ناموفق=${failCount}`);
                }
            };

            // تابع wrapper تست تک IP
            const testIPWrapper = async (ipWithPort) => {
                const result = await testSingleIP(ipWithPort);
                completedCount++;

                if (result) {
                    results.push(result);
                    successCount++;
                } else {
                    failCount++;
                }

                updateProgress();
                return result;
            };

            // کنترل همزمان: تقسیم لیست IP به دسته‌های متعدد
            const batches = [];
            for (let i = 0; i < ips.length; i += concurrency) {
                batches.push(ips.slice(i, i + concurrency));
            }

            // اجرای همزمان دسته‌ای
            for (const batch of batches) {
                await Promise.all(batch.map(ip => testIPWrapper(ip)));
            }

            console.log(`[انتخاب آنلاین] تکمیل: تست تکمیل شد، مجموع=${total}، موفق=${successCount}، ناموفق=${failCount}`);
            return results;
        }

        // تست لیست IP (نسخه قدیمی تک رشته‌ای، نگه داشته شده به عنوان پشتیبان)
        async function testIPs(ips, progressFill) {
            const results = [];
            const total = ips.length;
            let successCount = 0;
            let failCount = 0;

            console.log(`[انتخاب آنلاین] شروع: شروع تست ${total} IP`);

            for (let i = 0; i < total; i++) {
                const ipWithPort = ips[i];
                const result = await testSingleIP(ipWithPort);

                if (result) {
                    results.push(result);
                    successCount++;
                } else {
                    failCount++;
                }

                // هر 50 IP یکبار آماره چاپ شود
                if ((i + 1) % 50 === 0 || (i + 1) === total) {
                    console.log(`[انتخاب آنلاین] پیشرفت: ${i + 1}/${total}، موفق=${successCount}، ناموفق=${failCount}`);
                }

                // بروزرسانی پیشرفت
                const progress = ((i + 1) / total * 100).toFixed(2);
                progressFill.style.width = progress + '%';
                progressFill.textContent = `${i + 1}/${total} (${progress}%)`;
            }

            console.log(`[انتخاب آنلاین] تکمیل: تست تکمیل شد، مجموع=${total}، موفق=${successCount}، ناموفق=${failCount}`);
            return results;
        }

        // تست تک IP
        async function testSingleIP(ipWithPort) {
            try {
                // تجزیه IP و پورت
                let ip, port, remark = '';
                if (ipWithPort.includes('#')) {
                    const [ipPort, remarkPart] = ipWithPort.split('#');
                    [ip, port] = ipPort.split(':');
                    remark = remarkPart;
                } else {
                    [ip, port] = ipWithPort.split(':');
                }

                // تبدیل IP به هگزادسیمال
                const hexIP = ipToHex(ip);
                const testUrl = `https://${hexIP}.nip.lfree.org:${port}/cdn-cgi/trace?_t=${Date.now()}`;

                // تست 3 بار، میانگین 2 بار آخر
                const times = [];
                let resultData = null;

                for (let i = 0; i < 3; i++) {
                    const start = performance.now();
                    try {
                        const response = await fetch(testUrl, {
                            method: 'GET',
                            signal: AbortSignal.timeout(5000)
                        });

                        if (response.ok) {
                            const end = performance.now();
                            const time = end - start;

                            // اولین بار حساب نشود (مشکل DNS)
                            if (i > 0) {
                                times.push(time);
                            }

                            // فقط در اولین بار داده‌های پاسخ تجزیه شوند
                            if (i === 0) {
                                const text = await response.text();
                                const lines = text.trim().split('\n');
                                const data = {};
                                lines.forEach(line => {
                                    const [key, value] = line.split('=');
                                    if (key && value) data[key] = value;
                                });

                                resultData = {
                                    ip: ip,
                                    port: port,
                                    remark: remark,
                                    responseIP: data.ip || ip,
                                    colo: data.colo || '',
                                    avgTime: 0
                                };
                            }
                        } else {
                            // اگر اولین بار ناموفق بود، مستقیم null برگردان
                            if (i === 0) {
                                console.debug(`[انتخاب آنلاین] IP ${ip}:${port} تست ناموفق (HTTP ${response.status})`);
                                return null;
                            }
                        }
                    } catch (error) {
                        // درخواست ناموفق، اگر اولین بار بود null برگردان
                        if (i === 0) {
                            console.debug(`[انتخاب آنلاین] IP ${ip}:${port} تست ناموفق (${error.message})`);
                            return null;
                        }
                    }
                }

                // محاسبه میانگین زمان پاسخ
                if (resultData && times.length > 0) {
                    const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
                    resultData.avgTime = Math.round(avgTime);
                    console.debug(`[انتخاب آنلاین] IP ${ip}:${port} تست موفق - میانگین پاسخ: ${resultData.avgTime}ms, colo: ${resultData.colo}`);
                    return resultData;
                }

                return null;
            } catch (error) {
                return null;
            }
        }

        // IP به هگزادسیمال
        function ipToHex(ip) {
            return ip.split('.').map(num => {
                const hex = parseInt(num).toString(16);
                return hex.padStart(2, '0');
            }).join('');
        }

        // دسته‌بندی نتایج
        function classifyResults(results) {
            console.log('[انتخاب آنلاین] شروع: دسته‌بندی نتایج');
            optimizeResults = {};

            // تشخیص نوع کتابخانه IP
            // فقط وقتی از کتابخانه "لیست پروکسی معکوس" استفاده شود، یادداشت "پروکسی انتخاب" است، در غیر این صورت "انتخاب رسمی"
            const isReverseProxy = currentIPLibrary === 'reverse-proxy';
            const type = isReverseProxy ? 'پروکسی انتخاب' : 'انتخاب رسمی';
            console.log(`[انتخاب آنلاین] دیباگ: نوع کتابخانه IP=${currentIPLibrary}, نوع یادداشت=${type}`);

            for (const result of results) {
                if (!result.colo) continue;

                // پیدا کردن کد کشور از طریق colo
                const location = locationsData.find(loc => loc.iata === result.colo);
                const countryCode = location ? location.cca2 : result.colo;

                if (!optimizeResults[countryCode]) {
                    optimizeResults[countryCode] = [];
                }

                optimizeResults[countryCode].push({
                    ip: result.ip,
                    port: result.port,
                    remark: result.remark || countryCode,
                    type: type,
                    time: result.avgTime
                });
            }

            console.log(`[انتخاب آنلاین] نتیجه: دسته‌بندی به ${Object.keys(optimizeResults).length} کشور/منطقه`);

            // مرتب‌سازی نتایج هر کشور بر اساس زمان پاسخ
            for (const country in optimizeResults) {
                optimizeResults[country].sort((a, b) => a.time - b.time);
                console.log(`[انتخاب آنلاین] نتیجه: ${country}=${optimizeResults[country].length} IP`);
            }
        }

        // نمایش نتایج
        function displayResults() {
            console.log('[انتخاب آنلاین] پیشرفت: نمایش نتایج انتخاب');
            const tabsContainer = document.getElementById('optimizeResultsTabs');
            const contentContainer = document.getElementById('optimizeResultsContent');

            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';

            const countries = Object.keys(optimizeResults).sort();
            console.log(`[انتخاب آنلاین] نتیجه: کشورها/مناطق موجود=${countries.join(', ')}`);

            if (countries.length === 0) {
                console.warn('[انتخاب آنلاین] هشدار: هیچ IP قابل انتخاب یافت نشد');
                contentContainer.innerHTML = '<div style="text-align: center; color: #6b7280;">هیچ IP قابل انتخاب یافت نشد</div>';
                contentContainer.classList.remove('hidden-section');
                return;
            }

            // ایجاد تب‌ها - نمایش تعداد واقعی IP
            countries.forEach((country, index) => {
                const tab = document.createElement('div');
                tab.className = 'optimize-tab';
                if (index === 0) {
                    tab.classList.add('active');
                    currentSelectedCountry = country;
                }
                const actualCount = optimizeResults[country].length;
                tab.textContent = `${country} (${actualCount})`;
                tab.onclick = () => selectCountryTab(country);
                tabsContainer.appendChild(tab);
            });

            // نمایش نتایج اولین کشور
            showCountryResults(currentSelectedCountry);

            tabsContainer.classList.remove('hidden-section');
            contentContainer.classList.remove('hidden-section');

            // فعال کردن دکمه‌های ذخیره
            document.getElementById('btnSaveOverride').disabled = false;
            document.getElementById('btnSaveAppend').disabled = false;

            console.log('[انتخاب آنلاین] تکمیل: نمایش نتایج تکمیل شد');
        }

        // انتخاب تب کشور
        function selectCountryTab(country) {
            currentSelectedCountry = country;

            // بروزرسانی استایل تب‌ها
            const tabs = document.querySelectorAll('.optimize-tab');
            tabs.forEach(tab => {
                if (tab.textContent === country) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // نمایش نتایج کشور مربوطه
            showCountryResults(country);
        }

        // نمایش نتایج کشور
        function showCountryResults(country, showAll = false) {
            const contentContainer = document.getElementById('optimizeResultsContent');
            const results = optimizeResults[country] || [];

            if (results.length === 0) {
                contentContainer.innerHTML = '<div style="text-align: center; color: #6b7280;">داده‌ای موجود نیست</div>';
                return;
            }

            // پیش‌فرض فقط 16 مورد اول، با پارامتر showAll همه
            const displayCount = showAll ? results.length : Math.min(16, results.length);
            const displayResults = results.slice(0, displayCount);

            const html = displayResults.map(r => {
                // تعیین رنگ بر اساس زمان تاخیر
                let color = '#10b981'; // زیر 100ms سبز
                if (r.time > 100 && r.time <= 200) {
                    color = '#f59e0b'; // 101~200ms زرد
                } else if (r.time > 200) {
                    color = '#ef4444'; // بالای 201ms قرمز
                }

                return `<div class="optimize-result-item" style="color: ${color}; font-weight: bold;">${r.ip}:${r.port}#${r.remark} ${r.type} ${r.time}ms</div>`;
            }).join('');

            let finalHtml = html;

            // اگر نتایج بیشتر و باز نشده، دکمه بازشو اضافه کن
            if (!showAll && results.length > 16) {
                finalHtml += `<div style="margin-top: 15px; text-align: center;">
                    <button type="button" class="btn btn-secondary" onclick="showCountryResults('${country}', true)" style="padding: 8px 16px; font-size: 12px;">
                        📂 باز کردن همه IP (${results.length})
                    </button>
                </div>`;
            }

            contentContainer.innerHTML = finalHtml;
        }

        // ذخیره نتایج انتخاب
        async function saveOptimizeResults(mode) {
            console.log(`[انتخاب آنلاین] پیشرفت: ذخیره نتایج (حالت=${mode})`);

            if (!currentSelectedCountry || !optimizeResults[currentSelectedCountry]) {
                console.warn('[انتخاب آنلاین] کشوری انتخاب نشده یا داده نتایج موجود نیست');
                showToast('لطفاً ابتدا یک کشور را انتخاب کنید', 'error');
                return;
            }

            const allResults = optimizeResults[currentSelectedCountry];
            // فقط 16 مورد اول ذخیره شود
            const resultsToSave = allResults.slice(0, 16);
            // تغییر فرمت: شامل کشور، نوع و اطلاعات زمان
            const newContent = resultsToSave.map(r => `${r.ip}:${r.port}#${r.remark}|${r.type}|${r.time}ms`).join('\n');
            console.log(`[انتخاب آنلاین] موفق: ${currentSelectedCountry} ذخیره ${resultsToSave.length} IP (مجموع ${allResults.length})`);

            const textarea = document.getElementById('customIPs');

            if (mode === 'override') {
                textarea.value = newContent;
                console.log('[انتخاب آنلاین] موفق: ذخیره جایگزینی تکمیل شد');
                showToast('به آدرس سفارشی جایگزین شد (16 مورد اول)', 'success');
            } else if (mode === 'append') {
                const currentValue = textarea.value.trim();

                // حذف تکراری هنگام ذخیره الحاقی
                if (currentValue) {
                    // ترکیب محتوای موجود با محتوای جدید
                    const existingLines = currentValue.split('\n').map(line => line.trim()).filter(line => line);
                    const newLines = newContent.split('\n').map(line => line.trim()).filter(line => line);

                    // استفاده از Set برای حذف تکراری (بر اساس محتوای کامل خط)
                    const uniqueLinesSet = new Set(existingLines);
                    let addedCount = 0;

                    // اضافه کردن خطوط جدید،同时 شمارش تعداد واقعی اضافه شده
                    newLines.forEach(line => {
                        if (!uniqueLinesSet.has(line)) {
                            uniqueLinesSet.add(line);
                            addedCount++;
                        }
                    });

                    // ترکیب محتوای بدون تکرار
                    textarea.value = Array.from(uniqueLinesSet).join('\n');

                    console.log(`[انتخاب آنلاین] موفق: ذخیره الحاقی تکمیل شد، جدید=${addedCount} IP، تکراری=${newLines.length - addedCount}`);
                    if (addedCount === 0) {
                        showToast('همه IPها موجود هستند، محتوای جدیدی اضافه نشد', 'info');
                    } else if (addedCount < newLines.length) {
                        showToast(`${addedCount} IP جدید اضافه شد، ${newLines.length - addedCount} مورد تکراری فیلتر شد`, 'success');
                    } else {
                        showToast(`${addedCount} IP به آدرس سفارشی اضافه شد`, 'success');
                    }
                } else {
                    textarea.value = newContent;
                    console.log('[انتخاب آنلاین] موفق: ذخیره الحاقی تکمیل شد (محتوای قبلی خالی بود)');
                    showToast('به آدرس سفارشی اضافه شد (16 مورد اول)', 'success');
                }
            }

            // علامت‌گذاری به عنوان ویرایش شده
            markModified('sub');
        }

        // تابع ابزار: تصادفی کردن آرایه
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // مقداردهی اولیه
        initializeTheme();
        window.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            initUserMode();
            initLineEditor('customIPs');
            // پیش‌بارگذاری مستقل داده‌های SubConfig، بدون مسدود کردن فرآیند اصلی
            loadSubConfigData().catch(err => console.error('پیش‌بارگذاری SubConfig ناموفق:', err));
        });

        // شروع بروزرسانی شمارش معکوس
        setInterval(updateCountdown, 1000);
        updateCountdown(); // بلافاصله یکبار اجرا شود
		// ==================== توابع مربوط به اطلاعات شبکه ====================

        // تنظیم نشانگر وضعیت
        function setStatus(id, status) {
            const indicator = document.getElementById(id);
            if (indicator) {
                indicator.className = 'status-indicator status-' + status;
            }
        }

        // دریافت داده‌های تست داخلی (پیمایش چند API: speedtest.cn > ipipv.com > ipip.net)
        async function fetchIpipData() {
            setStatus('status-ipip', 'loading');

            // دریافت عنصر عنوان برای به‌روزرسانی پویای منبع API
            const titleElement = document.querySelector('#status-ipip').parentElement;

            // تعریف پیکربندی API ها به ترتیب اولویت
            const apiConfigs = [
                {
                    name: 'speedtest.cn',
                    url: 'https://api-v3.speedtest.cn/ip',
                    parser: (data) => {
                        if (data.code === 0 && data.data) {
                            return {
                                ip: data.data.ip || 'ناشناخته',
                                country: data.data.country || 'ناشناخته',
                                city: data.data.city || 'ناشناخته'
                            };
                        }
                        throw new Error('خطا در فرمت داده');
                    }
                },
                {
                    name: 'ipipv.com',
                    url: 'https://myip.ipipv.com/',
                    parser: (data) => {
                        return {
                            ip: data.Ip || 'ناشناخته',
                            country: data.Country || 'ناشناخته',
                            city: data.City || 'ناشناخته'
                        };
                    }
                },
                {
                    name: 'ipip.net',
                    url: 'https://myip.ipip.net/json',
                    parser: (data) => {
                        if (data.ret === 'ok' && data.data) {
                            return {
                                ip: data.data.ip || 'ناشناخته',
                                country: data.data.location[0] || 'ناشناخته',
                                city: data.data.location[2] || 'ناشناخته'
                            };
                        }
                        throw new Error('خطا در فرمت داده');
                    }
                }
            ];

            // پیمایش لیست پیکربندی API ها
            for (const config of apiConfigs) {
                try {
                    // افزودن پارامتر زمان برای اجتناب از کش
                    const timestamp = Date.now();
                    const url = config.url + (config.url.includes('?') ? '&' : '?') + `_t=${timestamp}`;
                    const response = await fetch(url);
                    const data = await response.json();

                    // استفاده از پارسر متناظر برای تجزیه داده
                    const result = config.parser(data);

                    // به‌روزرسانی نمایش صفحه
                    document.getElementById('ipip-ip').textContent = result.ip;
                    document.getElementById('ipip-country').textContent = result.country + ' ' + result.city;
                    setStatus('status-ipip', 'success');

                    // به‌روزرسانی نمایش عنوان با API فعلی
                    if (titleElement) {
                        titleElement.innerHTML = `<span class="status-indicator" id="status-ipip"></span><div class="title-text"><div class="title-main">تست داخلی</div><div class="title-subtitle">${config.name}</div></div>`;
                        setStatus('status-ipip', 'success'); // تنظیم مجدد وضعیت، زیرا innerHTML پاک می‌کند
                    }

                    console.log(`[API داخلی:${config.name}] موفق: IP=${result.ip}, موقعیت=${result.country} ${result.city}`);
                    return; // در صورت موفقیت برگشت، عدم تلاش برای API های دیگر

                } catch (error) {
                    console.warn(`${config.name} رابط شکست خورد:`, error);
                    // ادامه تلاش برای API بعدی
                }
            }

            // شکست همه API ها
            document.getElementById('ipip-ip').innerHTML = '<span class="error">بارگذاری ناموفق</span>';
            document.getElementById('ipip-country').textContent = '';
            document.getElementById('ipip-city').textContent = '';
            setStatus('status-ipip', 'error');
            console.error('همه API های تست داخلی شکست خوردند');
        }

        // دریافت داده‌های تست خارجی
        async function fetchOverseasTestData() {
            setStatus('status-overseas', 'loading');

            // پیکربندی API: URL + نگاشت فیلد
            const apis = [
                {
                    url: `https://api.cmliussss.net/api/ipinfo?_t=${Date.now()}`,
                    parse: d => ({ ip: d.ip, loc: `${d.country_code || 'ناشناخته'} ${d.asn || ''} ${d.as_name || ''}`.trim() })
                },
                {
                    url: `https://api.ipapi.is`,
                    parse: d => ({ ip: d.ip, loc: `${d.location?.country_code || 'ناشناخته'} AS${d.asn?.asn || ''} ${d.asn?.org || ''}`.trim() })
                }
            ];

            for (const api of apis) {
                try {
                    const response = await fetch(api.url);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const { ip, loc } = api.parse(await response.json());
                    const edgeIp = ip || 'ناشناخته';

                    document.getElementById('overseas-ip').textContent = edgeIp;
                    document.getElementById('overseas-country').textContent = loc || 'ناشناخته';
                    setStatus('status-overseas', 'success');
                    console.log(`[تست خارجی] موفق: IP=${edgeIp}, موقعیت=${loc}`);
                    return;
                } catch (error) {
                    console.log(`[تست خارجی] ${api.url} شکست: ${error.message}`);
                }
            }

            // شکست همه API ها
            document.getElementById('overseas-ip').innerHTML = '<span class="error">بارگذاری ناموفق</span>';
            document.getElementById('overseas-country').textContent = '';
            setStatus('status-overseas', 'error');
            console.error('تست خارجی همه API ها شکست خوردند');
        }

        // دریافت داده‌های CloudFlare
        async function fetchCloudFlareData() {
            setStatus('status-cf', 'loading');
            try {
                const timestamp = Date.now();
                const response = await fetch(`https://cf.090227.xyz/ip.json?_t=${timestamp}`);
                const data = await response.json();

                const cfIp = data.ip || 'ناشناخته';
                const cfLoc = ((data.country || '') + ' ' + (data.org || '')).trim() || 'ناشناخته';
                document.getElementById('cf-ip').textContent = cfIp;
                document.getElementById('cf-country').textContent = cfLoc;
                setStatus('status-cf', 'success');

                console.log(`[CloudFlare] موفق: IP=${cfIp}, موقعیت=${cfLoc}`);
            } catch (error) {
                document.getElementById('cf-ip').innerHTML = '<span class="error">بارگذاری ناموفق</span>';
                document.getElementById('cf-country').textContent = '';
                setStatus('status-cf', 'error');
                console.error('خطای رابط CloudFlare:', error);
            }
        }

        // دریافت داده‌های ورودی توییتر
        async function fetchTwitterData() {
            setStatus('status-twitter', 'loading');
            try {
                const timestamp = Date.now();
                const response = await fetch(`https://help.x.com/cdn-cgi/trace?_t=${timestamp}`);
                const text = await response.text();

                // تجزیه پاسخ متنی (فرمت key=value، هر خط یکی)
                const data = {};
                text.split('\n').forEach(line => {
                    const [key, value] = line.split('=');
                    if (key && value) {
                        data[key.trim()] = value.trim();
                    }
                });

                const twIp = data.ip || 'ناشناخته';
                const twLoc = ((data.loc || '') + ' ' + (data.colo || '')).trim() || 'ناشناخته';
                document.getElementById('twitter-ip').textContent = twIp;
                document.getElementById('twitter-country').textContent = twLoc;
                setStatus('status-twitter', 'success');

                console.log(`[Twitter] موفق: IP=${twIp}, موقعیت=${twLoc}`);
            } catch (error) {
                document.getElementById('twitter-ip').innerHTML = '<span class="error">شکست فیلترشکن</span>';
                document.getElementById('twitter-country').textContent = '';
                setStatus('status-twitter', 'error');
                console.error('خطای رابط توییتر:', error);
            }
        }

        // پرچم بارگذاری اطلاعات شبکه
        let networkInfoLoaded = false;

        // بارگذاری اطلاعات شبکه
        async function loadNetworkInfo() {
            // بررسی وجود کانتینر
            const container = document.querySelector('.network-cards-container');
            if (!container) return;

            // تنظیم پرچم بارگذاری
            networkInfoLoaded = true;

            // دریافت موازی همه اطلاعات شبکه
            await Promise.all([
                fetchIpipData(),
                fetchOverseasTestData(),
                fetchCloudFlareData(),
                fetchTwitterData()
            ]);

            // پس از بارگذاری همه اطلاعات شبکه، IP ها قابل کلیک شوند
            setTimeout(() => {
                makeIpClickable();
            }, 500);
        }

        // دریافت خودکار اطلاعات شبکه هنگام بارگذاری صفحه (چون ماژول اکنون به طور پیش‌فرض باز است)
        if (document.readyState !== 'loading') {
            // صفحه بارگذاری شده، داده‌ها را مستقیم بارگذاری کن
            loadNetworkInfo();
        } else {
            // صفحه هنوز در حال بارگذاری است، منتظر بمان
            document.addEventListener('DOMContentLoaded', () => {
                loadNetworkInfo();
            });
        }

        // قابلیت کلیک روی IP برای مشاهده جزئیات
        function makeIpClickable() {
            const ipElements = document.querySelectorAll('.ip-text');

            ipElements.forEach(element => {
                const ipText = element.textContent.trim();

                // رد کردن عناصری که قبلاً به عنوان خطا، در حال بارگذاری، ناشناخته علامت‌گذاری شده‌اند
                if (element.querySelector('.error') ||
                    ipText === 'در حال بارگذاری...' ||
                    ipText === 'ناشناخته' ||
                    element.classList.contains('clickable')) {
                    return;
                }

                // افزودن سبک قابل کلیک
                element.classList.add('clickable');

                element.addEventListener('click', function () {
                    let ipText = this.textContent.trim();

                    // رد کردن نمایش "در حال بارگذاری..." یا "ناشناخته"
                    if (ipText === 'در حال بارگذاری...' || ipText === 'ناشناخته') {
                        return;
                    }

                    fetchAndShowIpDetail(ipText, this);
                });
            });
        }

        // تبدیل مقادیر بولی به ایموجی
        function boolToEmoji(value, trueEmoji = '✅', falseEmoji = '❌') {
            return value ? trueEmoji : falseEmoji;
        }

        // تبدیل نوع IP به فارسی با افزودن سبک
        function formatIpType(type) {
            if (!type) return '<span class="ip-type-unknown">ناشناخته</span>';

            const typeMap = {
                'isp': { text: 'مسکونی', class: 'ip-type-residential' },
                'hosting': { text: 'دیتاسنتر', class: 'ip-type-hosting' },
                'business': { text: 'تجاری', class: 'ip-type-business' }
            };

            const typeInfo = typeMap[type.toLowerCase()] || { text: type, class: 'ip-type-unknown' };
            return `<span class="${typeInfo.class}">${typeInfo.text}</span>`;
        }

        // دریافت کلاس سبک سطح تهدید
        function getThreatBadgeClass(score) {
            if (!score) return 'badge-info';

            const numScore = parseFloat(score);
            if (numScore < 0.001) return 'badge-success';
            if (numScore < 0.01) return 'badge-info';
            if (numScore < 0.1) return 'badge-warning';
            return 'badge-danger';
        }

        // محاسبه نمره کلی سو استفاده
        function calculateAbuseScore(companyScore, asnScore, securityFlags = {}) {
            // اگر هر دو نمره نامعتبر باشند، null برگردان
            if (!companyScore || companyScore === 'ناشناخته') companyScore = 0;
            if (!asnScore || asnScore === 'ناشناخته') asnScore = 0;

            const company = parseFloat(companyScore) || 0;
            const asn = parseFloat(asnScore) || 0;

            // محاسبه نمره پایه: (company + asn) / 2 * 5
            let baseScore = ((company + asn) / 2) * 5;

            // محاسبه امتیاز اضافی ریسک امنیتی: هر مورد ریسک 15% اضافه می‌کند
            let riskAddition = 0;
            const riskFlags = [
                securityFlags.is_crawler,   // خزنده
                securityFlags.is_proxy,     // سرور پروکسی
                securityFlags.is_vpn,       // VPN
                securityFlags.is_tor,       // شبکه Tor
                securityFlags.is_abuser     // IP سو استفاده‌کننده
            ];

            // شمارش تعداد موارد ریسک true
            const riskCount = riskFlags.filter(flag => flag === true).length;
            riskAddition = riskCount * 0.15; // هر مورد ریسک 15% اضافه می‌کند

            // نمره نهایی = نمره پایه + امتیاز اضافی ریسک
            let finalScore = baseScore + riskAddition;

            // اگر IP جعلی (تور) باشد، مقدار ریسک 100% افزایش یابد
            if (securityFlags.is_bogon === true) {
                finalScore += 1.0; // افزایش 100%
            }

            // اگر نمره پایه و امتیاز اضافی ریسک هر دو 0 و IP جعلی نباشند، null برگردان
            if (baseScore === 0 && riskAddition === 0 && securityFlags.is_bogon !== true) return null;

            return finalScore;
        }

        // دریافت رنگ نمره سو استفاده
        function getAbuseScoreBadgeClass(percentage) {
            if (percentage === null || percentage === undefined) return 'badge-info';

            if (percentage >= 100) return 'badge-critical';      // قرمز خطرناک >= 100%
            if (percentage >= 20) return 'badge-high';           // نارنجی 15-99.99%
            if (percentage >= 5) return 'badge-elevated';     // زرد 5-14.99%
            if (percentage >= 0.25) return 'badge-low';       // سبز روشن 0.25-4.99%
            return 'badge-verylow';                              // سبز < 0.25%
        }

        // فرمت کردن نمره سو استفاده به درصد
        function formatAbuseScorePercentage(score) {
            if (score === null || score === undefined) return 'ناشناخته';

            const percentage = score * 100;
            return percentage.toFixed(2) + '%';
        }

        // تغییر راهنمای ابزار الگوریتم امتیازدهی
        function toggleScoreTooltip(helpIcon) {
            const tooltip = helpIcon.nextElementSibling;
            const isShowing = tooltip.classList.contains('show');

            // مخفی کردن همه ابزارهای دیگر
            document.querySelectorAll('.score-tooltip.show').forEach(t => {
                if (t !== tooltip) t.classList.remove('show');
            });

            // تغییر ابزارک فعلی
            tooltip.classList.toggle('show');

            // اگر ابزارک نمایش داده شود، موقعیت را تنظیم کنید و شنونده رویداد کلیک برای بستن آن اضافه کنید
            if (!isShowing) {
                setTimeout(() => {
                    positionTooltipNearMouse(tooltip, helpIcon);

                    const closeTooltip = (e) => {
                        if (!tooltip.contains(e.target) && !helpIcon.contains(e.target)) {
                            tooltip.classList.remove('show');
                            document.removeEventListener('click', closeTooltip);
                        }
                    };
                    document.addEventListener('click', closeTooltip);
                }, 100);
            }
        }

        // تنظیم موقعیت ابزارک نزدیک ماوس
        function positionTooltipNearMouse(tooltip, helpIcon) {
            const iconRect = helpIcon.getBoundingClientRect();
            const tooltipWidth = tooltip.offsetWidth;
            const tooltipHeight = tooltip.offsetHeight;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const padding = 10;

            let left = iconRect.right + padding;
            let top = iconRect.top - tooltipHeight / 2;

            // اگر ابزارک از مرز راست فراتر رود، در سمت چپ نمایش داده شود
            if (left + tooltipWidth > windowWidth - padding) {
                left = iconRect.left - tooltipWidth - padding;
            }

            // اگر ابزارک از بالا فراتر رود، به پایین تنظیم شود
            if (top < padding) {
                top = iconRect.top + padding;
            }

            // اگر ابزارک از پایین فراتر رود، به بالا تنظیم شود
            if (top + tooltipHeight > windowHeight - padding) {
                top = windowHeight - tooltipHeight - padding;
            }

            tooltip.style.position = 'fixed';
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        // نمایش پنجره جزئیات IP
        function showIpDetailModal(data) {
            // ابتدا پنجره قدیمی را حذف کن (در صورت وجود)
            const existingModal = document.querySelector('.ip-detail-modal');
            if (existingModal) existingModal.remove();

            // ایجاد پنجره
            const modal = document.createElement('div');
            modal.className = 'ip-detail-modal';

            // محاسبه امتیاز و سطح
            const companyScore = data.company?.abuser_score;
            const asnScore = data.asn?.abuser_score;
            const securityFlags = {
                is_crawler: data.is_crawler,
                is_proxy: data.is_proxy,
                is_vpn: data.is_vpn,
                is_tor: data.is_tor,
                is_abuser: data.is_abuser,
                is_bogon: data.is_bogon
            };

            const combinedScore = calculateAbuseScore(companyScore, asnScore, securityFlags);
            let riskControlHTML = 'ناشناخته';
            let riskLevel = 'ناشناخته';
            let badgeClass = 'badge-info';

            if (combinedScore !== null) {
                const scorePercentage = combinedScore * 100;
                badgeClass = getAbuseScoreBadgeClass(scorePercentage);
                const formattedScore = formatAbuseScorePercentage(combinedScore);

                if (scorePercentage >= 100) riskLevel = 'بسیار خطرناک';
                else if (scorePercentage >= 20) riskLevel = 'ریسک بالا';
                else if (scorePercentage >= 5) riskLevel = 'ریسک جزئی';
                else if (scorePercentage >= 0.25) riskLevel = 'تمیز';
                else riskLevel = 'بسیار تمیز';

                riskControlHTML = `<span class="ip-detail-badge ${badgeClass}">${formattedScore} ${riskLevel}</span>`;
            }
			
            // ساخت ساختار HTML
            modal.innerHTML = `
                <div class="ip-detail-content">
                    <div class="ip-detail-header">
                        <h2 class="ip-detail-title">
                            🔍 جزئیات IP
                            <span class="ip-detail-source-tag">منبع داده: ipapi.is</span>
                        </h2>
                        <button class="ip-detail-close" title="بستن">&times;</button>
                    </div>
                    <div class="ip-detail-body">
                        <!-- نمایش نقشه -->
                        <div class="ip-detail-map-container">
                            <div id="ip-detail-map"></div>
                        </div>

                        <!-- منطقه شبکه داده -->
                        <div class="ip-detail-grid-container">
                            <!-- ستون چپ: اطلاعات پایه (ترکیب جغرافیایی و اطلاعات ISP) -->
                            <div class="ip-detail-left-col">
                                <div class="ip-detail-card" style="height: 100%;">
                                    <div class="ip-detail-section-title">📍 اطلاعات پایه</div>
                                    <div class="ip-detail-item" title="آدرس IP عمومی فعلی که برای شناسایی منحصر به فرد دستگاه در اینترنت استفاده می‌شود">
                                        <span class="ip-detail-label">آدرس IP</span>
                                        <span class="ip-detail-value">${data.ip || 'ناشناخته'}</span>
                                    </div>
                                    <div class="ip-detail-item" title="مکان فیزیکی آدرس IP که از پایگاه داده تخصیص محدوده IP محاسبه می‌شود، شامل کشور/منطقه، استان و شهر">
                                        <span class="ip-detail-label">موقعیت جغرافیایی</span>
                                        <span class="ip-detail-value">${data.location?.country_code ? `[${data.location.country_code}]` : ''}${data.location?.country || ''} ${[data.location?.state, data.location?.city].filter(Boolean).join('/') || 'ناشناخته'}</span>
                                    </div>
                                    <div class="ip-detail-item" title="منطقه زمانی استاندارد منطقه‌ای که این IP در آن قرار دارد، به فرمت قاره/شهر مانند Asia/Tehran">
                                        <span class="ip-detail-label">منطقه زمانی</span>
                                        <span class="ip-detail-value">${data.location?.timezone || 'ناشناخته'}</span>
                                    </div>
                                    <div class="ip-detail-item" title="نوع شبکه IP:【مسکونی】اینترنت خانگی،【دیتاسنتر】مرکز داده یا سرور ابری،【تجاری】خط اختصاصی. سمت چپ طبقه‌بندی ISP، سمت راست طبقه‌بندی ASN">
                                        <span class="ip-detail-label">نوع ISP / ASN</span>
                                        <span class="ip-detail-value">${formatIpType(data.company?.type)} / ${formatIpType(data.asn?.type)}</span>
                                    </div>
                                    <div class="ip-detail-item" title="امتیاز کلی سو استفاده، بر اساس سوابق تاریخی ISP/ASN و موارد ریسک امنیتی محاسبه می‌شود. هرچه امتیاز کمتر باشد IP تمیزتر است، هرچه بیشتر باشد احتمال سو استفاده بیشتر است">
                                        <span class="ip-detail-label">سطح ریسک</span>
                                        <span class="ip-detail-value">${riskControlHTML}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- ستون راست: تشخیص امنیتی -->
                            <div class="ip-detail-right-col">
                                <!-- محتوای تشخیص امنیتی بدون تغییر می‌ماند -->
                                <div class="ip-detail-card" style="height: 100%;">
                                    <div class="ip-detail-section-title">🛡️ تشخیص امنیتی</div>
                                    <div class="ip-detail-security-grid">
                                        <div class="ip-detail-item" title="آیا این IP متعلق به مرکز داده (IDC)، ارائه‌دهنده خدمات ابری یا خدمات میزبانی است. IP های مرکز داده اغلب برای استقرار سرور استفاده می‌شوند، برخی سایت‌ها ممکن است دسترسی این نوع IP را محدود کنند">
                                            <span class="ip-detail-label">مرکز داده</span>
                                            <span class="ip-detail-value">${data.is_datacenter ? '<span class="warning-text">🏢 بله</span>' : '✅ خیر'}</span>
                                        </div>
                                        <div class="ip-detail-item" title="آیا این IP به عنوان سرور پروکسی عمومی شناسایی شده است (مانند پروکسی HTTP/SOCKS). پروکسی‌ها ممکن است برای مخفی کردن IP واقعی استفاده شوند، برخی سرویس‌ها دسترسی پروکسی را محدود می‌کنند">
                                            <span class="ip-detail-label">سرور پروکسی</span>
                                            <span class="ip-detail-value">${data.is_proxy ? '<span class="danger-text">⚠️ بله</span>' : '✅ خیر'}</span>
                                        </div>
                                        <div class="ip-detail-item" title="آیا این IP متعلق به ارائه‌دهنده سرویس VPN (شبکه خصوصی مجازی) شناخته شده است. VPN برای رمزنگاری ترافیک شبکه و مخفی کردن موقعیت واقعی استفاده می‌شود، برخی سایت‌ها دسترسی VPN را محدود می‌کنند">
                                            <span class="ip-detail-label">اتصال VPN</span>
                                            <span class="ip-detail-value">${data.is_vpn ? '<span class="danger-text">⚠️ بله</span>' : '✅ خیر'}</span>
                                        </div>
                                        <div class="ip-detail-item" title="آیا این IP متعلق به گره خروجی شبکه Tor (مسیریابی پیاز) است. Tor anonymity بالایی را فراهم می‌کند، اما اغلب برای فعالیت‌های غیرقانونی استفاده می‌شود، بنابراین اکثر سایت‌ها دسترسی Tor را محدود یا مسدود می‌کنند">
                                            <span class="ip-detail-label">شبکه Tor</span>
                                            <span class="ip-detail-value">${data.is_tor ? '<span class="danger-text">⚠️ بله</span>' : '✅ خیر'}</span>
                                        </div>
                                        <div class="ip-detail-item" title="آیا این IP به عنوان خزنده شبکه (عنکبوت‌های موتور جستجو، ربات‌های جمع‌آوری داده و غیره) شناسایی شده است. خزنده‌ها ممکن بار اضافی بر سایت‌ها ایجاد کنند، برخی سایت‌ها ترافیک خزنده را محدود یا به طور خاصی مدیریت می‌کنند">
                                            <span class="ip-detail-label">خزنده شبکه</span>
                                            <span class="ip-detail-value">${data.is_crawler ? '<span class="danger-text">🤖 بله</span>' : '✅ خیر'}</span>
                                        </div>
                                        <div class="ip-detail-item" title="آیا این IP از اپراتور شبکه موبایل (مانند شبکه 4G/5G) است. IP های شبکه موبایل معمولاً به صورت پویا تخصیص داده می‌شوند و تغییر می‌کنند، متعلق به IP های مسکونی هستند">
                                            <span class="ip-detail-label">شبکه موبایل</span>
                                            <span class="ip-detail-value">${data.is_mobile ? '<span class="success-text">📱 بله</span>' : 'خیر'}</span>
                                        </div>
                                        <div class="ip-detail-item" title="آیا این IP از خدمات اینترنت ماهواره‌ای (مانند Starlink، OneWeb و غیره) است. شبکه‌های ماهواره‌ای معمولاً برای دسترسی به اینترنت در مناطق دورافتاده یا سناریوهای متحرک استفاده می‌شوند، تاخیر بالاتری دارند">
                                            <span class="ip-detail-label">شبکه ماهواره‌ای</span>
                                            <span class="ip-detail-value">${data.is_satellite ? '<span class="success-text">🛰️ بله</span>' : 'خیر'}</span>
                                        </div>
                                        <div class="ip-detail-item" title="آیا این IP دارای سابقه سو استفاده شناخته شده است (مانند هرزنامه، حملات DDoS، اسکن مخرب و غیره). IP های سو استفاده شده معمولاً توسط سیستم‌های امنیتی مسدود یا محدود می‌شوند">
                                            <span class="ip-detail-label">سو استفاده شناخته شده</span></span>
                                            <span class="ip-detail-value">${data.is_abuser ? '<span class="danger-text">⚠️ بله</span>' : '✅ خیر'}</span>
                                        </div>
                                        <div class="ip-detail-item" title="آیا این IP یک IP جعلی (Bogon IP) است، یعنی آدرس رزرو شده، آدرس خصوصی یا محدوده تخصیص نداده شده. چنین IP هایی نباید در اینترنت عمومی ظاهر شوند، ممکن است نشان‌دهنده ترافیک غیرعادی یا تور (دام) باشند">
                                            <span class="ip-detail-label">IP جعلی</span>
                                            <span class="ip-detail-value">${data.is_bogon ? '<span class="danger-text">⚠️ بله</span>' : '✅ خیر'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // مقداردهی اولیه نقشه در پنجره
            if (data.location?.latitude && data.location?.longitude) {
                const lat = parseFloat(data.location.latitude);
                const lng = parseFloat(data.location.longitude);

                // کمی زمان برای رندر DOM بدهید
                setTimeout(() => {
                    const detailMap = L.map('ip-detail-map', {
                        zoomControl: false,
                        attributionControl: false
                    }).setView([lat + 5, lng], 4); // مرکز را به بالا منتقل کنید تا نشانگر در پایین دید باشد

                    L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
                        subdomains: '1234',
                        minZoom: 1,
                        maxZoom: 18
                    }).addTo(detailMap);

                    const popupHTML = `
                        <div class="ip-detail-popup-content">
                            <div class="ip-detail-popup-city">
                                ${data.location?.city || data.location?.country || 'موقعیت'}
                            </div>
                            <div class="ip-detail-popup-item">
                                <span class="ip-detail-popup-label">کشور:</span>
                                <span class="ip-detail-popup-value">[${data.location?.country_code || '-'}]${data.location?.country || 'ناشناخته'}</span>
                            </div>
                            <div class="ip-detail-popup-item">
                                <span class="ip-detail-popup-label">IP محلی:</span>
                                <span class="ip-detail-popup-value">${data.ip}</span>
                            </div>
                            <div class="ip-detail-popup-item">
                                <span class="ip-detail-popup-label">ASN:</span>
                                <span class="ip-detail-popup-value">${data.asn?.asn || ''}</span>
                            </div>
                            <div class="ip-detail-popup-item">
                                <span class="ip-detail-popup-label">ارائه‌دهنده:</span>
                                <span class="ip-detail-popup-value">${data.company?.name || 'ناشناخته'}</span>
                            </div>
                        </div>
                    `;

                    L.marker([lat, lng])
                        .addTo(detailMap)
                        .bindPopup(popupHTML, { closeButton: false, offset: [0, -32] })
                        .openPopup();

                    // گاهی اوقات طرح نقشه مشکل دارد، اجبار به تازه‌سازی
                    detailMap.invalidateSize();
                }, 400);
            } else {
                // اگر مختصات نیست، کانتینر نقشه را مخفی کن
                const mapContainer = modal.querySelector('.ip-detail-map-container');
                if (mapContainer) mapContainer.style.display = 'none';
            }

            // منطق بستن
            const closeBtn = modal.querySelector('.ip-detail-close');
            const closeFunc = () => {
                modal.style.opacity = '0';
                modal.querySelector('.ip-detail-content').style.transform = 'translateY(20px)';
                setTimeout(() => modal.remove(), 300);
            };

            closeBtn.onclick = closeFunc;
            modal.onclick = (e) => { if (e.target === modal) closeFunc(); };

            // بستن با کلید ESC
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    closeFunc();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }
		// ==================== توابع مرتبط با دریافت بیشتر PROXYIP ====================

        function showGetMoreProxyIPModal() {
            showExploreProxyModal('proxyip');
            // تنظیم مجدد موارد انتخاب شده
            selectedProxyIPs = [];
            updateSelectedProxyIPsUI();
        }

        function closeGetMoreProxyIPModal(event) {
            closeExploreProxyModal('proxyip', event);
        }

        function onProxyIPDataRegionChange() {
            onProxyRegionChange('proxyip');
        }

        async function verifySingleProxyIP(proxy, signal) {
            const config = proxyConfigs['proxyip'];
            const proxyIp = proxy.proxy; // فرمت: ip

            if (signal && signal.aborted) return;

            // تنظیم تایم اوت 15 ثانیه‌ای
            const timeoutId = setTimeout(() => {
                window[config.verificationStatus][proxyIp] = {
                    status: 'timeout',
                    responseTime: null
                };
                updateProxyDisplay('proxyip');
            }, 10000);

            window[config.verificationTimeouts][proxyIp] = timeoutId;

            try {
                const response = await fetch(`https://check-proxyip-api.cmliussss.net/check?proxyip=${proxyIp}`, { signal });
                clearTimeout(window[config.verificationTimeouts][proxyIp]);

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.type === 'ProxyIP') {
                        window[config.verificationStatus][proxyIp] = {
                            status: 'success',
                            responseTime: data.responseTime
                        };
                    } else {
                        window[config.verificationStatus][proxyIp] = {
                            status: 'failed',
                            responseTime: null
                        };
                    }
                } else {
                    window[config.verificationStatus][proxyIp] = {
                        status: 'failed',
                        responseTime: null
                    };
                }
            } catch (error) {
                if (signal && signal.aborted) return;
                window[config.verificationStatus][proxyIp] = {
                    status: 'failed',
                    responseTime: null
                };
            }
            updateProxyDisplay('proxyip');
        }

        function addSelectedProxyIP() {
            const select = document.getElementById('proxyIPProxySelect');
            const ip = select.value;
            if (!ip) return;

            if (selectedProxyIPs.length >= 8) {
                showToast('حداکثر می‌توان 8 ProxyIP انتخاب کرد', 'warning');
                return;
            }

            if (selectedProxyIPs.includes(ip)) {
                showToast('این IP قبلاً در لیست انتخاب شده است', 'warning');
                return;
            }

            selectedProxyIPs.push(ip);
            updateSelectedProxyIPsUI();
            updateProxyIPConfirmButton();
        }

        function removeSelectedProxyIP(ip) {
            selectedProxyIPs = selectedProxyIPs.filter(item => item !== ip);
            updateSelectedProxyIPsUI();
            updateProxyIPConfirmButton();
        }

        function updateSelectedProxyIPsUI() {
            const container = document.getElementById('selectedProxyIPsContainer');
            container.innerHTML = '';

            selectedProxyIPs.forEach(ip => {
                // یافتن ایموجی کشور مربوطه
                const dataList = window.proxyIPListData || [];
                const proxyData = dataList.find(p => p.ip === ip);
                const emoji = proxyData?.country_emoji || '🌐';

                // ساخت اطلاعات title
                let titleText = '';
                if (proxyData) {
                    const city = proxyData.city || 'ناشناخته';
                    const country = proxyData.country || 'ناشناخته';
                    const countryName = proxyData.country_cn || 'ناشناخته';
                    const clientIp = proxyData.clientIp || ip;
                    const asn = proxyData.asn || 'ناشناخته';
                    const asOrganization = proxyData.asOrganization || 'ناشناخته';

                    titleText = `${city}\nکشور: [${country}]${countryName}\nIP محلی: ${clientIp}\nASN: ${asn}\nارائه‌دهنده: ${asOrganization}`;
                }

                const tag = document.createElement('div');
                tag.style.cssText = 'background: #fee2e2; border: 1px solid #ef4444; color: #b91c1c; padding: 4px 10px; border-radius: 9999px; display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 500;';
                if (titleText) {
                    tag.title = titleText;
                }
                tag.innerHTML = `
                    <span>${emoji} ${ip}</span>
                    <span onclick="removeSelectedProxyIP('${ip}')" style="cursor: pointer; font-weight: bold; font-size: 16px;">×</span>
                `;
                container.appendChild(tag);
            });
        }

        function updateProxyIPConfirmButton() {
            const btn = document.getElementById('proxyIPConfirmBtn');
            btn.disabled = selectedProxyIPs.length === 0;
        }

        function confirmSelectProxyIP() {
            const input = document.getElementById('proxyIP');
            if (input) {
                input.value = selectedProxyIPs.join(',');
                input.dispatchEvent(new Event('change', { bubbles: true }));
                markModified('proxy');
            }

            closeGetMoreProxyIPModal();

            // اگر دریافت خودکار انتخاب شده، تیک آن را بردارید
            const autoProxyCheck = document.getElementById('autoProxy');
            if (autoProxyCheck && autoProxyCheck.checked) {
                autoProxyCheck.checked = false;
                if (typeof toggleAutoProxy === 'function') toggleAutoProxy();
            }

            const config = proxyConfigs['proxyip'];
            if (config.abortController) {
                config.abortController.abort();
                config.abortController = null;
            }

            // روشن کردن دکمه‌های ذخیره و لغو
            const saveBtn = document.getElementById('saveProxyBtn');
            const cancelBtn = document.getElementById('cancelProxyBtn');
            if (saveBtn) saveBtn.disabled = false;
            if (cancelBtn) cancelBtn.disabled = false;
        }
		// ==================== توابع مرتبط با SOCKS5 ====================

        // پیکربندی نوع پروکسی
        const proxyConfigs = {
            socks5: {
                modalId: 'exploreSocks5Modal',
                regionSelectId: 'socks5RegionSelect',
                proxySelectId: 'socks5ProxySelect',
                proxySelectGroupId: 'socks5ProxySelectGroup',
                confirmBtnId: 'socks5ConfirmBtn',
                listData: 'socks5ListData',
                countryMap: 'socks5CountryMap',
                verificationStatus: 'socks5VerificationStatus',
                verificationTimeouts: 'socks5VerificationTimeouts',
                url: 'https://raw.githubusercontent.com/EDT-Pages/Proxy-List/main/data/socks5.json',
                description: 'لیست SOCKS5',
                inputId: 'socks5Addr',
                abortController: null,
                verifySingleFunction: (proxy, signal) => verifySingleProxy(proxy, 'socks5', signal)
            },
            http: {
                modalId: 'exploreHTTPModal',
                regionSelectId: 'httpRegionSelect',
                proxySelectId: 'httpProxySelect',
                proxySelectGroupId: 'httpProxySelectGroup',
                confirmBtnId: 'httpConfirmBtn',
                listData: 'httpListData',
                countryMap: 'httpCountryMap',
                verificationStatus: 'httpVerificationStatus',
                verificationTimeouts: 'httpVerificationTimeouts',
                url: 'https://raw.githubusercontent.com/EDT-Pages/Proxy-List/main/data/http.json',
                description: 'لیست HTTP',
                inputId: 'httpAddr',
                abortController: null,
                verifySingleFunction: (proxy, signal) => verifySingleProxy(proxy, 'http', signal)
            },
            proxyip: {
                modalId: 'getMoreProxyIPModal',
                regionSelectId: 'proxyIPDataRegionSelect',
                proxySelectId: 'proxyIPProxySelect',
                proxySelectGroupId: 'proxyIPProxySelectGroup',
                confirmBtnId: 'proxyIPConfirmBtn',
                listData: 'proxyIPListData',
                countryMap: 'proxyIPCountryMap',
                verificationStatus: 'proxyIPVerificationStatus',
                verificationTimeouts: 'proxyIPVerificationTimeouts',
                url: 'https://zip.cm.edu.kg/all.json',
                description: 'لیست ProxyIP',
                inputId: 'proxyIP',
                abortController: null,
                verifySingleFunction: (proxy, signal) => verifySingleProxyIP(proxy, signal)
            }
        };

        // ذخیره داده‌های SOCKS5
        let socks5ListData = [];
        let socks5CountryMap = {};
        let socks5VerificationStatus = {}; // ذخیره وضعیت تایید
        let socks5VerificationTimeouts = {}; // ذخیره تایمر تایم اوت

        // ذخیره داده‌های ProxyIP
        let proxyIPListData = [];
        let proxyIPCountryMap = {};
        let proxyIPVerificationStatus = {};
        let proxyIPVerificationTimeouts = {};
        let selectedProxyIPs = []; // ذخیره ProxyIP های انتخاب شده توسط کاربر

        function showExploreSocks5Modal() {
            showExploreProxyModal('socks5');
        }

        function closeExploreSocks5Modal(event) {
            closeExploreProxyModal('socks5', event);
        }

        function loadSocks5List() {
            loadProxyList('socks5');
        }

        function buildCountryMap(listData, countryMap) {
            countryMap = {};

            // شمارش تعداد پروکسی در هر کشور
            listData.forEach(item => {
                const country = item.country;
                if (!countryMap[country]) {
                    countryMap[country] = [];
                }
                countryMap[country].push(item);
            });

            // مرتب‌سازی بر اساس تعداد (زیاد به کم)
            countryMap = Object.fromEntries(
                Object.entries(countryMap).sort((a, b) => b[1].length - a[1].length)
            );

            return countryMap;
        }

        function populateSocks5RegionSelect() {
            populateProxyRegionSelect('socks5');
        }

        function onSocks5RegionChange() {
            onProxyRegionChange('socks5');
        }

        function populateSocks5ProxySelect(selectedCountry) {
            populateProxySelect(selectedCountry, 'socks5ProxySelect', socks5CountryMap, socks5VerificationStatus, 'socks5');
        }

        function verifySocks5Proxies(proxies) {
            verifyProxies(proxies, verifySingleSocks5);
        }

        function verifySingleSocks5(proxy, signal) {
            return verifySingleProxy(proxy, 'socks5', signal);
        }

        function updateSocks5Display() {
            updateProxyDisplay('socks5');
        }

        function confirmSelectSocks5() {
            confirmSelectProxy('socks5');
        }

        function updateSocks5ConfirmButton() {
            updateProxyConfirmButton('socks5');
        }

        // تابع پر کردن انتخابگر پروکسی عمومی
        function populateProxySelect(selectedCountry, selectId, countryMap, verificationStatus, type) {
            const select = document.getElementById(selectId);
            const proxies = countryMap[selectedCountry] || [];

            // ذخیره مقدار فعلی انتخاب شده
            const currentValue = select.value;

            // بررسی اینکه آیا همه پروکسی‌ها تایید شده‌اند
            const allVerified = proxies.every(p => {
                const status = verificationStatus[p.proxy];
                return status && status.status !== 'pending';
            });

            // دریافت همه پروکسی‌های منطقه فعلی، و مرتب‌سازی بر اساس وضعیت و تاخیر
            const sortedProxies = [...proxies].sort((a, b) => {
                const statusA = verificationStatus[a.proxy] || { status: 'pending' };
                const statusB = verificationStatus[b.proxy] || { status: 'pending' };

                // موارد موجود در اول، و مرتب‌سازی بر اساس تاخیر از کم به زیاد
                if (statusA.status === 'success' && statusB.status === 'success') {
                    return (statusA.responseTime || 0) - (statusB.responseTime || 0);
                }
                if (statusA.status === 'success') return -1;
                if (statusB.status === 'success') return 1;

                return 0;
            });

            // بررسی اینکه آیا پروکسی موفق وجود دارد
            const successfulProxies = sortedProxies.filter(proxy => verificationStatus[proxy.proxy]?.status === 'success');

            // تابع کمکی: تولید HTML گزینه پروکسی
            function generateProxyOption(proxy, isSelectable = false) {
                const status = verificationStatus[proxy.proxy] || { status: 'pending' };
                let emoji = '⏳';
                let statusText = 'در حال تایید';

                if (status.status === 'success') {
                    emoji = '✅';
                    statusText = `${status.responseTime}ms`;
                } else if (status.status === 'timeout') {
                    emoji = '🔴';
                    statusText = 'منقضی شده';
                } else if (status.status === 'failed') {
                    emoji = '🔴';
                    statusText = 'غیرقابل استفاده';
                }

                // در حالت ProxyIP برچسب کمی متفاوت است، شامل پیشوند پروتکل نیست
                const label = type === 'proxyip'
                    ? `${emoji}[${statusText}]${proxy.ip}${proxy.city ? ` - ${proxy.city}` : ''},AS${proxy.asn}`
                    : `${emoji}[${statusText}]${proxy.city},AS${proxy.asn},${proxy.asOrganization}`;

                const disabled = !isSelectable || status.status !== 'success';
                // ProxyIP نیاز به انتخاب پیش‌فرض ندارد، چون چندانفعلي触发 است
                const selected = type !== 'proxyip' && isSelectable && status.status === 'success' && successfulProxies.indexOf(proxy) === 0 ? 'selected' : '';
                return `<option value="${proxy.proxy}" ${disabled ? 'disabled' : ''} ${selected}>${label}</option>`;
            }

            let html = type === 'proxyip' ? '<option value="">-- لطفا پروکسی را انتخاب کنید --</option>' : '';
            if (successfulProxies.length > 0) {
                // پروکسی موفق وجود دارد، نمایش همه پروکسی‌ها
                sortedProxies.forEach(proxy => {
                    html += generateProxyOption(proxy, true);
                });
            } else if (allVerified) {
                // تایید تکمیل شده اما پروکسی موفق وجود ندارد
                html = '<option value="">متأسفانه پروکسی موجود در منطقه فعلی نیست، لطفا منطقه دیگری را انتخاب کنید.</option>';
            } else {
                // در حال تایید، نمایش لیست پروکسی‌ها
                html = (type === 'proxyip' ? '<option value="">در حال تایید در دسترس بودن، لطفا صبر کنید...</option>' : '<option value="">در حال تایید در دسترس بودن، لطفا صبر کنید...</option>');
                sortedProxies.forEach(proxy => {
                    html += generateProxyOption(proxy, false);
                });
            }

            select.innerHTML = html;

            // بازگرداندن انتخاب کاربر (در حالت ProxyIP اگر انتخاب فعلی هنوز معتبر باشد، بازگردانید)
            if (successfulProxies.length > 0) {
                if (currentValue && successfulProxies.some(p => p.proxy === currentValue)) {
                    select.value = currentValue;
                } else if (type !== 'proxyip') {
                    select.value = successfulProxies[0].proxy;
                }
            }
        }

        // تابع تایید پروکسی عمومی
        // الگوریتم Fisher-Yates - تصادفی کردن آرایه
        function shuffleArray(array) {
            const shuffled = [...array]; // ایجاد کپی، تغییر آرایه اصلی نیست
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                // جابجایی عناصر
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function verifyProxies(proxies, verifySingleFunction, onProgress, signal) {
            // تصادفی کردن لیست پروکسی برای جلوگیری از شروع همزمان همه کاربران از ابتدا
            const shuffledProxies = shuffleArray(proxies);

            // کنترل همزمانی: حداکثر 8 درخواست همزمان
            const maxConcurrent = 8;
            let currentIndex = 0;
            let activeRequests = 0;

            function startNextProxy() {
                if (signal && signal.aborted) return;
                if (currentIndex >= shuffledProxies.length || activeRequests >= maxConcurrent) {
                    return;
                }

                activeRequests++;
                const proxy = shuffledProxies[currentIndex++];

                verifySingleFunction(proxy, signal).finally(() => {
                    activeRequests--;
                    if (onProgress) onProgress();
                    startNextProxy();
                });
            }

            // شروع 8 درخواست اولیه
            for (let i = 0; i < Math.min(maxConcurrent, shuffledProxies.length); i++) {
                startNextProxy();
            }
        }

        // تابع کاوش پروکسی عمومی
        function showExploreProxyModal(type) {
            const config = proxyConfigs[type];
            const modal = document.getElementById(config.modalId);
            if (!modal) return;

            // تنظیم مجدد وضعیت
            window[config.listData] = [];
            window[config.countryMap] = {};
            window[config.verificationStatus] = {};
            window[config.verificationTimeouts] = {};
            lastMappedProxy[type] = null;

            modal.classList.add('show');
            document.getElementById(config.regionSelectId).innerHTML = '<option value="">در حال بارگذاری...</option>';
            document.getElementById(config.proxySelectGroupId).style.display = 'block';
            document.getElementById(config.confirmBtnId).disabled = true;

            // مقداردهی اولیه شنونده‌های focus/blur جعبه انتخاب (اولین بار مؤثر است)
            ensureProxySelectListeners(type);
            // تنظیم مجدد وضعیت throttling
            resetProxyDisplayUpdateState(type);

            // بارگذاری لیست
            loadProxyList(type);

            // مقداردهی اولیه یا به‌روزرسانی کانتینر نقشه
            setTimeout(() => {
                initProxyMap(type);
            }, 300);
        }

        const lastMappedProxy = {
            socks5: null,
            http: null,
            proxyip: null
        };

        const proxyMaps = {
            socks5: { map: null, marker: null },
            http: { map: null, marker: null },
            proxyip: { map: null, marker: null }
        };

        function initProxyMap(type) {
            const containerId = type === 'socks5' ? 'proxy-map-socks5' : (type === 'http' ? 'proxy-map-http' : 'proxy-map-proxyip');
            const container = document.getElementById(containerId);
            if (!container) return;

            // اگر نقشه از قبل وجود دارد، ابتدا طرح‌بندی را تازه‌سازی کنید
            if (proxyMaps[type] && proxyMaps[type].map) {
                proxyMaps[type].map.invalidateSize();
                return;
            }

            if (!proxyMaps[type]) proxyMaps[type] = { map: null, marker: null };

            // ایجاد نقشه
            const map = L.map(containerId, {
                zoomControl: false, // مخفی کردن کنترل زوم، برای تمیزتر شدن رابط
                attributionControl: false
            }).setView([22.2783, 114.1747], 4);

            L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
                subdomains: '1234',
                minZoom: 1,
                maxZoom: 18
            }).addTo(map);

            proxyMaps[type].map = map;
        }

        function updateProxyMap(type) {
            const config = proxyConfigs[type];
            const select = document.getElementById(config.proxySelectId);
            const selectedProxyUrl = select.value;
            if (!selectedProxyUrl || !proxyMaps[type].map) return;

            // اگر این پروکسی قبلاً در نقشه نمایش داده شده، دوباره بارگذاری نکنید تا از refresh مکرر و چشمک زدن جلوگیری شود
            if (lastMappedProxy[type] === selectedProxyUrl) return;
            lastMappedProxy[type] = selectedProxyUrl;

            // یافتن اطلاعات کامل پروکسی از لیست داده‌ها
            const proxyData = window[config.listData].find(p => p.proxy === selectedProxyUrl);
            if (!proxyData || proxyData.latitude === null || proxyData.longitude === null) return;

            const lat = parseFloat(proxyData.latitude);
            const lng = parseFloat(proxyData.longitude);
            const map = proxyMaps[type].map;

            // به‌روزرسانی یا ایجاد Marker
            if (proxyMaps[type].marker) {
                proxyMaps[type].marker.setLatLng([lat, lng]);
            } else {
                proxyMaps[type].marker = L.marker([lat, lng]).addTo(map);
            }

            // حرکت نرم نقشه - قرار دادن نقطه نشانگر در پایین نقشه برای جلوگیری از پوشش داده
            map.setZoom(4);

            // محاسبه مرکز.offset شده برای نمایش نشانگر در 60% پایین نما
            const mapSize = map.getSize();
            const offsetY = mapSize.y * 0.2; // offset به بالا 20% برای نمایش نشانگر در 60%
            const point = map.project([lat, lng], 4).subtract([0, offsetY]);
            const offsetCenter = map.unproject(point, 4);

            map.flyTo(offsetCenter, 4, {
                duration: 1.5
            });

            // افزودن یا به‌روزرسانی Popup
            const isDark = document.documentElement.classList.contains('dark-mode');
            const textColor = isDark ? '#ffffff' : '#333333';
            const popupContent = `
                <div class="ip-detail-popup-city">
                    ${proxyData.city || proxyData.country || 'موقعیت'}
                </div>
                <div class="ip-detail-popup-item">
                    <span class="ip-detail-popup-label">کشور:</span>
                    <span class="ip-detail-popup-value">[${proxyData.country || '-'}]${proxyData.country_cn || ''}</span>
                </div>
                <div class="ip-detail-popup-item">
                    <span class="ip-detail-popup-label">IP محلی:</span>
                    <span class="ip-detail-popup-value">${proxyData.clientIp || proxyData.ip || '-'}</span>
                </div>
                <div class="ip-detail-popup-item">
                    <span class="ip-detail-popup-label">ASN:</span>
                    <span class="ip-detail-popup-value">${proxyData.asn || ''}</span>
                </div>
                <div class="ip-detail-popup-item">
                    <span class="ip-detail-popup-label">ارائه‌دهنده:</span>
                    <span class="ip-detail-popup-value">${proxyData.asOrganization || 'ناشناخته'}</span>
                </div>
            `;
            proxyMaps[type].marker.bindPopup(popupContent, { offset: L.point(0, -32) }).openPopup();
        }

        function closeExploreProxyModal(type, event) {
            if (event && event.preventDefault) event.preventDefault();
            const config = proxyConfigs[type];
            const modal = document.getElementById(config.modalId);
            if (modal) {
                modal.classList.remove('show');
            }

            // متوقف کردن تست‌های در حال انجام
            if (config.abortController) {
                config.abortController.abort();
                config.abortController = null;
            }

            // پاک کردن همه تایمرهای تایم اوت
            for (let timeout of Object.values(window[config.verificationTimeouts])) {
                clearTimeout(timeout);
            }

            // پاکسازی تایمر throttling
            resetProxyDisplayUpdateState(type);
        }

        function loadProxyList(type) {
            const config = proxyConfigs[type];
            const url = config.url;

            fetchWithAutoMirror(url, config.description)
                .then(text => {
                    let data = JSON.parse(text);
                    if (type === 'proxyip') {
                        // فرمت all.json آرایه 'data' دارد
                        data = data.data.filter(item =>
                            Array.isArray(item.port) ? item.port.includes(443) : item.port === 443
                        ).map(item => ({
                            proxy: item.ip,
                            ip: item.ip,
                            country: item.meta?.country || 'ناشناخته',
                            country_cn: item.meta?.country_cn || 'ناشناخته',
                            country_en: item.meta?.country_en || 'ناشناخته',
                            country_emoji: item.meta?.country_emoji || '🏳️',
                            city: item.meta?.city || 'ناشناخته',
                            clientIp: item.meta?.clientIp || item.ip,
                            asn: item.meta?.asn || 0,
                            asOrganization: item.meta?.asOrganization || 'ناشناخته',
                            continent: item.meta?.continent || 'ناشناخته',
                            latitude: item.meta?.latitude !== undefined ? item.meta.latitude : (item.meta?.colo?.lat !== undefined ? item.meta.colo.lat : null),
                            longitude: item.meta?.longitude !== undefined ? item.meta.longitude : (item.meta?.colo?.lon !== undefined ? item.meta.colo.lon : null)
                        }));
                    }
                    window[config.listData] = data;
                    window[config.countryMap] = buildCountryMap(window[config.listData], window[config.countryMap]);
                    populateProxyRegionSelect(type);
                })
                .catch(error => {
                    console.error(`${config.description}بارگذاری شکست خورد:`, error);
                    document.getElementById(config.regionSelectId).innerHTML = '<option value="">بارگذاری ناموفق</option>';
                });
        }

        // نگاشت اطلاعات قاره
        const continentInfo = {
            'AS': { emoji: '🌏', name: 'آسیا' },
            'NA': { emoji: '🌎', name: 'آمریکای شمالی' },
            'EU': { emoji: '🌍', name: 'اروپا' },
            'AF': { emoji: '🌍', name: 'آفریقا' },
            'SA': { emoji: '🌎', name: 'آمریکای جنوبی' },
            'OC': { emoji: '🌏', name: 'اقیانوسیه' },
            'AN': { emoji: '❄️', name: 'قطب جنوب' }
        };

        function populateProxyRegionSelect(type) {
            const config = proxyConfigs[type];
            const select = document.getElementById(config.regionSelectId);
            let html = '<option value="">-- لطفا منطقه را انتخاب کنید --</option>';

            // ساخت ساختار گروه‌بندی شده بر اساس قاره
            const continentMap = {};

            // پیمایش همه کشور، دسته‌بندی به قاره‌ها
            for (const [country, proxies] of Object.entries(window[config.countryMap])) {
                const proxy = proxies[0]; // گرفتن اولین پروکسی برای اطلاعات قاره
                const continent = proxy.continent || 'ناشناخته';
                const continentData = continentInfo[continent] || { emoji: '🌍', name: continent };

                if (!continentMap[continent]) {
                    continentMap[continent] = {
                        emoji: continentData.emoji,
                        name: continentData.name,
                        countries: {}
                    };
                }

                continentMap[continent].countries[country] = {
                    count: proxies.length,
                    name: proxy.country_cn || country,
                    emoji: proxy.country_emoji || ''
                };
            }

            // تولید HTML
            for (const [continentCode, continentData] of Object.entries(continentMap)) {
                const label = `${continentData.emoji} ${continentData.name} / ${continentCode}`;
                html += `<optgroup label="${label}">`;

                for (const [country, countryData] of Object.entries(continentData.countries)) {
                    html += `<option value="${country}">${countryData.emoji} ${countryData.name}(${countryData.count})</option>`;
                }

                html += `</optgroup>`;
            }

            select.innerHTML = html;
        }

        function onProxyRegionChange(type) {
            const config = proxyConfigs[type];
            const selectedCountry = document.getElementById(config.regionSelectId).value;

            if (!selectedCountry) {
                document.getElementById(config.confirmBtnId).disabled = true;
                return;
            }

            const proxies = window[config.countryMap][selectedCountry] || [];

            // نمایش گروه انتخاب پروکسی
            document.getElementById(config.proxySelectGroupId).style.display = 'block';

            // مقداردهی اولیه وضعیت تایید برای هر پروکسی
            proxies.forEach(proxy => {
                if (!window[config.verificationStatus][proxy.proxy]) {
                    window[config.verificationStatus][proxy.proxy] = {
                        status: 'pending', // pending, success, failed, timeout
                        responseTime: null
                    };
                }
            });

            // تنظیم select به وضعیت در حال تایید
            const select = document.getElementById(config.proxySelectId);
            select.innerHTML = '<option value="">در حال تایید در دسترس بودن، لطفا صبر کنید...</option>';

            // نمایش لیست پروکسی
            populateProxySelect(selectedCountry, config.proxySelectId, window[config.countryMap], window[config.verificationStatus]);

            // آزادسازی AbortController قبلی و ایجاد جدید
            if (config.abortController) {
                config.abortController.abort();
            }
            config.abortController = new AbortController();

            // شروع تایید همه پروکسی‌ها
            verifyProxies(proxies, config.verifySingleFunction, () => {
                updateProxyDisplay(type);
                // اگر انتخاب فعلی موفق است، تلاش برای به‌روزرسانی نقشه
                updateProxyMap(type);
            }, config.abortController.signal);
        }

        // ===== سیستم به‌روزرسانی throttled: جلوگیری از refresh مکرر جعبه انتخاب در موبایل =====
        const PROXY_DISPLAY_UPDATE_INTERVAL = 6000; // فاصله throttling: 6 ثانیه
        const proxyDisplayUpdateState = {
            socks5:  { lastUpdate: 0, pending: false, timer: null, selectOpen: false, listenersAdded: false },
            http:    { lastUpdate: 0, pending: false, timer: null, selectOpen: false, listenersAdded: false },
            proxyip: { lastUpdate: 0, pending: false, timer: null, selectOpen: false, listenersAdded: false }
        };

        // افزودن شنونده focus/blur برای جعبه انتخاب پروکسی، تشخیص اینکه آیا کاربر در حال کار با جعبه انتخاب است
        function ensureProxySelectListeners(type) {
            const state = proxyDisplayUpdateState[type];
            if (state.listenersAdded) return;
            const config = proxyConfigs[type];
            const select = document.getElementById(config.proxySelectId);
            if (!select) return;
            select.addEventListener('focus', () => {
                state.selectOpen = true;
            });
            select.addEventListener('blur', () => {
                state.selectOpen = false;
                // وقتی جعبه بسته شد، اگر به‌روزرسانی در انتظار است فوراً اجرا کن
                if (state.pending) {
                    _doUpdateProxyDisplay(type);
                }
            });
            state.listenersAdded = true;
        }

        // بررسی اینکه آیا همه پروکسی‌های منطقه فعلی کاملاً تایید شده‌اند
        function isAllProxiesVerified(type) {
            const config = proxyConfigs[type];
            const selectedCountry = document.getElementById(config.regionSelectId).value;
            if (!selectedCountry) return false;
            const proxies = window[config.countryMap][selectedCountry] || [];
            return proxies.length > 0 && proxies.every(p => {
                const s = window[config.verificationStatus][p.proxy];
                return s && s.status !== 'pending';
            });
        }

        // نسخه throttled از updateProxyDisplay —— فراخوانی یکپارچه از خارج
        // استراتژی: در زمان بسته بودن جعبه انتخاب به‌روزرسانی بلادرنگ؛ در زمان باز بودن هر 6 ثانیه یکبار throttled
        function updateProxyDisplay(type) {
            const state = proxyDisplayUpdateState[type];
            const now = Date.now();

            // جعبه انتخاب باز نیست: به‌روزرسانی بلادرنگ مستقیم
            if (!state.selectOpen) {
                if (state.timer) { clearTimeout(state.timer); state.timer = null; }
                _doUpdateProxyDisplay(type);
                return;
            }

            // === منطق throttling برای وضعیت باز بودن جعبه انتخاب ===

            // هنگامی که همه تایید شدند، اجبار به برنامه‌ریزی یکبار به‌روزرسانی (نتیجه نهایی)
            if (isAllProxiesVerified(type)) {
                if (state.timer) { clearTimeout(state.timer); state.timer = null; }
                // اگر از آخرین به‌روزرسانی بیش از فاصله throttling گذشته، به‌روزرسانی مستقیم
                if (now - state.lastUpdate >= PROXY_DISPLAY_UPDATE_INTERVAL) {
                    _doUpdateProxyDisplay(type);
                } else {
                    // اگر به فاصله نرسیده، تایمری برنامه‌ریزی کنید تا نتیجه نهایی حتماً refresh شود
                    state.pending = true;
                    if (!state.timer) {
                        const delay = PROXY_DISPLAY_UPDATE_INTERVAL - (now - state.lastUpdate);
                        state.timer = setTimeout(() => {
                            state.timer = null;
                            if (state.pending) {
                                _doUpdateProxyDisplay(type);
                            }
                        }, delay);
                    }
                }
                return;
            }

            // throttling: اگر از آخرین به‌روزرسانی کمتر از 6 ثانیه گذشته، اجرای به تعویق افتاده
            if (now - state.lastUpdate < PROXY_DISPLAY_UPDATE_INTERVAL) {
                state.pending = true;
                if (!state.timer) {
                    const delay = PROXY_DISPLAY_UPDATE_INTERVAL - (now - state.lastUpdate);
                    state.timer = setTimeout(() => {
                        state.timer = null;
                        if (state.pending) {
                            _doUpdateProxyDisplay(type);
                        }
                    }, delay);
                }
                return;
            }

            // اگر از فاصله throttling گذشته، به‌روزرسانی مستقیم
            _doUpdateProxyDisplay(type);
        }

        // تابع داخلی که به‌روزرسانی را واقعاً اجرا می‌کند
        function _doUpdateProxyDisplay(type) {
            const state = proxyDisplayUpdateState[type];
            state.lastUpdate = Date.now();
            state.pending = false;

            const config = proxyConfigs[type];
            const selectedCountry = document.getElementById(config.regionSelectId).value;
            if (selectedCountry) {
                populateProxySelect(selectedCountry, config.proxySelectId, window[config.countryMap], window[config.verificationStatus], type);

                // به‌روزرسانی وضعیت دکمه تایید
                const select = document.getElementById(config.proxySelectId);
                const selectedValue = select.value;
                const isValidSelected = selectedValue &&
                    window[config.verificationStatus][selectedValue] &&
                    window[config.verificationStatus][selectedValue].status === 'success';
                document.getElementById(config.confirmBtnId).disabled = !isValidSelected;
            }
        }

        // تنظیم مجدد وضعیت throttling (در زمان بستن مودال فراخوانی شود)
        function resetProxyDisplayUpdateState(type) {
            const state = proxyDisplayUpdateState[type];
            if (state.timer) { clearTimeout(state.timer); state.timer = null; }
            state.lastUpdate = 0;
            state.pending = false;
            state.selectOpen = false;
        }

        function confirmSelectProxy(type) {
            const config = proxyConfigs[type];
            const select = document.getElementById(config.proxySelectId);
            const selectedProxy = select.value;

            if (!selectedProxy) {
                showToast(`لطفا یک پروکسی معتبر ${type.toUpperCase()} انتخاب کنید`, 'error');
                return;
            }

            // وارد کردن آدرس پروکسی
            const input = document.getElementById(config.inputId);
            if (input) {
                input.value = selectedProxy.replace(/^socks5:\/\/|^http:\/\/|^https:\/\//, '');
                input.dispatchEvent(new Event('change', { bubbles: true }));
                markModified('proxy');
            }

            // بستن مودال
            const modal = document.getElementById(config.modalId);
            if (modal) {
                modal.classList.remove('show');
            }

            // پس از تایید انتخاب، تست‌های باقی‌مانده را متوقف کن
            if (config.abortController) {
                config.abortController.abort();
                config.abortController = null;
            }

            // روشن کردن دکمه‌های ذخیره و لغو
            const saveBtn = document.getElementById('saveProxyBtn');
            const cancelBtn = document.getElementById('cancelProxyBtn');
            if (saveBtn) saveBtn.disabled = false;
            if (cancelBtn) cancelBtn.disabled = false;
        }

        function updateProxyConfirmButton(type) {
            const config = proxyConfigs[type];
            const select = document.getElementById(config.proxySelectId);
            const selectedValue = select.value;
            const confirmBtn = document.getElementById(config.confirmBtnId);

            // بررسی اینکه آیا پروکسی انتخاب شده در دسترس است
            const isValidSelected = selectedValue &&
                window[config.verificationStatus][selectedValue] &&
                window[config.verificationStatus][selectedValue].status === 'success';

            if (confirmBtn) {
                confirmBtn.disabled = !isValidSelected;
            }
        }

        // تابع تایید تک پروکسی عمومی
        function verifySingleProxy(proxy, type, signal) {
            return new Promise((resolve) => {
                const config = proxyConfigs[type];
                const { protocol, proxy: proxyUrl } = proxy;
                const cleanProxy = proxyUrl.replace(protocol + '://', '');
                const checkUrl = `/admin/check?${protocol}=${encodeURIComponent(cleanProxy)}&_t=${Date.now()}`;

                // اگر از قبل终止 شده، مستقیم برگردید
                if (signal && signal.aborted) {
                    return resolve();
                }

                // تنظیم تایم اوت 15 ثانیه‌ای
                const timeoutId = setTimeout(() => {
                    window[config.verificationStatus][proxyUrl] = {
                        status: 'timeout',
                        responseTime: null
                    };
                    updateProxyDisplay(type);
                    resolve();
                }, 15000);

                window[config.verificationTimeouts][proxyUrl] = timeoutId;

                fetch(checkUrl, { signal })
                    .then(response => response.json())
                    .then(data => {
                        clearTimeout(timeoutId);
                        delete window[config.verificationTimeouts][proxyUrl];

                        if (data.success) {
                            window[config.verificationStatus][proxyUrl] = {
                                status: 'success',
                                responseTime: data.responseTime
                            };
                        } else {
                            window[config.verificationStatus][proxyUrl] = {
                                status: 'failed',
                                responseTime: null
                            };
                        }
                        updateProxyDisplay(type);
                        resolve();
                    })
                    .catch(error => {
                        clearTimeout(timeoutId);
                        delete window[config.verificationTimeouts][proxyUrl];

                        window[config.verificationStatus][proxyUrl] = {
                            status: 'failed',
                            responseTime: null
                        };
                        updateProxyDisplay(type);
                        resolve();
                    });
            });
        }
		// ==================== توابع مرتبط با HTTP ====================

        // ذخیره داده‌های HTTP
        let httpListData = [];
        let httpCountryMap = {};
        let httpVerificationStatus = {}; // ذخیره وضعیت تایید
        let httpVerificationTimeouts = {}; // ذخیره تایمر تایم اوت

        function showExploreHTTPModal() {
            showExploreProxyModal('http');
        }

        function closeExploreHTTPModal(event) {
            closeExploreProxyModal('http', event);
        }

        function loadHTTPList() {
            loadProxyList('http');
        }


        function populateHTTPRegionSelect() {
            populateProxyRegionSelect('http');
        }

        function onHTTPRegionChange() {
            onProxyRegionChange('http');
        }

        function populateHTTPProxySelect(selectedCountry) {
            populateProxySelect(selectedCountry, 'httpProxySelect', httpCountryMap, httpVerificationStatus, 'http');
        }

        function verifyHTTPProxies(proxies) {
            verifyProxies(proxies, verifySingleHTTP);
        }

        function verifySingleHTTP(proxy, signal) {
            return verifySingleProxy(proxy, 'http', signal);
        }

        function updateHTTPDisplay() {
            updateProxyDisplay('http');
        }

        function confirmSelectHTTP() {
            confirmSelectProxy('http');
        }

        function updateHTTPConfirmButton() {
            updateProxyConfirmButton('http');
        }

        // ============ توابع مرتبط با بررسی HOSTS ============

        // بررسی اینکه آیا دامنه فعلی در آرایه HOSTS وجود دارد
        function checkHostsMismatch() {
            const currentHostname = window.location.hostname;
            const hosts = currentConfig.HOSTS || [];

            // بررسی اینکه آیا hostname فعلی در آرایه HOSTS وجود دارد
            const isHostInArray = hosts.some(host => {
                // حذف شماره پورت برای مقایسه
                const hostWithoutPort = host.split(':')[0];
                return hostWithoutPort === currentHostname;
            });

            if (!isHostInArray && hosts.length > 0) {
                // بررسی کش، آیا در 24 ساعت گذشته نشان داده شده است
                if (shouldShowHostsMismatchNotification()) {
                    showHostsMismatchNotification(currentHostname, hosts);
                }
            }
        }

        // بررسی اینکه آیا باید提示 عدم تطابق HOSTS نمایش داده شود
        function shouldShowHostsMismatchNotification() {
            const cacheKey = 'hostsMismatchNotificationTime';
            const cachedTime = localStorage.getItem(cacheKey);

            if (!cachedTime) {
                // بدون کش، باید نمایش داده شود
                return true;
            }

            const lastNotificationTime = parseInt(cachedTime, 10);
            const currentTime = Date.now();
            const twentyFourHours = 24 * 60 * 60 * 1000; // میلی‌ثانیه 24 ساعت

            // بررسی اینکه آیا بیش از 24 ساعت گذشته
            return (currentTime - lastNotificationTime) > twentyFourHours;
        }

        // نمایش提示 عدم تطابق HOSTS
        function showHostsMismatchNotification(currentHostname, hosts) {
            // پر کردن محتوای مودال
            const currentHostnameEl = document.getElementById('currentHostname');
            const hostToAddEl = document.getElementById('hostToAdd');
            const currentHostsEl = document.getElementById('currentHosts');

            if (currentHostnameEl) {
                currentHostnameEl.textContent = currentHostname;
            }
            if (hostToAddEl) {
                hostToAddEl.textContent = currentHostname;
            }

            // پر کردن لیست HOSTS فعلی - با badge HTML به جای متن ساده
            if (currentHostsEl) {
                // پاک کردن و پر کردن مجدد با ساختار HTML
                currentHostsEl.innerHTML = '';

                hosts.forEach((host) => {
                    const badge = document.createElement('span');
                    badge.className = 'hosts-badge';
                    badge.textContent = host;
                    currentHostsEl.appendChild(badge);
                });
            }

            // نمایش مودال
            const overlay = document.getElementById('hostsMismatchModal');
            if (overlay) {
                const modal = overlay.querySelector('.modal');
                overlay.classList.add('show');
                console.log('✓提示 عدم تطابق دامنه نمایش داده شد');
            } else {
                console.error('✗ امکان یافتن عناصر hostsMismatchModal وجود ندارد');
            }
        }

        // بستن مودال提示 عدم تطابق HOSTS
        function closeHostsMismatchModal(event) {
            // اگر شیء رویداد وجود دارد و روی خود overlay کلیک نشده، برگردید
            if (event && event.target && event.target.id !== 'hostsMismatchModal') {
                return;
            }

            const overlay = document.getElementById('hostsMismatchModal');
            if (overlay) {
                overlay.classList.remove('show');
            }
        }

        // پردازش دکمه "متوجه شدم! 24 ساعت دیگر نشان نده"
        function dismissHostsMismatchNotification() {
            const cacheKey = 'hostsMismatchNotificationTime';
            const currentTime = Date.now();

            // ذخیره timestamp فعلی در localStorage
            localStorage.setItem(cacheKey, currentTime.toString());

            // بستن مودال
            closeHostsMismatchModal({ target: { id: 'hostsMismatchModal' } });

            // نمایش toast تأیید
            showToast('🎉 24 ساعت دیگر نشان داده نخواهد شد', 'info');
        }

    </script>
</body>

</html>